(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{8924:function(){},5024:function(){},9325:function(e,t,s){Promise.resolve().then(s.bind(s,8323))},8323:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return tp}});var a=s(7437),r=s(2265),n=s(4660),i=s(4810),l=s(4829);class c{setToken(e){this.token=e}getToken(){return this.token}async register(e,t,s,a){return(await this.client.post("/api/auth/register",{username:e,email:t,password:s,device_id:a,device_type:"web"})).data}async login(e,t){let s=new URLSearchParams;s.append("username",e),s.append("password",t);let a=await this.client.post("/api/auth/login",s,{headers:{"Content-Type":"application/x-www-form-urlencoded"}});return this.token=a.data.access_token,a.data}async getCurrentUser(){return(await this.client.get("/api/auth/me")).data}async updateSettings(e){return(await this.client.patch("/api/auth/me/settings",{settings:e})).data}async uploadKeys(e){await this.client.post("/api/keys/upload",e)}async getPublicKey(e){return(await this.client.get("/api/keys/".concat(e))).data}async getKeyBundle(e){return(await this.client.get("/api/keys/bundle/".concat(e))).data}async sendMessage(e,t,s){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"none",r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"text",n=arguments.length>5?arguments[5]:void 0,i=arguments.length>6?arguments[6]:void 0;return(await this.client.post("/api/messages/send",{recipient_username:e,encrypted_content:t,encrypted_key:s,expiry_type:a,message_type:r,file_metadata:n,sender_theme:i})).data}async getConversation(e){return(await this.client.get("/api/messages/conversation/".concat(e))).data}async getUnreadMessages(){return(await this.client.get("/api/messages/unread")).data}async getCallHistory(){return(await this.client.get("/api/messages/calls/history")).data}async deleteMessage(e){await this.client.delete("/api/messages/".concat(e))}async deleteConversation(e){await this.client.delete("/api/messages/conversation/".concat(e))}async deleteCallHistory(e){await this.client.delete("/api/messages/calls/history/".concat(e))}async getContacts(){return(await this.client.get("/api/contacts/")).data}async addContact(e,t){return(await this.client.post("/api/contacts/",{username:e,nickname:t})).data}async removeContact(e){await this.client.delete("/api/contacts/".concat(e))}async blockContact(e){await this.client.post("/api/contacts/".concat(e,"/block"))}async searchUsers(e){return(await this.client.get("/api/contacts/search",{params:{q:e}})).data}async getConversations(){return(await this.client.get("/api/contacts/conversations")).data}async getAllConversationsWithMessages(){return(await this.client.get("/api/messages/all-conversations")).data}async getVaultItems(){return(await this.client.get("/api/vault/items")).data}async createVaultItem(e){await this.client.post("/api/vault/items",e)}constructor(){this.token=null,this.client=l.Z.create({baseURL:"https://cipherlink-backend.onrender.com",headers:{"Content-Type":"application/json"}}),this.client.interceptors.request.use(e=>(this.token&&(e.headers.Authorization="Bearer ".concat(this.token)),e))}}let o=new c;class d{setToken(e){this.token=e}async sendFriendRequest(e){return(await this.client.post("/api/friend/request",e)).data}async acceptFriendRequest(e){return(await this.client.post("/api/friend/accept",e)).data}async rejectFriendRequest(e){await this.client.post("/api/friend/reject",e)}async cancelFriendRequest(e){await this.client.post("/api/friend/cancel/".concat(e))}async getPendingRequests(){return(await this.client.get("/api/friend/pending")).data}async getTrustedContacts(){return(await this.client.get("/api/friend/list")).data}async getContact(e){return(await this.client.get("/api/friend/contact/".concat(e))).data}async verifyContact(e){await this.client.post("/api/friend/verify",e)}async removeContact(e){await this.client.delete("/api/friend/contact/".concat(e))}async updateContactNickname(e,t){await this.client.put("/api/friend/contact/".concat(e,"/nickname"),null,{params:{nickname:t}})}async canMessageUser(e){return(await this.client.get("/api/friend/can-message/".concat(e))).data}async unfriendUser(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return(await this.client.post("/api/friend/unfriend",{user_id:e,revoke_keys:t})).data}async blockUser(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"other",s=arguments.length>2?arguments[2]:void 0;await this.client.post("/api/friend/block",{user_id:e,reason:t,additional_info:s})}async unblockUser(e){await this.client.post("/api/friend/unblock",{user_id:e})}async getBlockedUsers(){return(await this.client.get("/api/friend/blocked")).data}async getNotifications(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return(await this.client.get("/api/friend/notifications",{params:{unread_only:e,limit:t,offset:s}})).data}async getNotificationCount(){return(await this.client.get("/api/friend/notifications/count")).data}async markNotificationRead(e){await this.client.post("/api/friend/notifications/".concat(e,"/read"))}async markAllNotificationsRead(){await this.client.post("/api/friend/notifications/read-all")}async searchUsers(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"username";return(await this.client.get("/api/friend/search",{params:{q:e,search_type:t}})).data}async getQRData(){return(await this.client.get("/api/friend/qr-data")).data}async processQRScan(e){return(await this.client.post("/api/friend/qr-scan",e)).data}async notifyKeyChanged(e,t){await this.client.post("/api/friend/key-changed/".concat(e),null,{params:{new_fingerprint:t}})}constructor(){this.token=null,this.client=l.Z.create({baseURL:"https://cipherlink-backend.onrender.com",headers:{"Content-Type":"application/json"}}),this.client.interceptors.request.use(e=>(this.token&&(e.headers.Authorization="Bearer ".concat(this.token)),e))}}let u=new d;function m(e){var t;if(!e)return"";let s=e.replace("-----BEGIN PUBLIC KEY-----","").replace("-----END PUBLIC KEY-----","").replace(/\s/g,""),a=0;for(let e=0;e<s.length;e++)a=(a<<5)-a+s.charCodeAt(e),a&=a;return(null===(t=Math.abs(a).toString(16).toUpperCase().padStart(32,"0").match(/.{1,2}/g))||void 0===t?void 0:t.slice(0,16).join(":"))||""}var h=s(7963),g=s.n(h),x=s(2092);function p(e,t,s){try{var a;let r=(0,x.decodeBase64)(e.ciphertext),n=(0,x.decodeBase64)(e.nonce),i=e.senderPublicKey||t;if(console.log("\uD83D\uDD13 Decryption attempt:",{version:e.version||"v1",hasEmbeddedKey:!!e.senderPublicKey,embeddedKeyPrefix:null===(a=e.senderPublicKey)||void 0===a?void 0:a.substring(0,20),fallbackKeyPrefix:null==t?void 0:t.substring(0,20),usingKeyPrefix:null==i?void 0:i.substring(0,20),recipientKeyPrefix:null==s?void 0:s.substring(0,20)}),!i)return console.error("❌ Decryption failed: No sender public key available"),null;let l=(0,x.decodeBase64)(i),c=(0,x.decodeBase64)(s),o=g().box.open(r,n,l,c);if(!o){console.warn("⚠️ Primary decryption failed with key:",null==i?void 0:i.substring(0,20));let a=f(s);if(console.log("\uD83D\uDD0D Key diagnostics:",{senderKeyPrefix:null==i?void 0:i.substring(0,20),recipientDerivedPubKey:null==a?void 0:a.substring(0,20),hint:"Key mismatch detected - sender or recipient may have regenerated keys",recovery:"If you regenerated your keys, old messages cannot be decrypted. Contact sender to resend."}),e.senderPublicKey&&t&&e.senderPublicKey!==t){console.log("\uD83D\uDD04 Trying fallback sender key:",null==t?void 0:t.substring(0,20));try{let e=(0,x.decodeBase64)(t),s=g().box.open(r,n,e,c);if(s)return console.log("✅ Fallback decryption succeeded!"),(0,x.encodeUTF8)(s)}catch(e){console.warn("❌ Fallback decryption also failed:",e)}}return console.error("❌ All decryption attempts failed. This message may be permanently undecryptable if keys were regenerated."),null}return console.log("✅ Decryption succeeded"),(0,x.encodeUTF8)(o)}catch(e){return console.error("❌ Decryption error:",e),null}}function y(e){var t;let s=(0,x.decodeBase64)(e),a=Array.from(g().hash(s).slice(0,16)).map(e=>e.toString(16).padStart(2,"0")).join("");return(null===(t=a.toUpperCase().match(/.{1,4}/g))||void 0===t?void 0:t.join(" "))||a.toUpperCase()}function b(e,t){try{let s=(0,x.decodeBase64)(e),a=(0,x.decodeBase64)(t),r=g().box.keyPair.fromSecretKey(s).publicKey;if(r.length!==a.length)return!1;for(let e=0;e<r.length;e++)if(r[e]!==a[e])return!1;return!0}catch(e){return console.error("Key pair verification failed:",e),!1}}function f(e){let t=(0,x.decodeBase64)(e),s=g().box.keyPair.fromSecretKey(t);return(0,x.encodeBase64)(s.publicKey)}function v(e,t){let s=(0,x.decodeBase64)(e),a=(0,x.decodeBase64)(t),r=g().box.before(a,s);return(0,x.encodeBase64)(r)}let w={STORAGE_KEY:"zerotrace_keys",SESSION_CACHE_KEY:"zerotrace_sessions",save(e,t){try{let s=localStorage.getItem(this.STORAGE_KEY),a=s?JSON.parse(s):{};t.fingerprint=y(t.publicKey),a[e]=t,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(a))}catch(e){console.error("Failed to save keys:",e)}},load(e){try{let t=localStorage.getItem(this.STORAGE_KEY);if(!t)return null;return JSON.parse(t)[e]||null}catch(e){return null}},verifyKeyConsistency(e,t){let s=this.load(e);return!!s&&y(s.publicKey)===y(t)},remove(e){try{let t=localStorage.getItem(this.STORAGE_KEY);if(t){let s=JSON.parse(t);delete s[e],localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s))}this.clearSessionCache(e)}catch(e){console.error("Failed to remove keys:",e)}},clear(){localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.SESSION_CACHE_KEY)},getOrDeriveSessionKey(e,t,s,a){let r="".concat(e,":").concat(t,":").concat(y(a).slice(0,16));try{let e=localStorage.getItem(this.SESSION_CACHE_KEY),t=e?JSON.parse(e):{};if(t[r])return t[r];let n=v(s,a);return t[r]=n,localStorage.setItem(this.SESSION_CACHE_KEY,JSON.stringify(t)),n}catch(e){return console.error("Session cache error:",e),v(s,a)}},clearSessionCache(e){if(!e){localStorage.removeItem(this.SESSION_CACHE_KEY);return}try{let t=localStorage.getItem(this.SESSION_CACHE_KEY);if(t){let s=JSON.parse(t),a={};for(let[t,r]of Object.entries(s))t.startsWith("".concat(e,":"))||(a[t]=r);localStorage.setItem(this.SESSION_CACHE_KEY,JSON.stringify(a))}}catch(e){console.error("Failed to clear session cache:",e)}}};class j{connect(e,t){this.userId=e,this.token=t,this.connectWebSocket()}connectWebSocket(){var e;if(!this.isConnecting&&(null===(e=this.ws)||void 0===e?void 0:e.readyState)!==WebSocket.OPEN){if(this.isConnecting=!0,!this.token){console.warn("No auth token available for WebSocket connection"),this.isConnecting=!1;return}try{this.ws=new WebSocket("".concat("wss://cipherlink-backend.onrender.com/ws","/chat?token=").concat(this.token)),this.ws.onopen=()=>{console.log("\uD83D\uDD17 WebSocket connected"),this.isConnecting=!1,this.reconnectAttempts=0,this.startHeartbeat(),this.flushMessageQueue()},this.ws.onmessage=e=>{try{let t=JSON.parse(e.data);this.handleMessage(t)}catch(e){console.error("Failed to parse WebSocket message:",e)}},this.ws.onclose=e=>{console.log("\uD83D\uDD0C WebSocket disconnected:",e.code,e.reason),this.isConnecting=!1,this.stopHeartbeat(),this.attemptReconnect()},this.ws.onerror=e=>{console.error("❌ WebSocket error:",e),this.isConnecting=!1}}catch(e){console.error("Failed to create WebSocket connection:",e),this.isConnecting=!1,this.attemptReconnect()}}}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnection attempts reached");return}this.reconnectAttempts++;let e=Math.min(this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),3e4);console.log("Attempting to reconnect in ".concat(e,"ms (attempt ").concat(this.reconnectAttempts,")")),setTimeout(()=>{this.connectWebSocket()},e)}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{var e;(null===(e=this.ws)||void 0===e?void 0:e.readyState)===WebSocket.OPEN&&this.send({type:"ping",data:{},timestamp:new Date().toISOString()})},3e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}handleMessage(e){let t=e.type,s=this.messageHandlers.get(t);s&&s.size>0?s.forEach(s=>{try{s(e)}catch(e){console.error("Error in handler for ".concat(t,":"),e)}}):"pong"!==t&&console.log("Unhandled WebSocket message type:",t,e)}flushMessageQueue(){for(;this.messageQueue.length>0;){let e=this.messageQueue.shift();e&&this.send(e)}}send(e){var t,s;(null===(t=this.ws)||void 0===t?void 0:t.readyState)===WebSocket.OPEN?(console.log("\uD83D\uDCE4 Sending ".concat(e.type," message:"),e),this.ws.send(JSON.stringify(e))):(this.messageQueue.push(e),console.warn("⏳ WebSocket not connected (state: ".concat(null===(s=this.ws)||void 0===s?void 0:s.readyState,"), queuing ").concat(e.type," message")),!this.isConnecting&&this.userId&&this.token&&(console.log("\uD83D\uDD04 Triggering reconnection from send failure"),this.connect(this.userId,this.token)))}on(e,t){this.messageHandlers.has(e)||this.messageHandlers.set(e,new Set),this.messageHandlers.get(e).add(t)}off(e,t){if(t){var s;null===(s=this.messageHandlers.get(e))||void 0===s||s.delete(t)}else this.messageHandlers.delete(e)}onMessage(e,t){this.on(e,t)}offMessage(e){this.messageHandlers.delete(e)}sendEncryptedMessage(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text",a=arguments.length>3?arguments[3]:void 0;this.send({type:"message",data:{recipient_username:e,encrypted_content:t,message_type:s,file_metadata:a},timestamp:new Date().toISOString()})}sendTypingIndicator(e,t){this.send({type:"typing",data:{recipient_username:e,is_typing:t},timestamp:new Date().toISOString()})}sendDeliveryReceipt(e,t){this.send({type:"delivery_receipt",data:{message_id:e,sender_id:t},timestamp:new Date().toISOString()})}sendReadReceipt(e,t){this.send({type:"read_receipt",data:{message_id:e,sender_id:t},timestamp:new Date().toISOString()})}updatePresence(e){this.send({type:"presence",data:{is_online:e},timestamp:new Date().toISOString()})}subscribeToPresence(e){this.send({type:"presence_subscribe",data:{user_ids:e},timestamp:new Date().toISOString()})}getOnlineStatus(e){this.send({type:"get_online_status",data:{user_ids:e},timestamp:new Date().toISOString()})}sendDeleteMessage(e,t){this.send({type:"delete_message",data:{message_id:e,recipient_username:t},timestamp:new Date().toISOString()})}sendDeleteConversation(e){this.send({type:"delete_conversation",data:{recipient_username:e},timestamp:new Date().toISOString()})}disconnect(){this.stopHeartbeat(),this.updatePresence(!1),this.ws&&(this.ws.close(),this.ws=null),this.messageQueue=[]}isConnected(){var e;return(null===(e=this.ws)||void 0===e?void 0:e.readyState)===WebSocket.OPEN}getConnectionState(){var e,t;return null!==(t=null===(e=this.ws)||void 0===e?void 0:e.readyState)&&void 0!==t?t:null}constructor(){this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=10,this.reconnectDelay=1e3,this.heartbeatInterval=null,this.messageHandlers=new Map,this.userId=null,this.token=null,this.isConnecting=!1,this.messageQueue=[]}}let N=new j;window.addEventListener("beforeunload",()=>{N.updatePresence(!1),N.disconnect()}),document.addEventListener("visibilitychange",()=>{document.hidden?N.updatePresence(!1):N.updatePresence(!0)});class k{async init(){return new Promise((e,t)=>{let s=indexedDB.open(this.dbName,this.version);s.onerror=()=>t(s.error),s.onsuccess=()=>{this.db=s.result,e()},s.onupgradeneeded=e=>{let t=e.target.result;if(!t.objectStoreNames.contains("messages")){let e=t.createObjectStore("messages",{keyPath:"id"});e.createIndex("conversation",["sender_username","recipient_username"],{unique:!1}),e.createIndex("recipient","recipient_username",{unique:!1}),e.createIndex("sender","sender_username",{unique:!1}),e.createIndex("created_at","created_at",{unique:!1})}t.objectStoreNames.contains("conversations")||t.createObjectStore("conversations",{keyPath:"username"}).createIndex("last_message_time","last_message_time",{unique:!1}),t.objectStoreNames.contains("contacts")||t.createObjectStore("contacts",{keyPath:"id"}).createIndex("contact_username","contact_username",{unique:!1}),t.objectStoreNames.contains("sync_metadata")||t.createObjectStore("sync_metadata",{keyPath:"key"})}})}async saveMessage(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["messages"],"readwrite").objectStore("messages").put(e);a.onerror=()=>s(a.error),a.onsuccess=()=>t()})}async saveMessages(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["messages"],"readwrite").objectStore("messages"),r=0,n=e.length;if(0===n){t();return}e.forEach(e=>{let i=a.put(e);i.onsuccess=()=>{++r===n&&t()},i.onerror=()=>s(i.error)})})}async getConversationMessages(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50;return this.db||await this.init(),new Promise((a,r)=>{let n=this.db.transaction(["messages"],"readonly").objectStore("messages"),i=[],l=n.openCursor();l.onsuccess=r=>{let n=r.target.result;if(n){let s=n.value;(s.sender_username===e&&s.recipient_username===t||s.sender_username===t&&s.recipient_username===e)&&i.push(s),n.continue()}else i.sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime()),a(i.slice(-s))},l.onerror=()=>r(l.error)})}async getAllMessages(){return this.db||await this.init(),new Promise((e,t)=>{let s=this.db.transaction(["messages"],"readonly").objectStore("messages").getAll();s.onerror=()=>t(s.error),s.onsuccess=()=>e(s.result)})}async saveConversation(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["conversations"],"readwrite").objectStore("conversations").put(e);a.onerror=()=>s(a.error),a.onsuccess=()=>t()})}async saveConversations(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["conversations"],"readwrite").objectStore("conversations"),r=0,n=e.length;if(0===n){t();return}e.forEach(e=>{let i=a.put(e);i.onsuccess=()=>{++r===n&&t()},i.onerror=()=>s(i.error)})})}async getAllConversations(){return this.db||await this.init(),new Promise((e,t)=>{let s=this.db.transaction(["conversations"],"readonly").objectStore("conversations").getAll();s.onerror=()=>t(s.error),s.onsuccess=()=>e(s.result)})}async saveContact(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["contacts"],"readwrite").objectStore("contacts").put(e);a.onerror=()=>s(a.error),a.onsuccess=()=>t()})}async saveContacts(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["contacts"],"readwrite").objectStore("contacts"),r=0,n=e.length;if(0===n){t();return}e.forEach(e=>{let i=a.put(e);i.onsuccess=()=>{++r===n&&t()},i.onerror=()=>s(i.error)})})}async getAllContacts(){return this.db||await this.init(),new Promise((e,t)=>{let s=this.db.transaction(["contacts"],"readonly").objectStore("contacts").getAll();s.onerror=()=>t(s.error),s.onsuccess=()=>e(s.result)})}async setSyncTimestamp(e,t){return this.db||await this.init(),new Promise((s,a)=>{let r=this.db.transaction(["sync_metadata"],"readwrite").objectStore("sync_metadata").put({key:e,timestamp:t});r.onerror=()=>a(r.error),r.onsuccess=()=>s()})}async getSyncTimestamp(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["sync_metadata"],"readonly").objectStore("sync_metadata").get(e);a.onerror=()=>s(a.error),a.onsuccess=()=>{let e=a.result;t(e?e.timestamp:null)}})}async clearAllData(){this.db||await this.init();let e=["messages","conversations","contacts","sync_metadata"];return new Promise((t,s)=>{let a=this.db.transaction(e,"readwrite"),r=0;e.forEach(n=>{let i=a.objectStore(n).clear();i.onsuccess=()=>{++r===e.length&&t()},i.onerror=()=>s(i.error)})})}async deleteConversation(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["conversations","messages"],"readwrite");a.objectStore("conversations").delete(e);let r=a.objectStore("messages").openCursor();r.onsuccess=s=>{let a=s.target.result;if(a){let t=a.value;(t.sender_username===e||t.recipient_username===e)&&a.delete(),a.continue()}else t()},r.onerror=()=>s(r.error)})}async deleteMessage(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["messages"],"readwrite").objectStore("messages").delete(e);a.onerror=()=>s(a.error),a.onsuccess=()=>t()})}async markMessageAsDeleted(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["messages"],"readwrite").objectStore("messages"),r=a.get(e);r.onsuccess=()=>{let e=r.result;if(e){e.encrypted_content=JSON.stringify({deleted:!0}),e.message_type="deleted",e.status="deleted";let r=a.put(e);r.onsuccess=()=>t(),r.onerror=()=>s(r.error)}else t()},r.onerror=()=>s(r.error)})}async clearConversationMessages(e,t){return this.db||await this.init(),new Promise((s,a)=>{let r=this.db.transaction(["messages"],"readwrite").objectStore("messages").openCursor();r.onsuccess=a=>{let r=a.target.result;if(r){let s=r.value;(s.sender_username===e&&s.recipient_username===t||s.sender_username===t&&s.recipient_username===e)&&r.delete(),r.continue()}else s()},r.onerror=()=>a(r.error)})}constructor(){this.db=null,this.dbName="ZeroTraceDB",this.version=1}}let _=new k;_.init().catch(console.error);var C=s(804);let S={bubbleColor:"#3B82F6",textColor:"#ffffff",style:"rounded",font:"inter",accentGradient:"linear-gradient(135deg, #3B82F6, #1D4ED8)",accentPrimary:"#3B82F6",accentSecondary:"#1D4ED8"},D="zerotrace_bubble_style",E="zerotrace_font_style";function M(){try{let e=localStorage.getItem(D);if(e&&["rounded","glass","neon"].includes(e))return e}catch(e){console.error("Failed to load bubble style:",e)}return"rounded"}function T(){try{let e=localStorage.getItem(E);if(e&&["inter","mono"].includes(e))return e}catch(e){console.error("Failed to load font style:",e)}return"inter"}let P=(0,n.Ue)()((0,i.tJ)((e,t)=>({user:null,token:null,isAuthenticated:!1,isLoading:!1,error:null,privateKey:null,publicKey:null,identityKey:null,identityPrivateKey:null,contacts:[],conversations:[],currentConversation:null,messages:new Map,onlineUsers:new Set,typingUsers:new Map,callHistory:[],login:async(s,a)=>{var r,n,i,l,c,d,m,h,p,y;e({isLoading:!0,error:null});try{let p=await o.login(s,a);u.setToken(p.access_token);let y=await o.getCurrentUser();if(y.settings)try{let e=localStorage.getItem("zerotrace_appearance"),t={...e?JSON.parse(e):{},...y.settings},s=JSON.stringify(t);localStorage.setItem("zerotrace_appearance",s),window.dispatchEvent(new StorageEvent("storage",{key:"zerotrace_appearance",newValue:s,storageArea:localStorage,url:window.location.href}))}catch(e){console.error("Failed to sync settings",e)}localStorage.setItem("zerotrace_token",p.access_token),localStorage.setItem("zerotrace_username",s);let v=w.load(s),j=!y.public_key;if(v&&y.public_key&&!w.verifyKeyConsistency(s,y.public_key)&&(console.warn("⚠️ Key mismatch detected! Local key differs from server key."),console.warn("This may happen if you logged in from a different device."),console.warn("Old messages encrypted with the server key may not decrypt correctly.")),!v){console.log("\uD83D\uDD10 Generating new key bundle...");let{bundle:e,privateKeys:t}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=g().sign.keyPair(),s=g().box.keyPair(),a=g().sign.detached(s.publicKey,t.secretKey),r=[],n=[];for(let t=0;t<e;t++){let e=g().box.keyPair();r.push((0,x.encodeBase64)(e.publicKey)),n.push((0,x.encodeBase64)(e.secretKey))}return{bundle:{publicKey:(0,x.encodeBase64)(s.publicKey),identityKey:(0,x.encodeBase64)(t.publicKey),signedPrekey:(0,x.encodeBase64)(s.publicKey),signedPrekeySignature:(0,x.encodeBase64)(a),oneTimePrekeys:r},privateKeys:{identityPrivate:(0,x.encodeBase64)(t.secretKey),signedPrekeyPrivate:(0,x.encodeBase64)(s.secretKey),oneTimePrekeyPrivates:n}}}(5);v={privateKey:t.signedPrekeyPrivate,publicKey:e.publicKey,identityKey:e.identityKey,signedPrekey:e.signedPrekey,signedPrekeySignature:e.signedPrekeySignature,identityPrivateKey:t.identityPrivate,oneTimePrekeys:e.oneTimePrekeys},w.save(s,v),j=!0,console.log("✅ Key bundle generated")}if(v.privateKey&&v.publicKey){let e=b(v.privateKey,v.publicKey);if(console.log("\uD83D\uDD11 Key pair verification:",e?"✅ VALID":"❌ INVALID"),!e){console.warn("⚠️ Key pair mismatch detected! Deriving correct public key...");let e=f(v.privateKey);console.log("\uD83D\uDD27 Original publicKey:",null===(l=v.publicKey)||void 0===l?void 0:l.substring(0,30)),console.log("\uD83D\uDD27 Derived publicKey:",null==e?void 0:e.substring(0,30)),v.publicKey=e,w.save(s,v),j=!0,console.log("✅ Key pair corrected and saved")}}if(j&&v){console.log("\uD83D\uDCE4 Uploading keys to server...",{publicKeyToUpload:null===(c=v.publicKey)||void 0===c?void 0:c.substring(0,30)});try{await o.uploadKeys({public_key:v.publicKey||"",identity_key:v.identityKey||"",signed_prekey:v.signedPrekey||v.publicKey||"",signed_prekey_signature:v.signedPrekeySignature||"",one_time_prekeys:v.oneTimePrekeys||[]}),y=await o.getCurrentUser(),console.log("✅ Keys uploaded successfully!",{serverNowHas:null===(d=y.public_key)||void 0===d?void 0:d.substring(0,30)})}catch(e){console.error("❌ Failed to upload keys:",(null==e?void 0:null===(m=e.response)||void 0===m?void 0:m.data)||e)}}let k=(null==v?void 0:v.publicKey)===y.public_key;if(console.log("\uD83D\uDD10 Final Key Status:",{username:s,localPubKey:null==v?void 0:null===(r=v.publicKey)||void 0===r?void 0:r.substring(0,30),serverPubKey:null===(n=y.public_key)||void 0===n?void 0:n.substring(0,30),localPrivKey:null==v?void 0:null===(i=v.privateKey)||void 0===i?void 0:i.substring(0,30),LOCAL_MATCHES_SERVER:k?"✅ YES":"❌ NO"}),!k&&(null==v?void 0:v.publicKey)&&y.public_key){console.error("\uD83D\uDEA8 CRITICAL: Local public key does not match server! This will cause decryption failures."),console.log("\uD83D\uDD27 Attempting to force upload correct key...");try{await o.uploadKeys({public_key:v.publicKey||"",identity_key:v.identityKey||"",signed_prekey:v.signedPrekey||v.publicKey||"",signed_prekey_signature:v.signedPrekeySignature||"",one_time_prekeys:v.oneTimePrekeys||[]}),y=await o.getCurrentUser(),console.log("✅ Force upload complete, server now has:",null===(h=y.public_key)||void 0===h?void 0:h.substring(0,30))}catch(e){console.error("❌ Force upload failed:",e)}}e({user:y,token:p.access_token,isAuthenticated:!0,isLoading:!1,privateKey:v.privateKey||null,publicKey:v.publicKey||null,identityKey:v.identityKey||null}),N.connect(y.id.toString(),p.access_token),window._wsHandlersRegistered||(F(t,e),window._wsHandlersRegistered=!0)}catch(t){throw e({isLoading:!1,error:(null===(y=t.response)||void 0===y?void 0:null===(p=y.data)||void 0===p?void 0:p.detail)||"Login failed"}),t}},register:async(s,a,r)=>{e({isLoading:!0,error:null});try{let e="web-".concat(Date.now(),"-").concat(Math.random().toString(36).slice(2));await o.register(s,a,r,e),await t().login(s,r)}catch(t){var n,i;throw e({isLoading:!1,error:(null===(i=t.response)||void 0===i?void 0:null===(n=i.data)||void 0===n?void 0:n.detail)||"Registration failed"}),t}},logout:()=>{N.disconnect(),window._wsHandlersRegistered=!1,localStorage.removeItem("zerotrace_token"),localStorage.removeItem("zerotrace_username"),o.setToken(null),u.setToken(null),e({user:null,token:null,isAuthenticated:!1,privateKey:null,publicKey:null,identityKey:null,identityPrivateKey:null,contacts:[],conversations:[],currentConversation:null,messages:new Map,onlineUsers:new Set,typingUsers:new Map,callHistory:[]})},initializeWebSocket:()=>{let{user:s,token:a}=t();if(s&&a){N.connect(s.id.toString(),a);let r=window;r._zerotraceWsHandlersRegistered||(F(t,e),r._zerotraceWsHandlersRegistered=!0,console.log("\uD83D\uDD0C WebSocket handlers registered"))}},loadStoredAuth:async()=>{let s=localStorage.getItem("zerotrace_token"),a=localStorage.getItem("zerotrace_username");if(s&&a){o.setToken(s),u.setToken(s);try{let r=await o.getCurrentUser();if(r.settings)try{let e=localStorage.getItem("cipherlink_appearance"),t={...e?JSON.parse(e):{},...r.settings},s=JSON.stringify(t);localStorage.setItem("cipherlink_appearance",s),window.dispatchEvent(new StorageEvent("storage",{key:"cipherlink_appearance",newValue:s,storageArea:localStorage,url:window.location.href}))}catch(e){console.error("Failed to sync settings",e)}let n=w.load(a);e({user:r,token:s,isAuthenticated:!0,privateKey:(null==n?void 0:n.privateKey)||null,publicKey:(null==n?void 0:n.publicKey)||null,identityKey:(null==n?void 0:n.identityKey)||null}),N.connect(r.id.toString(),s),window._wsHandlersRegistered||(F(t,e),window._wsHandlersRegistered=!0),await t().loadPersistedData(),t().syncWithServer().catch(console.error);return}catch(e){localStorage.removeItem("zerotrace_token"),localStorage.removeItem("zerotrace_username")}}},generateAndUploadKeys:async()=>{let{user:s}=t();if(!s)return;let a=function(){let e=g().box.keyPair();return{publicKey:(0,x.encodeBase64)(e.publicKey),privateKey:(0,x.encodeBase64)(e.secretKey)}}(),r=function(){let e=g().sign.keyPair();return{publicKey:(0,x.encodeBase64)(e.publicKey),privateKey:(0,x.encodeBase64)(e.secretKey)}}();w.save(s.username,{privateKey:a.privateKey,publicKey:a.publicKey,identityKey:r.publicKey}),await o.uploadKeys({public_key:a.publicKey,identity_key:r.publicKey,signed_prekey:a.publicKey,signed_prekey_signature:r.publicKey,one_time_prekeys:[]}),e({privateKey:a.privateKey,publicKey:a.publicKey,identityKey:r.publicKey})},loadStoredKeys:()=>{let{user:s}=t();if(!s)return;let a=w.load(s.username);a&&e({privateKey:a.privateKey,publicKey:a.publicKey,identityKey:a.identityKey})},loadContacts:async()=>{try{let t=(await u.getTrustedContacts()).map(e=>({id:e.id,user_id:e.user_id,contact_id:e.contact_user_id,contact_username:e.contact_username,contact_email:"",public_key:e.public_key,identity_key:e.identity_key,nickname:e.nickname,is_blocked:!1,is_verified:e.is_verified,added_at:e.created_at}));e({contacts:t}),console.log("✅ Loaded ".concat(t.length," trusted contacts"))}catch(t){console.error("Failed to load contacts:",t);try{let t=await o.getContacts();e({contacts:t})}catch(e){console.error("Fallback contacts load also failed:",e)}}},loadConversations:async()=>{try{let t=await o.getConversations();e({conversations:t})}catch(e){console.error("Failed to load conversations:",e)}},loadMessages:async s=>{try{let a=await o.getConversation(s);console.log("\uD83D\uDCE5 Loaded ".concat(a.length," messages from server for ").concat(s));let r=t().messages.get(s)||[],n=new Set(r.map(e=>e.id)),i=[];for(let e of a)n.has(e.id)||i.push(e);if(i.length>0){let a=[...r,...i];a.sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime());let n=new Map(t().messages);n.set(s,a),e({messages:n})}let{privateKey:l,contacts:c,user:d}=t();if(l){let e;try{e=(await o.getPublicKey(s)).public_key,console.log("\uD83D\uDCE5 Got public key for ".concat(s,":"),null==e?void 0:e.substring(0,30))}catch(a){console.warn("Could not fetch public key for ".concat(s,":"),a);let t=c.find(e=>e.contact_username===s);e=null==t?void 0:t.public_key}for(let t of a)if(t.encrypted_content&&!t._decryptedContent)try{let s;let a=JSON.parse(t.encrypted_content);t.sender_username,null==d||d.username,s=e;let r=p(a,s||"",l);t._decryptedContent=r}catch(e){console.warn("Failed to decrypt message:",t.id,e),t._decryptedContent="[Decryption Failed]"}}let u=[...r];for(let e of a){let t=u.findIndex(t=>t.id===e.id);t>=0?u[t]={...u[t],...e}:n.has(e.id)||u.push(e)}u.sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime());let m=new Map(t().messages);m.set(s,u),e({messages:m}),console.log("✅ Merged and decrypted messages for ".concat(s,": ").concat(u.length," total"))}catch(e){console.error("Failed to load messages:",e)}},sendMessage:async function(s,a){let r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text",i=arguments.length>3?arguments[3]:void 0;console.log("\uD83D\uDCE4 sendMessage called:",{recipientUsername:s,content:a.substring(0,50),messageType:n});let{privateKey:l,publicKey:c,user:d,contacts:u}=t();if(!l||!c||!d){console.error("Cannot send message: missing keys or user",{hasPrivateKey:!!l,hasPublicKey:!!c,hasUser:!!d});return}let m=u.some(e=>e.contact_username===s&&!e.is_blocked);if(!m){console.log("\uD83D\uDD04 Friend not found in local state, refreshing contacts from server..."),await t().loadContacts();let e=t().contacts;console.log("\uD83D\uDD04 After refresh - isFriend:",m=e.some(e=>e.contact_username===s&&!e.is_blocked),"contacts:",e.map(e=>e.contact_username))}if(!m)throw console.error("❌ Cannot send message: Not friends with",s),Error("You must be friends with this user to send messages. Send a friend request first.");b(l,c)||(console.warn("⚠️ Invalid key pair detected in sendMessage! Deriving correct public key..."),console.log("\uD83D\uDD27 Using derived publicKey:",null==(c=f(l))?void 0:c.substring(0,30)),e({publicKey:c})),console.log("\uD83D\uDCE4 Fetching public key from server for:",s);try{r=(await o.getPublicKey(s)).public_key,console.log("\uD83D\uDCE4 Got recipient public key from server:",null==r?void 0:r.substring(0,30))}catch(e){throw console.error("Failed to get recipient public key:",e),Error("Could not get recipient encryption key")}if(!r)throw Error("Recipient has not set up encryption");console.log("\uD83D\uDCE4 Encrypting with:",{recipientPubKey:null==r?void 0:r.substring(0,30),senderPrivKey:null==l?void 0:l.substring(0,30),senderPubKey:null==c?void 0:c.substring(0,30)});let h=JSON.stringify(function(e,t,s,a){console.log("\uD83D\uDD10 Encrypting message:",{recipientKeyPrefix:null==t?void 0:t.substring(0,20),senderPrivKeyPrefix:null==s?void 0:s.substring(0,20),senderPubKeyPrefix:null==a?void 0:a.substring(0,20),hasSenderPubKey:!!a});let r=g().randomBytes(g().box.nonceLength),n=(0,x.decodeUTF8)(e),i=(0,x.decodeBase64)(t),l=(0,x.decodeBase64)(s),c=g().box(n,r,i,l),o={ciphertext:(0,x.encodeBase64)(c),nonce:(0,x.encodeBase64)(r),senderPublicKey:a,version:"v2"};return console.log("✅ Encrypted with v2 protocol, embedded senderPublicKey:",!!a),o}(a,r,l,c)),p=function(){try{let e=localStorage.getItem("zerotrace_appearance"),t="blue";e&&(t=JSON.parse(e).accent||"blue");let s=M(),a=T();return function(e,t,s){let a=C.FN[e];return{bubbleColor:a.primary,textColor:"#ffffff",style:t||"rounded",font:s||"inter",accentGradient:"linear-gradient(135deg, ".concat(a.primary,", ").concat(a.secondary,")"),accentPrimary:a.primary,accentSecondary:a.secondary}}(t,s,a)}catch(e){return console.error("Failed to build current message theme:",e),S}}(),y=t().messages.get(s)||[],v=-Date.now(),w={id:v,sender_id:d.id,sender_username:d.username,recipient_id:0,recipient_username:s,encrypted_content:h,message_type:n,status:"sending",expiry_type:"none",created_at:new Date().toISOString(),_decryptedContent:a,sender_theme:p},j=new Map(t().messages);j.set(s,[...y,w]),e({messages:j});try{console.log("\uD83D\uDCE4 Sending to API...");let r=await o.sendMessage(s,h,void 0,"none",n,i,p);console.log("✅ Message sent successfully",r),r._decryptedContent=a;let l=new Map(t().messages),c=l.get(s)||[],d=c.findIndex(e=>e.id===v);-1!==d?c[d]=r:c.push(r),l.set(s,c),e({messages:l});try{await t().persistMessage(r)}catch(e){console.error("❌ Failed to persist sent message:",e)}let u=t(),m=u.conversations.findIndex(e=>e.username===s);if(m>=0){let s=[...u.conversations],i={...s[m],last_message_time:r.created_at,last_message_preview:"image"===n?"\uD83D\uDCF7 Image":a};s[m]=i,e({conversations:s});try{await t().persistConversation(i)}catch(e){console.error("❌ Failed to persist conversation after send:",e)}}}catch(i){console.error("Failed to send message:",i);let a=new Map(t().messages),r=a.get(s)||[],n=r.findIndex(e=>e.id===v);throw -1!==n&&(r[n].status="failed",a.set(s,r),e({messages:a})),i}},setCurrentConversation:s=>{if(e({currentConversation:s}),s){t().loadMessages(s);let a=t(),r=new Map(a.typingUsers);r.delete(s),e({typingUsers:r})}},addContact:async s=>{try{let a=await o.addContact(s),r=t();if(e({contacts:[...r.contacts,a]}),!r.conversations.find(e=>e.username===s)){let t={user_id:a.contact_id,username:a.contact_username,public_key:a.public_key,identity_key:a.identity_key,last_message_time:void 0,last_message_preview:void 0,unread_count:0,is_online:!1};e({conversations:[t,...r.conversations]})}}catch(e){throw console.error("Failed to add contact:",e),e}},searchUsers:async e=>{try{return await o.searchUsers(e)}catch(e){return console.error("Failed to search users:",e),[]}},addIncomingMessage:async s=>{let a=t(),r=s.sender_username,n=t().messages.get(r)||[];if(!n.some(e=>e.id===s.id)){let{privateKey:i,contacts:l}=t();if(i&&s.encrypted_content)try{let e=JSON.parse(s.encrypted_content),t="",a=l.find(e=>e.contact_username===s.sender_username);if(null==a?void 0:a.public_key)t=a.public_key;else if(!e.senderPublicKey)try{t=(await o.getPublicKey(s.sender_username)).public_key||"",console.log("\uD83D\uDCE5 Fetched sender public key for decryption:",null==t?void 0:t.substring(0,30))}catch(e){console.warn("Could not fetch sender public key:",e)}s._decryptedContent=p(e,t,i),s._decryptedContent?console.log("✅ Successfully decrypted incoming message"):console.warn("⚠️ Decryption returned null for message:",s.id)}catch(e){console.error("❌ Decryption failed for incoming:",e)}let c=new Map(t().messages);c.set(r,[...n,s]),e({messages:c});let d=a.conversations.findIndex(e=>e.username===r);if(d>=0){let r=[...a.conversations],n={...r[d],last_message_time:s.created_at,last_message_preview:s._decryptedContent?"image"===s.message_type?"\uD83D\uDCF7 Image":s._decryptedContent:"[Encrypted Message]",unread_count:(r[d].unread_count||0)+1};r[d]=n,e({conversations:r}),t().persistMessage(s).catch(e=>console.error("❌ Failed to persist incoming message:",e)),t().persistConversation(n).catch(e=>console.error("❌ Failed to persist conversation for incoming message:",e))}else{let n={user_id:s.sender_id,username:r,public_key:void 0,identity_key:void 0,last_message_time:s.created_at,last_message_preview:s._decryptedContent?"image"===s.message_type?"\uD83D\uDCF7 Image":s._decryptedContent:"[Encrypted Message]",unread_count:1,is_online:!1};e({conversations:[n,...a.conversations]}),t().persistMessage(s).catch(e=>console.error("❌ Failed to persist incoming message:",e)),t().persistConversation(n).catch(e=>console.error("❌ Failed to persist new conversation for incoming message:",e))}}},loadCallHistory:async()=>{try{let t=await o.getCallHistory();e({callHistory:t})}catch(e){console.error("Failed to load call history:",e)}},loadPendingRequests:async()=>{try{let e=await u.getPendingRequests();console.log("\uD83D\uDCCB Pending friend requests:",e)}catch(e){console.error("Failed to load pending requests:",e)}},setUserOnline:(s,a)=>{let r=t(),n=new Set(r.onlineUsers);a?n.add(s):n.delete(s),e({onlineUsers:n})},setUserTyping:(s,a)=>{let r=t(),n=new Map(r.typingUsers);a?n.set(s,!0):n.delete(s),e({typingUsers:n})},clearError:()=>e({error:null}),deleteMessageForMe:async(s,a)=>{try{let r=new Map(t().messages),n=(r.get(a)||[]).filter(e=>e.id!==s);r.set(a,n),e({messages:r}),await _.deleteMessage(s),console.log("\uD83D\uDDD1️ Message deleted locally:",s)}catch(e){console.error("Failed to delete message locally:",e)}},deleteMessageForEveryone:async(s,a)=>{try{let r=new Map(t().messages),n=(r.get(a)||[]).map(e=>e.id===s?{...e,_decryptedContent:null,encrypted_content:JSON.stringify({deleted:!0}),message_type:"deleted"}:e);r.set(a,n),e({messages:r}),await _.markMessageAsDeleted(s),N.sendDeleteMessage(s,a);try{await o.deleteMessage(s)}catch(e){console.warn("Could not delete message on server:",e)}console.log("\uD83D\uDDD1️ Message deleted for everyone:",s)}catch(e){console.error("Failed to delete message for everyone:",e)}},clearChat:async s=>{try{let{user:a}=t();if(!a)return;let r=new Map(t().messages);r.set(s,[]),e({messages:r}),await _.clearConversationMessages(s,a.username);let n=t().callHistory.filter(e=>e.caller_username!==s&&e.receiver_username!==s);e({callHistory:n});try{await o.deleteCallHistory(s)}catch(e){console.warn("Failed to delete call history on server:",e)}let i=[...t().conversations],l=i.findIndex(e=>e.username===s);l>=0&&(i[l]={...i[l],last_message_preview:void 0,last_message_time:void 0,unread_count:0},e({conversations:i})),console.log("\uD83E\uDDF9 Chat cleared locally:",s)}catch(e){console.error("Failed to clear chat:",e)}},deleteConversationForEveryone:async s=>{try{let{user:a}=t();if(!a)return;let r=new Map(t().messages);r.set(s,[]),e({messages:r});let n=[...t().conversations],i=n.findIndex(e=>e.username===s);i>=0&&(n[i]={...n[i],last_message_preview:"Chat cleared",last_message_time:new Date().toISOString(),unread_count:0},e({conversations:n})),await _.clearConversationMessages(s,a.username),N.sendDeleteConversation(s);try{await o.deleteConversation(s)}catch(e){console.warn("Could not delete conversation messages on server:",e)}console.log("\uD83D\uDDD1️ Conversation messages deleted for everyone:",s)}catch(e){console.error("Failed to delete conversation messages for everyone:",e)}},handleRemoteDeleteMessage:(s,a)=>{let r=new Map(t().messages),n=(r.get(a)||[]).map(e=>e.id===s?{...e,_decryptedContent:null,encrypted_content:JSON.stringify({deleted:!0}),message_type:"deleted"}:e);r.set(a,n),e({messages:r}),_.markMessageAsDeleted(s).catch(console.error),console.log("\uD83D\uDCE8 Remote message deletion received:",s)},handleRemoteDeleteConversation:s=>{let a=new Map(t().messages);a.set(s,[]),e({messages:a});let r=[...t().conversations],n=r.findIndex(e=>e.username===s);n>=0&&(r[n]={...r[n],last_message_preview:"Chat cleared",last_message_time:new Date().toISOString(),unread_count:0},e({conversations:r}));let i=t().user;i&&_.clearConversationMessages(s,i.username).catch(console.error),console.log("\uD83D\uDCE8 Remote conversation cleared:",s)},loadPersistedData:async()=>{try{console.log("\uD83D\uDCC2 Loading persisted data from IndexedDB...");let s=await _.getAllConversations();if(s.length>0){let t=s.map(e=>({user_id:e.user_id,username:e.username,public_key:e.public_key,identity_key:e.identity_key,last_message_time:e.last_message_time,last_message_preview:e.last_message_preview,unread_count:e.unread_count,is_online:e.is_online}));e({conversations:t}),console.log("\uD83D\uDCC2 Loaded ".concat(t.length," conversations from storage"))}let a=await _.getAllContacts();if(a.length>0){let t=a.map(e=>({id:e.id,user_id:e.user_id,contact_id:e.contact_id,contact_username:e.contact_username,contact_email:e.contact_email,public_key:e.public_key,identity_key:e.identity_key,nickname:e.nickname,is_blocked:e.is_blocked,is_verified:e.is_verified,added_at:e.added_at}));e({contacts:t}),console.log("\uD83D\uDCC2 Loaded ".concat(t.length," contacts from storage"))}let{user:r,privateKey:n,contacts:i}=t();if(r){let t=new Map;for(let e of s){let s=await _.getConversationMessages(e.username,r.username,50);if(s.length>0){let a=s.map(e=>({id:e.id,sender_id:e.sender_id,sender_username:e.sender_username,recipient_id:e.recipient_id,recipient_username:e.recipient_username,encrypted_content:e.encrypted_content,encrypted_key:e.encrypted_key,message_type:e.message_type,status:e.status,created_at:e.created_at,delivered_at:e.delivered_at,read_at:e.read_at,expiry_type:e.expiry_type,expires_at:e.expires_at,file_metadata:e.file_metadata}));if(n){let t=e.public_key;if(!t){let s=i.find(t=>t.contact_username===e.username);t=null==s?void 0:s.public_key}for(let e of a)if(e.encrypted_content&&!e._decryptedContent)try{let s=JSON.parse(e.encrypted_content),a=p(s,t||"",n);e._decryptedContent=a}catch(t){e._decryptedContent=null}}t.set(e.username,a)}}e({messages:t}),console.log("\uD83D\uDCC2 Loaded messages for ".concat(t.size," conversations"))}}catch(e){console.error("❌ Failed to load persisted data:",e)}},syncWithServer:async()=>{try{console.log("\uD83D\uDD04 Syncing with server..."),await t().loadContacts(),await t().loadConversations();let s=await o.getAllConversationsWithMessages(),{user:a,contacts:r,conversations:n,privateKey:i}=t();if(a){let t=n.map(e=>({username:e.username,user_id:e.user_id,public_key:e.public_key,identity_key:e.identity_key,last_message_time:e.last_message_time,last_message_preview:e.last_message_preview,unread_count:e.unread_count,is_online:e.is_online}));await _.saveConversations(t);let a=r.map(e=>({id:e.id,user_id:e.user_id,contact_id:e.contact_id,contact_username:e.contact_username,contact_email:e.contact_email,public_key:e.public_key,identity_key:e.identity_key,nickname:e.nickname,is_blocked:e.is_blocked,is_verified:e.is_verified,added_at:e.added_at}));for(let[e,t]of(await _.saveContacts(a),Object.entries(s))){let e=t.map(e=>({id:e.id,sender_id:e.sender_id,sender_username:e.sender_username,recipient_id:e.recipient_id,recipient_username:e.recipient_username,encrypted_content:e.encrypted_content,encrypted_key:e.encrypted_key,message_type:e.message_type,status:e.status,created_at:e.created_at,delivered_at:e.delivered_at,read_at:e.read_at,expiry_type:e.expiry_type,expires_at:e.expires_at,file_metadata:e.file_metadata}));await _.saveMessages(e)}let l=new Map;for(let[e,t]of Object.entries(s)){if(i){let s;try{s=(await o.getPublicKey(e)).public_key}catch(a){let t=r.find(t=>t.contact_username===e);s=null==t?void 0:t.public_key}for(let e of t)if(e.encrypted_content&&!e._decryptedContent)try{let t=JSON.parse(e.encrypted_content),a=p(t,s||"",i);e._decryptedContent=a}catch(t){console.warn("Failed to decrypt message during sync:",e.id,t),e._decryptedContent="[Decryption Failed]"}}l.set(e,t)}e({messages:l}),console.log("✅ Sync completed successfully")}}catch(e){console.error("❌ Sync failed:",e)}},persistMessage:async e=>{try{let t={id:e.id,sender_id:e.sender_id,sender_username:e.sender_username,recipient_id:e.recipient_id,recipient_username:e.recipient_username,encrypted_content:e.encrypted_content,encrypted_key:e.encrypted_key,message_type:e.message_type,status:e.status,created_at:e.created_at,delivered_at:e.delivered_at,read_at:e.read_at,expiry_type:e.expiry_type,expires_at:e.expires_at,file_metadata:e.file_metadata};await _.saveMessage(t)}catch(e){console.error("❌ Failed to persist message:",e)}},persistConversation:async e=>{try{let t={username:e.username,user_id:e.user_id,public_key:e.public_key,identity_key:e.identity_key,last_message_time:e.last_message_time,last_message_preview:e.last_message_preview,unread_count:e.unread_count,is_online:e.is_online};await _.saveConversation(t)}catch(e){console.error("❌ Failed to persist conversation:",e)}},loadAllConversationHistory:async()=>{try{let{conversations:e}=t();for(let s of(console.log("\uD83D\uDCDA Loading history for ".concat(e.length," conversations...")),e))await t().loadMessages(s.username),await new Promise(e=>setTimeout(e,100));console.log("✅ All conversation history loaded")}catch(e){console.error("❌ Failed to load conversation history:",e)}}}),{name:"zerotrace-store",partialize:e=>({currentConversation:e.currentConversation})}));function F(e,t){let s=new Set;N.on("message",t=>{var a,r;console.log("\uD83D\uDCE8 Received message via WebSocket:",t);let n=t.message_id;if(s.has(n)){console.log("⏩ Skipping duplicate message ".concat(n));return}if(s.add(n),s.size>1e3){let e=s.values().next().value;void 0!==e&&s.delete(e)}let i=e(),l=t.sender_username,c={id:n,sender_id:t.sender_id,sender_username:l,recipient_id:(null===(a=i.user)||void 0===a?void 0:a.id)||0,recipient_username:(null===(r=i.user)||void 0===r?void 0:r.username)||"",encrypted_content:t.content||t.encrypted_content,encrypted_key:t.encrypted_key,message_type:t.message_type||"text",status:"delivered",expiry_type:t.expiry_type||"none",sender_theme:t.sender_theme,created_at:t.timestamp||new Date().toISOString()};e().addIncomingMessage(c),N.sendDeliveryReceipt(n,t.sender_id)}),N.on("typing",t=>{e().setUserTyping(t.sender_username,t.is_typing),t.is_typing&&setTimeout(()=>{e().setUserTyping(t.sender_username,!1)},3e3)}),N.on("presence",t=>{e().setUserOnline(t.user_id,t.is_online)}),N.on("message_sent",e=>{console.log("✅ Message sent confirmation:",e)}),N.on("read_receipt",e=>{console.log("\uD83D\uDC41️ Read receipt:",e)}),N.on("delivery_receipt",e=>{console.log("\uD83D\uDCEC Delivery receipt:",e)}),N.on("connected",e=>{console.log("✅ WebSocket connected:",e)}),N.on("error",e=>{console.error("❌ WebSocket error:",e)}),N.on("delete_message_received",t=>{var s,a;console.log("\uD83D\uDDD1️ Remote delete message received:",t);let r=t.message_id||(null===(s=t.data)||void 0===s?void 0:s.message_id),n=t.sender_username||(null===(a=t.data)||void 0===a?void 0:a.sender_username);r&&n&&e().handleRemoteDeleteMessage(r,n)}),N.on("delete_conversation_received",t=>{var s;console.log("\uD83D\uDDD1️ Remote delete conversation received:",t);let a=t.sender_username||(null===(s=t.data)||void 0===s?void 0:s.sender_username);a&&e().handleRemoteDeleteConversation(a)}),N.on("friend_request",t=>{var s,a;console.log("\uD83D\uDCE8 New friend request received:",t),null===(s=(a=e()).loadPendingRequests)||void 0===s||s.call(a)}),N.on("friend_request_accepted",t=>{var s;console.log("✅ Friend request accepted:",t);let a=t.accepter_username||(null===(s=t.data)||void 0===s?void 0:s.accepter_username);console.log("\uD83C\uDF89 ".concat(a," accepted your friend request!")),e().loadContacts(),e().loadConversations()}),N.on("friend_request_rejected",t=>{var s,a;console.log("❌ Friend request rejected:",t),null===(s=(a=e()).loadPendingRequests)||void 0===s||s.call(a)})}var Z=s(5589),I=s(9036),K=s(774),R=s(2882),O=s(7972),A=s(1295),U=s(7216),L=s(9670);function q(){let[e,t]=(0,r.useState)(!0),[s,n]=(0,r.useState)(""),[i,l]=(0,r.useState)(""),[c,o]=(0,r.useState)(""),[d,u]=(0,r.useState)(!1),{login:m,register:h,isLoading:g,error:x,clearError:p}=P(),y=async t=>{t.preventDefault(),p();try{e?await m(s,c):await h(s,i,c)}catch(e){}};return(0,a.jsxs)("div",{className:"min-h-screen bg-cipher-darker flex",children:[(0,a.jsxs)("div",{className:"hidden lg:flex lg:w-1/2 bg-gradient-to-br from-cipher-dark to-cipher-darker p-12 flex-col justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center gap-3 mb-8",children:[(0,a.jsx)("div",{className:"w-12 h-12 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-xl flex items-center justify-center",children:(0,a.jsx)(Z.Z,{className:"w-6 h-6 text-white"})}),(0,a.jsx)("span",{className:"text-2xl font-bold gradient-text",children:"ZeroTrace"})]}),(0,a.jsxs)("h1",{className:"text-4xl font-bold text-white mb-4",children:["Private by design.",(0,a.jsx)("br",{}),(0,a.jsx)("span",{className:"text-cipher-primary",children:"Secure by default."})]}),(0,a.jsx)("p",{className:"text-gray-400 text-lg mb-12",children:"End-to-end encrypted communication where only you and your recipient can read messages. The server never sees your data."}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)(H,{icon:(0,a.jsx)(I.Z,{className:"w-5 h-5"}),title:"Zero-Knowledge Server",description:"We can't read your messages. Ever."}),(0,a.jsx)(H,{icon:(0,a.jsx)(K.Z,{className:"w-5 h-5"}),title:"Cryptographic Identity",description:"Your identity is based on math, not trust."}),(0,a.jsx)(H,{icon:(0,a.jsx)(R.Z,{className:"w-5 h-5"}),title:"Ephemeral Messages",description:"Messages that disappear after being read."})]})]}),(0,a.jsxs)("div",{className:"text-gray-500 text-sm",children:[(0,a.jsx)("p",{children:"Encryption: X25519 + AES-256-GCM"}),(0,a.jsx)("p",{children:"Protocol: Signal-style X3DH"})]})]}),(0,a.jsx)("div",{className:"w-full lg:w-1/2 flex items-center justify-center p-8",children:(0,a.jsxs)("div",{className:"w-full max-w-md",children:[(0,a.jsxs)("div",{className:"lg:hidden flex items-center gap-3 mb-8 justify-center",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-xl flex items-center justify-center",children:(0,a.jsx)(Z.Z,{className:"w-5 h-5 text-white"})}),(0,a.jsx)("span",{className:"text-xl font-bold gradient-text",children:"ZeroTrace"})]}),(0,a.jsxs)("div",{className:"glass rounded-2xl p-8",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-white mb-2",children:e?"Welcome back":"Create account"}),(0,a.jsx)("p",{className:"text-gray-400 mb-6",children:e?"Enter your credentials to access your encrypted messages":"Generate your cryptographic identity"}),x&&(0,a.jsx)("div",{className:"bg-red-500/10 border border-red-500/20 rounded-lg p-3 mb-4",children:(0,a.jsx)("p",{className:"text-red-400 text-sm",children:x})}),(0,a.jsxs)("form",{onSubmit:y,className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Username"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(O.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"}),(0,a.jsx)("input",{type:"text",value:s,onChange:e=>n(e.target.value),className:"w-full bg-cipher-dark border border-gray-700 rounded-lg py-3 pl-10 pr-4 text-white placeholder-gray-500 focus:border-cipher-primary transition-colors",placeholder:"Enter username",required:!0,minLength:3})]})]}),!e&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Email"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(A.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"}),(0,a.jsx)("input",{type:"email",value:i,onChange:e=>l(e.target.value),className:"w-full bg-cipher-dark border border-gray-700 rounded-lg py-3 pl-10 pr-4 text-white placeholder-gray-500 focus:border-cipher-primary transition-colors",placeholder:"Enter email",required:!e})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Password"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(Z.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"}),(0,a.jsx)("input",{type:d?"text":"password",value:c,onChange:e=>o(e.target.value),className:"w-full bg-cipher-dark border border-gray-700 rounded-lg py-3 pl-10 pr-12 text-white placeholder-gray-500 focus:border-cipher-primary transition-colors",placeholder:"Enter password",required:!0,minLength:8}),(0,a.jsx)("button",{type:"button",onClick:()=>u(!d),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-300",children:d?(0,a.jsx)(U.Z,{className:"w-5 h-5"}):(0,a.jsx)(L.Z,{className:"w-5 h-5"})})]})]}),(0,a.jsx)("button",{type:"submit",disabled:g,className:"w-full bg-gradient-to-r from-cipher-primary to-cipher-secondary text-white py-3 rounded-lg font-medium btn-primary disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:g?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),e?"Authenticating...":"Creating keys..."]}):(0,a.jsxs)(a.Fragment,{children:[e?"Sign In":"Create Account",(0,a.jsx)(Z.Z,{className:"w-4 h-4"})]})})]}),(0,a.jsx)("div",{className:"mt-6 text-center",children:(0,a.jsxs)("p",{className:"text-gray-400",children:[e?"Don't have an account?":"Already have an account?",(0,a.jsx)("button",{onClick:()=>{t(!e),p(),o("")},className:"text-cipher-primary hover:text-cipher-secondary ml-1 font-medium",children:e?"Sign up":"Sign in"})]})})]}),(0,a.jsxs)("div",{className:"mt-6 flex items-start gap-3 text-sm text-gray-500",children:[(0,a.jsx)(I.Z,{className:"w-5 h-5 flex-shrink-0 text-cipher-primary"}),(0,a.jsx)("p",{children:"Your private keys are generated locally and never leave your device. We use end-to-end encryption so only you can read your messages."})]})]})})]})}function H(e){let{icon:t,title:s,description:r}=e;return(0,a.jsxs)("div",{className:"flex items-start gap-4",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-cipher-primary/20 rounded-lg flex items-center justify-center text-cipher-primary flex-shrink-0",children:t}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-white font-medium",children:s}),(0,a.jsx)("p",{className:"text-gray-400 text-sm",children:r})]})]})}var z=s(7662),B=s(6307),W=s(6004);s(6397);let V={sm:"w-8 h-8 text-sm",md:"w-10 h-10 text-base",lg:"w-12 h-12 text-lg",xl:"w-24 h-24 text-4xl"};function Q(e){let{name:t,isOnline:s=!1,size:r="md",className:n="",disableTilt:i=!1}=e,{getAccentGradient:l}=(0,C.MU)(),c=l(),o=(0,a.jsx)("div",{className:"\n        ".concat(V[r],"\n        rounded-full flex items-center justify-center font-medium text-white\n        ").concat(n,"\n      "),style:{background:c},children:t.charAt(0).toUpperCase()});return i?(0,a.jsxs)("div",{className:"relative",children:[o,s&&(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-cipher-dark"})]}):(0,a.jsxs)(W.TiltAvatar,{maxTilt:20,scale:1.05,glare:!0,shadow:!0,className:"relative",children:[o,s&&(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-cipher-dark"})]})}var Y=s(9409),J=s(4527),G=s(5750),X=s(9348),$=s(9883),ee=s(4280),et=s(5883),es=s(1827),ea=s(2549),er=s(6264),en=s(6834),ei=s(8175),el=s(5626);let ec=r.memo(e=>{let{conv:t,isActive:s,isOnline:r,collapsed:n,accentGradient:i,formatTime:l,onClick:c}=e;return(0,a.jsxs)("button",{onClick:c,className:"\n        w-full rounded-lg flex items-center transition-all duration-200\n        ".concat(n?"justify-center p-2 ".concat(s?"bg-cipher-primary/30":"hover:bg-gray-800"):"p-3 gap-3 ".concat(s?"bg-cipher-primary/20 border border-cipher-primary/30":"hover:bg-gray-800"),"\n      "),title:n?t.username:void 0,children:[(0,a.jsxs)("div",{className:"relative flex-shrink-0",children:[(0,a.jsx)("div",{className:"".concat(n?"w-10 h-10":"w-12 h-12"," rounded-full flex items-center justify-center transition-colors ").concat(s?"":"bg-gray-700"),style:s?{background:i}:void 0,children:(0,a.jsx)("span",{className:"text-white font-medium ".concat(n?"text-sm":""),children:t.username.charAt(0).toUpperCase()})}),r&&(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 bg-green-500 rounded-full border-2 border-cipher-dark online-indicator ".concat(n?"w-3 h-3":"w-3.5 h-3.5")}),n&&t.unread_count>0&&(0,a.jsx)("span",{className:"absolute -top-1 -right-1 bg-cipher-primary text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center",children:t.unread_count>9?"9+":t.unread_count})]}),!n&&(0,a.jsxs)("div",{className:"flex-1 min-w-0 text-left",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"font-medium truncate ".concat(s?"text-white":"text-gray-200"),children:t.username}),(0,a.jsx)("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:l(t.last_message_time)})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1 text-sm text-gray-400 truncate",children:[(0,a.jsx)(I.Z,{className:"w-3 h-3 text-cipher-primary flex-shrink-0"}),(0,a.jsx)("span",{className:"truncate",children:t.last_message_preview||"Start conversation"})]}),t.unread_count>0&&(0,a.jsx)("span",{className:"bg-cipher-primary text-white text-xs px-2 py-0.5 rounded-full flex-shrink-0 ml-2",children:t.unread_count})]})]})]})});function eo(e){let{collapsed:t=!1,onToggleCollapse:s,onNewChat:n,onSettings:i,onAddFriend:l,onPendingRequests:c,onBlockedUsers:o}=e,{user:d,conversations:m,currentConversation:h,setCurrentConversation:g,logout:x,onlineUsers:p,searchUsers:y,addContact:b,loadContacts:f,loadConversations:v,contacts:w}=P(),{getAccentGradient:j,settings:N}=(0,C.MU)(),k=j(),[_,S]=(0,r.useState)(""),[D,E]=(0,r.useState)(!1),[M,T]=(0,r.useState)([]),[F,I]=(0,r.useState)(!1),[K,O]=(0,r.useState)(null),[A,U]=(0,r.useState)(0),[L,q]=(0,r.useState)(!1),H=(0,r.useCallback)(async()=>{try{var e;let t=await u.getPendingRequests();U((null===(e=t.incoming)||void 0===e?void 0:e.length)||0)}catch(e){console.error("Failed to fetch pending requests:",e)}},[]),W=(0,r.useCallback)(async()=>{q(!0);try{await f(),await v(),await H()}catch(e){console.error("Failed to refresh contacts:",e)}finally{q(!1)}},[f,v,H]);(0,r.useEffect)(()=>{let e=()=>{console.log("Contacts sync event received"),W()},t=()=>{H()},s=()=>{W()};return window.addEventListener("contacts_sync",e),window.addEventListener("friend_request",t),window.addEventListener("friend_accepted",t),window.addEventListener("contact_removed",s),window.addEventListener("blocked",s),()=>{window.removeEventListener("contacts_sync",e),window.removeEventListener("friend_request",t),window.removeEventListener("friend_accepted",t),window.removeEventListener("contact_removed",s),window.removeEventListener("blocked",s)}},[W,H]),(0,r.useEffect)(()=>{H();let e=setInterval(()=>{H()},3e4);return()=>clearInterval(e)},[H]);let V=(0,r.useMemo)(()=>{if(!_.trim())return m;let e=_.toLowerCase();return m.filter(t=>t.username.toLowerCase().includes(e))},[m,_]),eo=(0,r.useCallback)(e=>p.has(e),[p]),ed=async e=>{if(S(e),e.trim().length>=2){E(!0),I(!0);try{let t=(await y(e.trim())).filter(e=>e.username!==(null==d?void 0:d.username));T(t)}catch(e){console.error("Search failed:",e),T([])}finally{E(!1)}}else T([]),I(!1)},eu=async e=>{O(e.id);try{m.find(t=>t.username===e.username)||(w.find(t=>t.contact_username===e.username)||(await b(e.username),await f()),await v()),g(e.username),S(""),T([]),I(!1)}catch(e){console.error("Failed to start chat:",e)}finally{O(null)}},em=(0,r.useCallback)(e=>{if(!e)return"";let t=new Date(e);return(0,en.z)(t)?(0,ei.WU)(t,"HH:mm"):(0,el.g)(t)?"Yesterday":(0,ei.WU)(t,"dd/MM")},[]);return(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-800 ".concat(t?"p-2":""),children:[(0,a.jsxs)("div",{className:"flex items-center ".concat(t?"justify-center":"justify-between"," mb-3"),children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center",style:{background:k},children:(0,a.jsx)(Z.Z,{className:"w-4 h-4 text-white"})}),!t&&(0,a.jsx)("span",{className:"font-bold text-white dark:text-white",children:"ZeroTrace"})]}),!t&&(0,a.jsx)("div",{className:"flex items-center gap-1",children:(0,a.jsx)("button",{onClick:i,className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Settings",children:(0,a.jsx)(Y.Z,{className:"w-5 h-5"})})})]}),(0,a.jsxs)("div",{className:"".concat(t?"flex flex-col gap-2":"flex items-center justify-between"," bg-gray-800/30 rounded-lg p-1 mb-3"),children:[(0,a.jsxs)("button",{onClick:l,className:"".concat(t?"p-3":"flex-1 p-2"," flex flex-col items-center gap-1 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-green-400 transition-colors"),title:"Add Friend",children:[(0,a.jsx)(J.Z,{className:"w-4 h-4"}),!t&&(0,a.jsx)("span",{className:"text-[10px]",children:"Add"})]}),(0,a.jsxs)("button",{onClick:c,className:"".concat(t?"p-3":"flex-1 p-2"," flex flex-col items-center gap-1 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-yellow-400 transition-colors relative"),title:"Pending Requests",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(G.Z,{className:"w-4 h-4"}),A>0&&(0,a.jsx)("span",{className:"absolute -top-2 -right-2 w-4 h-4 bg-yellow-500 text-black text-[9px] rounded-full flex items-center justify-center font-bold ".concat(t?"w-3 h-3 text-[8px]":""),children:A>9?"9+":A})]}),!t&&(0,a.jsx)("span",{className:"text-[10px]",children:"Requests"})]}),!t&&o&&(0,a.jsxs)("button",{onClick:o,className:"flex-1 flex flex-col items-center gap-1 p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-red-400 transition-colors",title:"Blocked Users",children:[(0,a.jsx)(X.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"text-[10px]",children:"Blocked"})]}),(0,a.jsxs)("button",{onClick:n,className:"".concat(t?"p-3":"flex-1 p-2"," flex flex-col items-center gap-1 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-cyan-400 transition-colors"),title:"New Chat",children:[(0,a.jsx)($.Z,{className:"w-4 h-4"}),!t&&(0,a.jsx)("span",{className:"text-[10px]",children:"New"})]}),!t&&(0,a.jsxs)("button",{onClick:W,disabled:L,className:"flex-1 flex flex-col items-center gap-1 p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-blue-400 transition-colors disabled:opacity-50",title:"Refresh",children:[(0,a.jsx)(ee.Z,{className:"w-4 h-4 ".concat(L?"animate-spin":"")}),(0,a.jsx)("span",{className:"text-[10px]",children:"Refresh"})]})]}),(0,a.jsxs)("div",{className:"flex items-center ".concat(t?"justify-center":"gap-3"," p-2 bg-cipher-darker/50 dark:bg-gray-800/50 rounded-lg"),children:[(0,a.jsx)(Q,{name:(null==d?void 0:d.username)||"U",size:t?"sm":"md",disableTilt:!0}),!t&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("p",{className:"font-medium text-white truncate",children:null==d?void 0:d.username}),(0,a.jsx)("p",{className:"text-xs text-gray-500 truncate",children:null==d?void 0:d.email})]}),(0,a.jsx)("button",{onClick:x,className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-red-400 transition-colors",title:"Logout",children:(0,a.jsx)(et.Z,{className:"w-4 h-4"})})]})]})]}),!t&&(0,a.jsxs)("div",{className:"p-4",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(es.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"}),(0,a.jsx)("input",{type:"text",placeholder:"Search users or conversations...",value:_,onChange:e=>ed(e.target.value),className:"w-full bg-cipher-darker border border-gray-700 rounded-lg py-2 pl-10 pr-10 text-sm text-white placeholder-gray-500 focus:border-cipher-primary transition-colors"}),_&&(0,a.jsx)("button",{onClick:()=>{S(""),T([]),I(!1)},className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white transition-colors",children:(0,a.jsx)(ea.Z,{className:"w-4 h-4"})}),D&&(0,a.jsx)(er.Z,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-cipher-primary animate-spin"})]}),(0,a.jsx)(B.M,{children:F&&M.length>0&&(0,a.jsxs)(z.E.div,{className:"mt-2 bg-cipher-darker border border-gray-700 rounded-lg overflow-hidden",initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},children:[(0,a.jsx)("div",{className:"px-3 py-2 border-b border-gray-700 bg-gray-800/50",children:(0,a.jsx)("p",{className:"text-xs text-gray-400 font-medium",children:"Users Found"})}),(0,a.jsx)("div",{className:"max-h-48 overflow-y-auto",children:M.map((e,t)=>{let s=m.find(t=>t.username===e.username),r=K===e.id;return(0,a.jsxs)(z.E.button,{onClick:()=>eu(e),disabled:r,className:"w-full p-3 flex items-center gap-3 hover:bg-gray-800 transition-colors border-b border-gray-700/50 last:border-0",initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.05*t},children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:k},children:(0,a.jsx)("span",{className:"text-white font-medium text-sm",children:e.username[0].toUpperCase()})}),e.is_online&&(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-cipher-darker"})]}),(0,a.jsxs)("div",{className:"flex-1 text-left min-w-0",children:[(0,a.jsx)("p",{className:"text-white font-medium truncate text-sm",children:e.username}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:s?"Open chat":"Start new chat"})]}),r?(0,a.jsx)(er.Z,{className:"w-5 h-5 text-cipher-primary animate-spin"}):s?(0,a.jsx)(R.Z,{className:"w-5 h-5 text-cipher-primary"}):(0,a.jsx)(J.Z,{className:"w-5 h-5 text-green-500"})]},e.id)})})]})}),(0,a.jsx)(B.M,{children:F&&!D&&_.length>=2&&0===M.length&&(0,a.jsxs)(z.E.div,{className:"mt-2 p-4 bg-cipher-darker border border-gray-700 rounded-lg text-center",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:[(0,a.jsxs)("p",{className:"text-sm text-gray-400",children:['No users found for "',_,'"']}),(0,a.jsx)("button",{onClick:n,className:"mt-2 text-xs text-cipher-primary hover:underline",children:"Try advanced search"})]})})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===V.length&&0===m.length?(0,a.jsxs)("div",{className:"p-8 text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(R.Z,{className:"w-8 h-8 text-gray-600"})}),(0,a.jsx)("p",{className:"text-gray-400 text-sm",children:"No conversations yet"}),(0,a.jsx)("button",{onClick:n,className:"mt-3 text-cipher-primary hover:text-cipher-secondary text-sm font-medium",children:"Start a new chat"})]}):0===V.length&&_?(0,a.jsx)("div",{className:"p-4 text-center",children:(0,a.jsxs)("p",{className:"text-gray-400 text-sm",children:['No conversations match "',_,'"']})}):(0,a.jsx)("div",{className:"space-y-1 ".concat(t?"p-1":"p-2"),children:V.map(e=>(0,a.jsx)(ec,{conv:e,isActive:h===e.username,isOnline:eo(e.user_id),collapsed:t,accentGradient:k,formatTime:em,onClick:()=>g(e.username)},e.user_id))})}),(0,a.jsx)("div",{className:"p-4 border-t border-gray-800 ".concat(t?"p-2":""),children:t?(0,a.jsx)("div",{className:"flex justify-center",children:(0,a.jsx)(Z.Z,{className:"w-4 h-4 text-cipher-primary"})}):(0,a.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[(0,a.jsx)(Z.Z,{className:"w-3 h-3 text-cipher-primary"}),(0,a.jsx)("span",{children:"End-to-end encrypted"})]})})]})}ec.displayName="ConversationItem";let ed={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"}]};class eu{setOnStateChange(e){this.onStateChange=e}setOnLocalStream(e){this.onLocalStream=e}setOnRemoteStream(e){this.onRemoteStream=e}setOnError(e){this.onError=e}setupWebSocketHandlers(){N.on("call_offer",e=>{var t,s,a,r;console.log("\uD83D\uDCDE Received call_offer:",e);let n=e.call_id||(null===(t=e.data)||void 0===t?void 0:t.call_id),i=e.call_type||(null===(s=e.data)||void 0===s?void 0:s.call_type)||"audio",l=e.caller_username||(null===(a=e.data)||void 0===a?void 0:a.caller_username),c=e.sdp||(null===(r=e.data)||void 0===r?void 0:r.sdp);if(!n||!l||!c){console.error("❌ Invalid call_offer:",{callId:n,callerUsername:l,hasSdp:!!c});return}this.pendingOffer={sdp:c,callId:n,callerUsername:l,type:i},this.currentCall={callId:n,type:i,status:"ringing",remoteUsername:l,isIncoming:!0,isMuted:!1,isVideoOff:!1},this.notifyStateChange(),console.log("\uD83D\uDCDE Call state: RINGING")}),N.on("call_answer",async e=>{var t;if(console.log("✅ Received call_answer:",e),!this.pc||!this.currentCall){console.error("❌ No peer connection or call");return}let s=e.sdp||(null===(t=e.data)||void 0===t?void 0:t.sdp);if(!s){console.error("❌ No SDP in answer");return}try{console.log("\uD83D\uDCDE Setting remote description (answer)..."),await this.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:s})),console.log("✅ Remote description set"),await this.processIceQueue(),this.currentCall.status="connecting",this.notifyStateChange(),console.log("\uD83D\uDCDE Call state: CONNECTING")}catch(e){console.error("❌ Error handling answer:",e),this.failCall("Failed to process answer")}}),N.on("ice_candidate",async e=>{var t;let s=e.candidate||(null===(t=e.data)||void 0===t?void 0:t.candidate);if(!s){console.log("⚠️ Empty ICE candidate");return}if(console.log("\uD83E\uDDCA Received ICE candidate"),this.pc&&this.pc.remoteDescription)try{await this.pc.addIceCandidate(new RTCIceCandidate(s)),console.log("✅ ICE candidate added")}catch(e){console.error("❌ Error adding ICE candidate:",e)}else console.log("⏳ Queuing ICE candidate"),this.iceQueue.push(s)}),N.on("call_rejected",e=>{console.log("❌ Call rejected:",e),this.currentCall&&(this.currentCall.status="rejected",this.notifyStateChange(),setTimeout(()=>this.cleanup(),3e3))}),N.on("call_ended",e=>{console.log("\uD83D\uDCF4 Call ended by remote:",e),this.currentCall&&(this.currentCall.status="ended",this.notifyStateChange(),this.cleanup())}),N.on("call_failed",e=>{console.error("\uD83D\uDCA5 Call failed:",e),this.failCall(e.reason||"Call failed")})}async getMedia(e){console.log("\uD83D\uDCF9 Getting media for ".concat(e," call..."));try{let t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:48e3,channelCount:2},video:"video"===e&&{width:{ideal:1280,min:640},height:{ideal:720,min:480},facingMode:"user",frameRate:{ideal:30,min:15}}});return console.log("✅ Media acquired:",t.getTracks().map(e=>"".concat(e.kind,"(").concat(e.label,")")).join(", ")),t}catch(e){throw console.error("❌ Media error:",e.name,e.message),this.normalizeMediaError(e)}}normalizeMediaError(e){return Error({NotAllowedError:"Camera/microphone permission denied. Please allow access in browser settings.",NotFoundError:"No camera or microphone found. Please connect a device.",NotReadableError:"Camera/microphone is in use by another app. Please close other apps.",OverconstrainedError:"Camera does not support the requested resolution.",SecurityError:"Camera/microphone access blocked. Please use HTTPS or localhost.",AbortError:"Permission request was aborted. Please try again."}[e.name]||"Media error: ".concat(e.message))}createPeerConnection(){console.log("\uD83D\uDD27 Creating RTCPeerConnection...");let e=new RTCPeerConnection({iceServers:this.config.iceServers,iceCandidatePoolSize:10,iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});return e.ontrack=e=>{console.log("\uD83C\uDFA5 Track received:",e.track.kind);let[t]=e.streams;if(t){var s;this.remoteStream=t,console.log("✅ Remote stream set, tracks:",t.getTracks().length),null===(s=this.onRemoteStream)||void 0===s||s.call(this,t),this.currentCall&&(this.currentCall.remoteStream=t,this.notifyStateChange()),e.track.onended=()=>{console.log("\uD83D\uDCF4 Track ended:",e.track.kind)},e.track.onmute=()=>{console.log("\uD83D\uDD07 Track muted:",e.track.kind)},e.track.onunmute=()=>{console.log("\uD83D\uDD0A Track unmuted:",e.track.kind)}}},e.onicecandidate=e=>{e.candidate&&this.currentCall&&(console.log("\uD83E\uDDCA Sending ICE candidate"),N.send({type:"ice_candidate",data:{call_id:this.currentCall.callId,candidate:e.candidate.toJSON()},timestamp:new Date().toISOString()}))},e.onconnectionstatechange=()=>{this.handleConnectionStateChange(e.connectionState)},e.oniceconnectionstatechange=()=>{console.log("\uD83E\uDDCA ICE state:",e.iceConnectionState)},e.onsignalingstatechange=()=>{console.log("\uD83D\uDCF6 Signaling state:",e.signalingState)},e}handleConnectionStateChange(e){if(console.log("\uD83D\uDD04 Connection state:",e),this.currentCall)switch(e){case"connected":this.clearConnectionTimeout(),"connected"!==this.currentCall.status&&(this.currentCall.status="connected",this.currentCall.startTime=new Date,this.notifyStateChange(),console.log("✅ CALL CONNECTED!"),this.startMonitoring());break;case"failed":console.error("❌ Connection failed"),this.failCall("Connection failed");break;case"disconnected":console.warn("⚠️ Connection disconnected - will attempt recovery..."),setTimeout(()=>{var e;(null===(e=this.pc)||void 0===e?void 0:e.connectionState)==="disconnected"&&(console.error("❌ Connection did not recover"),this.failCall("Connection lost"))},5e3);break;case"closed":console.log("\uD83D\uDCF4 Connection closed")}}async processIceQueue(){if(this.pc){for(let e of(console.log("\uD83D\uDCE4 Processing ".concat(this.iceQueue.length," queued ICE candidates")),this.iceQueue))try{await this.pc.addIceCandidate(new RTCIceCandidate(e)),console.log("✅ Queued ICE candidate added")}catch(e){console.error("❌ Error adding queued ICE candidate:",e)}this.iceQueue=[]}}async startCall(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"audio";if(console.log("\uD83D\uDCDE Starting ".concat(t," call to ").concat(e)),this.currentCall)return console.error("❌ Already in a call"),!1;try{var s;this.localStream=await this.getMedia(t),null===(s=this.onLocalStream)||void 0===s||s.call(this,this.localStream);let a="".concat(Date.now(),"-").concat(Math.random().toString(36).slice(2,9));this.currentCall={callId:a,type:t,status:"calling",remoteUsername:e,isIncoming:!1,isMuted:!1,isVideoOff:!1,localStream:this.localStream},this.notifyStateChange(),this.pc=this.createPeerConnection(),this.localStream.getTracks().forEach(e=>{this.pc&&this.localStream&&(this.pc.addTrack(e,this.localStream),console.log("✅ Added ".concat(e.kind," track")))});let r=await this.pc.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:"video"===t});return await this.pc.setLocalDescription(r),console.log("✅ Offer created and set"),N.send({type:"call_offer",data:{call_id:a,recipient_username:e,call_type:t,sdp:r.sdp},timestamp:new Date().toISOString()}),this.startConnectionTimeout(),!0}catch(e){return console.error("❌ Failed to start call:",e),this.failCall(e.message),!1}}async answerCall(){if(console.log("\uD83D\uDCDE Answering call..."),!this.currentCall||!this.pendingOffer)return console.error("❌ No call to answer"),!1;if("ringing"!==this.currentCall.status)return console.error("❌ Call not in ringing state:",this.currentCall.status),!1;try{var e;let{sdp:t,callId:s}=this.pendingOffer,a=this.currentCall.type;this.localStream=await this.getMedia(a),null===(e=this.onLocalStream)||void 0===e||e.call(this,this.localStream),this.currentCall.localStream=this.localStream,this.notifyStateChange(),this.pc=this.createPeerConnection(),this.localStream.getTracks().forEach(e=>{this.pc&&this.localStream&&(this.pc.addTrack(e,this.localStream),console.log("✅ Added ".concat(e.kind," track")))}),console.log("\uD83D\uDCDE Setting remote description (offer)..."),await this.pc.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:t})),console.log("✅ Remote description set"),await this.processIceQueue(),console.log("\uD83D\uDCDE Creating answer...");let r=await this.pc.createAnswer();return await this.pc.setLocalDescription(r),console.log("✅ Answer created and set"),this.currentCall.status="connecting",this.notifyStateChange(),console.log("\uD83D\uDCDE Call state: CONNECTING"),N.send({type:"call_answer",data:{call_id:s,sdp:r.sdp},timestamp:new Date().toISOString()}),this.startConnectionTimeout(),!0}catch(e){return console.error("❌ Failed to answer call:",e),this.failCall(e.message),!1}}rejectCall(){console.log("❌ Rejecting call"),this.currentCall&&(N.send({type:"call_reject",data:{call_id:this.currentCall.callId,reason:"rejected"},timestamp:new Date().toISOString()}),this.cleanup())}endCall(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];console.log("\uD83D\uDCF4 Ending call"),this.currentCall&&(e&&N.send({type:"call_end",data:{call_id:this.currentCall.callId},timestamp:new Date().toISOString()}),this.cleanup())}toggleMute(){if(!this.localStream)return!1;let e=this.localStream.getAudioTracks()[0];if(!e)return!1;e.enabled=!e.enabled;let t=!e.enabled;return this.currentCall&&(this.currentCall.isMuted=t,this.notifyStateChange()),console.log("\uD83C\uDFA4 Muted: ".concat(t)),t}toggleVideo(){if(!this.localStream)return!1;let e=this.localStream.getVideoTracks()[0];if(!e)return!1;e.enabled=!e.enabled;let t=!e.enabled;return this.currentCall&&(this.currentCall.isVideoOff=t,this.notifyStateChange()),console.log("\uD83D\uDCF9 Video off: ".concat(t)),t}async replaceVideoTrack(e){if(!this.pc)return!1;let t=this.pc.getSenders().find(e=>{var t;return(null===(t=e.track)||void 0===t?void 0:t.kind)==="video"});if(!t)return!1;try{if(await t.replaceTrack(e),this.localStream){var s;let t=this.localStream.getVideoTracks()[0];t&&(this.localStream.removeTrack(t),t.stop()),this.localStream.addTrack(e),null===(s=this.onLocalStream)||void 0===s||s.call(this,this.localStream)}return!0}catch(e){return console.error("❌ Failed to replace video track:",e),!1}}async switchCamera(){if(!this.localStream)return!1;let e=this.localStream.getVideoTracks()[0];if(!e)return!1;let t=e.getSettings().facingMode||"user",s="user"===t?"environment":"user";console.log("\uD83D\uDD04 Switching camera from ".concat(t," to ").concat(s));try{let e=(await navigator.mediaDevices.getUserMedia({video:{facingMode:s},audio:!1})).getVideoTracks()[0];if(!e)return console.error("❌ No video track in new stream"),!1;let t=await this.replaceVideoTrack(e);return t&&console.log("✅ Camera switched successfully"),t}catch(e){return console.error("❌ Failed to switch camera:",e),!1}}notifyStateChange(){if(this.currentCall&&this.onStateChange){let e={...this.currentCall,localStream:this.localStream||void 0,remoteStream:this.remoteStream||void 0};this.onStateChange(e)}}failCall(e){if(console.error("\uD83D\uDCA5 Call failed:",e),this.currentCall){var t;this.currentCall.status="failed",this.currentCall.errorMessage=e,this.notifyStateChange(),null===(t=this.onError)||void 0===t||t.call(this,e)}this.cleanup()}startConnectionTimeout(){this.clearConnectionTimeout(),this.connectionTimeout=setTimeout(()=>{var e;(null===(e=this.currentCall)||void 0===e?void 0:e.status)!=="connected"&&(console.error("❌ Connection timeout"),this.failCall("Connection timed out - please check your network"))},15e3)}clearConnectionTimeout(){this.connectionTimeout&&(clearTimeout(this.connectionTimeout),this.connectionTimeout=null)}startMonitoring(){this.stopMonitoring(),this.monitorInterval=setInterval(()=>{if(!this.pc||!this.currentCall){this.stopMonitoring();return}let e=this.pc.connectionState;("failed"===e||"closed"===e)&&(console.error("❌ Connection unhealthy"),this.failCall("Connection lost"),this.stopMonitoring())},2e3),this.pingInterval=setInterval(()=>{var e;(null===(e=this.currentCall)||void 0===e?void 0:e.status)==="connected"&&N.send({type:"ping",timestamp:new Date().toISOString()})},1e4)}stopMonitoring(){this.monitorInterval&&(clearInterval(this.monitorInterval),this.monitorInterval=null),this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null)}cleanup(){if(console.log("\uD83E\uDDF9 Cleaning up..."),this.clearConnectionTimeout(),this.stopMonitoring(),this.localStream&&(this.localStream.getTracks().forEach(e=>{e.stop(),console.log("\uD83D\uDCF4 Stopped ".concat(e.kind," track"))}),this.localStream=null),this.remoteStream&&(this.remoteStream.getTracks().forEach(e=>e.stop()),this.remoteStream=null),this.pc&&(this.pc.close(),this.pc=null),this.pendingOffer=null,this.iceQueue=[],this.currentCall){var e;let t={...this.currentCall};this.currentCall=null,"failed"!==t.status&&"rejected"!==t.status&&(t.status="ended"),null===(e=this.onStateChange)||void 0===e||e.call(this,t)}console.log("\uD83E\uDDF9 Cleanup complete")}getCurrentCall(){return this.currentCall?{...this.currentCall}:null}isInCall(){return null!==this.currentCall&&["calling","ringing","connecting","connected"].includes(this.currentCall.status)}async checkPermissions(e){let t={audio:!1,video:!1};try{if("permissions"in navigator)try{let s=await navigator.permissions.query({name:"microphone"});if(t.audio="granted"===s.state,"video"===e){let e=await navigator.permissions.query({name:"camera"});t.video="granted"===e.state}}catch(e){}if(!t.audio||"video"===e&&!t.video)try{(await navigator.mediaDevices.getUserMedia({audio:!t.audio,video:"video"===e&&!t.video})).getTracks().forEach(e=>e.stop()),t.audio=!0,"video"===e&&(t.video=!0)}catch(e){}}catch(e){console.error("Error checking permissions:",e)}return t}constructor(e=ed){this.pc=null,this.localStream=null,this.remoteStream=null,this.currentCall=null,this.onStateChange=null,this.onLocalStream=null,this.onRemoteStream=null,this.onError=null,this.iceQueue=[],this.connectionTimeout=null,this.monitorInterval=null,this.pingInterval=null,this.pendingOffer=null,this.config=e,this.setupWebSocketHandlers(),console.log("\uD83D\uDD27 WebRTC Service initialized")}}let em=new eu;var eh=s(7803),eg=s(4698),ex=s(1243),ep=s(1841),ey=s(5099),eb=s(5671),ef=s(8339),ev=s(2741),ew=s(4043),ej=s(9292),eN=s(612),ek=s(2030);function e_(e){let{callState:t,callDuration:s,isMuted:n,isVideoOff:i,isScreenSharing:l,isFullscreen:c,localStream:o,remoteStream:d,onToggleMute:u,onToggleVideo:m,onToggleScreenShare:h,onToggleFullscreen:g,onSwitchCamera:x,onEndCall:p,onRejectCall:y,onAnswerCall:b}=e,{getAccentGradient:f}=(0,C.MU)(),v=f(),w=(0,r.useRef)(null),j=(0,r.useRef)(null),N=(0,r.useRef)(null),[k,_]=(0,r.useState)({x:window.innerWidth-200,y:100}),[S,D]=(0,r.useState)(!0),[E,M]=(0,r.useState)(!1),[T,P]=(0,r.useState)(!0),F=(0,r.useRef)(null),{position:Z,isDragging:I,handleMouseDown:K}=function(e){let[t,s]=(0,r.useState)(e),[a,n]=(0,r.useState)(!1),i=(0,r.useRef)({x:0,y:0}),l=(0,r.useRef)({x:0,y:0}),c=(0,r.useCallback)(e=>{let s="touches"in e?e.touches[0].clientX:e.clientX,a="touches"in e?e.touches[0].clientY:e.clientY;n(!0),i.current={x:s,y:a},l.current={...t}},[t]),o=(0,r.useCallback)(e=>{if(!a)return;let t="touches"in e?e.touches[0].clientX:e.clientX,r="touches"in e?e.touches[0].clientY:e.clientY,n=t-i.current.x,c=r-i.current.y;s({x:Math.max(16,Math.min(window.innerWidth-176,l.current.x+n)),y:Math.max(80,Math.min(window.innerHeight-136,l.current.y+c))})},[a]),d=(0,r.useCallback)(()=>{n(!1)},[]);return(0,r.useEffect)(()=>(a&&(window.addEventListener("mousemove",o),window.addEventListener("mouseup",d),window.addEventListener("touchmove",o),window.addEventListener("touchend",d)),()=>{window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",d),window.removeEventListener("touchmove",o),window.removeEventListener("touchend",d)}),[a,o,d]),{position:t,isDragging:a,handleMouseDown:c}}(k);(0,r.useEffect)(()=>{I||_(Z)},[Z,I]),(0,r.useEffect)(()=>{o&&w.current&&(w.current.srcObject=o,w.current.play().catch(()=>{}))},[o]),(0,r.useEffect)(()=>{d&&(j.current&&(j.current.srcObject=d,j.current.play().catch(()=>{})),N.current&&(N.current.srcObject=d,N.current.muted=!1,N.current.volume=1,N.current.play().catch(()=>{})))},[d]),(0,r.useEffect)(()=>{let e=()=>{F.current&&clearTimeout(F.current),P(!0),F.current=setTimeout(()=>{"connected"===t.status&&P(!1)},3e3)};return window.addEventListener("mousemove",e),window.addEventListener("click",e),e(),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("click",e),F.current&&clearTimeout(F.current)}},[t.status]);let R=e=>"".concat(Math.floor(e/60),":").concat((e%60).toString().padStart(2,"0")),O=()=>{D(!S)},A="video"===t.type,U="ringing"===t.status,L=t.isIncoming;null==d||d.getVideoTracks().some(e=>"live"===e.readyState),null==o||o.getVideoTracks().some(e=>"live"===e.readyState);let q=S?d:o,H=S?o:d,B=S?j:w,W=S?w:j;return(0,a.jsxs)("div",{className:"fixed inset-0 w-screen h-screen bg-black z-[9999] overflow-hidden",children:[(0,a.jsx)("audio",{ref:N,autoPlay:!0,playsInline:!0,className:"hidden"}),(0,a.jsx)("div",{className:"absolute inset-0",children:q?(0,a.jsx)("video",{ref:B,autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover",onClick:O}):(0,a.jsx)("div",{className:"w-full h-full flex items-center justify-center bg-gradient-to-b from-gray-900 to-black",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-4",style:{background:v},children:(0,a.jsx)("span",{className:"text-5xl text-white font-bold",children:t.remoteUsername.charAt(0).toUpperCase()})}),(0,a.jsx)("h2",{className:"text-white text-2xl font-bold",children:t.remoteUsername}),(0,a.jsx)("p",{className:"text-gray-400 mt-2",children:"connecting"===t.status?"Connecting...":"calling"===t.status?"Calling...":R(s)})]})})}),A&&H&&(0,a.jsxs)(z.E.div,{className:"absolute z-50 rounded-xl overflow-hidden shadow-2xl border-2 border-white/20 bg-black/50 backdrop-blur-sm cursor-move",style:{width:160,height:120,left:Z.x,top:Z.y},initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},whileHover:{borderColor:"rgba(255,255,255,0.5)"},onMouseDown:K,onTouchStart:K,onClick:e=>{I||O()},children:[(0,a.jsx)("video",{ref:W,autoPlay:!0,playsInline:!0,muted:S,className:"w-full h-full object-cover"}),(0,a.jsx)("div",{className:"absolute top-1 left-1/2 -translate-x-1/2 px-2 py-0.5 bg-black/50 rounded-full text-white text-[10px] opacity-0 hover:opacity-100 transition-opacity",children:"Click to swap"}),n&&S&&(0,a.jsx)("div",{className:"absolute bottom-2 right-2 p-1 bg-red-500 rounded-full",children:(0,a.jsx)(eh.Z,{className:"w-3 h-3 text-white"})}),(0,a.jsx)("div",{className:"absolute top-1 left-1/2 -translate-x-1/2 w-8 h-1 bg-white/30 rounded-full cursor-move"})]}),(0,a.jsx)(z.E.div,{className:"absolute top-0 left-0 right-0 z-40 p-4 bg-gradient-to-b from-black/80 to-transparent",initial:{opacity:0,y:-20},animate:{opacity:T?1:0,y:T?0:-20},children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:v},children:(0,a.jsx)("span",{className:"text-white font-bold",children:t.remoteUsername.charAt(0).toUpperCase()})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-white font-medium",children:t.remoteUsername}),(0,a.jsxs)("span",{className:"text-green-400 text-sm flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),"connected"===t.status?R(s):t.status]})]})]}),"connected"===t.status&&(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>{N.current&&(N.current.muted=!E,M(!E))},className:"p-2 bg-white/10 hover:bg-white/20 rounded-full text-white",children:E?(0,a.jsx)(eg.Z,{className:"w-5 h-5"}):(0,a.jsx)(ex.Z,{className:"w-5 h-5"})}),(0,a.jsx)("button",{onClick:g,className:"p-2 bg-white/10 hover:bg-white/20 rounded-full text-white",children:c?(0,a.jsx)(ep.Z,{className:"w-5 h-5"}):(0,a.jsx)(ey.Z,{className:"w-5 h-5"})})]})]})}),(0,a.jsxs)(z.E.div,{className:"absolute bottom-0 left-0 right-0 z-40 p-6 bg-gradient-to-t from-black/90 via-black/50 to-transparent",initial:{opacity:0,y:20},animate:{opacity:T?1:0,y:T?0:20},children:[(0,a.jsx)("div",{className:"flex items-center justify-center gap-4",children:U&&L?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(z.E.button,{onClick:y,className:"p-5 bg-red-500 rounded-full",whileHover:{scale:1.1},whileTap:{scale:.95},children:(0,a.jsx)(eb.Z,{className:"w-8 h-8 text-white"})}),(0,a.jsx)(z.E.button,{onClick:b,className:"p-5 bg-green-500 rounded-full",whileHover:{scale:1.1},whileTap:{scale:.95},children:A?(0,a.jsx)(ef.Z,{className:"w-8 h-8 text-white"}):(0,a.jsx)(ev.Z,{className:"w-8 h-8 text-white"})})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(z.E.button,{onClick:u,className:"p-4 rounded-full ".concat(n?"bg-red-500":"bg-gray-700"),whileHover:{scale:1.1},whileTap:{scale:.95},children:n?(0,a.jsx)(eh.Z,{className:"w-6 h-6 text-white"}):(0,a.jsx)(ew.Z,{className:"w-6 h-6 text-white"})}),A&&(0,a.jsx)(z.E.button,{onClick:m,className:"p-4 rounded-full ".concat(i?"bg-red-500":"bg-gray-700"),whileHover:{scale:1.1},whileTap:{scale:.95},children:i?(0,a.jsx)(ej.Z,{className:"w-6 h-6 text-white"}):(0,a.jsx)(ef.Z,{className:"w-6 h-6 text-white"})}),A&&x&&(0,a.jsx)(z.E.button,{onClick:x,className:"p-4 bg-gray-700 rounded-full",whileHover:{scale:1.1},whileTap:{scale:.95},title:"Switch camera",children:(0,a.jsx)("svg",{className:"w-6 h-6 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})}),A&&"connected"===t.status&&(0,a.jsx)(z.E.button,{onClick:h,className:"p-4 rounded-full ".concat(l?"bg-blue-500":"bg-gray-700"),whileHover:{scale:1.1},whileTap:{scale:.95},children:(0,a.jsx)(eN.Z,{className:"w-6 h-6 text-white"})}),(0,a.jsx)(z.E.button,{onClick:O,className:"p-4 bg-gray-700 rounded-full",whileHover:{scale:1.1},whileTap:{scale:.95},children:(0,a.jsx)(ek.Z,{className:"w-6 h-6 text-white"})}),(0,a.jsx)(z.E.button,{onClick:p,className:"p-4 bg-red-500 rounded-full px-8",whileHover:{scale:1.05},whileTap:{scale:.95},children:(0,a.jsx)(eb.Z,{className:"w-6 h-6 text-white"})})]})}),(0,a.jsx)("p",{className:"text-center text-gray-400 text-sm mt-4",children:"connected"===t.status&&(0,a.jsxs)("span",{className:"text-green-500 flex items-center justify-center gap-2",children:[(0,a.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full"})," Connected"]})})]})]})}function eC(e){let{isInCall:t,callDuration:s,remoteUsername:n,isMuted:i,isVideoOff:l,isVideoCall:c,onToggleMute:o,onToggleVideo:d,onEndCall:u,onRestore:m}=e,[h,g]=(0,r.useState)(!1),[x,p]=(0,r.useState)(!0);(0,r.useEffect)(()=>{let e=()=>{let e=document.hidden;console.log("\uD83D\uDC41️ Visibility changed:",e?"hidden":"visible"),e&&t?(g(!0),p(!1)):p(!0)};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[t]),(0,r.useEffect)(()=>{let e=()=>{console.log("\uD83D\uDC41️ Window blurred"),t&&g(!0)},s=()=>{console.log("\uD83D\uDC41️ Window focused"),p(!0)};return window.addEventListener("blur",e),window.addEventListener("focus",s),()=>{window.removeEventListener("blur",e),window.removeEventListener("focus",s)}},[t]),(0,r.useEffect)(()=>{t||(g(!1),p(!0))},[t]);let y=(0,r.useCallback)(()=>{g(!1),m(),window.focus()},[m]);return t?(0,a.jsx)(B.M,{children:(h||!x)&&(0,a.jsxs)(z.E.div,{className:"fixed z-[99999]",initial:{opacity:0,scale:.8,y:50},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:50},style:{bottom:"20px",right:"20px"},children:[(0,a.jsxs)(z.E.div,{className:"bg-gray-900/95 backdrop-blur-lg rounded-2xl p-4 shadow-2xl border border-white/10 cursor-pointer hover:border-white/30 transition-colors",onClick:y,whileHover:{scale:1.02},whileTap:{scale:.98},children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg",children:n.charAt(0).toUpperCase()}),(0,a.jsxs)("div",{className:"flex-1 min-w-[120px]",children:[(0,a.jsx)("p",{className:"text-white font-medium truncate",children:n}),(0,a.jsxs)("p",{className:"text-green-400 text-sm flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"}),"".concat(Math.floor(s/60),":").concat((s%60).toString().padStart(2,"0"))]})]}),(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),u()},className:"p-2.5 bg-red-500 hover:bg-red-600 rounded-full transition-colors",children:(0,a.jsx)(eb.Z,{className:"w-5 h-5 text-white"})})]}),(0,a.jsxs)("div",{className:"flex items-center justify-center gap-2 mt-3 pt-3 border-t border-white/10",children:[(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),o()},className:"p-2 rounded-full transition-colors ".concat(i?"bg-red-500/20 text-red-400":"bg-white/10 text-white hover:bg-white/20"),children:i?(0,a.jsx)(eh.Z,{className:"w-4 h-4"}):(0,a.jsx)(ew.Z,{className:"w-4 h-4"})}),c&&(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),d()},className:"p-2 rounded-full transition-colors ".concat(l?"bg-red-500/20 text-red-400":"bg-white/10 text-white hover:bg-white/20"),children:l?(0,a.jsx)(ej.Z,{className:"w-4 h-4"}):(0,a.jsx)(ef.Z,{className:"w-4 h-4"})}),(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),y()},className:"px-3 py-1.5 bg-blue-500/20 text-blue-400 rounded-full text-sm hover:bg-blue-500/30 transition-colors",children:"Restore"})]})]}),(0,a.jsx)(z.E.div,{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full",animate:{scale:[1,1.2,1]},transition:{duration:1,repeat:1/0}})]},"minimized")}):null}var eS=s(7323),eD=s(6141),eE=s(2442),eM=s(6224);function eT(e){let{isOpen:t,onClose:s}=e,[n,i]=(0,r.useState)(null),[l,c]=(0,r.useState)(""),[o,d]=(0,r.useState)(!1),[m,h]=(0,r.useState)(null),[g,x]=(0,r.useState)(300),[p,y]=(0,r.useState)(!1),b=async()=>{d(!0),h(null);try{let e=await u.getQRData();i(e);let t=await f(e);c(t),x(300)}catch(s){var e,t;h((null===(t=s.response)||void 0===t?void 0:null===(e=t.data)||void 0===e?void 0:e.detail)||"Failed to generate QR code")}finally{d(!1)}},f=async e=>{let t=new TextEncoder,s="".concat(e.user_id,":").concat(e.username,":").concat(e.timestamp),a=t.encode(s),r=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(r)).map(e=>e.toString(16).padStart(2,"0")).join("").substring(0,64)};(0,r.useEffect)(()=>{t&&b()},[t]),(0,r.useEffect)(()=>{if(!t||g<=0)return;let e=setInterval(()=>{x(e=>e<=1?(b(),300):e-1)},1e3);return()=>clearInterval(e)},[t,g]);let v=async()=>{if(!n)return;let e={...n,signature:l};try{await navigator.clipboard.writeText(JSON.stringify(e)),y(!0),setTimeout(()=>y(!1),2e3)}catch(e){console.error("Failed to copy:",e)}};return t?(0,a.jsx)(B.M,{children:(0,a.jsx)(z.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4",onClick:s,children:(0,a.jsxs)(z.E.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-gray-900 rounded-2xl w-full max-w-md overflow-hidden shadow-2xl border border-gray-800",onClick:e=>e.stopPropagation(),children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-800 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(I.Z,{className:"w-5 h-5 text-blue-400"}),(0,a.jsx)("h2",{className:"text-lg font-semibold text-white",children:"My QR Code"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:b,disabled:o,className:"p-2 hover:bg-gray-800 rounded-lg transition-colors disabled:opacity-50",title:"Refresh QR Code",children:(0,a.jsx)(ee.Z,{className:"w-5 h-5 text-gray-400 ".concat(o?"animate-spin":"")})}),(0,a.jsx)("button",{onClick:s,className:"p-2 hover:bg-gray-800 rounded-lg transition-colors",children:(0,a.jsx)(ea.Z,{className:"w-5 h-5 text-gray-400"})})]})]}),(0,a.jsx)("div",{className:"p-6",children:m?(0,a.jsxs)("div",{className:"text-center py-8",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(I.Z,{className:"w-8 h-8 text-red-400"})}),(0,a.jsx)("p",{className:"text-red-400 mb-4",children:m}),(0,a.jsx)("button",{onClick:b,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:"Try Again"})]}):o?(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center py-12",children:[(0,a.jsx)("div",{className:"w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"}),(0,a.jsx)("p",{className:"text-gray-400",children:"Generating QR code..."})]}):n?(0,a.jsxs)("div",{className:"flex flex-col items-center",children:[(0,a.jsx)("div",{className:"bg-white p-4 rounded-2xl mb-6",children:(0,a.jsx)(eS.t,{value:n?JSON.stringify({...n,signature:l}):"",size:240,level:"H",includeMargin:!1,bgColor:"#ffffff",fgColor:"#000000"})}),(0,a.jsxs)("div",{className:"text-center mb-4",children:[(0,a.jsx)("p",{className:"text-white font-medium text-lg",children:n.username}),(0,a.jsx)("p",{className:"text-gray-500 text-sm",children:"Scan to add as contact"})]}),(0,a.jsxs)("div",{className:"w-full bg-gray-800/50 rounded-lg p-3 mb-4",children:[(0,a.jsx)("p",{className:"text-xs text-gray-500 mb-1",children:"Key Fingerprint"}),(0,a.jsx)("p",{className:"text-xs font-mono text-gray-400 break-all",children:n.public_key_fingerprint})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 text-sm ".concat(g<60?"text-red-400":"text-yellow-400"),children:[(0,a.jsx)(eD.Z,{className:"w-4 h-4"}),(0,a.jsxs)("span",{children:["Expires in ","".concat(Math.floor(g/60),":").concat((g%60).toString().padStart(2,"0"))]})]}),(0,a.jsx)("button",{onClick:v,className:"mt-4 flex items-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors text-sm text-gray-300",children:p?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(eE.Z,{className:"w-4 h-4 text-green-400"}),(0,a.jsx)("span",{className:"text-green-400",children:"Copied!"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(eM.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Copy QR Data"})]})})]}):null}),(0,a.jsx)("div",{className:"p-4 bg-gray-800/50 border-t border-gray-800",children:(0,a.jsxs)("p",{className:"text-xs text-gray-500 text-center flex items-center justify-center gap-2",children:[(0,a.jsx)(I.Z,{className:"w-3 h-3"}),"This QR code contains your public key fingerprint for secure verification"]})})]})})}):null}var eP=s(690),eF=s(1981),eZ=s(1138),eI=s(5817),eK=s(6637),eR=s(3067),eO=s(4056),eA=s(290),eU=s(2790),eL=s(3482),eq=s(3056),eH=s(3480),ez=s(3714),eB=s(8438),eW=s(8734),eV=s(6489),eQ=s(6020),eY=s(7870);function eJ(e){return e?new Date(e.endsWith("Z")||/[+-]\d{2}:\d{2}$/.test(e)||/[+-]\d{4}$/.test(e)?e:e+"Z"):new Date}function eG(e){let{children:t,isSent:s,isNew:r=!1,index:n=0}=e;return(0,a.jsxs)(z.E.div,{initial:s?{scale:.8,opacity:0,y:20,rotateY:5}:{scale:.9,opacity:0,y:20,z:-30},animate:{scale:1,opacity:1,y:0,rotateY:0,z:0},transition:{type:"spring",stiffness:400,damping:25,delay:.03*n},style:{transformStyle:"preserve-3d",perspective:1e3},children:[s&&r&&(0,a.jsx)(z.E.div,{className:"absolute inset-0 rounded-2xl pointer-events-none",initial:{boxShadow:"0 0 0 0 rgba(var(--accent-rgb), 0.4)"},animate:{boxShadow:["0 0 0 0 rgba(var(--accent-rgb), 0.4)","0 0 20px 5px rgba(var(--accent-rgb), 0.2)","0 0 0 0 rgba(var(--accent-rgb), 0)"]},transition:{duration:1.5}}),t]})}function eX(){let{user:e,currentConversation:t,messages:s,contacts:n,conversations:i,privateKey:l,sendMessage:c,onlineUsers:d,typingUsers:m,setCurrentConversation:h,loadCallHistory:g,callHistory:x,loadContacts:b,deleteMessageForMe:f,deleteMessageForEveryone:v,clearChat:w,deleteConversationForEveryone:j}=P(),{getAccentGradient:k,getAccentColors:_,getDensityClasses:S,getFontClasses:D,settings:E}=(0,C.MU)(),M=k(),T=_(),F=S(),Z=D(),[K,R]=(0,r.useState)(""),[O,A]=(0,r.useState)(!1),[U,L]=(0,r.useState)(!1),[q,H]=(0,r.useState)(null),[V,Q]=(0,r.useState)(null),{callState:Y,isMuted:J,isVideoOff:G,callDuration:X,localStream:$,remoteStream:ee,startCall:et,answerCall:es,rejectCall:en,endCall:el,toggleMute:ec,toggleVideo:eo,error:ed,clearError:eu}=function(){var e,t;let[s,a]=(0,r.useState)(null),[n,i]=(0,r.useState)(null),[l,c]=(0,r.useState)(null),[o,d]=(0,r.useState)(null),u=null!==s&&["calling","ringing","connecting","connected"].includes(s.status),m=null!==(e=null==s?void 0:s.isMuted)&&void 0!==e&&e,h=null!==(t=null==s?void 0:s.isVideoOff)&&void 0!==t&&t,[g,x]=(0,r.useState)(0);(0,r.useEffect)(()=>{let e=null;return(null==s?void 0:s.status)==="connected"&&s.startTime?e=setInterval(()=>{let e=new Date,t=new Date(s.startTime);x(Math.floor((e.getTime()-t.getTime())/1e3))},1e3):x(0),()=>{e&&clearInterval(e)}},[null==s?void 0:s.status,null==s?void 0:s.startTime]),(0,r.useEffect)(()=>(console.log("\uD83D\uDD27 Setting up WebRTC hooks"),em.setOnStateChange(e=>{console.log("\uD83D\uDCDE Call state update:",e.status),a({...e}),"connected"===e.status&&i(null)}),em.setOnLocalStream(e=>{console.log("\uD83D\uDCF9 Local stream received:",e.id),c(e)}),em.setOnRemoteStream(e=>{console.log("\uD83D\uDCF9 Remote stream received:",e.id),d(e)}),em.setOnError(e=>{console.error("\uD83D\uDCA5 WebRTC error:",e),i(e)}),()=>{console.log("\uD83D\uDD27 Cleaning up WebRTC hooks"),em.setOnStateChange(null),em.setOnLocalStream(null),em.setOnRemoteStream(null),em.setOnError(null)}),[]);let p=(0,r.useCallback)(async(e,t)=>(i(null),em.startCall(e,t)),[]),y=(0,r.useCallback)(async()=>(i(null),em.answerCall()),[]),b=(0,r.useCallback)(()=>{em.rejectCall()},[]),f=(0,r.useCallback)(()=>{em.endCall()},[]);return{callState:s,isInCall:u,isMuted:m,isVideoOff:h,callDuration:g,localStream:l,remoteStream:o,startCall:p,answerCall:y,rejectCall:b,endCall:f,toggleMute:(0,r.useCallback)(()=>em.toggleMute(),[]),toggleVideo:(0,r.useCallback)(()=>em.toggleVideo(),[]),error:n,clearError:(0,r.useCallback)(()=>{i(null)},[])}}(),[eh,eg]=(0,r.useState)(!1),[ex,ep]=(0,r.useState)(!1),[ey,ew]=(0,r.useState)(!1),[ej,eN]=(0,r.useState)(!1),[ek,eS]=(0,r.useState)(!1),[eM,eX]=(0,r.useState)(null),[e$,e0]=(0,r.useState)(new Set),e1=(0,r.useRef)(new Map),[e2,e4]=(0,r.useState)(null),[e5,e3]=(0,r.useState)(!1),[e8,e6]=(0,r.useState)(!1),[e9,e7]=(0,r.useState)(null),[te,tt]=(0,r.useState)(null),ts=(0,r.useRef)(null),ta=(0,r.useRef)(null),tr=(0,r.useRef)(null),tn=n.find(e=>e.contact_username===t),ti=i.find(e=>e.username===t),tl=tn&&!tn.is_blocked,tc=(null==tn?void 0:tn.is_blocked)||!1,to=(null==tn?void 0:tn.contact_id)||(null==ti?void 0:ti.user_id),td=(null==tn?void 0:tn.public_key)||(null==ti?void 0:ti.public_key),tu=!!to&&d.has(to),tm=!!t&&m.get(t),th=t&&s.get(t)||[],tg=(x||[]).filter(e=>e.caller_username===t||e.receiver_username===t),tx=[...th.map(e=>({type:"message",data:e,date:eJ(e.created_at)})),...tg.map(e=>({type:"call",data:e,date:eJ(e.start_time)}))].sort((e,t)=>e.date.getTime()-t.date.getTime());(0,r.useEffect)(()=>{g()},[g]),(0,r.useEffect)(()=>{e1.current.clear()},[t]),(0,r.useEffect)(()=>{(async function(){if(t&&!td)try{let e=await o.getPublicKey(t);(null==e?void 0:e.public_key)&&eX(e.public_key)}catch(e){console.error("Failed to fetch public key:",e)}else td&&eX(td)})()},[t,td]),(0,r.useEffect)(()=>{t&&!tn&&(console.log("\uD83D\uDD04 Contact not found for conversation, refreshing contacts..."),b())},[t,tn,b]),(0,r.useEffect)(()=>{let e=e=>{e5&&!e.target.closest(".chat-menu-container")&&e3(!1)};return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[e5]),(0,r.useEffect)(()=>{var e;null===(e=ts.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[th]),(0,r.useEffect)(()=>{if(t&&K){N.sendTypingIndicator(t,!0);let e=setTimeout(()=>{N.sendTypingIndicator(t,!1)},2e3);return()=>clearTimeout(e)}},[K,t]),(0,r.useEffect)(()=>{Y&&"ended"!==Y.status&&"failed"!==Y.status||eg(!1)},[null==Y?void 0:Y.status]),(0,r.useEffect)(()=>{ed&&(console.error("Call error:",ed),eu())},[ed,eu]),(0,r.useEffect)(()=>{let e=()=>e3(!1);return e5&&document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[e5]);let tp=async()=>{if(eh)try{let e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});em.replaceVideoTrack(e.getVideoTracks()[0]),eg(!1)}catch(e){console.error("Error stopping screen share:",e)}else try{let e=await navigator.mediaDevices.getDisplayMedia({video:!0});em.replaceVideoTrack(e.getVideoTracks()[0]),eg(!0),e.getVideoTracks()[0].onended=()=>{eg(!1),navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{em.replaceVideoTrack(e.getVideoTracks()[0])})}}catch(e){console.error("Error starting screen share:",e)}},ty=async()=>{if(K.trim()&&t&&!O){A(!0),Q(null);try{var e;let s=Date.now();e0(e=>new Set(e).add(s)),await c(t,K),R(""),null===(e=ta.current)||void 0===e||e.focus(),setTimeout(()=>{e0(e=>{let t=new Set(e);return t.delete(s),t})},1e3)}catch(e){console.error("Failed to send message:",e),Q(e.message||"Failed to send message")}finally{A(!1)}}},tb=async e=>{t&&(await et(t,e)||console.error("Failed to start call"))},tf=async()=>{try{await es()}catch(e){console.error("Error answering call:",e)}},tv=()=>{en()},tw=()=>{el()},tj=()=>{ec()},tN=()=>{eo()},tk=async()=>{try{await em.switchCamera()}catch(e){console.error("Error switching camera:",e)}},t_=async e=>{let s=e.target.files;if(!s||0===s.length||!t)return;let a=s[0];eN(!1),A(!0);try{let e=new FileReader;e.onload=async()=>{let s=e.result,r={name:a.name,type:a.type,size:a.size};await c(t,s,a.type.startsWith("image/")?"image":"file",r)},e.readAsDataURL(a)}catch(e){console.error("Failed to send file:",e)}finally{A(!1),tr.current&&(tr.current.value="")}},tC=(0,r.useCallback)(t=>{if(e1.current.has(t.id))return e1.current.get(t.id);if(t._decryptedContent)return e1.current.set(t.id,t._decryptedContent),t._decryptedContent;if(!l)return"[Encrypted]";try{let s;let a=JSON.parse(t.encrypted_content);s=eM||(null==tn?void 0:tn.public_key)||(null==ti?void 0:ti.public_key);let r=null;if(a.senderPublicKey)r=p(a,s||"",l);else{if(!s){let s=t.sender_username===(null==e?void 0:e.username)?"[Sent message]":"[Key not available]";return e1.current.set(t.id,s),s}r=p(a,s,l)}if(r)return e1.current.set(t.id,r),t._decryptedContent=r,r;let n=t.sender_username===(null==e?void 0:e.username)?"[Sent message]":"[Decryption failed]";return e1.current.set(t.id,n),n}catch(s){console.error("Decryption error:",s);let e="[Encrypted message]";return e1.current.set(t.id,e),e}},[l,e,tn,ti,eM]),tS=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"download";try{let s=document.createElement("a");s.href=e,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s)}catch(e){console.error("Download failed:",e)}},tD=e=>{switch(e.status){case"sent":return(0,a.jsx)(eE.Z,{className:"w-4 h-4 text-gray-400"});case"delivered":return(0,a.jsx)(eP.Z,{className:"w-4 h-4 text-gray-400"});case"read":return(0,a.jsx)(eP.Z,{className:"w-4 h-4",style:{color:T.primary}});case"sending":return(0,a.jsx)(er.Z,{className:"w-4 h-4 text-gray-500 animate-spin"});case"failed":return(0,a.jsx)(eF.Z,{className:"w-4 h-4 text-red-500"});default:return(0,a.jsx)(eD.Z,{className:"w-4 h-4 text-gray-500"})}},tE=e=>{if("deleted"===e.message_type)return(0,a.jsxs)("p",{className:"italic text-gray-400/70",children:[(0,a.jsx)(eZ.Z,{className:"w-3 h-3 inline mr-1"}),"This message was deleted"]});let t=tC(e);if("image"===e.message_type&&t.startsWith("data:image"))return(0,a.jsxs)("div",{className:"relative group",children:[(0,a.jsx)("img",{src:t,alt:"Shared image",className:"max-w-full rounded-lg max-h-64 object-cover cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>H(t)}),(0,a.jsx)("button",{onClick:()=>tS(t,"image_".concat(e.id,".png")),className:"absolute top-2 right-2 p-1.5 bg-black/50 hover:bg-black/70 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity",title:"Download Image",children:(0,a.jsx)(eI.Z,{className:"w-4 h-4"})})]});if("file"===e.message_type||"image"===e.message_type&&!t.startsWith("data:image")){var s,r,n;return(0,a.jsx)("div",{className:"flex flex-col gap-2 p-1",children:(0,a.jsxs)("div",{className:"flex items-center gap-3 bg-cipher-dark/40 p-3 rounded-xl border border-white/5",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-cipher-primary/20 rounded-lg flex items-center justify-center text-cipher-primary",children:(0,a.jsx)(eK.Z,{className:"w-6 h-6"})}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("p",{className:"text-sm font-medium truncate text-white",children:(null===(s=e.file_metadata)||void 0===s?void 0:s.name)||"document_".concat(e.id)}),(0,a.jsx)("p",{className:"text-xs text-gray-500 uppercase",children:(null===(n=e.file_metadata)||void 0===n?void 0:null===(r=n.type)||void 0===r?void 0:r.split("/")[1])||"FILE"})]}),(0,a.jsx)("button",{onClick:()=>{var s;return tS(t,(null===(s=e.file_metadata)||void 0===s?void 0:s.name)||"document")},className:"p-2 hover:bg-white/10 rounded-full text-cipher-primary transition-colors",title:"Download File",children:(0,a.jsx)(eI.Z,{className:"w-5 h-5"})})]})})}return(0,a.jsx)("p",{className:"break-words",children:t})},tM=(e,t,s)=>{e.preventDefault(),e4({visible:!0,x:e.clientX,y:e.clientY,messageId:t,isMine:s})},tT=async e=>{e2&&t&&(e?e7({visible:!0,type:"message",messageId:e2.messageId,deleteForEveryone:!0}):await f(e2.messageId,t),e4(null))},tP=async()=>{if(te&&to){tt({...te,loading:!0});try{"block"===te.type?(await u.blockUser(to,"other"),console.log("✅ User blocked successfully")):"unblock"===te.type?(await u.unblockUser(to),console.log("✅ User unblocked successfully")):"remove"===te.type&&(await u.removeContact(to),console.log("✅ Contact removed successfully"),h(null)),await b()}catch(e){console.error("Failed to ".concat(te.type," user:"),e)}tt(null)}},tF=async()=>{if(e9&&t){try{"message"===e9.type&&e9.messageId?e9.deleteForEveryone?await v(e9.messageId,t):await f(e9.messageId,t):"chat"===e9.type?await w(t):"conversation"===e9.type&&await j(t)}catch(e){console.error("Deletion failed:",e)}e7(null)}};return t?Y&&"failed"===Y.status?(0,a.jsx)("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50",children:(0,a.jsxs)(z.E.div,{className:"text-center max-w-md p-6",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},children:[(0,a.jsx)("div",{className:"w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(eF.Z,{className:"w-10 h-10 text-red-500"})}),(0,a.jsx)("h2",{className:"text-xl font-bold text-white mb-2",children:"Call Failed"}),(0,a.jsx)("p",{className:"text-gray-400 mb-6",children:Y.errorMessage||"Unable to connect the call. Please try again."}),(0,a.jsx)("button",{onClick:()=>{el()},className:"px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors",children:"Dismiss"})]})}):Y&&"rejected"===Y.status?(0,a.jsx)("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50",children:(0,a.jsxs)(z.E.div,{className:"text-center max-w-md p-6",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},children:[(0,a.jsx)("div",{className:"w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(eb.Z,{className:"w-10 h-10 text-red-500"})}),(0,a.jsx)("h2",{className:"text-xl font-bold text-white mb-2",children:"Call Declined"}),(0,a.jsxs)("p",{className:"text-gray-400 mb-6",children:[Y.remoteUsername," declined your call."]}),(0,a.jsx)("button",{onClick:()=>{el()},className:"px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors",children:"Close"})]})}):Y&&["calling","ringing","connecting","connected"].includes(Y.status)?(0,a.jsx)(e_,{callState:Y,callDuration:X,isMuted:J,isVideoOff:G,isScreenSharing:eh,isFullscreen:ex,localStream:$,remoteStream:ee,onToggleMute:tj,onToggleVideo:tN,onToggleScreenShare:tp,onToggleFullscreen:()=>{document.fullscreenElement?(document.exitFullscreen(),ep(!1)):(document.documentElement.requestFullscreen(),ep(!0))},onSwitchCamera:tk,onEndCall:tw,onRejectCall:tv,onAnswerCall:tf}):(0,a.jsxs)("div",{className:"flex-1 flex flex-col h-full",children:[(0,a.jsxs)(z.E.div,{className:"h-16 px-4 border-b border-gray-800 flex items-center justify-between bg-cipher-dark/50",initial:{y:-20,opacity:0},animate:{y:0,opacity:1},transition:{duration:.3},children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(z.E.button,{onClick:()=>h(null),className:"lg:hidden p-2 -ml-2 hover:bg-gray-700 rounded-lg text-gray-400",whileHover:{x:-2},whileTap:{scale:.95},children:(0,a.jsx)(eR.Z,{className:"w-5 h-5"})}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(z.E.div,{className:"w-10 h-10 rounded-full flex items-center justify-center cursor-pointer",style:{background:M},whileHover:{scale:1.1,rotate:5},whileTap:{scale:.95},children:(0,a.jsx)("span",{className:"text-white font-medium",children:t.charAt(0).toUpperCase()})}),tu&&(0,a.jsx)(z.E.div,{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-cipher-dark",animate:{scale:[1,1.2,1]},transition:{duration:2,repeat:1/0}})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"font-medium text-white",children:t}),(0,a.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[tm?(0,a.jsx)("span",{className:"text-cipher-primary",children:"typing..."}):tu?(0,a.jsx)("span",{className:"text-green-500",children:"Online"}):(0,a.jsx)("span",{className:"text-gray-500",children:"Offline"}),(0,a.jsx)("span",{className:"text-gray-600",children:"•"}),(0,a.jsxs)("div",{className:"flex items-center gap-1 text-gray-500",children:[(0,a.jsx)(W.EncryptionLock,{size:"sm",isEncrypting:!1}),(0,a.jsx)("span",{children:"Encrypted"})]})]})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)(z.E.button,{onClick:()=>tb("audio"),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Voice Call",whileHover:{scale:1.1},whileTap:{scale:.9},children:(0,a.jsx)(ev.Z,{className:"w-5 h-5"})}),(0,a.jsx)(z.E.button,{onClick:()=>tb("video"),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Video Call",whileHover:{scale:1.1},whileTap:{scale:.9},children:(0,a.jsx)(ef.Z,{className:"w-5 h-5"})}),(0,a.jsx)(z.E.button,{onClick:()=>L(!U),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",whileHover:{scale:1.1,rotate:15},whileTap:{scale:.9},children:(0,a.jsx)(eO.Z,{className:"w-5 h-5"})}),(0,a.jsxs)("div",{className:"relative chat-menu-container",children:[(0,a.jsx)(z.E.button,{onClick:()=>e3(!e5),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Chat Options",whileHover:{scale:1.1},whileTap:{scale:.9},children:(0,a.jsx)(eA.Z,{className:"w-5 h-5"})}),e5&&(0,a.jsxs)(z.E.div,{className:"absolute right-0 top-full mt-1 bg-cipher-dark border border-gray-700 rounded-lg shadow-xl py-1 min-w-[200px] z-50",initial:{opacity:0,y:-10,scale:.95},animate:{opacity:1,y:0,scale:1},children:[(0,a.jsxs)("button",{onClick:()=>{e7({visible:!0,type:"chat"}),e3(!1)},className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-gray-700/50 transition-colors",children:[(0,a.jsx)(eZ.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Clear chat"})]}),(0,a.jsxs)("button",{onClick:()=>{e7({visible:!0,type:"conversation"}),e3(!1)},className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-gray-700/50 transition-colors",children:[(0,a.jsx)(eZ.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Delete for everyone"})]}),(0,a.jsx)("div",{className:"border-t border-gray-700 my-1"}),(0,a.jsxs)("button",{onClick:()=>{e6(!0),e3(!1)},className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-blue-400 hover:bg-blue-500/10 transition-colors",children:[(0,a.jsx)(eU.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Show my QR code"})]}),(0,a.jsx)("div",{className:"border-t border-gray-700 my-1"}),tc?(0,a.jsxs)("button",{onClick:()=>{tt({visible:!0,type:"unblock",loading:!1}),e3(!1)},className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-green-400 hover:bg-green-500/10 transition-colors",children:[(0,a.jsx)(eL.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Unblock user"})]}):(0,a.jsxs)("button",{onClick:()=>{tt({visible:!0,type:"block",loading:!1}),e3(!1)},className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-orange-400 hover:bg-orange-500/10 transition-colors",children:[(0,a.jsx)(eq.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Block user"})]}),tn&&(0,a.jsxs)("button",{onClick:()=>{tt({visible:!0,type:"remove",loading:!1}),e3(!1)},className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-400 hover:bg-red-500/10 transition-colors",children:[(0,a.jsx)(eH.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Remove contact"})]})]})]})]})]}),(0,a.jsxs)(z.E.div,{className:"px-4 py-2 bg-cipher-primary/10 border-b border-cipher-primary/20 flex items-center justify-center gap-2 text-xs text-cipher-primary",initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},children:[(0,a.jsx)(W.EncryptionLock,{size:"sm",isEncrypting:!1}),(0,a.jsx)("span",{children:"Messages are end-to-end encrypted. No one outside this chat can read them."})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 ".concat(F.messageGap),children:[0===tx.length?(0,a.jsx)(z.E.div,{className:"h-full flex items-center justify-center",initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:.3},children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)(z.E.div,{className:"w-16 h-16 bg-cipher-primary/20 rounded-full flex items-center justify-center mx-auto mb-4",animate:{rotate:[0,10,-10,0]},transition:{duration:4,repeat:1/0},children:(0,a.jsx)(I.Z,{className:"w-8 h-8 text-cipher-primary"})}),(0,a.jsx)("p",{className:"text-gray-400 text-sm",children:"Send a message or start a call to begin"}),((null==tn?void 0:tn.public_key)||eM)&&(0,a.jsxs)("div",{className:"mt-4 p-3 bg-cipher-dark rounded-lg",children:[(0,a.jsx)("p",{className:"text-xs text-gray-500 mb-1",children:"Key fingerprint"}),(0,a.jsx)("p",{className:"text-xs font-mono text-gray-400",children:y((null==tn?void 0:tn.public_key)||eM||"")})]})]})}):(0,a.jsxs)(a.Fragment,{children:[tx.map((t,s)=>{var r,n,i;let l=0===s||(0,ei.WU)(t.date,"yyyy-MM-dd")!==(0,ei.WU)(tx[s-1].date,"yyyy-MM-dd");if("call"===t.type){let s=t.data,r=s.caller_username===(null==e?void 0:e.username),n="video"===s.call_type?ef.Z:ev.Z;return(0,a.jsxs)("div",{children:[l&&(0,a.jsx)(z.E.div,{className:"flex justify-center my-4",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},children:(0,a.jsx)("span",{className:"bg-cipher-dark px-3 py-1 rounded-full text-xs text-gray-500",children:(0,ei.WU)(t.date,"MMMM d, yyyy")})}),(0,a.jsx)(z.E.div,{className:"flex justify-center my-4",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},children:(0,a.jsxs)("div",{className:"bg-gray-800/40 backdrop-blur-sm border border-gray-700/50 px-4 py-2 rounded-2xl flex items-center gap-3",children:[(0,a.jsx)("div",{className:"p-2 rounded-full ".concat("missed"===s.status?"bg-red-500/20 text-red-500":"bg-cipher-primary/20 text-cipher-primary"),children:(0,a.jsx)(n,{className:"w-4 h-4"})}),(0,a.jsxs)("div",{className:"text-left",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-200",children:"completed"===s.status?r?"Outgoing call":"Incoming call":"missed"===s.status?r?"No answer":"Missed call":"rejected"===s.status?r?"Call declined":"Declined call":"Call failed"}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:"completed"===s.status&&s.duration_seconds>0?"".concat(Math.floor(s.duration_seconds/60),"m ").concat(s.duration_seconds%60,"s"):(0,ei.WU)(t.date,"HH:mm")})]})]})})]},"call-".concat(s.id))}let c=t.data,o=c.sender_username===(null==e?void 0:e.username),d="deleted"===c.message_type,u=e$.has(c.id),m=!o&&(null===(r=c.sender_theme)||void 0===r?void 0:r.accentGradient);return(0,a.jsxs)("div",{className:F.messagePadding,children:[l&&(0,a.jsx)(z.E.div,{className:"flex justify-center my-4",initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},children:(0,a.jsx)("span",{className:"bg-cipher-dark dark:bg-gray-800 px-3 py-1 rounded-full ".concat(Z.xs," text-gray-500"),children:(0,ei.WU)(t.date,"MMMM d, yyyy")})}),(0,a.jsx)("div",{className:"flex ".concat(o?"justify-end":"justify-start"," message-bubble group"),children:(0,a.jsx)(eG,{isSent:o,isNew:u,index:s,children:(0,a.jsxs)("div",{className:"\n                          relative max-w-[85%] ".concat(F.bubblePadding," rounded-2xl ").concat(Z.base,"\n                          ").concat(o?"text-white rounded-br-md":m?"text-white rounded-bl-md":"bg-gray-800 dark:bg-gray-800 text-white dark:text-white rounded-bl-md","\n                          ").concat(d?"":"cursor-pointer","\n                          ").concat((null===(n=c.sender_theme)||void 0===n?void 0:n.style)==="glass"?"backdrop-blur-md border border-white/10":"","\n                          ").concat((null===(i=c.sender_theme)||void 0===i?void 0:i.style)==="neon"?"shadow-lg shadow-[var(--accent-color)]/30":"","\n                        "),style:(()=>{var e;if(!d){if(o)return{background:M};if(null===(e=c.sender_theme)||void 0===e?void 0:e.accentGradient)return{background:c.sender_theme.accentGradient}}})(),onContextMenu:e=>!d&&tM(e,c.id,o),children:[tE(c),(0,a.jsxs)("div",{className:"flex items-center gap-1 mt-1 ".concat(o?"justify-end":""),children:[(0,a.jsx)("span",{className:"".concat(Z.xs," opacity-60"),children:(0,ei.WU)(t.date,"HH:mm")}),!d&&(0,a.jsx)(z.E.button,{onClick:e=>{e.stopPropagation(),tM(e,c.id,o)},className:"opacity-0 group-hover:opacity-100 p-0.5 text-gray-400 hover:text-red-400 transition-opacity",title:"Delete",whileHover:{scale:1.2},whileTap:{scale:.9},children:(0,a.jsx)(eZ.Z,{className:"w-3 h-3"})}),o&&tD(c)]})]})})})]},"msg-".concat(c.id))}),tm&&(0,a.jsx)(z.E.div,{className:"flex justify-start",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:(0,a.jsx)("div",{className:"bg-gray-800 px-4 py-3 rounded-2xl rounded-bl-md",children:(0,a.jsxs)("div",{className:"flex gap-1",children:[(0,a.jsx)(z.E.div,{className:"w-2 h-2 bg-gray-500 rounded-full",animate:{y:[0,-5,0]},transition:{duration:.5,repeat:1/0,delay:0}}),(0,a.jsx)(z.E.div,{className:"w-2 h-2 bg-gray-500 rounded-full",animate:{y:[0,-5,0]},transition:{duration:.5,repeat:1/0,delay:.15}}),(0,a.jsx)(z.E.div,{className:"w-2 h-2 bg-gray-500 rounded-full",animate:{y:[0,-5,0]},transition:{duration:.5,repeat:1/0,delay:.3}})]})})})]}),(0,a.jsx)("div",{ref:ts})]}),V&&(0,a.jsxs)(z.E.div,{className:"mx-4 mb-2 p-3 bg-red-900/50 border border-red-500/50 rounded-lg text-red-200 text-sm flex items-center justify-between",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:[(0,a.jsx)("span",{children:V}),(0,a.jsx)("button",{onClick:()=>Q(null),className:"ml-2 text-red-400 hover:text-red-200",children:"\xd7"})]}),(0,a.jsx)(z.E.div,{className:"p-4 border-t border-gray-800 bg-cipher-dark/50",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},children:tl?(0,a.jsxs)("div",{className:"flex items-end gap-3",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(z.E.button,{onClick:()=>eN(!ej),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white",whileHover:{scale:1.1,rotate:-10},whileTap:{scale:.9},children:(0,a.jsx)(ez.Z,{className:"w-5 h-5"})}),(0,a.jsx)(B.M,{children:ej&&(0,a.jsxs)(z.E.div,{className:"absolute bottom-12 left-0 bg-cipher-dark border border-gray-700 rounded-lg shadow-lg p-2 min-w-[150px]",initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},children:[(0,a.jsxs)("button",{onClick:()=>{var e;return null===(e=tr.current)||void 0===e?void 0:e.click()},className:"w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-700 rounded text-gray-300 text-sm",children:[(0,a.jsx)(eB.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Photo"})]}),(0,a.jsxs)("button",{onClick:()=>{var e;return null===(e=tr.current)||void 0===e?void 0:e.click()},className:"w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-700 rounded text-gray-300 text-sm",children:[(0,a.jsx)(eW.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Document"})]})]})}),(0,a.jsx)("input",{ref:tr,type:"file",className:"hidden",accept:"image/*,video/*,.pdf,.doc,.docx,.txt",onChange:t_})]}),(0,a.jsxs)("div",{className:"flex-1 relative",children:[(0,a.jsx)("textarea",{ref:ta,value:K,onChange:e=>R(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),ty())},placeholder:"Type a message...",rows:1,className:"w-full bg-cipher-darker border border-gray-700 rounded-2xl py-3 px-4 pr-12 text-white placeholder-gray-500 focus:border-cipher-primary resize-none transition-colors",style:{maxHeight:"120px"}}),(0,a.jsx)(z.E.button,{onClick:()=>eS(!ek),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-cipher-primary transition-colors",whileHover:{scale:1.2},whileTap:{scale:.9},children:(0,a.jsx)(eV.Z,{className:"w-5 h-5"})}),(0,a.jsx)(B.M,{children:ek&&(0,a.jsx)(z.E.div,{className:"absolute right-0 bottom-14 z-50",initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},children:(0,a.jsx)(eY.ZP,{onEmojiClick:e=>{var t;R(t=>t+e.emoji),eS(!1),null===(t=ta.current)||void 0===t||t.focus()},theme:eY.Q2.DARK,width:350,height:400,searchPlaceholder:"Search emoji...",previewConfig:{showPreview:!1}})})})]}),(0,a.jsx)(z.E.button,{onClick:ty,disabled:!K.trim()||O,className:"\n              p-3 rounded-full transition-all\n              ".concat(K.trim()?"text-white hover:opacity-90":"bg-gray-700 text-gray-500 cursor-not-allowed","\n            "),style:K.trim()?{background:M}:void 0,whileHover:K.trim()?{scale:1.1}:{},whileTap:K.trim()?{scale:.9}:{},children:O?(0,a.jsx)(er.Z,{className:"w-5 h-5 animate-spin"}):(0,a.jsx)(eQ.Z,{className:"w-5 h-5"})})]}):(0,a.jsxs)("div",{className:"text-center py-4",children:[(0,a.jsxs)("div",{className:"text-gray-400 mb-2",children:["You must be friends with ",(0,a.jsx)("span",{className:"text-white font-medium",children:t})," to send messages."]}),(0,a.jsx)("div",{className:"text-sm text-gray-500",children:"Send a friend request to start chatting securely."})]})}),(0,a.jsx)(B.M,{children:U&&(0,a.jsxs)(z.E.div,{className:"absolute right-0 top-0 h-full w-80 bg-cipher-dark/95 backdrop-blur-xl border-l border-gray-800 p-4 overflow-y-auto z-20",initial:{x:"100%",opacity:0},animate:{x:0,opacity:1},exit:{x:"100%",opacity:0},transition:{type:"spring",stiffness:300,damping:30},children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,a.jsx)("h3",{className:"font-medium text-white",children:"Contact Info"}),(0,a.jsx)(z.E.button,{onClick:()=>L(!1),className:"p-1 hover:bg-gray-700 rounded",whileHover:{scale:1.1,rotate:90},whileTap:{scale:.9},children:(0,a.jsx)(ea.Z,{className:"w-5 h-5 text-gray-400"})})]}),(0,a.jsxs)(z.E.div,{className:"text-center mb-6",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1},children:[(0,a.jsx)(z.E.div,{className:"w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-3",style:{background:M},whileHover:{scale:1.05,rotate:5},children:(0,a.jsx)("span",{className:"text-2xl text-white font-medium",children:t.charAt(0).toUpperCase()})}),(0,a.jsx)("h4",{className:"text-lg font-medium text-white",children:t}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:(null==tn?void 0:tn.contact_email)||"Secured Peer"})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)(z.E.div,{className:"p-3 bg-cipher-darker rounded-lg",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},children:[(0,a.jsx)("p",{className:"text-xs text-gray-500 mb-1",children:"Public Key Fingerprint"}),(0,a.jsx)("p",{className:"text-xs font-mono text-gray-400 break-all",children:(null==tn?void 0:tn.public_key)||eM?y((null==tn?void 0:tn.public_key)||eM||""):"Not available - user has not set up encryption"})]}),(0,a.jsxs)(z.E.div,{className:"p-3 bg-cipher-darker rounded-lg",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.3},children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 text-cipher-primary",children:[(0,a.jsx)(I.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"text-sm font-medium",children:"Encryption Active"})]}),(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"All messages are encrypted with X25519 + AES-256-GCM"})]})]})]})}),(0,a.jsx)(B.M,{children:Y&&"ringing"===Y.status&&Y.isIncoming&&(0,a.jsx)(z.E.div,{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsxs)(z.E.div,{className:"relative mx-auto mb-6",initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",stiffness:200,damping:15},children:[(0,a.jsx)(z.E.div,{className:"absolute inset-0 rounded-full border-2 border-cipher-primary/30",animate:{scale:[1,1.5],opacity:[.5,0]},transition:{duration:2,repeat:1/0}}),(0,a.jsx)(z.E.div,{className:"absolute inset-0 rounded-full border-2 border-cipher-primary/20",animate:{scale:[1,1.8],opacity:[.3,0]},transition:{duration:2,repeat:1/0,delay:.3}}),(0,a.jsx)(z.E.div,{className:"relative w-24 h-24 rounded-full flex items-center justify-center",style:{background:M},children:(0,a.jsx)("span",{className:"text-3xl text-white font-bold",children:Y.remoteUsername.charAt(0).toUpperCase()})})]}),(0,a.jsx)(z.E.h2,{className:"text-xl font-bold text-white mb-2",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},children:Y.remoteUsername}),(0,a.jsxs)(z.E.p,{className:"text-gray-400 mb-6",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.3},children:["Incoming ",Y.type," call..."]}),(0,a.jsxs)(z.E.div,{className:"flex items-center justify-center gap-4",initial:{y:30,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4},children:[(0,a.jsx)(z.E.button,{onClick:tv,className:"p-4 bg-red-500 rounded-full hover:bg-red-600 transition-colors",whileHover:{scale:1.1},whileTap:{scale:.9},children:(0,a.jsx)(eb.Z,{className:"w-6 h-6 text-white"})}),(0,a.jsx)(z.E.button,{onClick:tf,className:"p-4 bg-green-500 rounded-full hover:bg-green-600 transition-colors",whileHover:{scale:1.1},whileTap:{scale:.9},animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0},children:"video"===Y.type?(0,a.jsx)(ef.Z,{className:"w-6 h-6 text-white"}):(0,a.jsx)(ev.Z,{className:"w-6 h-6 text-white"})})]})]})})}),(0,a.jsx)(B.M,{children:q&&(0,a.jsxs)(z.E.div,{className:"fixed inset-0 bg-black/95 z-[100] flex flex-col",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>H(null),children:[(0,a.jsx)("div",{className:"h-16 px-4 flex items-center justify-end",children:(0,a.jsx)(z.E.button,{onClick:()=>H(null),className:"p-2 text-white/70 hover:text-white transition-colors",whileHover:{scale:1.1,rotate:90},whileTap:{scale:.9},children:(0,a.jsx)(ea.Z,{className:"w-8 h-8"})})}),(0,a.jsx)(z.E.div,{className:"flex-1 flex items-center justify-center p-4",initial:{scale:.9},animate:{scale:1},exit:{scale:.9},children:(0,a.jsx)("img",{src:q,alt:"Full screen preview",className:"max-w-full max-h-full object-contain shadow-2xl rounded-lg",onClick:e=>e.stopPropagation()})}),(0,a.jsx)("div",{className:"h-20 flex items-center justify-center pb-4",children:(0,a.jsxs)(z.E.button,{onClick:()=>tS(q,"zerotrace_image.png"),className:"flex items-center gap-2 px-6 py-2 text-white rounded-full hover:opacity-90 transition-colors",style:{background:M},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,a.jsx)(eI.Z,{className:"w-5 h-5"}),(0,a.jsx)("span",{children:"Download Full Image"})]})})]})}),(0,a.jsx)(B.M,{children:e2&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(z.E.div,{className:"fixed inset-0 z-[90]",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>{e4(null)}}),(0,a.jsxs)(z.E.div,{className:"fixed bg-cipher-dark/95 backdrop-blur-md border border-gray-700 rounded-xl shadow-2xl py-2 min-w-[160px] z-[100]",style:{left:Math.min(e2.x,window.innerWidth-180),top:Math.min(e2.y,window.innerHeight-120)},initial:{opacity:0,scale:.9,y:-10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:-10},children:[(0,a.jsxs)("button",{onClick:()=>tT(!1),className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-gray-700/50 transition-colors",children:[(0,a.jsx)(eZ.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Delete for me"})]}),e2.isMine&&(0,a.jsxs)("button",{onClick:()=>tT(!0),className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-400 hover:bg-red-500/10 transition-colors",children:[(0,a.jsx)(eZ.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Delete for everyone"})]})]})]})}),(0,a.jsx)(B.M,{children:e9&&(0,a.jsx)(z.E.div,{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[110]",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:(0,a.jsxs)(z.E.div,{className:"bg-cipher-dark border border-gray-700 rounded-2xl p-6 max-w-sm mx-4 shadow-2xl",initial:{scale:.9,opacity:0,y:20},animate:{scale:1,opacity:1,y:0},exit:{scale:.9,opacity:0,y:20},children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-white mb-2",children:"message"===e9.type?"Delete message?":"chat"===e9.type?"Clear chat?":"Delete conversation?"}),(0,a.jsx)("p",{className:"text-gray-400 text-sm mb-6",children:"message"===e9.type?"This message will be deleted for everyone. This action cannot be undone.":"chat"===e9.type?"This will clear all messages from your device. The other person will still have their copy.":"This will delete the entire conversation for both you and the other person. This cannot be undone."}),(0,a.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,a.jsx)(z.E.button,{onClick:()=>e7(null),className:"px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition-colors",whileHover:{scale:1.05},whileTap:{scale:.95},children:"Cancel"}),(0,a.jsx)(z.E.button,{onClick:tF,className:"px-4 py-2 text-sm font-medium rounded-lg transition-colors ".concat("conversation"===e9.type?"bg-red-500 hover:bg-red-600 text-white":"text-white hover:opacity-90"),style:"conversation"!==e9.type?{background:M}:void 0,whileHover:{scale:1.05},whileTap:{scale:.95},children:"message"===e9.type?"Delete":"chat"===e9.type?"Clear":"Delete for everyone"})]})]})})}),(0,a.jsx)(B.M,{children:te&&te.visible&&(0,a.jsx)(z.E.div,{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[110]",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:(0,a.jsxs)(z.E.div,{className:"bg-cipher-dark border border-gray-700 rounded-2xl p-6 max-w-sm mx-4 shadow-2xl",initial:{scale:.9,opacity:0,y:20},animate:{scale:1,opacity:1,y:0},exit:{scale:.9,opacity:0,y:20},children:[(0,a.jsxs)("div",{className:"flex items-center gap-3 mb-4",children:[(0,a.jsxs)("div",{className:"w-12 h-12 rounded-full flex items-center justify-center ".concat("block"===te.type?"bg-orange-500/20":"unblock"===te.type?"bg-green-500/20":"bg-red-500/20"),children:["block"===te.type&&(0,a.jsx)(eq.Z,{className:"w-6 h-6 text-orange-400"}),"unblock"===te.type&&(0,a.jsx)(eL.Z,{className:"w-6 h-6 text-green-400"}),"remove"===te.type&&(0,a.jsx)(eH.Z,{className:"w-6 h-6 text-red-400"})]}),(0,a.jsx)("h3",{className:"text-lg font-semibold text-white",children:"block"===te.type?"Block user?":"unblock"===te.type?"Unblock user?":"Remove contact?"})]}),(0,a.jsx)("p",{className:"text-gray-400 text-sm mb-6",children:"block"===te.type?"".concat(t," will no longer be able to send you messages or see when you're online."):"unblock"===te.type?"".concat(t," will be able to send you messages again."):"".concat(t," will be removed from your contacts. You'll need to send a new friend request to message them again.")}),(0,a.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,a.jsx)(z.E.button,{onClick:()=>tt(null),disabled:te.loading,className:"px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition-colors disabled:opacity-50",whileHover:{scale:1.05},whileTap:{scale:.95},children:"Cancel"}),(0,a.jsxs)(z.E.button,{onClick:tP,disabled:te.loading,className:"px-4 py-2 text-sm font-medium rounded-lg transition-colors flex items-center gap-2 ".concat("block"===te.type?"bg-orange-500 hover:bg-orange-600 text-white":"unblock"===te.type?"bg-green-500 hover:bg-green-600 text-white":"bg-red-500 hover:bg-red-600 text-white"," disabled:opacity-50"),whileHover:{scale:1.05},whileTap:{scale:.95},children:[te.loading&&(0,a.jsx)(er.Z,{className:"w-4 h-4 animate-spin"}),"block"===te.type?"Block":"unblock"===te.type?"Unblock":"Remove"]})]})]})})}),(0,a.jsx)(eC,{isInCall:!!Y&&["calling","ringing","connecting","connected"].includes(Y.status),callDuration:X,remoteUsername:(null==Y?void 0:Y.remoteUsername)||"",isMuted:J,isVideoOff:G,isVideoCall:(null==Y?void 0:Y.type)==="video",onToggleMute:tj,onToggleVideo:tN,onEndCall:tw,onRestore:()=>{window.scrollTo({top:0,behavior:"smooth"})}}),(0,a.jsx)(eT,{isOpen:e8,onClose:()=>e6(!1)})]}):null}var e$=s(2431);function e0(e){let{isOpen:t,onClose:s}=e,[n,i]=(0,r.useState)(""),[l,c]=(0,r.useState)([]),[o,d]=(0,r.useState)("idle"),[h,g]=(0,r.useState)(""),[x,p]=(0,r.useState)(null),[y,b]=(0,r.useState)(null),f=(0,r.useRef)(null),{setCurrentConversation:v,searchUsers:w,loadContacts:j,loadConversations:N,conversations:k,contacts:_,publicKey:C}=P();(0,r.useEffect)(()=>{t&&f.current&&setTimeout(()=>{var e;return null===(e=f.current)||void 0===e?void 0:e.focus()},100),t||(i(""),c([]),d("idle"),g(""),p(null),b(null))},[t]);let S=async()=>{let e=n.trim();if(e){if(e.length<2){g("Please enter at least 2 characters"),d("error");return}d("searching"),g(""),c([]);try{let t=await w(e);if(0===t.length)d("not_found");else{let e=t.map(e=>{let t=_.some(t=>t.contact_username===e.username);return{...e,is_friend:t,has_pending_request:!1}});c(e),d("success")}}catch(e){var t,s;console.error("Search failed:",e),g((null==e?void 0:null===(s=e.response)||void 0===s?void 0:null===(t=s.data)||void 0===t?void 0:t.detail)||"Search failed. Please try again."),d("error")}}},D=async e=>{p(e.id),g("");try{if(k.find(t=>t.username===e.username)){v(e.username),s();return}if(!_.some(t=>t.contact_username===e.username)){g("You must be friends with ".concat(e.username," to chat. Send them a friend request first!")),p(null);return}await N(),v(e.username),s()}catch(e){var t,a;console.error("Failed to start chat:",e),g((null==e?void 0:null===(a=e.response)||void 0===a?void 0:null===(t=a.data)||void 0===t?void 0:t.detail)||"Failed to start chat. Please try again."),p(null)}},E=async e=>{if(!C){g("Your encryption keys are not set up. Please refresh the page.");return}b(e.id),g("");try{let t=m(C);await u.sendFriendRequest({receiver_username:e.username,sender_public_key_fingerprint:t}),c(t=>t.map(t=>t.id===e.id?{...t,has_pending_request:!0}:t)),g("Friend request sent to ".concat(e.username,"!"))}catch(e){var t,s;console.error("Failed to send friend request:",e),g((null==e?void 0:null===(s=e.response)||void 0===s?void 0:null===(t=s.data)||void 0===t?void 0:t.detail)||"Failed to send friend request. Please try again.")}finally{b(null)}};return t?(0,a.jsx)("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",onClick:e=>e.target===e.currentTarget&&s(),children:(0,a.jsxs)("div",{className:"bg-cipher-dark border border-gray-700 rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-in fade-in zoom-in duration-200",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-5 border-b border-gray-700 bg-gradient-to-r from-cipher-primary/10 to-cipher-secondary/10",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-full flex items-center justify-center",children:(0,a.jsx)(R.Z,{className:"w-5 h-5 text-white"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-white",children:"New Conversation"}),(0,a.jsx)("p",{className:"text-xs text-gray-400",children:"Search for users to start chatting"})]})]}),(0,a.jsx)("button",{onClick:s,className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",children:(0,a.jsx)(ea.Z,{className:"w-5 h-5"})})]}),(0,a.jsxs)("div",{className:"p-5 space-y-4",children:[(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("div",{className:"flex-1 relative",children:[(0,a.jsx)(es.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 w-4 h-4"}),(0,a.jsx)("input",{ref:f,type:"text",placeholder:"Search by username...",value:n,onChange:e=>i(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),S())},className:"w-full pl-10 pr-4 py-3 bg-cipher-darker border border-gray-700 rounded-lg focus:ring-2 focus:ring-cipher-primary focus:border-transparent text-white placeholder-gray-500 transition-all",disabled:"searching"===o})]}),(0,a.jsx)("button",{onClick:S,disabled:"searching"===o||!n.trim(),className:"px-5 py-3 bg-gradient-to-r from-cipher-primary to-cipher-secondary text-white rounded-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2 font-medium",children:"searching"===o?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(er.Z,{className:"w-4 h-4 animate-spin"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"Searching..."})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(es.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"Search"})]})})]}),"error"===o&&h&&(0,a.jsxs)("div",{className:"flex items-center gap-2 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm",children:[(0,a.jsx)(eF.Z,{className:"w-4 h-4 flex-shrink-0"}),(0,a.jsx)("span",{children:h})]}),null===x&&null===y&&h&&"error"!==o&&(0,a.jsxs)("div",{className:"flex items-center gap-2 p-3 rounded-lg text-sm ".concat(h.includes("sent")?"bg-green-500/10 border border-green-500/30 text-green-400":"bg-red-500/10 border border-red-500/30 text-red-400"),children:[h.includes("sent")?(0,a.jsx)(e$.Z,{className:"w-4 h-4 flex-shrink-0"}):(0,a.jsx)(eF.Z,{className:"w-4 h-4 flex-shrink-0"}),(0,a.jsx)("span",{children:h})]}),(0,a.jsxs)("div",{className:"min-h-[200px] max-h-[320px] overflow-y-auto",children:["idle"===o&&(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-[200px] text-gray-500",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4",children:(0,a.jsx)(J.Z,{className:"w-8 h-8 text-gray-600"})}),(0,a.jsxs)("p",{className:"text-center text-sm",children:["Search for a username to start a new",(0,a.jsx)("br",{}),"encrypted conversation"]})]}),"searching"===o&&(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-[200px] text-gray-400",children:[(0,a.jsx)(er.Z,{className:"w-10 h-10 animate-spin mb-4 text-cipher-primary"}),(0,a.jsx)("p",{className:"text-sm",children:"Searching for users..."})]}),"not_found"===o&&(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-[200px] text-gray-500",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4",children:(0,a.jsx)(eF.Z,{className:"w-8 h-8 text-amber-500/70"})}),(0,a.jsx)("p",{className:"text-center font-medium text-amber-400 mb-1",children:"No users found"}),(0,a.jsxs)("p",{className:"text-center text-sm text-gray-500",children:['No users match "',n,'".',(0,a.jsx)("br",{}),"Check the username and try again."]})]}),"success"===o&&l.length>0&&(0,a.jsx)("div",{className:"space-y-2",children:l.map(e=>{k.some(t=>t.username===e.username);let t=x===e.id,s=y===e.id,r=e.is_friend||_.some(t=>t.contact_username===e.username);return(0,a.jsxs)("div",{className:"flex items-center justify-between p-3 border border-gray-700 rounded-lg hover:bg-cipher-darker/70 transition-colors group",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"w-11 h-11 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-full flex items-center justify-center text-white font-semibold shadow-lg",children:e.username[0].toUpperCase()}),e.is_online&&(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-cipher-dark"})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("p",{className:"font-medium text-white flex items-center gap-2",children:[e.username,r&&(0,a.jsxs)("span",{className:"text-xs px-1.5 py-0.5 bg-green-500/20 text-green-400 rounded flex items-center gap-1",children:[(0,a.jsx)(e$.Z,{className:"w-3 h-3"}),"Friend"]}),e.has_pending_request&&!r&&(0,a.jsxs)("span",{className:"text-xs px-1.5 py-0.5 bg-yellow-500/20 text-yellow-400 rounded flex items-center gap-1",children:[(0,a.jsx)(eD.Z,{className:"w-3 h-3"}),"Pending"]})]}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:r?"You can chat with this user":e.has_pending_request?"Friend request sent":"Send friend request to chat"})]})]}),r?(0,a.jsx)("button",{onClick:()=>D(e),disabled:t,className:"px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed",children:t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(er.Z,{className:"w-4 h-4 animate-spin"}),(0,a.jsx)("span",{children:"Opening..."})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(R.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Chat"})]})}):e.has_pending_request?(0,a.jsxs)("span",{className:"px-4 py-2 rounded-lg text-sm font-medium bg-yellow-500/20 text-yellow-400 flex items-center gap-2",children:[(0,a.jsx)(eD.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Pending"})]}):(0,a.jsx)("button",{onClick:()=>E(e),disabled:s,className:"px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 bg-gradient-to-r from-cipher-primary to-cipher-secondary text-white hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed",children:s?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(er.Z,{className:"w-4 h-4 animate-spin"}),(0,a.jsx)("span",{children:"Sending..."})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(J.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Add Friend"})]})})]},e.id)})})]})]}),(0,a.jsx)("div",{className:"px-5 py-3 border-t border-gray-700 bg-cipher-darker/50",children:(0,a.jsxs)("p",{className:"text-xs text-gray-500 text-center flex items-center justify-center gap-1",children:[(0,a.jsx)("span",{className:"inline-block w-2 h-2 bg-green-500 rounded-full"}),"All conversations are end-to-end encrypted"]})})]})}):null}var e1=s(597),e2=s(1541),e4=s(820),e5=s(1213),e3=s(1813);function e8(){let{settings:e,updateWallpaper:t}=(0,C.MU)(),{wallpaper:s}=e,n=(0,r.useRef)(null),[i,l]=(0,r.useState)(""),[c,o]=(0,r.useState)(!1),[d,u]=(0,r.useState)(!1),m=e=>{t({type:"preset",value:e,enabled:"none"!==e})},h=e=>{if(!e.type.startsWith("image/")){alert("Please upload an image file");return}if(e.size>5242880){alert("Image must be less than 5MB");return}let s=new FileReader;s.onload=e=>{var s;let a=null===(s=e.target)||void 0===s?void 0:s.result;a&&((0,C.P9)(a),t({type:"custom",value:a,enabled:!0}))},s.readAsDataURL(e)},g=()=>{(0,C.ss)(),t({enabled:!1,type:"preset",value:"none"})};return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3 pb-4 border-b border-gray-800",children:[(0,a.jsx)("div",{className:"p-2 bg-cyan-500/20 rounded-lg",children:(0,a.jsx)(eB.Z,{className:"w-5 h-5 text-cyan-400"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-white",children:"Chat Wallpaper"}),(0,a.jsx)("p",{className:"text-sm text-gray-400",children:"Customize your chat background"})]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 bg-gray-800/50 rounded-xl",children:[(0,a.jsx)("span",{className:"text-white",children:"Enable Wallpaper"}),(0,a.jsx)("button",{onClick:()=>t({enabled:!s.enabled}),className:"relative w-14 h-7 rounded-full transition-colors ".concat(s.enabled?"bg-cyan-500":"bg-gray-600"),children:(0,a.jsx)(z.E.div,{animate:{x:s.enabled?28:4},className:"absolute top-1 w-5 h-5 bg-white rounded-full"})})]}),s.enabled&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(e1.Z,{className:"w-4 h-4 text-gray-400"}),(0,a.jsx)("span",{className:"text-sm font-medium text-gray-300",children:"Presets"})]}),(0,a.jsx)("div",{className:"grid grid-cols-4 sm:grid-cols-5 gap-3",children:C.CY.map(e=>(0,a.jsxs)("button",{onClick:()=>m(e.id),className:"group relative aspect-square rounded-xl overflow-hidden border-2 transition-all ".concat("preset"===s.type&&s.value===e.id?"border-cyan-500 ring-2 ring-cyan-500/30":"border-gray-700 hover:border-gray-600"),title:e.name,children:["none"===e.id?(0,a.jsx)("div",{className:"w-full h-full bg-gray-800 flex items-center justify-center",children:(0,a.jsx)(ea.Z,{className:"w-6 h-6 text-gray-500"})}):"dots"===e.id||"grid"===e.id?(0,a.jsx)("div",{className:"w-full h-full bg-gray-900",style:{backgroundImage:e.value,backgroundSize:"dots"===e.id?"20px 20px":"40px 40px"}}):(0,a.jsx)("div",{className:"w-full h-full",style:{background:e.value}}),"preset"===s.type&&s.value===e.id&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-black/30",children:(0,a.jsx)("div",{className:"w-6 h-6 bg-cyan-500 rounded-full flex items-center justify-center",children:(0,a.jsx)(eE.Z,{className:"w-4 h-4 text-white"})})}),(0,a.jsx)("div",{className:"absolute bottom-0 left-0 right-0 py-1 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,a.jsx)("span",{className:"text-[10px] text-white text-center block truncate px-1",children:e.name})})]},e.id))})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(e2.Z,{className:"w-4 h-4 text-gray-400"}),(0,a.jsx)("span",{className:"text-sm font-medium text-gray-300",children:"Custom Image"})]}),(0,a.jsxs)("div",{onClick:()=>{var e;return null===(e=n.current)||void 0===e?void 0:e.click()},onDragOver:e=>{e.preventDefault(),u(!0)},onDragLeave:()=>{u(!1)},onDrop:e=>{e.preventDefault(),u(!1);let t=e.dataTransfer.files[0];t&&h(t)},className:"relative border-2 border-dashed rounded-xl p-6 text-center cursor-pointer transition-colors ".concat(d?"border-cyan-500 bg-cyan-500/10":"border-gray-700 hover:border-gray-600 bg-gray-800/30"),children:[(0,a.jsx)("input",{ref:n,type:"file",accept:"image/*",onChange:e=>{var t;let s=null===(t=e.target.files)||void 0===t?void 0:t[0];s&&h(s)},className:"hidden"}),"custom"===s.type?(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("img",{src:s.value,alt:"Custom wallpaper",className:"w-full h-24 object-cover rounded-lg"}),(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),g()},className:"absolute -top-2 -right-2 p-1 bg-red-500 rounded-full hover:bg-red-600",children:(0,a.jsx)(eZ.Z,{className:"w-3 h-3 text-white"})})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e2.Z,{className:"w-8 h-8 text-gray-500 mx-auto mb-2"}),(0,a.jsx)("p",{className:"text-sm text-gray-400",children:"Click or drag image here"}),(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Max 5MB"})]})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("button",{onClick:()=>o(!c),className:"flex items-center gap-2 text-sm text-gray-300 hover:text-white",children:[(0,a.jsx)(e4.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Image URL"})]}),c&&(0,a.jsxs)(z.E.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},className:"flex gap-2",children:[(0,a.jsx)("input",{type:"url",value:i,onChange:e=>l(e.target.value),placeholder:"https://example.com/image.jpg",className:"flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"}),(0,a.jsx)("button",{onClick:()=>{i.trim()&&(t({type:"url",value:i.trim(),enabled:!0}),o(!1),l(""))},className:"px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-lg text-white text-sm font-medium",children:"Apply"})]})]}),(0,a.jsxs)("div",{className:"space-y-4 pt-4 border-t border-gray-800",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(e5.Z,{className:"w-4 h-4 text-gray-400"}),(0,a.jsx)("span",{className:"text-sm font-medium text-gray-300",children:"Adjustments"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-gray-400",children:"Opacity"}),(0,a.jsxs)("span",{className:"text-white",children:[s.opacity,"%"]})]}),(0,a.jsx)("input",{type:"range",min:"10",max:"100",value:s.opacity,onChange:e=>t({opacity:Number(e.target.value)}),className:"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-cyan-500"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-gray-400",children:"Blur"}),(0,a.jsxs)("span",{className:"text-white",children:[s.blur,"px"]})]}),(0,a.jsx)("input",{type:"range",min:"0",max:"20",value:s.blur,onChange:e=>t({blur:Number(e.target.value)}),className:"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-cyan-500"})]})]}),(0,a.jsxs)("div",{className:"pt-4 border-t border-gray-800",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,a.jsx)(e3.Z,{className:"w-4 h-4 text-gray-400"}),(0,a.jsx)("span",{className:"text-sm font-medium text-gray-300",children:"Preview"})]}),(0,a.jsxs)("div",{className:"relative h-32 rounded-xl overflow-hidden bg-gray-800",children:[s.enabled&&(0,a.jsx)("div",{className:"absolute inset-0",style:{backgroundImage:function(e){if(!e.enabled)return"none";if("preset"===e.type){let t=C.CY.find(t=>t.id===e.value);return t&&"none"!==t.id&&"value"in t?t.value:"none"}return"custom"===e.type||"url"===e.type?"url(".concat(e.value,")"):"none"}(s),backgroundSize:"custom"===s.type||"url"===s.type?"cover":"initial",backgroundPosition:"center",backgroundRepeat:"custom"===s.type||"url"===s.type?"no-repeat":"initial",opacity:s.opacity/100,filter:"blur(".concat(s.blur,"px)")}}),(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"max-w-[80%] space-y-2",children:[(0,a.jsx)("div",{className:"h-3 w-24 bg-gray-600 rounded-full"}),(0,a.jsx)("div",{className:"h-3 w-32 bg-gray-700 rounded-full"})]})})]})]})]})]})}var e6=s(3021),e9=s(4135),e7=s(3088),te=s(6369),tt=s(7346);function ts(e){let{isOpen:t,onClose:s}=e,{user:n,logout:i}=P(),[l,c]=(0,r.useState)("profile"),{settings:d,updateSettings:u,getAccentGradient:m}=(0,C.MU)(),{theme:h,accent:g,fontSize:x,density:p,messagePreview:y,animationsEnabled:b}=d,[f,v]=(0,r.useState)("rounded"),[w,j]=(0,r.useState)("inter");(0,r.useEffect)(()=>{v(M()),j(T())},[]);let N=e=>{u(e),o.updateSettings(e).catch(e=>console.error("Failed to save settings to server:",e))},k=e=>{v(e),function(e){try{localStorage.setItem(D,e)}catch(e){console.error("Failed to save bubble style:",e)}}(e)},_=e=>{j(e),function(e){try{localStorage.setItem(E,e)}catch(e){console.error("Failed to save font style:",e)}}(e)},S=[{id:"profile",label:"Profile",icon:O.Z},{id:"security",label:"Security",icon:I.Z},{id:"notifications",label:"Notifications",icon:e6.Z},{id:"appearance",label:"Appearance",icon:e1.Z}];return t?(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Settings"}),(0,a.jsx)("button",{onClick:s,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300",children:(0,a.jsx)(ea.Z,{className:"w-6 h-6"})})]}),(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)("div",{className:"w-64 bg-gray-50 dark:bg-gray-900 p-4",children:(0,a.jsx)("nav",{className:"space-y-2",children:S.map(e=>{let t=e.icon;return(0,a.jsxs)("button",{onClick:()=>c(e.id),className:"w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-left transition-colors ".concat(l===e.id?"bg-blue-600 text-white":"text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700"),children:[(0,a.jsx)(t,{className:"w-5 h-5"}),(0,a.jsx)("span",{children:e.label})]},e.id)})})}),(0,a.jsxs)("div",{className:"flex-1 p-6 overflow-y-auto max-h-[calc(90vh-80px)]",children:["profile"===l&&(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Profile Information"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Username"}),(0,a.jsx)("input",{type:"text",value:(null==n?void 0:n.username)||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Email"}),(0,a.jsx)("input",{type:"email",value:(null==n?void 0:n.email)||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white"})]})]}),(0,a.jsx)("div",{className:"pt-4 border-t border-gray-200 dark:border-gray-700",children:(0,a.jsx)("button",{onClick:()=>{i(),s()},className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Sign Out"})})]}),"security"===l&&(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Security & Privacy"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"p-4 bg-green-50 dark:bg-green-900/20 rounded-lg",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 mb-2",children:[(0,a.jsx)(I.Z,{className:"w-5 h-5 text-green-600"}),(0,a.jsx)("span",{className:"font-medium text-green-800 dark:text-green-200",children:"End-to-End Encryption Active"})]}),(0,a.jsx)("p",{className:"text-sm text-green-700 dark:text-green-300",children:"Your messages are encrypted with X25519 + Ed25519 cryptography. Only you and your recipients can read them."})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("h4",{className:"font-medium text-gray-900 dark:text-white",children:"Cryptographic Keys"}),(0,a.jsxs)("button",{onClick:()=>{console.log("Exporting keys...")},className:"flex items-center space-x-2 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700",children:[(0,a.jsx)(eI.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Export Key Backup"})]}),(0,a.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Export your keys for backup or device migration. Keep this file secure."})]})]})]}),"notifications"===l&&(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Notification Preferences"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Message Notifications"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Get notified when you receive new messages"})]}),(0,a.jsx)("input",{type:"checkbox",defaultChecked:!0,className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Sound Notifications"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Play sound for new messages"})]}),(0,a.jsx)("input",{type:"checkbox",defaultChecked:!0,className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"})]})]})]}),"appearance"===l&&(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Appearance"}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Theme Mode"}),(0,a.jsx)("div",{className:"grid grid-cols-3 gap-3",children:[{value:"light",icon:e9.Z,label:"Light"},{value:"dark",icon:e7.Z,label:"Dark"},{value:"system",icon:eN.Z,label:"System"}].map(e=>{let t=e.icon,s=h===e.value;return(0,a.jsxs)("button",{onClick:()=>N({theme:e.value}),className:"flex flex-col items-center gap-2 p-4 rounded-lg border-2 transition-all ".concat(s?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:[(0,a.jsx)(t,{className:"w-6 h-6 ".concat(s?"text-blue-500":"text-gray-500")}),(0,a.jsx)("span",{className:"text-sm font-medium ".concat(s?"text-blue-600 dark:text-blue-400":"text-gray-700 dark:text-gray-300"),children:e.label}),s&&(0,a.jsx)(eE.Z,{className:"w-4 h-4 text-blue-500 absolute top-2 right-2"})]},e.value)})})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Accent Color"}),(0,a.jsx)("div",{className:"flex flex-wrap gap-3",children:Object.keys(C.FN).map(e=>{let t=C.FN[e],s=g===e;return(0,a.jsx)("button",{onClick:()=>N({accent:e}),className:"relative w-12 h-12 rounded-full transition-transform hover:scale-110 ".concat(s?"ring-2 ring-offset-2 ring-offset-white dark:ring-offset-gray-800":""),style:{background:"linear-gradient(135deg, ".concat(t.primary,", ").concat(t.secondary,")"),boxShadow:s?"0 0 0 2px ".concat(t.primary):void 0},title:t.name,children:s&&(0,a.jsx)(eE.Z,{className:"w-5 h-5 text-white absolute inset-0 m-auto"})},e)})}),(0,a.jsxs)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Selected: ",C.FN[g].name]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Font Size"}),(0,a.jsx)("div",{className:"flex items-center gap-4",children:[{value:"small",label:"Small",size:"text-sm"},{value:"medium",label:"Medium",size:"text-base"},{value:"large",label:"Large",size:"text-lg"}].map(e=>{let t=x===e.value;return(0,a.jsx)("button",{onClick:()=>N({fontSize:e.value}),className:"px-4 py-2 rounded-lg border-2 transition-all ".concat(e.size," ").concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400":"border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:border-gray-300"),children:e.label},e.value)})})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Chat Density"}),(0,a.jsx)("div",{className:"space-y-2",children:[{value:"compact",label:"Compact",desc:"More messages visible"},{value:"comfortable",label:"Comfortable",desc:"Balanced spacing"},{value:"spacious",label:"Spacious",desc:"More breathing room"}].map(e=>{let t=p===e.value;return(0,a.jsx)("label",{className:"flex items-center justify-between p-3 rounded-lg border-2 cursor-pointer transition-all ".concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300"),children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("input",{type:"radio",name:"density",checked:t,onChange:()=>N({density:e.value}),className:"w-4 h-4 text-blue-600"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium ".concat(t?"text-blue-600 dark:text-blue-400":"text-gray-900 dark:text-white"),children:e.label}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:e.desc})]})]})},e.value)})})]}),(0,a.jsxs)("div",{className:"space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Additional Options"}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Message Preview"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Show message preview in sidebar"})]}),(0,a.jsx)("button",{onClick:()=>N({messagePreview:!y}),className:"relative w-12 h-6 rounded-full transition-colors ".concat(y?"bg-blue-600":"bg-gray-300 dark:bg-gray-600"),children:(0,a.jsx)("div",{className:"absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ".concat(y?"translate-x-7":"translate-x-1")})})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Animations"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Enable UI animations and transitions"})]}),(0,a.jsx)("button",{onClick:()=>N({animationsEnabled:!b}),className:"relative w-12 h-6 rounded-full transition-colors ".concat(b?"bg-blue-600":"bg-gray-300 dark:bg-gray-600"),children:(0,a.jsx)("div",{className:"absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ".concat(b?"translate-x-7":"translate-x-1")})})]})]}),(0,a.jsxs)("div",{className:"space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Message Style"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:"Your message style will be visible to recipients"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Bubble Style"}),(0,a.jsx)("div",{className:"grid grid-cols-3 gap-3",children:[{value:"rounded",label:"Rounded",desc:"Classic"},{value:"glass",label:"Glass",desc:"Translucent"},{value:"neon",label:"Neon",desc:"Glow effect"}].map(e=>{let t=f===e.value;return(0,a.jsxs)("button",{onClick:()=>k(e.value),className:"flex flex-col items-center gap-1.5 p-3 rounded-lg border-2 transition-all ".concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:[(0,a.jsx)("div",{className:"w-12 h-8 rounded-lg flex items-center justify-center ".concat("glass"===e.value?"backdrop-blur-md border border-white/20":"neon"===e.value?"shadow-lg":""),style:{background:"linear-gradient(135deg, ".concat(C.FN[g].primary,", ").concat(C.FN[g].secondary,")"),boxShadow:"neon"===e.value?"0 0 10px ".concat(C.FN[g].primary,"50"):void 0},children:(0,a.jsx)(te.Z,{className:"w-3 h-3 text-white"})}),(0,a.jsx)("span",{className:"text-xs font-medium ".concat(t?"text-blue-600 dark:text-blue-400":"text-gray-700 dark:text-gray-300"),children:e.label})]},e.value)})})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Message Font"}),(0,a.jsx)("div",{className:"grid grid-cols-2 gap-3",children:[{value:"inter",label:"Sans-serif",sample:"Hello!"},{value:"mono",label:"Monospace",sample:"Hello!"}].map(e=>{let t=w===e.value;return(0,a.jsxs)("button",{onClick:()=>_(e.value),className:"flex items-center gap-3 p-3 rounded-lg border-2 transition-all ".concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:[(0,a.jsx)(tt.Z,{className:"w-5 h-5 ".concat(t?"text-blue-500":"text-gray-500")}),(0,a.jsxs)("div",{className:"text-left",children:[(0,a.jsx)("p",{className:"text-sm font-medium ".concat(t?"text-blue-600 dark:text-blue-400":"text-gray-700 dark:text-gray-300"),children:e.label}),(0,a.jsx)("p",{className:"text-xs text-gray-500 ".concat("mono"===e.value?"font-mono":"font-sans"),children:e.sample})]})]},e.value)})})]})]}),(0,a.jsx)("div",{className:"space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:(0,a.jsx)(e8,{})}),(0,a.jsxs)("div",{className:"space-y-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Preview"}),(0,a.jsxs)("div",{className:"p-4 rounded-lg bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700",children:[(0,a.jsxs)("div",{className:"flex items-start gap-3",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center text-white font-medium",style:{background:"linear-gradient(135deg, ".concat(C.FN[g].primary,", ").concat(C.FN[g].secondary,")")},children:"J"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"font-medium text-gray-900 dark:text-white",children:"John Doe"}),(0,a.jsx)("span",{className:"text-xs text-gray-500",children:"12:34 PM"})]}),(0,a.jsx)("p",{className:"text-gray-700 dark:text-gray-300 mt-1",children:"This is how your messages will look with the current settings! \uD83C\uDFA8"})]})]}),(0,a.jsx)("div",{className:"flex justify-end mt-3",children:(0,a.jsxs)("div",{className:"px-4 py-2 rounded-2xl text-white max-w-xs",style:{background:"linear-gradient(135deg, ".concat(C.FN[g].primary,", ").concat(C.FN[g].secondary,")")},children:[(0,a.jsx)("p",{children:"Looking great! ✨"}),(0,a.jsx)("div",{className:"flex justify-end mt-1",children:(0,a.jsx)("span",{className:"text-xs opacity-70",children:"12:35 PM"})})]})})]})]})]})]})]})]})}):null}var ta=s(8142),tr=s(6601),tn=s(4035);function ti(e){let{isOpen:t,onClose:s,onScanSuccess:n}=e,i=(0,r.useRef)(null),[l,c]=(0,r.useState)(!1),[o,d]=(0,r.useState)(null),[m,h]=(0,r.useState)(null),[g,x]=(0,r.useState)(!1),[p,y]=(0,r.useState)(!1),[b,f]=(0,r.useState)(""),[v,w]=(0,r.useState)(!1),j=(0,r.useRef)(null),N=(0,r.useRef)(null),k=(0,r.useRef)(null),_=(0,r.useCallback)(()=>{N.current&&(N.current.stop(),N.current=null),k.current&&(k.current.getTracks().forEach(e=>e.stop()),k.current=null),c(!1)},[]),C=(0,r.useCallback)(async()=>{if(i.current)try{d(null),c(!0);let e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});k.current=e,i.current.srcObject=e,await i.current.play();let t=new tr.Nm;j.current=t;let s=await t.decodeFromVideoElement(i.current,(e,t,s)=>{if(e){let t=e.getText();S(t),s.stop()}});N.current=s}catch(e){console.error("Camera error:",e),d("Failed to access camera. Please grant camera permission or use manual input."),c(!1)}},[]),S=async e=>{if(!g){_(),x(!0);try{let t=JSON.parse(e);if(!t.user_id||!t.username||!t.public_key_fingerprint)throw Error("Invalid QR code format");await D(t)}catch(e){console.error("Parse error:",e),d(e.message||"Invalid QR code data"),x(!1)}}},D=async e=>{try{if(Math.floor(Date.now()/1e3)-e.timestamp>300){d("QR code has expired. Please ask for a fresh one."),x(!1);return}await u.processQRScan(e),h(e),w(!0),null==n||n(e),setTimeout(()=>{s(),w(!1),h(null)},2e3)}catch(e){var t,a;console.error("Process error:",e),d((null===(a=e.response)||void 0===a?void 0:null===(t=a.data)||void 0===t?void 0:t.detail)||"Failed to process QR code"),x(!1)}},E=async()=>{b.trim()&&await S(b.trim())};return((0,r.useEffect)(()=>(t?C():_(),()=>{_()}),[t,C,_]),t)?(0,a.jsx)(B.M,{children:(0,a.jsx)(z.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4",onClick:s,children:(0,a.jsxs)(z.E.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-gray-900 rounded-2xl w-full max-w-md overflow-hidden shadow-2xl border border-gray-800",onClick:e=>e.stopPropagation(),children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-800 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(tn.Z,{className:"w-5 h-5 text-blue-400"}),(0,a.jsx)("h2",{className:"text-lg font-semibold text-white",children:"Scan QR Code"})]}),(0,a.jsx)("button",{onClick:s,className:"p-2 hover:bg-gray-800 rounded-lg transition-colors",children:(0,a.jsx)(ea.Z,{className:"w-5 h-5 text-gray-400"})})]}),!p&&(0,a.jsxs)("div",{className:"relative aspect-square bg-black",children:[(0,a.jsx)("video",{ref:i,className:"w-full h-full object-cover",playsInline:!0,muted:!0}),(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:(0,a.jsxs)("div",{className:"w-56 h-56 border-2 border-white/30 rounded-lg relative",children:[(0,a.jsx)("div",{className:"absolute -top-1 -left-1 w-6 h-6 border-t-4 border-l-4 border-blue-500"}),(0,a.jsx)("div",{className:"absolute -top-1 -right-1 w-6 h-6 border-t-4 border-r-4 border-blue-500"}),(0,a.jsx)("div",{className:"absolute -bottom-1 -left-1 w-6 h-6 border-b-4 border-l-4 border-blue-500"}),(0,a.jsx)("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 border-b-4 border-r-4 border-blue-500"}),l&&!g&&!v&&(0,a.jsx)(z.E.div,{className:"absolute left-0 right-0 h-0.5 bg-blue-500 shadow-lg shadow-blue-500/50",initial:{top:0},animate:{top:"100%"},transition:{duration:2,repeat:1/0,ease:"linear"}})]})}),v&&(0,a.jsx)(z.E.div,{initial:{opacity:0},animate:{opacity:1},className:"absolute inset-0 bg-green-500/20 flex items-center justify-center",children:(0,a.jsx)("div",{className:"bg-green-500 rounded-full p-4",children:(0,a.jsx)(eE.Z,{className:"w-12 h-12 text-white"})})}),g&&(0,a.jsx)("div",{className:"absolute inset-0 bg-black/60 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"flex flex-col items-center",children:[(0,a.jsx)(er.Z,{className:"w-10 h-10 text-blue-500 animate-spin mb-2"}),(0,a.jsx)("p",{className:"text-white text-sm",children:"Processing..."})]})})]}),(0,a.jsxs)("div",{className:"p-4",children:[o&&(0,a.jsxs)(z.E.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm mb-4 flex items-start gap-2",children:[(0,a.jsx)(eF.Z,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),(0,a.jsx)("span",{children:o})]}),v&&m&&(0,a.jsxs)(z.E.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"p-3 bg-green-500/10 border border-green-500/20 rounded-lg text-green-400 text-sm mb-4",children:[(0,a.jsx)("p",{className:"font-medium",children:"Friend request sent!"}),(0,a.jsxs)("p",{className:"text-green-400/70",children:["Connected with ",m.username]})]}),(0,a.jsx)(B.M,{mode:"wait",children:p?(0,a.jsxs)(z.E.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-3",children:[(0,a.jsx)("p",{className:"text-xs text-gray-500 mb-2",children:"Paste the QR code JSON data manually:"}),(0,a.jsx)("textarea",{value:b,onChange:e=>f(e.target.value),placeholder:'{"user_id": 123, "username": "...", "public_key_fingerprint": "...", "timestamp": 1234567890, "signature": "..."}',className:"w-full h-32 bg-gray-800 text-white text-xs font-mono rounded-lg p-3 border border-gray-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none resize-none"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{onClick:()=>y(!1),className:"flex-1 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors text-sm",children:"Back to Camera"}),(0,a.jsx)("button",{onClick:E,disabled:!b.trim()||g,className:"flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:text-gray-500 text-white rounded-lg transition-colors text-sm flex items-center justify-center gap-2",children:g?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(er.Z,{className:"w-4 h-4 animate-spin"}),"Processing..."]}):"Submit"})]})]}):(0,a.jsxs)(z.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"flex flex-col gap-3",children:[(0,a.jsx)("p",{className:"text-sm text-gray-400 text-center",children:"Align the QR code within the frame to scan"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("button",{onClick:()=>y(!0),className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors text-sm",children:[(0,a.jsx)(ta.Z,{className:"w-4 h-4"}),"Manual Input"]}),o&&(0,a.jsxs)("button",{onClick:C,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm",children:[(0,a.jsx)(ee.Z,{className:"w-4 h-4"}),"Retry Camera"]})]})]})})]}),(0,a.jsx)("div",{className:"p-4 bg-gray-800/50 border-t border-gray-800",children:(0,a.jsxs)("p",{className:"text-xs text-gray-500 flex items-center justify-center gap-2",children:[(0,a.jsx)(I.Z,{className:"w-3 h-3"}),"QR codes contain signed key fingerprints for secure contact exchange"]})})]})})}):null}function tl(e){let{isOpen:t,onClose:s,currentUserPublicKey:n,onRequestSent:i}=e,{token:l}=P(),[c,o]=(0,r.useState)("search"),[d,h]=(0,r.useState)(!1),[g,x]=(0,r.useState)(""),[p,y]=(0,r.useState)("username"),[b,f]=(0,r.useState)([]),[v,w]=(0,r.useState)(!1),[j,N]=(0,r.useState)(!1),[k,_]=(0,r.useState)(null),[C,S]=(0,r.useState)(null),[D,E]=(0,r.useState)("");(0,r.useEffect)(()=>{l&&u.setToken(l)},[l]),(0,r.useEffect)(()=>{t&&(o("search"),_(null),S(null))},[t]);let M=(0,r.useCallback)(async()=>{if(g.length<2){f([]);return}w(!0),_(null);try{let e=await u.searchUsers(g,p);f(e)}catch(t){var e;(null===(e=t.response)||void 0===e?void 0:e.status)===429?_("Search rate limit reached. Please wait before searching again."):_("Failed to search users. Please try again."),f([])}finally{w(!1)}},[g,p]),T=async e=>{if(!j){N(!0),_(null),S(null);try{let t=m(n),s={receiver_username:e.username,sender_public_key_fingerprint:t,message:D||void 0};await u.sendFriendRequest(s),S("Friend request sent to ".concat(e.username,"!")),E(""),f(t=>t.map(t=>t.user_id===e.user_id?{...t,has_pending_request:!0}:t)),null==i||i()}catch(e){var t,s,a;(null===(t=e.response)||void 0===t?void 0:t.status)===429?_("Friend request rate limit reached. Please wait before sending more requests."):(null===(a=e.response)||void 0===a?void 0:null===(s=a.data)||void 0===s?void 0:s.detail)?_(e.response.data.detail):_("Failed to send friend request. Please try again.")}finally{N(!1)}}};return t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(B.M,{children:(0,a.jsx)(z.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",onClick:s,children:(0,a.jsxs)(z.E.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-gray-900 rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden shadow-2xl border border-gray-800",onClick:e=>e.stopPropagation(),children:[(0,a.jsxs)("div",{className:"p-6 border-b border-gray-800",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("h2",{className:"text-xl font-semibold text-white flex items-center gap-2",children:[(0,a.jsx)(J.Z,{className:"w-6 h-6 text-blue-400"}),"Add Friend"]}),(0,a.jsx)("button",{onClick:s,className:"p-2 hover:bg-gray-800 rounded-lg transition-colors",children:(0,a.jsx)(ea.Z,{className:"w-5 h-5 text-gray-400"})})]}),(0,a.jsxs)("div",{className:"flex gap-2 mt-4 p-1 bg-gray-800/50 rounded-lg",children:[(0,a.jsxs)("button",{onClick:()=>o("search"),className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ".concat("search"===c?"bg-blue-600 text-white":"text-gray-400 hover:text-white hover:bg-gray-700/50"),children:[(0,a.jsx)(es.Z,{className:"w-4 h-4"}),"Search"]}),(0,a.jsxs)("button",{onClick:()=>o("scan"),className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ".concat("scan"===c?"bg-blue-600 text-white":"text-gray-400 hover:text-white hover:bg-gray-700/50"),children:[(0,a.jsx)(eU.Z,{className:"w-4 h-4"}),"Scan QR"]})]})]}),(0,a.jsx)("div",{className:"p-6",children:(0,a.jsx)(B.M,{mode:"wait",children:"search"===c?(0,a.jsxs)(z.E.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("select",{value:p,onChange:e=>y(e.target.value),className:"bg-gray-800 text-gray-300 rounded-lg px-3 py-2 text-sm border border-gray-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none",children:[(0,a.jsx)("option",{value:"username",children:"Username"}),(0,a.jsx)("option",{value:"user_id",children:"User ID"}),(0,a.jsx)("option",{value:"fingerprint",children:"Fingerprint"})]}),(0,a.jsx)("input",{type:"text",placeholder:"Search by ".concat(p,"..."),value:g,onChange:e=>x(e.target.value),onKeyDown:e=>"Enter"===e.key&&M(),className:"flex-1 bg-gray-800 text-white rounded-lg px-4 py-2 border border-gray-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none placeholder-gray-500"}),(0,a.jsxs)("button",{onClick:M,disabled:v||g.length<2,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:text-gray-500 text-white rounded-lg transition-colors flex items-center gap-2",children:[v?(0,a.jsx)(er.Z,{className:"w-4 h-4 animate-spin"}):(0,a.jsx)(es.Z,{className:"w-4 h-4"}),"Search"]})]}),(0,a.jsx)("input",{type:"text",placeholder:"Add a message (optional)",value:D,onChange:e=>E(e.target.value),maxLength:200,className:"w-full bg-gray-800 text-white rounded-lg px-4 py-2 border border-gray-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none placeholder-gray-500 text-sm"})]}),k&&(0,a.jsx)("div",{className:"p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm",children:k}),C&&(0,a.jsx)("div",{className:"p-3 bg-green-500/10 border border-green-500/20 rounded-lg text-green-400 text-sm",children:C}),(0,a.jsx)("div",{className:"overflow-y-auto max-h-[40vh]",children:0===b.length?(0,a.jsx)("div",{className:"text-center text-gray-500 py-8",children:g.length>=2?"No users found. Try a different search.":"Enter at least 2 characters to search."}):(0,a.jsx)("div",{className:"space-y-3",children:b.map(e=>(0,a.jsxs)(z.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex items-center justify-between p-4 bg-gray-800/50 rounded-xl border border-gray-700/50 hover:border-gray-600 transition-colors",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-semibold",children:e.username[0].toUpperCase()}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium text-white",children:e.username}),e.public_key_fingerprint&&(0,a.jsxs)("div",{className:"text-xs text-gray-500 font-mono",children:["\uD83D\uDD11 ",function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e?t?e.split(":").slice(0,4).join(":"):e:""}(e.public_key_fingerprint,!0)]})]})]}),(0,a.jsx)("div",{children:e.is_contact?(0,a.jsx)("span",{className:"px-3 py-1 bg-green-500/10 text-green-400 rounded-full text-sm",children:"✓ Contact"}):e.has_pending_request?(0,a.jsx)("span",{className:"px-3 py-1 bg-yellow-500/10 text-yellow-400 rounded-full text-sm",children:"⏳ Pending"}):(0,a.jsxs)("button",{onClick:()=>T(e),disabled:j,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 text-white rounded-lg text-sm transition-colors flex items-center gap-2",children:[j?(0,a.jsx)(er.Z,{className:"w-4 h-4 animate-spin"}):(0,a.jsx)(J.Z,{className:"w-4 h-4"}),"Add"]})})]},e.user_id))})})]},"search"):(0,a.jsxs)(z.E.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"text-center py-8",children:[(0,a.jsx)("div",{className:"w-20 h-20 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-6",children:(0,a.jsx)(eU.Z,{className:"w-10 h-10 text-blue-400"})}),(0,a.jsx)("h3",{className:"text-lg font-medium text-white mb-2",children:"Scan QR Code"}),(0,a.jsx)("p",{className:"text-gray-400 text-sm mb-6 max-w-xs mx-auto",children:"Scan another user's QR code to quickly add them as a contact without searching"}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("button",{onClick:()=>h(!0),className:"w-full flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors font-medium",children:[(0,a.jsx)(eU.Z,{className:"w-5 h-5"}),"Open QR Scanner"]}),(0,a.jsxs)("button",{onClick:()=>o("search"),className:"w-full flex items-center justify-center gap-2 px-6 py-3 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-xl transition-colors",children:[(0,a.jsx)(ta.Z,{className:"w-5 h-5"}),"Enter Code Manually"]})]}),C&&(0,a.jsx)(z.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mt-4 p-3 bg-green-500/10 border border-green-500/20 rounded-lg text-green-400 text-sm",children:C})]},"scan")})}),(0,a.jsx)("div",{className:"p-4 bg-gray-800/50 border-t border-gray-800",children:(0,a.jsxs)("p",{className:"text-xs text-gray-500 flex items-center justify-center gap-2",children:[(0,a.jsx)(I.Z,{className:"w-3 h-3"}),"search"===c?"Friend requests include your public key fingerprint for secure key exchange.":"QR codes contain signed key fingerprints and expire after 5 minutes for security."]})})]})})}),(0,a.jsx)(ti,{isOpen:d,onClose:()=>h(!1),onScanSuccess:()=>{S("Friend request sent via QR code!"),null==i||i()}})]}):null}function tc(e){let{isOpen:t,onClose:s,currentUserPublicKey:n,onRequestAccepted:i,onRequestRejected:l}=e,{token:c}=P(),[o,d]=(0,r.useState)(null),[h,g]=(0,r.useState)(!1),[x,p]=(0,r.useState)("incoming"),[y,b]=(0,r.useState)(null),[f,v]=(0,r.useState)(null),[w,j]=(0,r.useState)(null);(0,r.useEffect)(()=>{c&&u.setToken(c)},[c]);let N=(0,r.useCallback)(async()=>{g(!0),v(null);try{let e=await u.getPendingRequests();d(e)}catch(e){v("Failed to load pending requests"),console.error(e)}finally{g(!1)}},[]);(0,r.useEffect)(()=>{t&&N()},[t,N]);let k=async e=>{j({request:e,inputFingerprint:""})},_=async()=>{var e,t,s;if(!w)return;let{request:a,inputFingerprint:r}=w;if(e=a.sender_public_key_fingerprint,r.toUpperCase().replace(/\s/g,"")!==e.toUpperCase().replace(/\s/g,"")){v("Fingerprint does not match! This could indicate a man-in-the-middle attack.");return}b(a.id),v(null);try{let e={request_id:a.id,receiver_public_key_fingerprint:m(n),verify_sender_fingerprint:r};await u.acceptFriendRequest(e),d(e=>e?{...e,incoming:e.incoming.filter(e=>e.id!==a.id),total_incoming:e.total_incoming-1}:null),j(null),null==i||i()}catch(e){v((null===(s=e.response)||void 0===s?void 0:null===(t=s.data)||void 0===t?void 0:t.detail)||"Failed to accept request")}finally{b(null)}},C=async e=>{b(e.id),v(null);try{await u.rejectFriendRequest({request_id:e.id}),d(t=>t?{...t,incoming:t.incoming.filter(t=>t.id!==e.id),total_incoming:t.total_incoming-1}:null),null==l||l()}catch(e){var t,s;v((null===(s=e.response)||void 0===s?void 0:null===(t=s.data)||void 0===t?void 0:t.detail)||"Failed to reject request")}finally{b(null)}},S=async e=>{b(e.id),v(null);try{await u.cancelFriendRequest(e.id),d(t=>t?{...t,outgoing:t.outgoing.filter(t=>t.id!==e.id),total_outgoing:t.total_outgoing-1}:null)}catch(e){var t,s;v((null===(s=e.response)||void 0===s?void 0:null===(t=s.data)||void 0===t?void 0:t.detail)||"Failed to cancel request")}finally{b(null)}},D=e=>{let t=new Date(e),s=new Date,a=t.getTime()-s.getTime();if(a<=0)return"Expired";let r=Math.floor(a/864e5),n=Math.floor(a%864e5/36e5);return r>0?"".concat(r,"d ").concat(n,"h remaining"):"".concat(n,"h remaining")};return t?(0,a.jsx)(B.M,{children:(0,a.jsxs)(z.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",onClick:s,children:[(0,a.jsxs)(z.E.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-gray-900 rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden shadow-2xl border border-gray-800",onClick:e=>e.stopPropagation(),children:[(0,a.jsxs)("div",{className:"p-6 border-b border-gray-800",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("h2",{className:"text-xl font-semibold text-white flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-2xl",children:"\uD83D\uDCE8"}),"Friend Requests"]}),(0,a.jsx)("button",{onClick:s,className:"p-2 hover:bg-gray-800 rounded-lg transition-colors",children:(0,a.jsx)("svg",{className:"w-5 h-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,a.jsxs)("div",{className:"flex mt-4 bg-gray-800 rounded-lg p-1",children:[(0,a.jsxs)("button",{onClick:()=>p("incoming"),className:"flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-colors ".concat("incoming"===x?"bg-blue-600 text-white":"text-gray-400 hover:text-white"),children:["Incoming",o&&o.total_incoming>0&&(0,a.jsx)("span",{className:"ml-2 px-2 py-0.5 bg-blue-500 rounded-full text-xs",children:o.total_incoming})]}),(0,a.jsxs)("button",{onClick:()=>p("outgoing"),className:"flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-colors ".concat("outgoing"===x?"bg-blue-600 text-white":"text-gray-400 hover:text-white"),children:["Outgoing",o&&o.total_outgoing>0&&(0,a.jsx)("span",{className:"ml-2 px-2 py-0.5 bg-gray-600 rounded-full text-xs",children:o.total_outgoing})]})]})]}),f&&(0,a.jsx)("div",{className:"mx-6 mt-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm",children:f}),(0,a.jsx)("div",{className:"p-6 overflow-y-auto max-h-[50vh]",children:h?(0,a.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,a.jsxs)("svg",{className:"w-8 h-8 animate-spin text-blue-500",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):"incoming"===x?(null==o?void 0:o.incoming.length)===0?(0,a.jsx)("div",{className:"text-center text-gray-500 py-8",children:"No incoming friend requests"}):(0,a.jsx)("div",{className:"space-y-3",children:null==o?void 0:o.incoming.map(e=>(0,a.jsxs)(z.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"p-4 bg-gray-800/50 rounded-xl border border-gray-700/50",children:[(0,a.jsx)("div",{className:"flex items-center justify-between mb-3",children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-blue-500 flex items-center justify-center text-white font-semibold",children:e.sender_username[0].toUpperCase()}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium text-white",children:e.sender_username}),(0,a.jsx)("div",{className:"text-xs text-gray-500",children:D(e.expires_at)})]})]})}),(0,a.jsxs)("div",{className:"mb-3 p-2 bg-gray-900 rounded-lg",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 mb-1",children:"Sender's Key Fingerprint"}),(0,a.jsxs)("div",{className:"font-mono text-xs text-blue-400 break-all",children:["\uD83D\uDD11 ",e.sender_public_key_fingerprint]})]}),e.message&&(0,a.jsxs)("div",{className:"mb-3 p-2 bg-gray-900 rounded-lg",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 mb-1",children:"Message"}),(0,a.jsx)("div",{className:"text-sm text-gray-300",children:e.message})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("button",{onClick:()=>k(e),disabled:y===e.id,className:"flex-1 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-700 text-white rounded-lg text-sm transition-colors flex items-center justify-center gap-2",children:[y===e.id?(0,a.jsxs)("svg",{className:"w-4 h-4 animate-spin",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):"✓","Accept"]}),(0,a.jsx)("button",{onClick:()=>C(e),disabled:y===e.id,className:"flex-1 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded-lg text-sm transition-colors",children:"✕ Reject"})]})]},e.id))}):(null==o?void 0:o.outgoing.length)===0?(0,a.jsx)("div",{className:"text-center text-gray-500 py-8",children:"No outgoing friend requests"}):(0,a.jsx)("div",{className:"space-y-3",children:null==o?void 0:o.outgoing.map(e=>(0,a.jsx)(z.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"p-4 bg-gray-800/50 rounded-xl border border-gray-700/50",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-semibold",children:e.receiver_username[0].toUpperCase()}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium text-white",children:e.receiver_username}),(0,a.jsx)("div",{className:"text-xs text-gray-500",children:D(e.expires_at)})]})]}),(0,a.jsx)("button",{onClick:()=>S(e),disabled:y===e.id,className:"px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg text-sm transition-colors",children:"Cancel"})]})},e.id))})}),(0,a.jsx)("div",{className:"p-4 bg-gray-800/50 border-t border-gray-800",children:(0,a.jsxs)("p",{className:"text-xs text-gray-500 flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-lg",children:"\uD83D\uDD12"}),"Verify fingerprints in-person or via secure channel to prevent MITM attacks."]})})]}),w&&(0,a.jsx)(z.E.div,{initial:{opacity:0},animate:{opacity:1},className:"fixed inset-0 bg-black/70 z-60 flex items-center justify-center p-4",onClick:()=>j(null),children:(0,a.jsxs)(z.E.div,{initial:{scale:.95},animate:{scale:1},className:"bg-gray-800 rounded-xl p-6 max-w-md w-full border border-gray-700",onClick:e=>e.stopPropagation(),children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold text-white mb-4 flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xl",children:"\uD83D\uDD10"}),"Verify Fingerprint"]}),(0,a.jsxs)("p",{className:"text-sm text-gray-400 mb-4",children:["To ensure secure communication, please verify ",w.request.sender_username,"'s key fingerprint. Ask them to share their fingerprint in-person or via another secure channel."]}),(0,a.jsxs)("div",{className:"mb-4 p-3 bg-gray-900 rounded-lg",children:[(0,a.jsx)("div",{className:"text-xs text-gray-500 mb-2",children:"Expected Fingerprint"}),(0,a.jsx)("div",{className:"font-mono text-sm text-blue-400 break-all",children:w.request.sender_public_key_fingerprint})]}),(0,a.jsx)("input",{type:"text",placeholder:"Enter the fingerprint to verify...",value:w.inputFingerprint,onChange:e=>j({...w,inputFingerprint:e.target.value}),className:"w-full bg-gray-900 text-white rounded-lg px-4 py-3 border border-gray-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none font-mono text-sm mb-4"}),(0,a.jsxs)("div",{className:"flex gap-3",children:[(0,a.jsx)("button",{onClick:()=>j(null),className:"flex-1 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors",children:"Cancel"}),(0,a.jsx)("button",{onClick:_,disabled:!w.inputFingerprint,className:"flex-1 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-700 text-white rounded-lg transition-colors",children:"Verify & Accept"})]})]})})]})}):null}var to=s(2894);function td(e){let{isOpen:t,onClose:s}=e,{token:n,loadContacts:i}=P(),[l,c]=(0,r.useState)([]),[o,d]=(0,r.useState)(!0),[m,h]=(0,r.useState)(null),[g,x]=(0,r.useState)(null),[p,y]=(0,r.useState)(null),[b,f]=(0,r.useState)(""),[v,w]=(0,r.useState)(null);(0,r.useEffect)(()=>{n&&u.setToken(n)},[n]);let j=(0,r.useCallback)(async()=>{d(!0),x(null);try{let e=await u.getBlockedUsers();c(e)}catch(e){x("Failed to load blocked users"),console.error("Error loading blocked users:",e)}finally{d(!1)}},[]);(0,r.useEffect)(()=>{t&&j()},[t,j]);let N=async e=>{h(e),x(null),y(null);try{await u.unblockUser(e),c(t=>t.filter(t=>t.blocked_user_id!==e)),y("User unblocked successfully. Contact relationship restored."),w(null),await i()}catch(e){var t,s;x((null===(s=e.response)||void 0===s?void 0:null===(t=s.data)||void 0===t?void 0:t.detail)||"Failed to unblock user")}finally{h(null)}},k=l.filter(e=>e.blocked_username.toLowerCase().includes(b.toLowerCase())),_=e=>{switch(e){case"spam":return"\uD83D\uDEAB Spam";case"harassment":return"⚠️ Harassment";case"unwanted":return"\uD83D\uDC64 Unwanted contact";default:return"\uD83D\uDCCB Other"}},C=e=>new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"});return t?(0,a.jsx)(B.M,{children:(0,a.jsx)(z.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",onClick:s,children:(0,a.jsxs)(z.E.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-gray-900 rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden shadow-2xl border border-gray-800",onClick:e=>e.stopPropagation(),children:[(0,a.jsxs)("div",{className:"p-6 border-b border-gray-800",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("h2",{className:"text-xl font-semibold text-white flex items-center gap-2",children:[(0,a.jsx)(I.Z,{className:"w-6 h-6 text-red-400"}),"Blocked Users"]}),(0,a.jsx)("button",{onClick:s,className:"p-2 hover:bg-gray-800 rounded-lg transition-colors",children:(0,a.jsx)(ea.Z,{className:"w-5 h-5 text-gray-400"})})]}),(0,a.jsx)("p",{className:"mt-2 text-sm text-gray-400",children:"Blocked users cannot send you messages, friend requests, or see your profile."}),l.length>0&&(0,a.jsxs)("div",{className:"mt-4 relative",children:[(0,a.jsx)(es.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"}),(0,a.jsx)("input",{type:"text",placeholder:"Search blocked users...",value:b,onChange:e=>f(e.target.value),className:"w-full bg-gray-800 text-white rounded-lg pl-10 pr-4 py-2 border border-gray-700 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none placeholder-gray-500"})]})]}),(0,a.jsxs)(B.M,{children:[g&&(0,a.jsxs)(z.E.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"mx-6 mt-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm flex items-center gap-2",children:[(0,a.jsx)(to.Z,{className:"w-4 h-4"}),g]}),p&&(0,a.jsxs)(z.E.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"mx-6 mt-4 p-3 bg-green-500/10 border border-green-500/20 rounded-lg text-green-400 text-sm flex items-center gap-2",children:[(0,a.jsx)(eL.Z,{className:"w-4 h-4"}),p]})]}),(0,a.jsx)("div",{className:"p-6 overflow-y-auto max-h-[50vh]",children:o?(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center py-12",children:[(0,a.jsx)(er.Z,{className:"w-8 h-8 text-gray-400 animate-spin mb-4"}),(0,a.jsx)("p",{className:"text-gray-400",children:"Loading blocked users..."})]}):0===l.length?(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4",children:(0,a.jsx)(eq.Z,{className:"w-8 h-8 text-gray-500"})}),(0,a.jsx)("p",{className:"text-gray-400 mb-2",children:"No blocked users"}),(0,a.jsx)("p",{className:"text-gray-500 text-sm",children:"You haven't blocked anyone yet"})]}):0===k.length?(0,a.jsxs)("div",{className:"text-center py-8 text-gray-400",children:['No users found matching "',b,'"']}):(0,a.jsx)("div",{className:"space-y-3",children:k.map(e=>(0,a.jsx)(z.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"p-4 bg-gray-800/50 rounded-xl border border-gray-700 hover:border-gray-600 transition-colors",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-red-500 to-red-700 flex items-center justify-center",children:(0,a.jsx)("span",{className:"text-white font-medium",children:e.blocked_username.charAt(0).toUpperCase()})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-white",children:e.blocked_username}),(0,a.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-400",children:[(0,a.jsx)("span",{children:_(e.reason)}),(0,a.jsx)("span",{children:"•"}),(0,a.jsxs)("span",{children:["Blocked ",C(e.blocked_at)]})]})]})]}),v===e.blocked_user_id?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>N(e.blocked_user_id),disabled:m===e.blocked_user_id,className:"px-3 py-1.5 bg-red-600 hover:bg-red-700 disabled:bg-red-800 text-white text-sm rounded-lg transition-colors flex items-center gap-1",children:m===e.blocked_user_id?(0,a.jsx)(er.Z,{className:"w-3 h-3 animate-spin"}):"Confirm"}),(0,a.jsx)("button",{onClick:()=>w(null),className:"px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-sm rounded-lg transition-colors",children:"Cancel"})]}):(0,a.jsxs)("button",{onClick:()=>w(e.blocked_user_id),className:"px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-sm rounded-lg transition-colors flex items-center gap-1",children:[(0,a.jsx)(eL.Z,{className:"w-4 h-4"}),"Unblock"]})]})},e.id))})}),(0,a.jsx)("div",{className:"p-4 border-t border-gray-800 bg-gray-900/50",children:(0,a.jsx)("p",{className:"text-xs text-gray-500 text-center",children:"Unblocking a user will allow them to send you friend requests again. You'll need to accept their request to communicate."})})]})})}):null}var tu=s(8004),tm=s(5179),th=s(7138);function tg(){let{loadContacts:e,loadConversations:t,loadCallHistory:s,initializeWebSocket:n,currentConversation:i,publicKey:l}=P(),{settings:c}=(0,C.MU)(),{wallpaper:o}=c,[d,u]=(0,r.useState)(!0),[m,h]=(0,r.useState)(!1),[g,x]=(0,r.useState)(!1),[p,y]=(0,r.useState)(!1),[b,f]=(0,r.useState)(!1),[v,w]=(0,r.useState)(!1),[j,N]=(0,r.useState)(!1),[k,_]=(0,r.useState)(!1);(0,r.useEffect)(()=>{e(),t(),s(),n();let a=()=>_(window.innerWidth<1024);return a(),window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[e,t,s,n]);let S=k?320:m?80:320;return(0,a.jsxs)("div",{className:"h-screen bg-cipher-darker flex overflow-hidden relative",children:[(0,a.jsx)(W.ParticleField,{density:"low",className:"opacity-30"}),(0,a.jsx)(z.E.button,{onClick:()=>u(!d),className:"lg:hidden fixed top-4 left-4 z-50 p-2 bg-cipher-dark rounded-lg text-gray-400 hover:text-white",whileHover:{scale:1.05},whileTap:{scale:.95},initial:{opacity:0,x:-20},animate:{opacity:1,x:0},children:d?(0,a.jsx)(ea.Z,{className:"w-5 h-5"}):(0,a.jsx)(tu.Z,{className:"w-5 h-5"})}),(0,a.jsx)(B.M,{children:d&&!k&&(0,a.jsx)(z.E.button,{onClick:()=>h(!m),className:"hidden lg:flex fixed top-1/2 -translate-y-1/2 z-50 p-2 bg-cipher-dark border border-gray-700 rounded-r-lg text-gray-400 hover:text-white shadow-lg",style:{left:S-1},initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},whileHover:{scale:1.1,x:2},whileTap:{scale:.95},title:m?"Expand sidebar":"Collapse sidebar",children:m?(0,a.jsx)(tm.Z,{className:"w-4 h-4"}):(0,a.jsx)(th.Z,{className:"w-4 h-4"})})}),(0,a.jsx)(z.E.div,{className:"\n          fixed lg:relative inset-y-0 left-0 z-40\n          bg-cipher-dark border-r border-gray-800\n          transform ".concat(d?"translate-x-0":"-translate-x-full","\n          lg:translate-x-0\n        "),initial:!1,animate:{x:d?0:-320,width:S,rotateY:d&&!k?0:5,scale:d?1:.95},transition:{type:"spring",stiffness:300,damping:30},style:{transformStyle:"preserve-3d",perspective:1200,transformOrigin:"left center"},children:(0,a.jsx)(eo,{collapsed:m,onToggleCollapse:()=>h(!m),onNewChat:()=>x(!0),onSettings:()=>y(!0),onAddFriend:()=>f(!0),onPendingRequests:()=>w(!0),onBlockedUsers:()=>N(!0)})}),(0,a.jsxs)("div",{className:"flex-1 flex flex-col relative",style:{backgroundImage:o.enabled?(0,C.X)(o):void 0,backgroundSize:o.enabled&&("custom"===o.type||"url"===o.type)?"cover":"initial",backgroundPosition:"center",backgroundRepeat:o.enabled&&("custom"===o.type||"url"===o.type)?"no-repeat":"initial"},children:[o.enabled&&(0,a.jsx)("div",{className:"absolute inset-0 pointer-events-none z-0",style:{backdropFilter:"blur(".concat(o.blur,"px)"),opacity:o.opacity/100}}),(0,a.jsx)(B.M,{mode:"wait",children:i?(0,a.jsx)(z.E.div,{className:"flex-1 flex flex-col h-full relative z-10",initial:{x:50,opacity:0,rotateY:-10},animate:{x:0,opacity:1,rotateY:0},exit:{x:-30,opacity:0,rotateY:10},transition:{type:"spring",stiffness:300,damping:30},style:{transformStyle:"preserve-3d",perspective:1200},children:(0,a.jsx)(eX,{})},"chat"):(0,a.jsx)(z.E.div,{className:"flex-1 flex items-center justify-center relative z-10",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.3},children:(0,a.jsx)(tx,{})},"empty")})]}),(0,a.jsx)(e0,{isOpen:g,onClose:()=>x(!1)}),(0,a.jsx)(ts,{isOpen:p,onClose:()=>y(!1)}),(0,a.jsx)(tl,{isOpen:b,onClose:()=>f(!1),currentUserPublicKey:l||"",onRequestSent:()=>{}}),(0,a.jsx)(tc,{isOpen:v,onClose:()=>w(!1),currentUserPublicKey:l||"",onRequestAccepted:()=>{e(),t()},onRequestRejected:()=>{}}),(0,a.jsx)(td,{isOpen:j,onClose:()=>N(!1)}),(0,a.jsx)(B.M,{children:d&&k&&(0,a.jsx)(z.E.div,{className:"lg:hidden fixed inset-0 bg-black/50 z-30 backdrop-blur-sm",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>u(!1)})})]})}function tx(){return(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)(z.E.div,{className:"w-20 h-20 bg-gradient-to-br from-cipher-primary/20 to-cipher-secondary/20 rounded-full flex items-center justify-center mx-auto mb-6",initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.2},children:(0,a.jsx)(Z.Z,{className:"w-10 h-10 text-cipher-primary"})}),(0,a.jsx)(z.E.h2,{className:"text-2xl font-bold text-white mb-2",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.3},children:"Welcome to ZeroTrace"}),(0,a.jsx)(z.E.p,{className:"text-gray-400 max-w-md",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4},children:"Select a conversation or start a new chat to begin sending end-to-end encrypted messages."}),(0,a.jsxs)(z.E.div,{className:"mt-6 flex items-center justify-center gap-2 text-sm text-gray-500",initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},children:[(0,a.jsx)(Z.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"All messages are encrypted on your device"})]})]})}function tp(){let{isAuthenticated:e,isLoading:t,loadStoredAuth:s}=P();return((0,r.useEffect)(()=>{s()},[s]),t)?(0,a.jsx)("div",{className:"min-h-screen bg-cipher-darker flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 border-4 border-cipher-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-gray-400",children:"Loading ZeroTrace..."})]})}):e?(0,a.jsx)(tg,{}):(0,a.jsx)(q,{})}}},function(e){e.O(0,[560,89,224,336,971,938,744],function(){return e(e.s=9325)}),_N_E=e.O()}]);