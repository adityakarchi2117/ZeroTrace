(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{8924:function(){},5024:function(){},9325:function(e,t,s){Promise.resolve().then(s.bind(s,2123))},2123:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return eU}});var a=s(7437),r=s(2265),n=s(4660),i=s(4810),l=s(4829);class c{setToken(e){this.token=e}getToken(){return this.token}async register(e,t,s,a){return(await this.client.post("/api/auth/register",{username:e,email:t,password:s,device_id:a,device_type:"web"})).data}async login(e,t){let s=new URLSearchParams;s.append("username",e),s.append("password",t);let a=await this.client.post("/api/auth/login",s,{headers:{"Content-Type":"application/x-www-form-urlencoded"}});return this.token=a.data.access_token,a.data}async getCurrentUser(){return(await this.client.get("/api/auth/me")).data}async updateSettings(e){return(await this.client.patch("/api/auth/me/settings",{settings:e})).data}async uploadKeys(e){await this.client.post("/api/keys/upload",e)}async getPublicKey(e){return(await this.client.get("/api/keys/".concat(e))).data}async getKeyBundle(e){return(await this.client.get("/api/keys/bundle/".concat(e))).data}async sendMessage(e,t,s){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"none",r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"text",n=arguments.length>5?arguments[5]:void 0,i=arguments.length>6?arguments[6]:void 0;return(await this.client.post("/api/messages/send",{recipient_username:e,encrypted_content:t,encrypted_key:s,expiry_type:a,message_type:r,file_metadata:n,sender_theme:i})).data}async getConversation(e){return(await this.client.get("/api/messages/conversation/".concat(e))).data}async getUnreadMessages(){return(await this.client.get("/api/messages/unread")).data}async getCallHistory(){return(await this.client.get("/api/messages/calls/history")).data}async deleteMessage(e){await this.client.delete("/api/messages/".concat(e))}async deleteConversation(e){await this.client.delete("/api/messages/conversation/".concat(e))}async deleteCallHistory(e){await this.client.delete("/api/messages/calls/history/".concat(e))}async getContacts(){return(await this.client.get("/api/contacts/")).data}async addContact(e,t){return(await this.client.post("/api/contacts/",{username:e,nickname:t})).data}async removeContact(e){await this.client.delete("/api/contacts/".concat(e))}async blockContact(e){await this.client.post("/api/contacts/".concat(e,"/block"))}async searchUsers(e){return(await this.client.get("/api/contacts/search",{params:{q:e}})).data}async getConversations(){return(await this.client.get("/api/contacts/conversations")).data}async getAllConversationsWithMessages(){return(await this.client.get("/api/messages/all-conversations")).data}async getVaultItems(){return(await this.client.get("/api/vault/items")).data}async createVaultItem(e){await this.client.post("/api/vault/items",e)}constructor(){this.token=null,this.client=l.Z.create({baseURL:"http://localhost:8000",headers:{"Content-Type":"application/json"}}),this.client.interceptors.request.use(e=>(this.token&&(e.headers.Authorization="Bearer ".concat(this.token)),e))}}let o=new c;var d=s(7963),u=s.n(d),m=s(2092);function h(e,t,s){try{var a;let r=(0,m.decodeBase64)(e.ciphertext),n=(0,m.decodeBase64)(e.nonce),i=e.senderPublicKey||t;if(console.log("\uD83D\uDD13 Decryption attempt:",{version:e.version||"v1",hasEmbeddedKey:!!e.senderPublicKey,embeddedKeyPrefix:null===(a=e.senderPublicKey)||void 0===a?void 0:a.substring(0,20),fallbackKeyPrefix:null==t?void 0:t.substring(0,20),usingKeyPrefix:null==i?void 0:i.substring(0,20),recipientKeyPrefix:null==s?void 0:s.substring(0,20)}),!i)return console.error("❌ Decryption failed: No sender public key available"),null;let l=(0,m.decodeBase64)(i),c=(0,m.decodeBase64)(s),o=u().box.open(r,n,l,c);if(!o){if(console.warn("⚠️ Primary decryption failed with key:",null==i?void 0:i.substring(0,20)),e.senderPublicKey&&t&&e.senderPublicKey!==t){console.log("\uD83D\uDD04 Trying fallback sender key:",null==t?void 0:t.substring(0,20));try{let e=(0,m.decodeBase64)(t),s=u().box.open(r,n,e,c);if(s)return console.log("✅ Fallback decryption succeeded!"),(0,m.encodeUTF8)(s)}catch(e){console.warn("❌ Fallback decryption also failed:",e)}}return null}return console.log("✅ Decryption succeeded"),(0,m.encodeUTF8)(o)}catch(e){return console.error("❌ Decryption error:",e),null}}function g(e){var t;let s=(0,m.decodeBase64)(e),a=Array.from(u().hash(s).slice(0,16)).map(e=>e.toString(16).padStart(2,"0")).join("");return(null===(t=a.toUpperCase().match(/.{1,4}/g))||void 0===t?void 0:t.join(" "))||a.toUpperCase()}function p(e,t){try{let s=(0,m.decodeBase64)(e),a=(0,m.decodeBase64)(t),r=u().box.keyPair.fromSecretKey(s).publicKey;if(r.length!==a.length)return!1;for(let e=0;e<r.length;e++)if(r[e]!==a[e])return!1;return!0}catch(e){return console.error("Key pair verification failed:",e),!1}}function y(e){let t=(0,m.decodeBase64)(e),s=u().box.keyPair.fromSecretKey(t);return(0,m.encodeBase64)(s.publicKey)}function x(e,t){let s=(0,m.decodeBase64)(e),a=(0,m.decodeBase64)(t),r=u().box.before(a,s);return(0,m.encodeBase64)(r)}let b={STORAGE_KEY:"cipherlink_keys",SESSION_CACHE_KEY:"cipherlink_sessions",save(e,t){try{let s=localStorage.getItem(this.STORAGE_KEY),a=s?JSON.parse(s):{};t.fingerprint=g(t.publicKey),a[e]=t,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(a))}catch(e){console.error("Failed to save keys:",e)}},load(e){try{let t=localStorage.getItem(this.STORAGE_KEY);if(!t)return null;return JSON.parse(t)[e]||null}catch(e){return null}},verifyKeyConsistency(e,t){let s=this.load(e);return!!s&&g(s.publicKey)===g(t)},remove(e){try{let t=localStorage.getItem(this.STORAGE_KEY);if(t){let s=JSON.parse(t);delete s[e],localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s))}this.clearSessionCache(e)}catch(e){console.error("Failed to remove keys:",e)}},clear(){localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.SESSION_CACHE_KEY)},getOrDeriveSessionKey(e,t,s,a){let r="".concat(e,":").concat(t,":").concat(g(a).slice(0,16));try{let e=localStorage.getItem(this.SESSION_CACHE_KEY),t=e?JSON.parse(e):{};if(t[r])return t[r];let n=x(s,a);return t[r]=n,localStorage.setItem(this.SESSION_CACHE_KEY,JSON.stringify(t)),n}catch(e){return console.error("Session cache error:",e),x(s,a)}},clearSessionCache(e){if(!e){localStorage.removeItem(this.SESSION_CACHE_KEY);return}try{let t=localStorage.getItem(this.SESSION_CACHE_KEY);if(t){let s=JSON.parse(t),a={};for(let[t,r]of Object.entries(s))t.startsWith("".concat(e,":"))||(a[t]=r);localStorage.setItem(this.SESSION_CACHE_KEY,JSON.stringify(a))}}catch(e){console.error("Failed to clear session cache:",e)}}};class v{connect(e,t){this.userId=e,this.token=t,this.connectWebSocket()}connectWebSocket(){var e;if(!this.isConnecting&&(null===(e=this.ws)||void 0===e?void 0:e.readyState)!==WebSocket.OPEN){if(this.isConnecting=!0,!this.token){console.warn("No auth token available for WebSocket connection"),this.isConnecting=!1;return}try{this.ws=new WebSocket("".concat("ws://localhost:8000/ws","/chat?token=").concat(this.token)),this.ws.onopen=()=>{console.log("\uD83D\uDD17 WebSocket connected"),this.isConnecting=!1,this.reconnectAttempts=0,this.startHeartbeat(),this.flushMessageQueue()},this.ws.onmessage=e=>{try{let t=JSON.parse(e.data);this.handleMessage(t)}catch(e){console.error("Failed to parse WebSocket message:",e)}},this.ws.onclose=e=>{console.log("\uD83D\uDD0C WebSocket disconnected:",e.code,e.reason),this.isConnecting=!1,this.stopHeartbeat(),this.attemptReconnect()},this.ws.onerror=e=>{console.error("❌ WebSocket error:",e),this.isConnecting=!1}}catch(e){console.error("Failed to create WebSocket connection:",e),this.isConnecting=!1,this.attemptReconnect()}}}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnection attempts reached");return}this.reconnectAttempts++;let e=Math.min(this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),3e4);console.log("Attempting to reconnect in ".concat(e,"ms (attempt ").concat(this.reconnectAttempts,")")),setTimeout(()=>{this.connectWebSocket()},e)}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{var e;(null===(e=this.ws)||void 0===e?void 0:e.readyState)===WebSocket.OPEN&&this.send({type:"ping",data:{},timestamp:new Date().toISOString()})},3e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}handleMessage(e){let t=e.type,s=this.messageHandlers.get(t);s&&s.size>0?s.forEach(s=>{try{s(e)}catch(e){console.error("Error in handler for ".concat(t,":"),e)}}):"pong"!==t&&console.log("Unhandled WebSocket message type:",t,e)}flushMessageQueue(){for(;this.messageQueue.length>0;){let e=this.messageQueue.shift();e&&this.send(e)}}send(e){var t,s;(null===(t=this.ws)||void 0===t?void 0:t.readyState)===WebSocket.OPEN?(console.log("\uD83D\uDCE4 Sending ".concat(e.type," message:"),e),this.ws.send(JSON.stringify(e))):(this.messageQueue.push(e),console.warn("⏳ WebSocket not connected (state: ".concat(null===(s=this.ws)||void 0===s?void 0:s.readyState,"), queuing ").concat(e.type," message")),!this.isConnecting&&this.userId&&this.token&&(console.log("\uD83D\uDD04 Triggering reconnection from send failure"),this.connect(this.userId,this.token)))}on(e,t){this.messageHandlers.has(e)||this.messageHandlers.set(e,new Set),this.messageHandlers.get(e).add(t)}off(e,t){if(t){var s;null===(s=this.messageHandlers.get(e))||void 0===s||s.delete(t)}else this.messageHandlers.delete(e)}onMessage(e,t){this.on(e,t)}offMessage(e){this.messageHandlers.delete(e)}sendEncryptedMessage(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text",a=arguments.length>3?arguments[3]:void 0;this.send({type:"message",data:{recipient_username:e,encrypted_content:t,message_type:s,file_metadata:a},timestamp:new Date().toISOString()})}sendTypingIndicator(e,t){this.send({type:"typing",data:{recipient_username:e,is_typing:t},timestamp:new Date().toISOString()})}sendDeliveryReceipt(e,t){this.send({type:"delivery_receipt",data:{message_id:e,sender_id:t},timestamp:new Date().toISOString()})}sendReadReceipt(e,t){this.send({type:"read_receipt",data:{message_id:e,sender_id:t},timestamp:new Date().toISOString()})}updatePresence(e){this.send({type:"presence",data:{is_online:e},timestamp:new Date().toISOString()})}subscribeToPresence(e){this.send({type:"presence_subscribe",data:{user_ids:e},timestamp:new Date().toISOString()})}getOnlineStatus(e){this.send({type:"get_online_status",data:{user_ids:e},timestamp:new Date().toISOString()})}sendDeleteMessage(e,t){this.send({type:"delete_message",data:{message_id:e,recipient_username:t},timestamp:new Date().toISOString()})}sendDeleteConversation(e){this.send({type:"delete_conversation",data:{recipient_username:e},timestamp:new Date().toISOString()})}disconnect(){this.stopHeartbeat(),this.updatePresence(!1),this.ws&&(this.ws.close(),this.ws=null),this.messageQueue=[]}isConnected(){var e;return(null===(e=this.ws)||void 0===e?void 0:e.readyState)===WebSocket.OPEN}getConnectionState(){var e,t;return null!==(t=null===(e=this.ws)||void 0===e?void 0:e.readyState)&&void 0!==t?t:null}constructor(){this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=10,this.reconnectDelay=1e3,this.heartbeatInterval=null,this.messageHandlers=new Map,this.userId=null,this.token=null,this.isConnecting=!1,this.messageQueue=[]}}let f=new v;window.addEventListener("beforeunload",()=>{f.updatePresence(!1),f.disconnect()}),document.addEventListener("visibilitychange",()=>{document.hidden?f.updatePresence(!1):f.updatePresence(!0)});class w{async init(){return new Promise((e,t)=>{let s=indexedDB.open(this.dbName,this.version);s.onerror=()=>t(s.error),s.onsuccess=()=>{this.db=s.result,e()},s.onupgradeneeded=e=>{let t=e.target.result;if(!t.objectStoreNames.contains("messages")){let e=t.createObjectStore("messages",{keyPath:"id"});e.createIndex("conversation",["sender_username","recipient_username"],{unique:!1}),e.createIndex("recipient","recipient_username",{unique:!1}),e.createIndex("sender","sender_username",{unique:!1}),e.createIndex("created_at","created_at",{unique:!1})}t.objectStoreNames.contains("conversations")||t.createObjectStore("conversations",{keyPath:"username"}).createIndex("last_message_time","last_message_time",{unique:!1}),t.objectStoreNames.contains("contacts")||t.createObjectStore("contacts",{keyPath:"id"}).createIndex("contact_username","contact_username",{unique:!1}),t.objectStoreNames.contains("sync_metadata")||t.createObjectStore("sync_metadata",{keyPath:"key"})}})}async saveMessage(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["messages"],"readwrite").objectStore("messages").put(e);a.onerror=()=>s(a.error),a.onsuccess=()=>t()})}async saveMessages(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["messages"],"readwrite").objectStore("messages"),r=0,n=e.length;if(0===n){t();return}e.forEach(e=>{let i=a.put(e);i.onsuccess=()=>{++r===n&&t()},i.onerror=()=>s(i.error)})})}async getConversationMessages(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50;return this.db||await this.init(),new Promise((a,r)=>{let n=this.db.transaction(["messages"],"readonly").objectStore("messages"),i=[],l=n.openCursor();l.onsuccess=r=>{let n=r.target.result;if(n){let s=n.value;(s.sender_username===e&&s.recipient_username===t||s.sender_username===t&&s.recipient_username===e)&&i.push(s),n.continue()}else i.sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime()),a(i.slice(-s))},l.onerror=()=>r(l.error)})}async getAllMessages(){return this.db||await this.init(),new Promise((e,t)=>{let s=this.db.transaction(["messages"],"readonly").objectStore("messages").getAll();s.onerror=()=>t(s.error),s.onsuccess=()=>e(s.result)})}async saveConversation(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["conversations"],"readwrite").objectStore("conversations").put(e);a.onerror=()=>s(a.error),a.onsuccess=()=>t()})}async saveConversations(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["conversations"],"readwrite").objectStore("conversations"),r=0,n=e.length;if(0===n){t();return}e.forEach(e=>{let i=a.put(e);i.onsuccess=()=>{++r===n&&t()},i.onerror=()=>s(i.error)})})}async getAllConversations(){return this.db||await this.init(),new Promise((e,t)=>{let s=this.db.transaction(["conversations"],"readonly").objectStore("conversations").getAll();s.onerror=()=>t(s.error),s.onsuccess=()=>e(s.result)})}async saveContact(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["contacts"],"readwrite").objectStore("contacts").put(e);a.onerror=()=>s(a.error),a.onsuccess=()=>t()})}async saveContacts(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["contacts"],"readwrite").objectStore("contacts"),r=0,n=e.length;if(0===n){t();return}e.forEach(e=>{let i=a.put(e);i.onsuccess=()=>{++r===n&&t()},i.onerror=()=>s(i.error)})})}async getAllContacts(){return this.db||await this.init(),new Promise((e,t)=>{let s=this.db.transaction(["contacts"],"readonly").objectStore("contacts").getAll();s.onerror=()=>t(s.error),s.onsuccess=()=>e(s.result)})}async setSyncTimestamp(e,t){return this.db||await this.init(),new Promise((s,a)=>{let r=this.db.transaction(["sync_metadata"],"readwrite").objectStore("sync_metadata").put({key:e,timestamp:t});r.onerror=()=>a(r.error),r.onsuccess=()=>s()})}async getSyncTimestamp(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["sync_metadata"],"readonly").objectStore("sync_metadata").get(e);a.onerror=()=>s(a.error),a.onsuccess=()=>{let e=a.result;t(e?e.timestamp:null)}})}async clearAllData(){this.db||await this.init();let e=["messages","conversations","contacts","sync_metadata"];return new Promise((t,s)=>{let a=this.db.transaction(e,"readwrite"),r=0;e.forEach(n=>{let i=a.objectStore(n).clear();i.onsuccess=()=>{++r===e.length&&t()},i.onerror=()=>s(i.error)})})}async deleteConversation(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["conversations","messages"],"readwrite");a.objectStore("conversations").delete(e);let r=a.objectStore("messages").openCursor();r.onsuccess=s=>{let a=s.target.result;if(a){let t=a.value;(t.sender_username===e||t.recipient_username===e)&&a.delete(),a.continue()}else t()},r.onerror=()=>s(r.error)})}async deleteMessage(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["messages"],"readwrite").objectStore("messages").delete(e);a.onerror=()=>s(a.error),a.onsuccess=()=>t()})}async markMessageAsDeleted(e){return this.db||await this.init(),new Promise((t,s)=>{let a=this.db.transaction(["messages"],"readwrite").objectStore("messages"),r=a.get(e);r.onsuccess=()=>{let e=r.result;if(e){e.encrypted_content=JSON.stringify({deleted:!0}),e.message_type="deleted",e.status="deleted";let r=a.put(e);r.onsuccess=()=>t(),r.onerror=()=>s(r.error)}else t()},r.onerror=()=>s(r.error)})}async clearConversationMessages(e,t){return this.db||await this.init(),new Promise((s,a)=>{let r=this.db.transaction(["messages"],"readwrite").objectStore("messages").openCursor();r.onsuccess=a=>{let r=a.target.result;if(r){let s=r.value;(s.sender_username===e&&s.recipient_username===t||s.sender_username===t&&s.recipient_username===e)&&r.delete(),r.continue()}else s()},r.onerror=()=>a(r.error)})}constructor(){this.db=null,this.dbName="CipherLinkDB",this.version=1}}let j=new w;j.init().catch(console.error);var N=s(804);let _={bubbleColor:"#3B82F6",textColor:"#ffffff",style:"rounded",font:"inter",accentGradient:"linear-gradient(135deg, #3B82F6, #1D4ED8)",accentPrimary:"#3B82F6",accentSecondary:"#1D4ED8"},k="cipherlink_bubble_style",C="cipherlink_font_style";function S(){try{let e=localStorage.getItem(k);if(e&&["rounded","glass","neon"].includes(e))return e}catch(e){console.error("Failed to load bubble style:",e)}return"rounded"}function D(){try{let e=localStorage.getItem(C);if(e&&["inter","mono"].includes(e))return e}catch(e){console.error("Failed to load font style:",e)}return"inter"}let E=(0,n.Ue)()((0,i.tJ)((e,t)=>({user:null,token:null,isAuthenticated:!1,isLoading:!1,error:null,privateKey:null,publicKey:null,identityKey:null,identityPrivateKey:null,contacts:[],conversations:[],currentConversation:null,messages:new Map,onlineUsers:new Set,typingUsers:new Map,callHistory:[],login:async(s,a)=>{var r,n,i,l,c,d,h,g,x,v;e({isLoading:!0,error:null});try{let x=await o.login(s,a),v=await o.getCurrentUser();if(v.settings)try{let e=localStorage.getItem("cipherlink_appearance"),t={...e?JSON.parse(e):{},...v.settings},s=JSON.stringify(t);localStorage.setItem("cipherlink_appearance",s),window.dispatchEvent(new StorageEvent("storage",{key:"cipherlink_appearance",newValue:s,storageArea:localStorage,url:window.location.href}))}catch(e){console.error("Failed to sync settings",e)}localStorage.setItem("cipherlink_token",x.access_token),localStorage.setItem("cipherlink_username",s);let w=b.load(s),j=!v.public_key;if(w&&v.public_key&&!b.verifyKeyConsistency(s,v.public_key)&&(console.warn("⚠️ Key mismatch detected! Local key differs from server key."),console.warn("This may happen if you logged in from a different device."),console.warn("Old messages encrypted with the server key may not decrypt correctly.")),!w){console.log("\uD83D\uDD10 Generating new key bundle...");let{bundle:e,privateKeys:t}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=u().sign.keyPair(),s=u().box.keyPair(),a=u().sign.detached(s.publicKey,t.secretKey),r=[],n=[];for(let t=0;t<e;t++){let e=u().box.keyPair();r.push((0,m.encodeBase64)(e.publicKey)),n.push((0,m.encodeBase64)(e.secretKey))}return{bundle:{publicKey:(0,m.encodeBase64)(s.publicKey),identityKey:(0,m.encodeBase64)(t.publicKey),signedPrekey:(0,m.encodeBase64)(s.publicKey),signedPrekeySignature:(0,m.encodeBase64)(a),oneTimePrekeys:r},privateKeys:{identityPrivate:(0,m.encodeBase64)(t.secretKey),signedPrekeyPrivate:(0,m.encodeBase64)(s.secretKey),oneTimePrekeyPrivates:n}}}(5);w={privateKey:t.signedPrekeyPrivate,publicKey:e.publicKey,identityKey:e.identityKey,signedPrekey:e.signedPrekey,signedPrekeySignature:e.signedPrekeySignature,identityPrivateKey:t.identityPrivate,oneTimePrekeys:e.oneTimePrekeys},b.save(s,w),j=!0,console.log("✅ Key bundle generated")}if(w.privateKey&&w.publicKey){let e=p(w.privateKey,w.publicKey);if(console.log("\uD83D\uDD11 Key pair verification:",e?"✅ VALID":"❌ INVALID"),!e){console.warn("⚠️ Key pair mismatch detected! Deriving correct public key...");let e=y(w.privateKey);console.log("\uD83D\uDD27 Original publicKey:",null===(l=w.publicKey)||void 0===l?void 0:l.substring(0,30)),console.log("\uD83D\uDD27 Derived publicKey:",null==e?void 0:e.substring(0,30)),w.publicKey=e,b.save(s,w),j=!0,console.log("✅ Key pair corrected and saved")}}if(j&&w){console.log("\uD83D\uDCE4 Uploading keys to server...",{publicKeyToUpload:null===(c=w.publicKey)||void 0===c?void 0:c.substring(0,30)});try{await o.uploadKeys({public_key:w.publicKey||"",identity_key:w.identityKey||"",signed_prekey:w.signedPrekey||w.publicKey||"",signed_prekey_signature:w.signedPrekeySignature||"",one_time_prekeys:w.oneTimePrekeys||[]}),v=await o.getCurrentUser(),console.log("✅ Keys uploaded successfully!",{serverNowHas:null===(d=v.public_key)||void 0===d?void 0:d.substring(0,30)})}catch(e){console.error("❌ Failed to upload keys:",(null==e?void 0:null===(h=e.response)||void 0===h?void 0:h.data)||e)}}let N=(null==w?void 0:w.publicKey)===v.public_key;if(console.log("\uD83D\uDD10 Final Key Status:",{username:s,localPubKey:null==w?void 0:null===(r=w.publicKey)||void 0===r?void 0:r.substring(0,30),serverPubKey:null===(n=v.public_key)||void 0===n?void 0:n.substring(0,30),localPrivKey:null==w?void 0:null===(i=w.privateKey)||void 0===i?void 0:i.substring(0,30),LOCAL_MATCHES_SERVER:N?"✅ YES":"❌ NO"}),!N&&(null==w?void 0:w.publicKey)&&v.public_key){console.error("\uD83D\uDEA8 CRITICAL: Local public key does not match server! This will cause decryption failures."),console.log("\uD83D\uDD27 Attempting to force upload correct key...");try{await o.uploadKeys({public_key:w.publicKey||"",identity_key:w.identityKey||"",signed_prekey:w.signedPrekey||w.publicKey||"",signed_prekey_signature:w.signedPrekeySignature||"",one_time_prekeys:w.oneTimePrekeys||[]}),v=await o.getCurrentUser(),console.log("✅ Force upload complete, server now has:",null===(g=v.public_key)||void 0===g?void 0:g.substring(0,30))}catch(e){console.error("❌ Force upload failed:",e)}}e({user:v,token:x.access_token,isAuthenticated:!0,isLoading:!1,privateKey:w.privateKey||null,publicKey:w.publicKey||null,identityKey:w.identityKey||null}),f.connect(v.id.toString(),x.access_token),window._wsHandlersRegistered||(K(t,e),window._wsHandlersRegistered=!0)}catch(t){throw e({isLoading:!1,error:(null===(v=t.response)||void 0===v?void 0:null===(x=v.data)||void 0===x?void 0:x.detail)||"Login failed"}),t}},register:async(s,a,r)=>{e({isLoading:!0,error:null});try{let e="web-".concat(Date.now(),"-").concat(Math.random().toString(36).slice(2));await o.register(s,a,r,e),await t().login(s,r)}catch(t){var n,i;throw e({isLoading:!1,error:(null===(i=t.response)||void 0===i?void 0:null===(n=i.data)||void 0===n?void 0:n.detail)||"Registration failed"}),t}},logout:()=>{f.disconnect(),window._wsHandlersRegistered=!1,localStorage.removeItem("cipherlink_token"),localStorage.removeItem("cipherlink_username"),o.setToken(null),e({user:null,token:null,isAuthenticated:!1,privateKey:null,publicKey:null,identityKey:null,identityPrivateKey:null,contacts:[],conversations:[],currentConversation:null,messages:new Map,onlineUsers:new Set,typingUsers:new Map,callHistory:[]})},initializeWebSocket:()=>{let{user:s,token:a}=t();s&&a&&(f.connect(s.id.toString(),a),window._wsHandlersRegistered||(K(t,e),window._wsHandlersRegistered=!0))},loadStoredAuth:async()=>{let s=localStorage.getItem("cipherlink_token"),a=localStorage.getItem("cipherlink_username");if(s&&a){o.setToken(s);try{let r=await o.getCurrentUser();if(r.settings)try{let e=localStorage.getItem("cipherlink_appearance"),t={...e?JSON.parse(e):{},...r.settings},s=JSON.stringify(t);localStorage.setItem("cipherlink_appearance",s),window.dispatchEvent(new StorageEvent("storage",{key:"cipherlink_appearance",newValue:s,storageArea:localStorage,url:window.location.href}))}catch(e){console.error("Failed to sync settings",e)}let n=b.load(a);e({user:r,token:s,isAuthenticated:!0,privateKey:(null==n?void 0:n.privateKey)||null,publicKey:(null==n?void 0:n.publicKey)||null,identityKey:(null==n?void 0:n.identityKey)||null}),f.connect(r.id.toString(),s),window._wsHandlersRegistered||(K(t,e),window._wsHandlersRegistered=!0),await t().loadPersistedData(),t().syncWithServer().catch(console.error);return}catch(e){localStorage.removeItem("cipherlink_token"),localStorage.removeItem("cipherlink_username")}}},generateAndUploadKeys:async()=>{let{user:s}=t();if(!s)return;let a=function(){let e=u().box.keyPair();return{publicKey:(0,m.encodeBase64)(e.publicKey),privateKey:(0,m.encodeBase64)(e.secretKey)}}(),r=function(){let e=u().sign.keyPair();return{publicKey:(0,m.encodeBase64)(e.publicKey),privateKey:(0,m.encodeBase64)(e.secretKey)}}();b.save(s.username,{privateKey:a.privateKey,publicKey:a.publicKey,identityKey:r.publicKey}),await o.uploadKeys({public_key:a.publicKey,identity_key:r.publicKey,signed_prekey:a.publicKey,signed_prekey_signature:r.publicKey,one_time_prekeys:[]}),e({privateKey:a.privateKey,publicKey:a.publicKey,identityKey:r.publicKey})},loadStoredKeys:()=>{let{user:s}=t();if(!s)return;let a=b.load(s.username);a&&e({privateKey:a.privateKey,publicKey:a.publicKey,identityKey:a.identityKey})},loadContacts:async()=>{try{let t=await o.getContacts();e({contacts:t})}catch(e){console.error("Failed to load contacts:",e)}},loadConversations:async()=>{try{let t=await o.getConversations();e({conversations:t})}catch(e){console.error("Failed to load conversations:",e)}},loadMessages:async s=>{try{let r=await o.getConversation(s),{privateKey:n,contacts:i,user:l}=t();if(n){for(let e of r)if(e.encrypted_content&&!e._decryptedContent)try{let t;let s=JSON.parse(e.encrypted_content);if(e.sender_username===(null==l?void 0:l.username)){var a;t=null===(a=i.find(t=>t.contact_username===e.recipient_username))||void 0===a?void 0:a.public_key}else{let s=i.find(t=>t.contact_username===e.sender_username);t=null==s?void 0:s.public_key}let r=h(s,t||"",n);e._decryptedContent=r}catch(t){console.warn("Failed to decrypt message:",e.id,t)}}let c=new Map(t().messages);c.set(s,r),e({messages:c})}catch(e){console.error("Failed to load messages:",e)}},sendMessage:async function(s,a){let r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text",i=arguments.length>3?arguments[3]:void 0;console.log("\uD83D\uDCE4 sendMessage called:",{recipientUsername:s,content:a.substring(0,50),messageType:n});let{privateKey:l,publicKey:c,user:d}=t();if(!l||!c||!d){console.error("Cannot send message: missing keys or user",{hasPrivateKey:!!l,hasPublicKey:!!c,hasUser:!!d});return}p(l,c)||(console.warn("⚠️ Invalid key pair detected in sendMessage! Deriving correct public key..."),console.log("\uD83D\uDD27 Using derived publicKey:",null==(c=y(l))?void 0:c.substring(0,30)),e({publicKey:c})),console.log("\uD83D\uDCE4 Fetching public key from server for:",s);try{r=(await o.getPublicKey(s)).public_key,console.log("\uD83D\uDCE4 Got recipient public key from server:",null==r?void 0:r.substring(0,30))}catch(e){throw console.error("Failed to get recipient public key:",e),Error("Could not get recipient encryption key")}if(!r)throw Error("Recipient has not set up encryption");console.log("\uD83D\uDCE4 Encrypting with:",{recipientPubKey:null==r?void 0:r.substring(0,30),senderPrivKey:null==l?void 0:l.substring(0,30),senderPubKey:null==c?void 0:c.substring(0,30)});let h=JSON.stringify(function(e,t,s,a){console.log("\uD83D\uDD10 Encrypting message:",{recipientKeyPrefix:null==t?void 0:t.substring(0,20),senderPrivKeyPrefix:null==s?void 0:s.substring(0,20),senderPubKeyPrefix:null==a?void 0:a.substring(0,20),hasSenderPubKey:!!a});let r=u().randomBytes(u().box.nonceLength),n=(0,m.decodeUTF8)(e),i=(0,m.decodeBase64)(t),l=(0,m.decodeBase64)(s),c=u().box(n,r,i,l),o={ciphertext:(0,m.encodeBase64)(c),nonce:(0,m.encodeBase64)(r),senderPublicKey:a,version:"v2"};return console.log("✅ Encrypted with v2 protocol, embedded senderPublicKey:",!!a),o}(a,r,l,c)),g=function(){try{let e=localStorage.getItem("cipherlink_appearance"),t="blue";e&&(t=JSON.parse(e).accent||"blue");let s=S(),a=D();return function(e,t,s){let a=N.FN[e];return{bubbleColor:a.primary,textColor:"#ffffff",style:t||"rounded",font:s||"inter",accentGradient:"linear-gradient(135deg, ".concat(a.primary,", ").concat(a.secondary,")"),accentPrimary:a.primary,accentSecondary:a.secondary}}(t,s,a)}catch(e){return console.error("Failed to build current message theme:",e),_}}(),x=t().messages.get(s)||[],b=-Date.now(),v={id:b,sender_id:d.id,sender_username:d.username,recipient_id:0,recipient_username:s,encrypted_content:h,message_type:n,status:"sending",expiry_type:"none",created_at:new Date().toISOString(),_decryptedContent:a,sender_theme:g},f=new Map(t().messages);f.set(s,[...x,v]),e({messages:f});try{console.log("\uD83D\uDCE4 Sending to API...");let r=await o.sendMessage(s,h,void 0,"none",n,i,g);console.log("✅ Message sent successfully",r),r._decryptedContent=a;let l=new Map(t().messages),c=l.get(s)||[],d=c.findIndex(e=>e.id===b);-1!==d?c[d]=r:c.push(r),l.set(s,c),e({messages:l});try{await t().persistMessage(r)}catch(e){console.error("❌ Failed to persist sent message:",e)}let u=t(),m=u.conversations.findIndex(e=>e.username===s);if(m>=0){let s=[...u.conversations],i={...s[m],last_message_time:r.created_at,last_message_preview:"image"===n?"\uD83D\uDCF7 Image":a};s[m]=i,e({conversations:s});try{await t().persistConversation(i)}catch(e){console.error("❌ Failed to persist conversation after send:",e)}}}catch(i){console.error("Failed to send message:",i);let a=new Map(t().messages),r=a.get(s)||[],n=r.findIndex(e=>e.id===b);throw -1!==n&&(r[n].status="failed",a.set(s,r),e({messages:a})),i}},setCurrentConversation:s=>{if(e({currentConversation:s}),s){t().loadMessages(s);let a=t(),r=new Map(a.typingUsers);r.delete(s),e({typingUsers:r})}},addContact:async s=>{try{let a=await o.addContact(s),r=t();if(e({contacts:[...r.contacts,a]}),!r.conversations.find(e=>e.username===s)){let t={user_id:a.contact_id,username:a.contact_username,public_key:a.public_key,identity_key:a.identity_key,last_message_time:void 0,last_message_preview:void 0,unread_count:0,is_online:!1};e({conversations:[t,...r.conversations]})}}catch(e){throw console.error("Failed to add contact:",e),e}},searchUsers:async e=>{try{return await o.searchUsers(e)}catch(e){return console.error("Failed to search users:",e),[]}},addIncomingMessage:s=>{let a=t(),r=s.sender_username,n=t().messages.get(r)||[];if(!n.some(e=>e.id===s.id)){let{privateKey:i,contacts:l}=t();if(i&&s.encrypted_content)try{let e=JSON.parse(s.encrypted_content),t=l.find(e=>e.contact_username===s.sender_username),a=(null==t?void 0:t.public_key)||"";s._decryptedContent=h(e,a,i),s._decryptedContent?console.log("✅ Successfully decrypted incoming message"):console.warn("⚠️ Decryption returned null for message:",s.id)}catch(e){console.error("❌ Decryption failed for incoming:",e)}let c=new Map(t().messages);c.set(r,[...n,s]),e({messages:c});let o=a.conversations.findIndex(e=>e.username===r);if(o>=0){let r=[...a.conversations],n={...r[o],last_message_time:s.created_at,last_message_preview:s._decryptedContent?"image"===s.message_type?"\uD83D\uDCF7 Image":s._decryptedContent:"[Encrypted Message]",unread_count:(r[o].unread_count||0)+1};r[o]=n,e({conversations:r}),t().persistMessage(s).catch(e=>console.error("❌ Failed to persist incoming message:",e)),t().persistConversation(n).catch(e=>console.error("❌ Failed to persist conversation for incoming message:",e))}else{let n={user_id:s.sender_id,username:r,public_key:void 0,identity_key:void 0,last_message_time:s.created_at,last_message_preview:s._decryptedContent?"image"===s.message_type?"\uD83D\uDCF7 Image":s._decryptedContent:"[Encrypted Message]",unread_count:1,is_online:!1};e({conversations:[n,...a.conversations]}),t().persistMessage(s).catch(e=>console.error("❌ Failed to persist incoming message:",e)),t().persistConversation(n).catch(e=>console.error("❌ Failed to persist new conversation for incoming message:",e))}}},loadCallHistory:async()=>{try{let t=await o.getCallHistory();e({callHistory:t})}catch(e){console.error("Failed to load call history:",e)}},setUserOnline:(s,a)=>{let r=t(),n=new Set(r.onlineUsers);a?n.add(s):n.delete(s),e({onlineUsers:n})},setUserTyping:(s,a)=>{let r=t(),n=new Map(r.typingUsers);a?n.set(s,!0):n.delete(s),e({typingUsers:n})},clearError:()=>e({error:null}),deleteMessageForMe:async(s,a)=>{try{let r=new Map(t().messages),n=(r.get(a)||[]).filter(e=>e.id!==s);r.set(a,n),e({messages:r}),await j.deleteMessage(s),console.log("\uD83D\uDDD1️ Message deleted locally:",s)}catch(e){console.error("Failed to delete message locally:",e)}},deleteMessageForEveryone:async(s,a)=>{try{let r=new Map(t().messages),n=(r.get(a)||[]).map(e=>e.id===s?{...e,_decryptedContent:null,encrypted_content:JSON.stringify({deleted:!0}),message_type:"deleted"}:e);r.set(a,n),e({messages:r}),await j.markMessageAsDeleted(s),f.sendDeleteMessage(s,a);try{await o.deleteMessage(s)}catch(e){console.warn("Could not delete message on server:",e)}console.log("\uD83D\uDDD1️ Message deleted for everyone:",s)}catch(e){console.error("Failed to delete message for everyone:",e)}},clearChat:async s=>{try{let{user:a}=t();if(!a)return;let r=new Map(t().messages);r.set(s,[]),e({messages:r}),await j.clearConversationMessages(s,a.username);let n=t().callHistory.filter(e=>e.caller_username!==s&&e.receiver_username!==s);e({callHistory:n});try{await o.deleteCallHistory(s)}catch(e){console.warn("Failed to delete call history on server:",e)}let i=[...t().conversations],l=i.findIndex(e=>e.username===s);l>=0&&(i[l]={...i[l],last_message_preview:void 0,last_message_time:void 0,unread_count:0},e({conversations:i})),console.log("\uD83E\uDDF9 Chat cleared locally:",s)}catch(e){console.error("Failed to clear chat:",e)}},deleteConversationForEveryone:async s=>{try{let{user:a}=t();if(!a)return;let r=new Map(t().messages);r.set(s,[]),e({messages:r});let n=[...t().conversations],i=n.findIndex(e=>e.username===s);i>=0&&(n[i]={...n[i],last_message_preview:"Chat cleared",last_message_time:new Date().toISOString(),unread_count:0},e({conversations:n})),await j.clearConversationMessages(s,a.username),f.sendDeleteConversation(s);try{await o.deleteConversation(s)}catch(e){console.warn("Could not delete conversation messages on server:",e)}console.log("\uD83D\uDDD1️ Conversation messages deleted for everyone:",s)}catch(e){console.error("Failed to delete conversation messages for everyone:",e)}},handleRemoteDeleteMessage:(s,a)=>{let r=new Map(t().messages),n=(r.get(a)||[]).map(e=>e.id===s?{...e,_decryptedContent:null,encrypted_content:JSON.stringify({deleted:!0}),message_type:"deleted"}:e);r.set(a,n),e({messages:r}),j.markMessageAsDeleted(s).catch(console.error),console.log("\uD83D\uDCE8 Remote message deletion received:",s)},handleRemoteDeleteConversation:s=>{let a=new Map(t().messages);a.set(s,[]),e({messages:a});let r=[...t().conversations],n=r.findIndex(e=>e.username===s);n>=0&&(r[n]={...r[n],last_message_preview:"Chat cleared",last_message_time:new Date().toISOString(),unread_count:0},e({conversations:r}));let i=t().user;i&&j.clearConversationMessages(s,i.username).catch(console.error),console.log("\uD83D\uDCE8 Remote conversation cleared:",s)},loadPersistedData:async()=>{try{console.log("\uD83D\uDCC2 Loading persisted data from IndexedDB...");let s=await j.getAllConversations();if(s.length>0){let t=s.map(e=>({user_id:e.user_id,username:e.username,public_key:e.public_key,identity_key:e.identity_key,last_message_time:e.last_message_time,last_message_preview:e.last_message_preview,unread_count:e.unread_count,is_online:e.is_online}));e({conversations:t}),console.log("\uD83D\uDCC2 Loaded ".concat(t.length," conversations from storage"))}let a=await j.getAllContacts();if(a.length>0){let t=a.map(e=>({id:e.id,user_id:e.user_id,contact_id:e.contact_id,contact_username:e.contact_username,contact_email:e.contact_email,public_key:e.public_key,identity_key:e.identity_key,nickname:e.nickname,is_blocked:e.is_blocked,is_verified:e.is_verified,added_at:e.added_at}));e({contacts:t}),console.log("\uD83D\uDCC2 Loaded ".concat(t.length," contacts from storage"))}let{user:r}=t();if(r){let t=new Map;for(let e of s){let s=await j.getConversationMessages(e.username,r.username,50);if(s.length>0){let a=s.map(e=>({id:e.id,sender_id:e.sender_id,sender_username:e.sender_username,recipient_id:e.recipient_id,recipient_username:e.recipient_username,encrypted_content:e.encrypted_content,encrypted_key:e.encrypted_key,message_type:e.message_type,status:e.status,created_at:e.created_at,delivered_at:e.delivered_at,read_at:e.read_at,expiry_type:e.expiry_type,expires_at:e.expires_at,file_metadata:e.file_metadata}));t.set(e.username,a)}}e({messages:t}),console.log("\uD83D\uDCC2 Loaded messages for ".concat(t.size," conversations"))}}catch(e){console.error("❌ Failed to load persisted data:",e)}},syncWithServer:async()=>{try{console.log("\uD83D\uDD04 Syncing with server..."),await t().loadContacts(),await t().loadConversations();let s=await o.getAllConversationsWithMessages(),{user:a,contacts:r,conversations:n}=t();if(a){let t=n.map(e=>({username:e.username,user_id:e.user_id,public_key:e.public_key,identity_key:e.identity_key,last_message_time:e.last_message_time,last_message_preview:e.last_message_preview,unread_count:e.unread_count,is_online:e.is_online}));await j.saveConversations(t);let a=r.map(e=>({id:e.id,user_id:e.user_id,contact_id:e.contact_id,contact_username:e.contact_username,contact_email:e.contact_email,public_key:e.public_key,identity_key:e.identity_key,nickname:e.nickname,is_blocked:e.is_blocked,is_verified:e.is_verified,added_at:e.added_at}));for(let[e,t]of(await j.saveContacts(a),Object.entries(s))){let e=t.map(e=>({id:e.id,sender_id:e.sender_id,sender_username:e.sender_username,recipient_id:e.recipient_id,recipient_username:e.recipient_username,encrypted_content:e.encrypted_content,encrypted_key:e.encrypted_key,message_type:e.message_type,status:e.status,created_at:e.created_at,delivered_at:e.delivered_at,read_at:e.read_at,expiry_type:e.expiry_type,expires_at:e.expires_at,file_metadata:e.file_metadata}));await j.saveMessages(e)}let i=new Map;for(let[e,t]of Object.entries(s))i.set(e,t);e({messages:i}),console.log("✅ Sync completed successfully")}}catch(e){console.error("❌ Sync failed:",e)}},persistMessage:async e=>{try{let t={id:e.id,sender_id:e.sender_id,sender_username:e.sender_username,recipient_id:e.recipient_id,recipient_username:e.recipient_username,encrypted_content:e.encrypted_content,encrypted_key:e.encrypted_key,message_type:e.message_type,status:e.status,created_at:e.created_at,delivered_at:e.delivered_at,read_at:e.read_at,expiry_type:e.expiry_type,expires_at:e.expires_at,file_metadata:e.file_metadata};await j.saveMessage(t)}catch(e){console.error("❌ Failed to persist message:",e)}},persistConversation:async e=>{try{let t={username:e.username,user_id:e.user_id,public_key:e.public_key,identity_key:e.identity_key,last_message_time:e.last_message_time,last_message_preview:e.last_message_preview,unread_count:e.unread_count,is_online:e.is_online};await j.saveConversation(t)}catch(e){console.error("❌ Failed to persist conversation:",e)}},loadAllConversationHistory:async()=>{try{let{conversations:e}=t();for(let s of(console.log("\uD83D\uDCDA Loading history for ".concat(e.length," conversations...")),e))await t().loadMessages(s.username),await new Promise(e=>setTimeout(e,100));console.log("✅ All conversation history loaded")}catch(e){console.error("❌ Failed to load conversation history:",e)}}}),{name:"cipherlink-store",partialize:e=>({currentConversation:e.currentConversation})}));function K(e,t){f.on("message",t=>{var s,a;console.log("\uD83D\uDCE8 Received message:",t);let r=e(),n=t.sender_username,i={id:t.message_id,sender_id:t.sender_id,sender_username:n,recipient_id:(null===(s=r.user)||void 0===s?void 0:s.id)||0,recipient_username:(null===(a=r.user)||void 0===a?void 0:a.username)||"",encrypted_content:t.content||t.encrypted_content,encrypted_key:t.encrypted_key,message_type:t.message_type||"text",status:"delivered",expiry_type:t.expiry_type||"none",sender_theme:t.sender_theme,created_at:t.timestamp};e().addIncomingMessage(i),f.sendDeliveryReceipt(t.message_id,t.sender_id)}),f.on("typing",t=>{e().setUserTyping(t.sender_username,t.is_typing),t.is_typing&&setTimeout(()=>{e().setUserTyping(t.sender_username,!1)},3e3)}),f.on("presence",t=>{e().setUserOnline(t.user_id,t.is_online)}),f.on("message_sent",e=>{console.log("✅ Message sent confirmation:",e)}),f.on("read_receipt",e=>{console.log("\uD83D\uDC41️ Read receipt:",e)}),f.on("delivery_receipt",e=>{console.log("\uD83D\uDCEC Delivery receipt:",e)}),f.on("connected",e=>{console.log("✅ WebSocket connected:",e)}),f.on("error",e=>{console.error("❌ WebSocket error:",e)}),f.on("delete_message_received",t=>{var s,a;console.log("\uD83D\uDDD1️ Remote delete message received:",t);let r=t.message_id||(null===(s=t.data)||void 0===s?void 0:s.message_id),n=t.sender_username||(null===(a=t.data)||void 0===a?void 0:a.sender_username);r&&n&&e().handleRemoteDeleteMessage(r,n)}),f.on("delete_conversation_received",t=>{var s;console.log("\uD83D\uDDD1️ Remote delete conversation received:",t);let a=t.sender_username||(null===(s=t.data)||void 0===s?void 0:s.sender_username);a&&e().handleRemoteDeleteConversation(a)})}var P=s(5589),I=s(9036),M=s(774),F=s(2882),Z=s(7972),O=s(1295),A=s(7216),T=s(9670);function U(){let[e,t]=(0,r.useState)(!0),[s,n]=(0,r.useState)(""),[i,l]=(0,r.useState)(""),[c,o]=(0,r.useState)(""),[d,u]=(0,r.useState)(!1),{login:m,register:h,isLoading:g,error:p,clearError:y}=E(),x=async t=>{t.preventDefault(),y();try{e?await m(s,c):await h(s,i,c)}catch(e){}};return(0,a.jsxs)("div",{className:"min-h-screen bg-cipher-darker flex",children:[(0,a.jsxs)("div",{className:"hidden lg:flex lg:w-1/2 bg-gradient-to-br from-cipher-dark to-cipher-darker p-12 flex-col justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center gap-3 mb-8",children:[(0,a.jsx)("div",{className:"w-12 h-12 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-xl flex items-center justify-center",children:(0,a.jsx)(P.Z,{className:"w-6 h-6 text-white"})}),(0,a.jsx)("span",{className:"text-2xl font-bold gradient-text",children:"CipherLink"})]}),(0,a.jsxs)("h1",{className:"text-4xl font-bold text-white mb-4",children:["Private by design.",(0,a.jsx)("br",{}),(0,a.jsx)("span",{className:"text-cipher-primary",children:"Secure by default."})]}),(0,a.jsx)("p",{className:"text-gray-400 text-lg mb-12",children:"End-to-end encrypted communication where only you and your recipient can read messages. The server never sees your data."}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)(R,{icon:(0,a.jsx)(I.Z,{className:"w-5 h-5"}),title:"Zero-Knowledge Server",description:"We can't read your messages. Ever."}),(0,a.jsx)(R,{icon:(0,a.jsx)(M.Z,{className:"w-5 h-5"}),title:"Cryptographic Identity",description:"Your identity is based on math, not trust."}),(0,a.jsx)(R,{icon:(0,a.jsx)(F.Z,{className:"w-5 h-5"}),title:"Ephemeral Messages",description:"Messages that disappear after being read."})]})]}),(0,a.jsxs)("div",{className:"text-gray-500 text-sm",children:[(0,a.jsx)("p",{children:"Encryption: X25519 + AES-256-GCM"}),(0,a.jsx)("p",{children:"Protocol: Signal-style X3DH"})]})]}),(0,a.jsx)("div",{className:"w-full lg:w-1/2 flex items-center justify-center p-8",children:(0,a.jsxs)("div",{className:"w-full max-w-md",children:[(0,a.jsxs)("div",{className:"lg:hidden flex items-center gap-3 mb-8 justify-center",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-xl flex items-center justify-center",children:(0,a.jsx)(P.Z,{className:"w-5 h-5 text-white"})}),(0,a.jsx)("span",{className:"text-xl font-bold gradient-text",children:"CipherLink"})]}),(0,a.jsxs)("div",{className:"glass rounded-2xl p-8",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-white mb-2",children:e?"Welcome back":"Create account"}),(0,a.jsx)("p",{className:"text-gray-400 mb-6",children:e?"Enter your credentials to access your encrypted messages":"Generate your cryptographic identity"}),p&&(0,a.jsx)("div",{className:"bg-red-500/10 border border-red-500/20 rounded-lg p-3 mb-4",children:(0,a.jsx)("p",{className:"text-red-400 text-sm",children:p})}),(0,a.jsxs)("form",{onSubmit:x,className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Username"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(Z.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"}),(0,a.jsx)("input",{type:"text",value:s,onChange:e=>n(e.target.value),className:"w-full bg-cipher-dark border border-gray-700 rounded-lg py-3 pl-10 pr-4 text-white placeholder-gray-500 focus:border-cipher-primary transition-colors",placeholder:"Enter username",required:!0,minLength:3})]})]}),!e&&(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Email"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(O.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"}),(0,a.jsx)("input",{type:"email",value:i,onChange:e=>l(e.target.value),className:"w-full bg-cipher-dark border border-gray-700 rounded-lg py-3 pl-10 pr-4 text-white placeholder-gray-500 focus:border-cipher-primary transition-colors",placeholder:"Enter email",required:!e})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Password"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(P.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"}),(0,a.jsx)("input",{type:d?"text":"password",value:c,onChange:e=>o(e.target.value),className:"w-full bg-cipher-dark border border-gray-700 rounded-lg py-3 pl-10 pr-12 text-white placeholder-gray-500 focus:border-cipher-primary transition-colors",placeholder:"Enter password",required:!0,minLength:8}),(0,a.jsx)("button",{type:"button",onClick:()=>u(!d),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-300",children:d?(0,a.jsx)(A.Z,{className:"w-5 h-5"}):(0,a.jsx)(T.Z,{className:"w-5 h-5"})})]})]}),(0,a.jsx)("button",{type:"submit",disabled:g,className:"w-full bg-gradient-to-r from-cipher-primary to-cipher-secondary text-white py-3 rounded-lg font-medium btn-primary disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:g?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),e?"Authenticating...":"Creating keys..."]}):(0,a.jsxs)(a.Fragment,{children:[e?"Sign In":"Create Account",(0,a.jsx)(P.Z,{className:"w-4 h-4"})]})})]}),(0,a.jsx)("div",{className:"mt-6 text-center",children:(0,a.jsxs)("p",{className:"text-gray-400",children:[e?"Don't have an account?":"Already have an account?",(0,a.jsx)("button",{onClick:()=>{t(!e),y(),o("")},className:"text-cipher-primary hover:text-cipher-secondary ml-1 font-medium",children:e?"Sign up":"Sign in"})]})})]}),(0,a.jsxs)("div",{className:"mt-6 flex items-start gap-3 text-sm text-gray-500",children:[(0,a.jsx)(I.Z,{className:"w-5 h-5 flex-shrink-0 text-cipher-primary"}),(0,a.jsx)("p",{children:"Your private keys are generated locally and never leave your device. We use end-to-end encryption so only you can read your messages."})]})]})})]})}function R(e){let{icon:t,title:s,description:r}=e;return(0,a.jsxs)("div",{className:"flex items-start gap-4",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-cipher-primary/20 rounded-lg flex items-center justify-center text-cipher-primary flex-shrink-0",children:t}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-white font-medium",children:s}),(0,a.jsx)("p",{className:"text-gray-400 text-sm",children:r})]})]})}var L=s(9883),H=s(9409),B=s(5883),W=s(1827),z=s(2549),J=s(6264),G=s(4527),V=s(6834),Y=s(8175),q=s(5626);function Q(e){let{onNewChat:t,onSettings:s}=e,{user:n,conversations:i,currentConversation:l,setCurrentConversation:c,logout:o,onlineUsers:d,searchUsers:u,addContact:m,loadContacts:h,loadConversations:g,contacts:p}=E(),{getAccentGradient:y,settings:x}=(0,N.MU)(),b=y(),[v,f]=(0,r.useState)(""),[w,j]=(0,r.useState)(!1),[_,k]=(0,r.useState)([]),[C,S]=(0,r.useState)(!1),[D,K]=(0,r.useState)(null),M=(0,r.useMemo)(()=>{if(!v.trim())return i;let e=v.toLowerCase();return i.filter(t=>t.username.toLowerCase().includes(e))},[i,v]),O=async e=>{if(f(e),e.trim().length>=2){j(!0),S(!0);try{let t=(await u(e.trim())).filter(e=>e.username!==(null==n?void 0:n.username));k(t)}catch(e){console.error("Search failed:",e),k([])}finally{j(!1)}}else k([]),S(!1)},A=async e=>{K(e.id);try{i.find(t=>t.username===e.username)||(p.find(t=>t.contact_username===e.username)||(await m(e.username),await h()),await g()),c(e.username),f(""),k([]),S(!1)}catch(e){console.error("Failed to start chat:",e)}finally{K(null)}},T=e=>{if(!e)return"";let t=new Date(e);return(0,V.z)(t)?(0,Y.WU)(t,"HH:mm"):(0,q.g)(t)?"Yesterday":(0,Y.WU)(t,"dd/MM")};return(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-800",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center",style:{background:b},children:(0,a.jsx)(P.Z,{className:"w-4 h-4 text-white"})}),(0,a.jsx)("span",{className:"font-bold text-white dark:text-white",children:"CipherLink"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:t,className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"New Chat",children:(0,a.jsx)(L.Z,{className:"w-5 h-5"})}),(0,a.jsx)("button",{onClick:s,className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Settings",children:(0,a.jsx)(H.Z,{className:"w-5 h-5"})})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3 p-2 bg-cipher-darker/50 dark:bg-gray-800/50 rounded-lg",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:b},children:(0,a.jsx)(Z.Z,{className:"w-5 h-5 text-white"})}),(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-cipher-dark"})]}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("p",{className:"font-medium text-white truncate",children:null==n?void 0:n.username}),(0,a.jsx)("p",{className:"text-xs text-gray-500 truncate",children:null==n?void 0:n.email})]}),(0,a.jsx)("button",{onClick:o,className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-red-400 transition-colors",title:"Logout",children:(0,a.jsx)(B.Z,{className:"w-4 h-4"})})]})]}),(0,a.jsxs)("div",{className:"p-4",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(W.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"}),(0,a.jsx)("input",{type:"text",placeholder:"Search users or conversations...",value:v,onChange:e=>O(e.target.value),className:"w-full bg-cipher-darker border border-gray-700 rounded-lg py-2 pl-10 pr-10 text-sm text-white placeholder-gray-500 focus:border-cipher-primary transition-colors"}),v&&(0,a.jsx)("button",{onClick:()=>{f(""),k([]),S(!1)},className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white transition-colors",children:(0,a.jsx)(z.Z,{className:"w-4 h-4"})}),w&&(0,a.jsx)(J.Z,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-cipher-primary animate-spin"})]}),C&&_.length>0&&(0,a.jsxs)("div",{className:"mt-2 bg-cipher-darker border border-gray-700 rounded-lg overflow-hidden",children:[(0,a.jsx)("div",{className:"px-3 py-2 border-b border-gray-700 bg-gray-800/50",children:(0,a.jsx)("p",{className:"text-xs text-gray-400 font-medium",children:"Users Found"})}),(0,a.jsx)("div",{className:"max-h-48 overflow-y-auto",children:_.map(e=>{let t=i.find(t=>t.username===e.username),s=D===e.id;return(0,a.jsxs)("button",{onClick:()=>A(e),disabled:s,className:"w-full p-3 flex items-center gap-3 hover:bg-gray-800 transition-colors border-b border-gray-700/50 last:border-0",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:b},children:(0,a.jsx)("span",{className:"text-white font-medium text-sm",children:e.username[0].toUpperCase()})}),e.is_online&&(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-cipher-darker"})]}),(0,a.jsxs)("div",{className:"flex-1 text-left min-w-0",children:[(0,a.jsx)("p",{className:"text-white font-medium truncate text-sm",children:e.username}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:t?"Open chat":"Start new chat"})]}),s?(0,a.jsx)(J.Z,{className:"w-5 h-5 text-cipher-primary animate-spin"}):t?(0,a.jsx)(F.Z,{className:"w-5 h-5 text-cipher-primary"}):(0,a.jsx)(G.Z,{className:"w-5 h-5 text-green-500"})]},e.id)})})]}),C&&!w&&v.length>=2&&0===_.length&&(0,a.jsxs)("div",{className:"mt-2 p-4 bg-cipher-darker border border-gray-700 rounded-lg text-center",children:[(0,a.jsxs)("p",{className:"text-sm text-gray-400",children:['No users found for "',v,'"']}),(0,a.jsx)("button",{onClick:t,className:"mt-2 text-xs text-cipher-primary hover:underline",children:"Try advanced search"})]})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===M.length&&0===i.length?(0,a.jsxs)("div",{className:"p-8 text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(F.Z,{className:"w-8 h-8 text-gray-600"})}),(0,a.jsx)("p",{className:"text-gray-400 text-sm",children:"No conversations yet"}),(0,a.jsx)("button",{onClick:t,className:"mt-3 text-cipher-primary hover:text-cipher-secondary text-sm font-medium",children:"Start a new chat"})]}):0===M.length&&v?(0,a.jsx)("div",{className:"p-4 text-center",children:(0,a.jsxs)("p",{className:"text-gray-400 text-sm",children:['No conversations match "',v,'"']})}):(0,a.jsx)("div",{className:"space-y-1 p-2",children:M.map(e=>{let t=l===e.username,s=d.has(e.user_id);return(0,a.jsxs)("button",{onClick:()=>c(e.username),className:"\n                    w-full p-3 rounded-lg flex items-center gap-3 transition-colors\n                    ".concat(t?"bg-cipher-primary/20 border border-cipher-primary/30":"hover:bg-gray-800","\n                  "),children:[(0,a.jsxs)("div",{className:"relative flex-shrink-0",children:[(0,a.jsx)("div",{className:"w-12 h-12 rounded-full flex items-center justify-center ".concat(t?"":"bg-gray-700"),style:t?{background:b}:void 0,children:(0,a.jsx)("span",{className:"text-white font-medium",children:e.username.charAt(0).toUpperCase()})}),s&&(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-cipher-dark online-indicator"})]}),(0,a.jsxs)("div",{className:"flex-1 min-w-0 text-left",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"font-medium truncate ".concat(t?"text-white":"text-gray-200"),children:e.username}),(0,a.jsx)("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:T(e.last_message_time)})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1 text-sm text-gray-400 truncate",children:[(0,a.jsx)(I.Z,{className:"w-3 h-3 text-cipher-primary flex-shrink-0"}),(0,a.jsx)("span",{className:"truncate",children:e.last_message_preview||"Start conversation"})]}),e.unread_count>0&&(0,a.jsx)("span",{className:"bg-cipher-primary text-white text-xs px-2 py-0.5 rounded-full flex-shrink-0 ml-2",children:e.unread_count})]})]})]},e.user_id)})})}),(0,a.jsx)("div",{className:"p-4 border-t border-gray-800",children:(0,a.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[(0,a.jsx)(P.Z,{className:"w-3 h-3 text-cipher-primary"}),(0,a.jsx)("span",{children:"End-to-end encrypted"})]})})]})}let X={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}]};class ${setupWebSocketHandlers(){f.on("call_offer",async e=>{console.log("\uD83D\uDCDE Incoming call offer received:",e);let t=e.call_id,s=e.call_type||"audio",a=e.caller_username,r=e.sdp;if(!t||!a){console.error("Invalid call_offer message:",e);return}this.pendingSdp=r,this.currentCall={callId:t,type:s,status:"ringing",remoteUsername:a,isIncoming:!0},console.log("\uD83D\uDCDE Call state set to ringing:",this.currentCall),this.notifyStateChange()}),f.on("call_answer",async e=>{if(console.log("✅ Call answered:",e),this.currentCall&&this.peerConnection)try{await this.peerConnection.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e.sdp})),await this.processPendingIceCandidates(),this.currentCall.status="connected",this.currentCall.startTime=new Date,this.notifyStateChange()}catch(e){console.error("Error setting remote description:",e)}}),f.on("call_rejected",e=>{console.log("❌ Call rejected:",e),this.endCall(!1),this.currentCall&&(this.currentCall.status="failed",this.notifyStateChange())}),f.on("call_ended",e=>{console.log("\uD83D\uDCF4 Call ended:",e),this.endCall(!1)}),f.on("ice_candidate",async e=>{console.log("\uD83E\uDDCA ICE candidate received:",e);let t=e.candidate;if(t){if(this.peerConnection&&this.peerConnection.remoteDescription)try{await this.peerConnection.addIceCandidate(new RTCIceCandidate(t)),console.log("✅ ICE candidate added successfully")}catch(e){console.error("❌ Error adding ICE candidate:",e)}else console.log("⏳ Queued ICE candidate (remote description not set yet)"),this.pendingIceCandidates.push(t)}else console.log("⚠️ Empty ICE candidate received (end of candidates)")}),f.on("call_failed",e=>{console.warn("\uD83D\uDCA5 Call failed error received:",e),this.currentCall&&(this.currentCall.status="failed",this.notifyStateChange()),this.cleanup()})}async processPendingIceCandidates(){if(this.peerConnection&&this.peerConnection.remoteDescription){for(let e of this.pendingIceCandidates)try{await this.peerConnection.addIceCandidate(new RTCIceCandidate(e))}catch(e){console.error("Error adding pending ICE candidate:",e)}this.pendingIceCandidates=[]}}notifyStateChange(){this.onCallStateChange&&this.currentCall&&this.onCallStateChange({...this.currentCall})}setOnCallStateChange(e){this.onCallStateChange=e}setOnRemoteStream(e){this.onRemoteStream=e}setOnLocalStream(e){this.onLocalStream=e}async startCall(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"audio";try{var s;console.log("\uD83D\uDCDE Starting ".concat(t," call to ").concat(e));let a="".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9));this.currentCall={callId:a,type:t,status:"calling",remoteUsername:e,isIncoming:!1},this.notifyStateChange(),console.log("\uD83D\uDCDE Requesting user media..."),this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:"video"===t}),null===(s=this.onLocalStream)||void 0===s||s.call(this,this.localStream),this.currentCall.localStream=this.localStream,this.notifyStateChange(),console.log("\uD83D\uDCDE Creating peer connection..."),this.peerConnection=new RTCPeerConnection({iceServers:this.config.iceServers}),this.setupPeerConnectionHandlers(),this.localStream.getTracks().forEach(e=>{this.peerConnection.addTrack(e,this.localStream)}),console.log("\uD83D\uDCDE Creating offer...");let r=await this.peerConnection.createOffer();return await this.peerConnection.setLocalDescription(r),console.log("\uD83D\uDCDE Sending call offer via WebSocket..."),f.send({type:"call_offer",data:{call_id:a,recipient_username:e,call_type:t,sdp:r.sdp},timestamp:new Date().toISOString()}),!0}catch(t){console.error("Error starting call:",t);let e="Failed to start call";return"NotReadableError"===t.name?e="Camera/microphone is in use by another application. Please close other apps using the camera.":"NotAllowedError"===t.name?e="Camera/microphone permission denied. Please allow access in browser settings.":"NotFoundError"===t.name&&(e="No camera/microphone found. Please connect a device."),this.currentCall&&(this.currentCall.status="failed",this.currentCall.errorMessage=e,this.notifyStateChange()),this.cleanup(),!1}}async answerCall(e){if(console.log("\uD83D\uDCDE answerCall() called, currentCall:",this.currentCall),!this.currentCall)return console.error("❌ No current call to answer"),!1;try{var t;console.log("✅ Answering call, getting user media...");let s={audio:!0,video:"video"===this.currentCall.type};this.localStream=await navigator.mediaDevices.getUserMedia(s),console.log("✅ Got user media"),null===(t=this.onLocalStream)||void 0===t||t.call(this,this.localStream),console.log("✅ Creating peer connection..."),this.peerConnection=new RTCPeerConnection({iceServers:this.config.iceServers}),this.setupPeerConnectionHandlers(),this.localStream.getTracks().forEach(e=>{this.peerConnection.addTrack(e,this.localStream)}),console.log("✅ Added local tracks");let a=(null==e?void 0:e.sdp)||this.pendingSdp;if(console.log("\uD83D\uDCDE Incoming SDP available:",!!a),a)console.log("✅ Setting remote description..."),await this.peerConnection.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:a}));else throw console.error("❌ No SDP available to answer call"),Error("No SDP available");await this.processPendingIceCandidates(),console.log("✅ Creating answer...");let r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),this.currentCall.status="connecting",this.currentCall.localStream=this.localStream,this.notifyStateChange(),console.log("✅ Sending answer via WebSocket..."),f.send({type:"call_answer",data:{call_id:this.currentCall.callId,sdp:r.sdp},timestamp:new Date().toISOString()}),console.log("✅ Call answered successfully"),!0}catch(t){console.error("❌ Error answering call:",t);let e="Failed to answer call";return"NotReadableError"===t.name?e="Camera/microphone is in use by another application. Please close other apps using the camera.":"NotAllowedError"===t.name?e="Camera/microphone permission denied. Please allow access in browser settings.":"NotFoundError"===t.name&&(e="No camera/microphone found. Please connect a device."),this.currentCall&&(this.currentCall.status="failed",this.currentCall.errorMessage=e,this.notifyStateChange()),this.cleanup(),!1}}rejectCall(){this.currentCall&&(console.log("❌ Rejecting call"),f.send({type:"call_reject",data:{call_id:this.currentCall.callId,reason:"rejected"},timestamp:new Date().toISOString()}),this.cleanup())}endCall(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];this.currentCall&&(console.log("\uD83D\uDCF4 Ending call"),e&&f.send({type:"call_end",data:{call_id:this.currentCall.callId},timestamp:new Date().toISOString()}),this.cleanup())}setupPeerConnectionHandlers(){this.peerConnection&&(this.peerConnection.ontrack=e=>{var t;console.log("\uD83C\uDFA5 Remote track received:",e.track.kind),this.remoteStream||(this.remoteStream=new MediaStream),this.remoteStream.addTrack(e.track),this.currentCall&&(this.currentCall.remoteStream=this.remoteStream,this.currentCall.status="connected",this.currentCall.startTime||(this.currentCall.startTime=new Date),this.notifyStateChange()),null===(t=this.onRemoteStream)||void 0===t||t.call(this,this.remoteStream)},this.peerConnection.onicecandidate=e=>{if(e.candidate&&this.currentCall){var t;console.log("\uD83E\uDDCA Sending ICE candidate:",(null===(t=e.candidate.candidate)||void 0===t?void 0:t.substring(0,50))+"..."),f.send({type:"ice_candidate",data:{call_id:this.currentCall.callId,candidate:e.candidate.toJSON()},timestamp:new Date().toISOString()})}else e.candidate||console.log("\uD83E\uDDCA ICE gathering complete")},this.peerConnection.onconnectionstatechange=()=>{var e,t;console.log("Connection state:",null===(e=this.peerConnection)||void 0===e?void 0:e.connectionState),(null===(t=this.peerConnection)||void 0===t?void 0:t.connectionState)==="failed"&&this.endCall()},this.peerConnection.oniceconnectionstatechange=()=>{var e;console.log("ICE connection state:",null===(e=this.peerConnection)||void 0===e?void 0:e.iceConnectionState)})}cleanup(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.remoteStream&&(this.remoteStream.getTracks().forEach(e=>e.stop()),this.remoteStream=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.currentCall&&(this.currentCall.status="ended",this.notifyStateChange()),this.currentCall=null,this.pendingIceCandidates=[],this.pendingSdp=null}toggleMute(){if(this.localStream){let e=this.localStream.getAudioTracks()[0];if(e)return e.enabled=!e.enabled,e.enabled}return!0}toggleVideo(){if(this.localStream){let e=this.localStream.getVideoTracks()[0];if(e)return e.enabled=!e.enabled,e.enabled}return!0}getCurrentCall(){return this.currentCall?{...this.currentCall}:null}isInCall(){return null!==this.currentCall&&["calling","ringing","connecting","connected"].includes(this.currentCall.status)}async replaceVideoTrack(e){if(!this.peerConnection)return!1;let t=this.peerConnection.getSenders().find(e=>{var t;return(null===(t=e.track)||void 0===t?void 0:t.kind)==="video"});if(t)try{if(await t.replaceTrack(e),this.localStream){let t=this.localStream.getVideoTracks()[0];t&&this.localStream.removeTrack(t),this.localStream.addTrack(e),this.currentCall&&(this.currentCall.localStream=this.localStream,this.notifyStateChange())}return!0}catch(e){console.error("Error replacing video track:",e)}return!1}constructor(e=X){this.peerConnection=null,this.localStream=null,this.remoteStream=null,this.currentCall=null,this.onCallStateChange=null,this.onRemoteStream=null,this.onLocalStream=null,this.pendingIceCandidates=[],this.pendingSdp=null,this.config=e,this.setupWebSocketHandlers()}}let ee=new $;var et=s(2442),es=s(690),ea=s(1981),er=s(6141),en=s(1138),ei=s(5817),el=s(6637),ec=s(5671),eo=s(8339),ed=s(2741),eu=s(612),em=s(1841),eh=s(5099),eg=s(9292),ep=s(7803),ey=s(4043),ex=s(3067),eb=s(4056),ev=s(290),ef=s(3714),ew=s(8438),ej=s(8734),eN=s(6489),e_=s(6020),ek=s(7870);function eC(e){return e?new Date(e.endsWith("Z")||/[+-]\d{2}:\d{2}$/.test(e)||/[+-]\d{4}$/.test(e)?e:e+"Z"):new Date}function eS(){let{user:e,currentConversation:t,messages:s,contacts:n,conversations:i,privateKey:l,sendMessage:c,onlineUsers:d,typingUsers:u,setCurrentConversation:m,loadCallHistory:p,callHistory:y,deleteMessageForMe:x,deleteMessageForEveryone:b,clearChat:v,deleteConversationForEveryone:w}=E(),{getAccentGradient:j,getAccentColors:_,getDensityClasses:k,getFontClasses:C,settings:S}=(0,N.MU)(),D=j();_();let K=k(),M=C(),[F,Z]=(0,r.useState)(""),[O,A]=(0,r.useState)(!1),[T,U]=(0,r.useState)(!1),[R,L]=(0,r.useState)(null),[H,B]=(0,r.useState)(null),[W,G]=(0,r.useState)(!1),[V,q]=(0,r.useState)(!1),[Q,X]=(0,r.useState)(!1),[$,eS]=(0,r.useState)(!1),[eD,eE]=(0,r.useState)(0),[eK,eP]=(0,r.useState)(!1),[eI,eM]=(0,r.useState)(!1),[eF,eZ]=(0,r.useState)(!1),[eO,eA]=(0,r.useState)(null),[eT,eU]=(0,r.useState)(null),[eR,eL]=(0,r.useState)(!1),[eH,eB]=(0,r.useState)(null),eW=(0,r.useRef)(null),ez=(0,r.useRef)(null),eJ=(0,r.useRef)(null),eG=(0,r.useRef)(null),eV=(0,r.useRef)(null),eY=n.find(e=>e.contact_username===t),eq=i.find(e=>e.username===t),eQ=(null==eY?void 0:eY.contact_id)||(null==eq?void 0:eq.user_id),eX=(null==eY?void 0:eY.public_key)||(null==eq?void 0:eq.public_key),e$=!!eQ&&d.has(eQ),e0=!!t&&u.get(t),e1=t&&s.get(t)||[],e4=(y||[]).filter(e=>e.caller_username===t||e.receiver_username===t),e2=[...e1.map(e=>({type:"message",data:e,date:eC(e.created_at)})),...e4.map(e=>({type:"call",data:e,date:eC(e.start_time)}))].sort((e,t)=>e.date.getTime()-t.date.getTime());(0,r.useEffect)(()=>{p()},[p]),(0,r.useEffect)(()=>{(async function(){if(t&&!eX)try{let e=await o.getPublicKey(t);(null==e?void 0:e.public_key)&&eA(e.public_key)}catch(e){console.error("Failed to fetch public key:",e)}else eX&&eA(eX)})()},[t,eX]),(0,r.useEffect)(()=>{var e;null===(e=eW.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[e1]),(0,r.useEffect)(()=>{if(t&&F){f.sendTypingIndicator(t,!0);let e=setTimeout(()=>{f.sendTypingIndicator(t,!1)},2e3);return()=>clearTimeout(e)}},[F,t]),(0,r.useEffect)(()=>(ee.setOnCallStateChange(e=>{console.log("\uD83D\uDCDE Call state changed:",e),B(e)}),ee.setOnLocalStream(e=>{eJ.current&&(eJ.current.srcObject=e)}),ee.setOnRemoteStream(e=>{eG.current&&(eG.current.srcObject=e)}),()=>{ee.setOnCallStateChange(null),ee.setOnLocalStream(null),ee.setOnRemoteStream(null)}),[]),(0,r.useEffect)(()=>{H&&(console.log("\uD83C\uDFA5 Syncing streams, callState:",H.status,"localStream:",!!H.localStream,"remoteStream:",!!H.remoteStream),H.localStream&&(eJ.current?eJ.current.srcObject!==H.localStream&&(console.log("\uD83C\uDFA5 Attaching local stream to video element"),eJ.current.srcObject=H.localStream,eJ.current.play().catch(e=>console.error("Error playing local stream:",e))):console.log("⏳ Local video element not yet mounted")),H.remoteStream&&(eG.current?eG.current.srcObject!==H.remoteStream&&(console.log("\uD83C\uDFA5 Attaching remote stream to video element"),eG.current.srcObject=H.remoteStream,eG.current.play().catch(e=>console.error("Error playing remote stream:",e))):(console.log("⏳ Remote video element not yet mounted, retrying..."),setTimeout(()=>{eG.current&&H.remoteStream&&(console.log("\uD83C\uDFA5 Retry: Attaching remote stream to video element"),eG.current.srcObject=H.remoteStream,eG.current.play().catch(e=>console.error("Error playing remote stream:",e)))},100))))},[H,null==H?void 0:H.localStream,null==H?void 0:H.remoteStream]),(0,r.useEffect)(()=>{let e=null;return(null==H?void 0:H.status)==="connected"&&H.startTime?e=setInterval(()=>{let e=new Date,t=new Date(H.startTime);eE(Math.floor((e.getTime()-t.getTime())/1e3))},1e3):eE(0),()=>{e&&clearInterval(e)}},[null==H?void 0:H.status,null==H?void 0:H.startTime]),(0,r.useEffect)(()=>{let e=()=>eL(!1);return eR&&document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[eR]);let e3=e=>{let t=Math.floor(e/3600),s=Math.floor(e%3600/60),a=e%60;return t>0?"".concat(t,":").concat(s.toString().padStart(2,"0"),":").concat(a.toString().padStart(2,"0")):"".concat(s,":").concat(a.toString().padStart(2,"0"))},e5=async()=>{if(Q)try{let e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});ee.replaceVideoTrack(e.getVideoTracks()[0]),X(!1)}catch(e){console.error("Error stopping screen share:",e)}else try{let e=await navigator.mediaDevices.getDisplayMedia({video:!0});ee.replaceVideoTrack(e.getVideoTracks()[0]),X(!0),e.getVideoTracks()[0].onended=()=>{X(!1),navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{ee.replaceVideoTrack(e.getVideoTracks()[0])})}}catch(e){console.error("Error starting screen share:",e)}},e6=async()=>{if(F.trim()&&t&&!O){A(!0);try{var e;await c(t,F),Z(""),null===(e=ez.current)||void 0===e||e.focus()}catch(e){console.error("Failed to send message:",e)}finally{A(!1)}}},e8=async e=>{t&&(console.log("\uD83D\uDCDE Initiating ".concat(e," call to ").concat(t)),await ee.startCall(t,e)?console.log("✅ Call started successfully"):console.error("❌ Failed to start call"))},e7=async()=>{console.log("\uD83D\uDCDE Answer button clicked");try{let e=await ee.answerCall();console.log("\uD83D\uDCDE Answer call result:",e),e||console.error("❌ Failed to answer call")}catch(e){console.error("❌ Error answering call:",e)}},e9=()=>{ee.rejectCall(),B(null)},te=async e=>{let s=e.target.files;if(!s||0===s.length||!t)return;let a=s[0];eM(!1),A(!0);try{let e=new FileReader;e.onload=async()=>{let s=e.result,r={name:a.name,type:a.type,size:a.size};await c(t,s,a.type.startsWith("image/")?"image":"file",r)},e.readAsDataURL(a)}catch(e){console.error("Failed to send file:",e)}finally{A(!1),eV.current&&(eV.current.value="")}},tt=(0,r.useCallback)(t=>{if(t._decryptedContent)return t._decryptedContent;if(!l)return"[Encrypted]";try{let s;let a=JSON.parse(t.encrypted_content);if(t.sender_username===(null==e?void 0:e.username)){if(s=(null==eY?void 0:eY.public_key)||(null==eq?void 0:eq.public_key)||eO||void 0,!a.senderPublicKey&&!s)return"[Sent message]"}else if(s=(null==eY?void 0:eY.public_key)||(null==eq?void 0:eq.public_key)||eO||void 0,!a.senderPublicKey&&!s)return"[Key not available]";let r=h(a,s||"",l);if(!r){if(t.sender_username===(null==e?void 0:e.username))return"[Sent message]";return"[Decryption failed]"}return r}catch(e){return console.error("Decryption error:",e),"[Encrypted message]"}},[l,e,eY,eq,eO]),ts=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"download";try{let s=document.createElement("a");s.href=e,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s)}catch(e){console.error("Download failed:",e)}},ta=e=>{switch(e.status){case"sent":return(0,a.jsx)(et.Z,{className:"w-4 h-4 text-gray-400"});case"delivered":return(0,a.jsx)(es.Z,{className:"w-4 h-4 text-gray-400"});case"read":return(0,a.jsx)(es.Z,{className:"w-4 h-4 text-cipher-primary"});case"sending":return(0,a.jsx)(J.Z,{className:"w-4 h-4 text-gray-500 animate-spin"});case"failed":return(0,a.jsx)(ea.Z,{className:"w-4 h-4 text-red-500"});default:return(0,a.jsx)(er.Z,{className:"w-4 h-4 text-gray-500"})}},tr=e=>{if("deleted"===e.message_type)return(0,a.jsxs)("p",{className:"italic text-gray-400/70",children:[(0,a.jsx)(en.Z,{className:"w-3 h-3 inline mr-1"}),"This message was deleted"]});let t=tt(e);if("image"===e.message_type&&t.startsWith("data:image"))return(0,a.jsxs)("div",{className:"relative group",children:[(0,a.jsx)("img",{src:t,alt:"Shared image",className:"max-w-full rounded-lg max-h-64 object-cover cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>L(t)}),(0,a.jsx)("button",{onClick:()=>ts(t,"image_".concat(e.id,".png")),className:"absolute top-2 right-2 p-1.5 bg-black/50 hover:bg-black/70 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity",title:"Download Image",children:(0,a.jsx)(ei.Z,{className:"w-4 h-4"})})]});if("file"===e.message_type||"image"===e.message_type&&!t.startsWith("data:image")){var s,r,n;return t.startsWith("data:"),(0,a.jsx)("div",{className:"flex flex-col gap-2 p-1",children:(0,a.jsxs)("div",{className:"flex items-center gap-3 bg-cipher-dark/40 p-3 rounded-xl border border-white/5",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-cipher-primary/20 rounded-lg flex items-center justify-center text-cipher-primary",children:(0,a.jsx)(el.Z,{className:"w-6 h-6"})}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("p",{className:"text-sm font-medium truncate text-white",children:(null===(s=e.file_metadata)||void 0===s?void 0:s.name)||"document_".concat(e.id)}),(0,a.jsx)("p",{className:"text-xs text-gray-500 uppercase",children:(null===(n=e.file_metadata)||void 0===n?void 0:null===(r=n.type)||void 0===r?void 0:r.split("/")[1])||"FILE"})]}),(0,a.jsx)("button",{onClick:()=>{var s;return ts(t,(null===(s=e.file_metadata)||void 0===s?void 0:s.name)||"document")},className:"p-2 hover:bg-white/10 rounded-full text-cipher-primary transition-colors",title:"Download File",children:(0,a.jsx)(ei.Z,{className:"w-5 h-5"})})]})})}return(0,a.jsx)("p",{className:"break-words",children:t})},tn=(e,t,s)=>{e.preventDefault(),eU({visible:!0,x:e.clientX,y:e.clientY,messageId:t,isMine:s})},ti=async e=>{eT&&t&&(e?eB({visible:!0,type:"message",messageId:eT.messageId,deleteForEveryone:!0}):await x(eT.messageId,t),eU(null))},tl=async()=>{if(eH&&t){try{"message"===eH.type&&eH.messageId?eH.deleteForEveryone?await b(eH.messageId,t):await x(eH.messageId,t):"chat"===eH.type?await v(t):"conversation"===eH.type&&await w(t)}catch(e){console.error("Deletion failed:",e)}eB(null)}};return H&&"ringing"===H.status&&H.isIncoming?(0,a.jsx)("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-24 h-24 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse",children:(0,a.jsx)("span",{className:"text-3xl text-white font-bold",children:H.remoteUsername.charAt(0).toUpperCase()})}),(0,a.jsx)("h2",{className:"text-xl font-bold text-white mb-2",children:H.remoteUsername}),(0,a.jsxs)("p",{className:"text-gray-400 mb-6",children:["Incoming ",H.type," call..."]}),(0,a.jsxs)("div",{className:"flex items-center justify-center gap-4",children:[(0,a.jsx)("button",{type:"button",onClick:e=>{e.stopPropagation(),e9()},className:"p-4 bg-red-500 rounded-full hover:bg-red-600 transition-colors",children:(0,a.jsx)(ec.Z,{className:"w-6 h-6 text-white"})}),(0,a.jsx)("button",{type:"button",onClick:e=>{e.stopPropagation(),e7()},className:"p-4 bg-green-500 rounded-full hover:bg-green-600 transition-colors animate-bounce",children:"video"===H.type?(0,a.jsx)(eo.Z,{className:"w-6 h-6 text-white"}):(0,a.jsx)(ed.Z,{className:"w-6 h-6 text-white"})})]})]})}):t?H&&"failed"===H.status?(0,a.jsx)("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"text-center max-w-md p-6",children:[(0,a.jsx)("div",{className:"w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(ea.Z,{className:"w-10 h-10 text-red-500"})}),(0,a.jsx)("h2",{className:"text-xl font-bold text-white mb-2",children:"Call Failed"}),(0,a.jsx)("p",{className:"text-gray-400 mb-6",children:H.errorMessage||"Unable to connect the call. Please try again."}),(0,a.jsx)("button",{onClick:()=>{ee.endCall(!1),B(null)},className:"px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors",children:"Dismiss"})]})}):H&&["calling","ringing","connecting","connected"].includes(H.status)?(0,a.jsxs)("div",{className:"flex-1 flex flex-col h-full bg-[#1a1a1a] relative overflow-hidden",children:[(0,a.jsxs)("div",{className:"absolute top-0 left-0 right-0 z-30 p-4 flex items-center justify-between bg-gradient-to-b from-black/60 to-transparent",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-full flex items-center justify-center",children:(0,a.jsx)("span",{className:"text-white font-bold",children:H.remoteUsername.charAt(0).toUpperCase()})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-white font-medium",children:H.remoteUsername}),(0,a.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:["connected"===H.status?(0,a.jsx)("span",{className:"text-green-400",children:e3(eD)}):(0,a.jsxs)("span",{className:"text-gray-400 capitalize",children:[H.status,"..."]}),Q&&(0,a.jsxs)("span",{className:"text-blue-400 flex items-center gap-1",children:[(0,a.jsx)(eu.Z,{className:"w-3 h-3"})," Presenting"]})]})]})]}),(0,a.jsx)("div",{className:"flex items-center gap-2",children:(0,a.jsx)("button",{onClick:()=>{document.fullscreenElement?(document.exitFullscreen(),eS(!1)):(document.documentElement.requestFullscreen(),eS(!0))},className:"p-2 hover:bg-white/10 rounded-lg text-white transition-colors",title:$?"Exit fullscreen":"Fullscreen",children:$?(0,a.jsx)(em.Z,{className:"w-5 h-5"}):(0,a.jsx)(eh.Z,{className:"w-5 h-5"})})})]}),(0,a.jsxs)("div",{className:"flex-1 flex items-center justify-center relative",children:[(0,a.jsx)("video",{ref:eG,autoPlay:!0,playsInline:!0,className:"\n              ".concat("video"===H.type&&H.remoteStream?"absolute inset-0 w-full h-full object-cover":"absolute inset-0 w-full h-full object-cover opacity-0 pointer-events-none","\n            ")}),("audio"===H.type||!H.remoteStream)&&(0,a.jsxs)("div",{className:"relative z-10 text-center",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"w-40 h-40 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-full flex items-center justify-center mx-auto mb-6 ".concat("calling"===H.status||"ringing"===H.status?"animate-pulse":""),children:(0,a.jsx)("span",{className:"text-5xl text-white font-bold",children:H.remoteUsername.charAt(0).toUpperCase()})}),"calling"===H.status&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,a.jsx)("div",{className:"w-44 h-44 border-4 border-cipher-primary/30 rounded-full animate-ping"})})]}),(0,a.jsx)("h2",{className:"text-2xl font-bold text-white mb-2",children:H.remoteUsername}),(0,a.jsxs)("p",{className:"text-gray-400",children:["calling"===H.status&&"Calling...","ringing"===H.status&&H.isIncoming&&"Incoming call...","ringing"===H.status&&!H.isIncoming&&"Ringing...","connecting"===H.status&&"Connecting...","connected"===H.status&&"audio"===H.type&&(0,a.jsxs)("span",{className:"flex items-center justify-center gap-2",children:[(0,a.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e3(eD)]})]})]}),(0,a.jsxs)("div",{className:"\n            absolute bottom-28 right-6 z-20 rounded-xl overflow-hidden shadow-2xl border-2 border-white/10\n            transition-all duration-300 hover:scale-105 cursor-move\n            ".concat("video"===H.type?"w-48 h-36 bg-[#2a2a2a]":"hidden","\n          "),children:[(0,a.jsx)("video",{ref:eJ,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover ".concat(V?"hidden":"")}),V&&(0,a.jsx)("div",{className:"w-full h-full flex items-center justify-center bg-[#2a2a2a]",children:(0,a.jsx)("div",{className:"w-16 h-16 bg-cipher-primary/20 rounded-full flex items-center justify-center",children:(0,a.jsx)(eg.Z,{className:"w-8 h-8 text-cipher-primary"})})}),W&&(0,a.jsx)("div",{className:"absolute bottom-2 right-2 p-1 bg-red-500 rounded-full",children:(0,a.jsx)(ep.Z,{className:"w-3 h-3 text-white"})}),(0,a.jsx)("div",{className:"absolute bottom-2 left-2 text-xs text-white/70 bg-black/50 px-1.5 py-0.5 rounded",children:"You"})]})]}),(0,a.jsx)("div",{className:"absolute bottom-0 left-0 right-0 z-30 p-6 bg-gradient-to-t from-black/80 via-black/40 to-transparent",children:(0,a.jsxs)("div",{className:"flex items-center justify-center gap-3",children:["ringing"===H.status&&H.isIncoming&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:e9,className:"p-4 bg-red-500 rounded-full hover:bg-red-600 transition-all hover:scale-110 shadow-lg",title:"Decline",children:(0,a.jsx)(ec.Z,{className:"w-7 h-7 text-white"})}),(0,a.jsx)("button",{onClick:e7,className:"p-4 bg-green-500 rounded-full hover:bg-green-600 transition-all hover:scale-110 shadow-lg animate-bounce",title:"Answer",children:"video"===H.type?(0,a.jsx)(eo.Z,{className:"w-7 h-7 text-white"}):(0,a.jsx)(ed.Z,{className:"w-7 h-7 text-white"})})]}),("calling"===H.status||"connecting"===H.status||"connected"===H.status)&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:()=>{G(!!ee.toggleMute())},className:"p-4 rounded-full transition-all hover:scale-110 shadow-lg ".concat(W?"bg-red-500 hover:bg-red-600":"bg-[#3c4043] hover:bg-[#4a4d50]"),title:W?"Unmute":"Mute",children:W?(0,a.jsx)(ep.Z,{className:"w-6 h-6 text-white"}):(0,a.jsx)(ey.Z,{className:"w-6 h-6 text-white"})}),"video"===H.type&&(0,a.jsx)("button",{onClick:()=>{q(!!ee.toggleVideo())},className:"p-4 rounded-full transition-all hover:scale-110 shadow-lg ".concat(V?"bg-red-500 hover:bg-red-600":"bg-[#3c4043] hover:bg-[#4a4d50]"),title:V?"Turn on camera":"Turn off camera",children:V?(0,a.jsx)(eg.Z,{className:"w-6 h-6 text-white"}):(0,a.jsx)(eo.Z,{className:"w-6 h-6 text-white"})}),"video"===H.type&&"connected"===H.status&&(0,a.jsx)("button",{onClick:e5,className:"p-4 rounded-full transition-all hover:scale-110 shadow-lg ".concat(Q?"bg-blue-500 hover:bg-blue-600":"bg-[#3c4043] hover:bg-[#4a4d50]"),title:Q?"Stop presenting":"Present screen",children:(0,a.jsx)(eu.Z,{className:"w-6 h-6 text-white"})}),(0,a.jsx)("button",{onClick:()=>{ee.endCall(),B(null)},className:"p-4 bg-red-500 rounded-full hover:bg-red-600 transition-all hover:scale-110 shadow-lg px-8",title:"End call",children:(0,a.jsx)(ec.Z,{className:"w-6 h-6 text-white"})})]})]})})]}):(0,a.jsxs)("div",{className:"flex-1 flex flex-col h-full",children:[(0,a.jsxs)("div",{className:"h-16 px-4 border-b border-gray-800 flex items-center justify-between bg-cipher-dark/50",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("button",{onClick:()=>m(null),className:"lg:hidden p-2 -ml-2 hover:bg-gray-700 rounded-lg text-gray-400",children:(0,a.jsx)(ex.Z,{className:"w-5 h-5"})}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:D},children:(0,a.jsx)("span",{className:"text-white font-medium",children:t.charAt(0).toUpperCase()})}),e$&&(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-cipher-dark"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"font-medium text-white",children:t}),(0,a.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[e0?(0,a.jsx)("span",{className:"text-cipher-primary",children:"typing..."}):e$?(0,a.jsx)("span",{className:"text-green-500",children:"Online"}):(0,a.jsx)("span",{className:"text-gray-500",children:"Offline"}),(0,a.jsx)("span",{className:"text-gray-600",children:"•"}),(0,a.jsxs)("div",{className:"flex items-center gap-1 text-gray-500",children:[(0,a.jsx)(I.Z,{className:"w-3 h-3 text-cipher-primary"}),"Encrypted"]})]})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)("button",{onClick:()=>e8("audio"),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Voice Call",children:(0,a.jsx)(ed.Z,{className:"w-5 h-5"})}),(0,a.jsx)("button",{onClick:()=>e8("video"),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Video Call",children:(0,a.jsx)(eo.Z,{className:"w-5 h-5"})}),(0,a.jsx)("button",{onClick:()=>U(!T),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",children:(0,a.jsx)(eb.Z,{className:"w-5 h-5"})}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("button",{onClick:()=>eL(!eR),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Chat Options",children:(0,a.jsx)(ev.Z,{className:"w-5 h-5"})}),eR&&(0,a.jsxs)("div",{className:"absolute right-0 top-full mt-1 bg-cipher-dark border border-gray-700 rounded-lg shadow-xl py-1 min-w-[180px] z-50",children:[(0,a.jsxs)("button",{onClick:()=>{eB({visible:!0,type:"chat"}),eL(!1)},className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-gray-700/50 transition-colors",children:[(0,a.jsx)(en.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Clear chat"})]}),(0,a.jsxs)("button",{onClick:()=>{eB({visible:!0,type:"conversation"}),eL(!1)},className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-400 hover:bg-red-500/10 transition-colors",children:[(0,a.jsx)(en.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Delete for everyone"})]})]})]})]})]}),(0,a.jsxs)("div",{className:"px-4 py-2 bg-cipher-primary/10 border-b border-cipher-primary/20 flex items-center justify-center gap-2 text-xs text-cipher-primary",children:[(0,a.jsx)(P.Z,{className:"w-3 h-3"}),(0,a.jsx)("span",{children:"Messages are end-to-end encrypted. No one outside this chat can read them."})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 ".concat(K.messageGap),children:[0===e2.length?(0,a.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-cipher-primary/20 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)(I.Z,{className:"w-8 h-8 text-cipher-primary"})}),(0,a.jsx)("p",{className:"text-gray-400 text-sm",children:"Send a message or start a call to begin"}),((null==eY?void 0:eY.public_key)||eO)&&(0,a.jsxs)("div",{className:"mt-4 p-3 bg-cipher-dark rounded-lg",children:[(0,a.jsx)("p",{className:"text-xs text-gray-500 mb-1",children:"Key fingerprint"}),(0,a.jsx)("p",{className:"text-xs font-mono text-gray-400",children:g((null==eY?void 0:eY.public_key)||eO||"")})]})]})}):(0,a.jsxs)(a.Fragment,{children:[e2.map((t,s)=>{var r,n,i;let l=0===s||(0,Y.WU)(t.date,"yyyy-MM-dd")!==(0,Y.WU)(e2[s-1].date,"yyyy-MM-dd");if("call"===t.type){let s=t.data,r=s.caller_username===(null==e?void 0:e.username),n="video"===s.call_type?eo.Z:ed.Z;return(0,a.jsxs)("div",{children:[l&&(0,a.jsx)("div",{className:"flex justify-center my-4",children:(0,a.jsx)("span",{className:"bg-cipher-dark px-3 py-1 rounded-full text-xs text-gray-500",children:(0,Y.WU)(t.date,"MMMM d, yyyy")})}),(0,a.jsx)("div",{className:"flex justify-center my-4",children:(0,a.jsxs)("div",{className:"bg-gray-800/40 backdrop-blur-sm border border-gray-700/50 px-4 py-2 rounded-2xl flex items-center gap-3",children:[(0,a.jsx)("div",{className:"p-2 rounded-full ".concat("missed"===s.status?"bg-red-500/20 text-red-500":"bg-cipher-primary/20 text-cipher-primary"),children:(0,a.jsx)(n,{className:"w-4 h-4"})}),(0,a.jsxs)("div",{className:"text-left",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-200",children:"completed"===s.status?r?"Outgoing call":"Incoming call":"missed"===s.status?r?"No answer":"Missed call":"rejected"===s.status?r?"Call declined":"Declined call":"Call failed"}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:"completed"===s.status&&s.duration_seconds>0?"".concat(Math.floor(s.duration_seconds/60),"m ").concat(s.duration_seconds%60,"s"):(0,Y.WU)(t.date,"HH:mm")})]})]})})]},"call-".concat(s.id))}let c=t.data,o=c.sender_username===(null==e?void 0:e.username),d="deleted"===c.message_type,u=!o&&(null===(r=c.sender_theme)||void 0===r?void 0:r.accentGradient);return(0,a.jsxs)("div",{className:K.messagePadding,children:[l&&(0,a.jsx)("div",{className:"flex justify-center my-4",children:(0,a.jsx)("span",{className:"bg-cipher-dark dark:bg-gray-800 px-3 py-1 rounded-full ".concat(M.xs," text-gray-500"),children:(0,Y.WU)(t.date,"MMMM d, yyyy")})}),(0,a.jsx)("div",{className:"flex ".concat(o?"justify-end":"justify-start"," message-bubble group"),children:(0,a.jsxs)("div",{className:"\n                        relative max-w-[70%] ".concat(K.bubblePadding," rounded-2xl ").concat(M.base,"\n                        ").concat(o?"text-white rounded-br-md":u?"text-white rounded-bl-md":"bg-gray-800 dark:bg-gray-800 text-white dark:text-white rounded-bl-md","\n                        ").concat(d?"":"cursor-pointer","\n                        ").concat((null===(n=c.sender_theme)||void 0===n?void 0:n.style)==="glass"?"backdrop-blur-md border border-white/10":"","\n                        ").concat((null===(i=c.sender_theme)||void 0===i?void 0:i.style)==="neon"?"shadow-lg shadow-[var(--accent-color)]/30":"","\n                      "),style:(()=>{var e;if(!d){if(o)return{background:D};if(null===(e=c.sender_theme)||void 0===e?void 0:e.accentGradient)return{background:c.sender_theme.accentGradient}}})(),onContextMenu:e=>!d&&tn(e,c.id,o),children:[tr(c),(0,a.jsxs)("div",{className:"flex items-center gap-1 mt-1 ".concat(o?"justify-end":""),children:[(0,a.jsx)("span",{className:"".concat(M.xs," opacity-60"),children:(0,Y.WU)(t.date,"HH:mm")}),!d&&(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),tn(e,c.id,o)},className:"opacity-0 group-hover:opacity-100 p-0.5 text-gray-400 hover:text-red-400 transition-opacity",title:"Delete",children:(0,a.jsx)(en.Z,{className:"w-3 h-3"})}),o&&ta(c)]})]})})]},"msg-".concat(c.id))}),e0&&(0,a.jsx)("div",{className:"flex justify-start",children:(0,a.jsx)("div",{className:"bg-gray-800 px-4 py-3 rounded-2xl rounded-bl-md",children:(0,a.jsxs)("div",{className:"flex gap-1",children:[(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-500 rounded-full typing-dot"}),(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-500 rounded-full typing-dot"}),(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-500 rounded-full typing-dot"})]})})})]}),(0,a.jsx)("div",{ref:eW})]}),(0,a.jsx)("div",{className:"p-4 border-t border-gray-800 bg-cipher-dark/50",children:(0,a.jsxs)("div",{className:"flex items-end gap-3",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("button",{onClick:()=>eM(!eI),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white",children:(0,a.jsx)(ef.Z,{className:"w-5 h-5"})}),eI&&(0,a.jsxs)("div",{className:"absolute bottom-12 left-0 bg-cipher-dark border border-gray-700 rounded-lg shadow-lg p-2 min-w-[150px]",children:[(0,a.jsxs)("button",{onClick:()=>{var e;null===(e=eV.current)||void 0===e||e.click()},className:"w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-700 rounded text-gray-300 text-sm",children:[(0,a.jsx)(ew.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Photo"})]}),(0,a.jsxs)("button",{onClick:()=>{var e;null===(e=eV.current)||void 0===e||e.click()},className:"w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-700 rounded text-gray-300 text-sm",children:[(0,a.jsx)(ej.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Document"})]})]}),(0,a.jsx)("input",{ref:eV,type:"file",className:"hidden",accept:"image/*,video/*,.pdf,.doc,.docx,.txt",onChange:te})]}),(0,a.jsxs)("div",{className:"flex-1 relative",children:[(0,a.jsx)("textarea",{ref:ez,value:F,onChange:e=>Z(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),e6())},placeholder:"Type a message...",rows:1,className:"w-full bg-cipher-darker border border-gray-700 rounded-2xl py-3 px-4 pr-12 text-white placeholder-gray-500 focus:border-cipher-primary resize-none transition-colors",style:{maxHeight:"120px"}}),(0,a.jsx)("button",{onClick:()=>eZ(!eF),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-cipher-primary transition-colors",children:(0,a.jsx)(eN.Z,{className:"w-5 h-5"})}),eF&&(0,a.jsx)("div",{className:"absolute right-0 bottom-14 z-50",children:(0,a.jsx)(ek.ZP,{onEmojiClick:e=>{var t;Z(t=>t+e.emoji),eZ(!1),null===(t=ez.current)||void 0===t||t.focus()},theme:ek.Q2.DARK,width:350,height:400,searchPlaceholder:"Search emoji...",previewConfig:{showPreview:!1}})})]}),(0,a.jsx)("button",{onClick:e6,disabled:!F.trim()||O,className:"\n              p-3 rounded-full transition-all\n              ".concat(F.trim()?"text-white hover:opacity-90":"bg-gray-700 text-gray-500 cursor-not-allowed","\n            "),style:F.trim()?{background:D}:void 0,children:O?(0,a.jsx)(J.Z,{className:"w-5 h-5 animate-spin"}):(0,a.jsx)(e_.Z,{className:"w-5 h-5"})})]})}),T&&(0,a.jsxs)("div",{className:"absolute right-0 top-0 h-full w-80 bg-cipher-dark border-l border-gray-800 p-4 overflow-y-auto z-20",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,a.jsx)("h3",{className:"font-medium text-white",children:"Contact Info"}),(0,a.jsx)("button",{onClick:()=>U(!1),className:"p-1 hover:bg-gray-700 rounded",children:(0,a.jsx)(z.Z,{className:"w-5 h-5 text-gray-400"})})]}),(0,a.jsxs)("div",{className:"text-center mb-6",children:[(0,a.jsx)("div",{className:"w-20 h-20 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-full flex items-center justify-center mx-auto mb-3",children:(0,a.jsx)("span",{className:"text-2xl text-white font-medium",children:t.charAt(0).toUpperCase()})}),(0,a.jsx)("h4",{className:"text-lg font-medium text-white",children:t}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:(null==eY?void 0:eY.contact_email)||"Secured Peer"})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"p-3 bg-cipher-darker rounded-lg",children:[(0,a.jsx)("p",{className:"text-xs text-gray-500 mb-1",children:"Public Key Fingerprint"}),(0,a.jsx)("p",{className:"text-xs font-mono text-gray-400 break-all",children:(null==eY?void 0:eY.public_key)||eO?g((null==eY?void 0:eY.public_key)||eO||""):"Not available - user has not set up encryption"})]}),(0,a.jsxs)("div",{className:"p-3 bg-cipher-darker rounded-lg",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 text-cipher-primary",children:[(0,a.jsx)(I.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"text-sm font-medium",children:"Encryption Active"})]}),(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"All messages are encrypted with X25519 + AES-256-GCM"})]})]})]}),H&&"ringing"===H.status&&H.isIncoming&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-24 h-24 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse",children:(0,a.jsx)("span",{className:"text-3xl text-white font-bold",children:H.remoteUsername.charAt(0).toUpperCase()})}),(0,a.jsx)("h2",{className:"text-xl font-bold text-white mb-2",children:H.remoteUsername}),(0,a.jsxs)("p",{className:"text-gray-400 mb-6",children:["Incoming ",H.type," call..."]}),(0,a.jsxs)("div",{className:"flex items-center justify-center gap-4",children:[(0,a.jsx)("button",{onClick:e9,className:"p-4 bg-red-500 rounded-full hover:bg-red-600 transition-colors",children:(0,a.jsx)(ec.Z,{className:"w-6 h-6 text-white"})}),(0,a.jsx)("button",{onClick:e7,className:"p-4 bg-green-500 rounded-full hover:bg-green-600 transition-colors animate-bounce",children:"video"===H.type?(0,a.jsx)(eo.Z,{className:"w-6 h-6 text-white"}):(0,a.jsx)(ed.Z,{className:"w-6 h-6 text-white"})})]})]})}),R&&(0,a.jsxs)("div",{className:"fixed inset-0 bg-black/95 z-[100] flex flex-col",onClick:()=>L(null),children:[(0,a.jsx)("div",{className:"h-16 px-4 flex items-center justify-end",children:(0,a.jsx)("button",{onClick:()=>L(null),className:"p-2 text-white/70 hover:text-white transition-colors",children:(0,a.jsx)(z.Z,{className:"w-8 h-8"})})}),(0,a.jsx)("div",{className:"flex-1 flex items-center justify-center p-4",children:(0,a.jsx)("img",{src:R,alt:"Full screen preview",className:"max-w-full max-h-full object-contain shadow-2xl",onClick:e=>e.stopPropagation()})}),(0,a.jsx)("div",{className:"h-20 flex items-center justify-center pb-4",children:(0,a.jsxs)("button",{onClick:()=>ts(R,"cipherlink_image.png"),className:"flex items-center gap-2 px-6 py-2 bg-cipher-primary text-white rounded-full hover:bg-cipher-primary/90 transition-colors",children:[(0,a.jsx)(ei.Z,{className:"w-5 h-5"}),(0,a.jsx)("span",{children:"Download Full Image"})]})})]}),eT&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"fixed inset-0 z-[90]",onClick:()=>{eU(null)}}),(0,a.jsxs)("div",{className:"fixed bg-cipher-dark/95 backdrop-blur-md border border-gray-700 rounded-xl shadow-2xl py-2 min-w-[160px] z-[100]",style:{left:Math.min(eT.x,window.innerWidth-180),top:Math.min(eT.y,window.innerHeight-120)},children:[(0,a.jsxs)("button",{onClick:()=>ti(!1),className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-gray-700/50 transition-colors",children:[(0,a.jsx)(en.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Delete for me"})]}),eT.isMine&&(0,a.jsxs)("button",{onClick:()=>ti(!0),className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-400 hover:bg-red-500/10 transition-colors",children:[(0,a.jsx)(en.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Delete for everyone"})]})]})]}),eH&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-[110]",children:(0,a.jsxs)("div",{className:"bg-cipher-dark border border-gray-700 rounded-2xl p-6 max-w-sm mx-4 shadow-2xl",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-white mb-2",children:"message"===eH.type?"Delete message?":"chat"===eH.type?"Clear chat?":"Delete conversation?"}),(0,a.jsx)("p",{className:"text-gray-400 text-sm mb-6",children:"message"===eH.type?"This message will be deleted for everyone. This action cannot be undone.":"chat"===eH.type?"This will clear all messages from your device. The other person will still have their copy.":"This will delete the entire conversation for both you and the other person. This cannot be undone."}),(0,a.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,a.jsx)("button",{onClick:()=>eB(null),className:"px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition-colors",children:"Cancel"}),(0,a.jsx)("button",{onClick:tl,className:"px-4 py-2 text-sm font-medium rounded-lg transition-colors ".concat("conversation"===eH.type?"bg-red-500 hover:bg-red-600 text-white":"bg-cipher-primary hover:bg-cipher-primary/80 text-white"),children:"message"===eH.type?"Delete":"chat"===eH.type?"Clear":"Delete for everyone"})]})]})})]}):null}function eD(e){let{isOpen:t,onClose:s}=e,[n,i]=(0,r.useState)(""),[l,c]=(0,r.useState)([]),[d,u]=(0,r.useState)("idle"),[m,h]=(0,r.useState)(""),[g,p]=(0,r.useState)(null),y=(0,r.useRef)(null),{addContact:x,setCurrentConversation:b,searchUsers:v,loadContacts:f,loadConversations:w,conversations:j,contacts:N}=E();(0,r.useEffect)(()=>{t&&y.current&&setTimeout(()=>{var e;return null===(e=y.current)||void 0===e?void 0:e.focus()},100),t||(i(""),c([]),u("idle"),h(""),p(null))},[t]);let _=async()=>{let e=n.trim();if(e){if(e.length<2){h("Please enter at least 2 characters"),u("error");return}u("searching"),h(""),c([]);try{let t=await v(e);0===t.length?u("not_found"):(c(t),u("success"))}catch(e){var t,s;console.error("Search failed:",e),h((null==e?void 0:null===(s=e.response)||void 0===s?void 0:null===(t=s.data)||void 0===t?void 0:t.detail)||"Search failed. Please try again."),u("error")}}},k=async e=>{p(e.id),h("");try{if(j.find(t=>t.username===e.username)){b(e.username),s();return}try{if(!(await o.getPublicKey(e.username)).public_key){h("".concat(e.username," hasn't set up their encryption keys yet.")),p(null);return}}catch(e){console.log("Key fetch failed, proceeding with contact addition:",e)}N.find(t=>t.contact_username===e.username)||(await x(e.username),await f()),await w(),b(e.username),s()}catch(e){var t,a;console.error("Failed to start chat:",e),h((null==e?void 0:null===(a=e.response)||void 0===a?void 0:null===(t=a.data)||void 0===t?void 0:t.detail)||"Failed to start chat. Please try again."),p(null)}};return t?(0,a.jsx)("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",onClick:e=>e.target===e.currentTarget&&s(),children:(0,a.jsxs)("div",{className:"bg-cipher-dark border border-gray-700 rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-in fade-in zoom-in duration-200",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-5 border-b border-gray-700 bg-gradient-to-r from-cipher-primary/10 to-cipher-secondary/10",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-10 h-10 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-full flex items-center justify-center",children:(0,a.jsx)(F.Z,{className:"w-5 h-5 text-white"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-white",children:"New Conversation"}),(0,a.jsx)("p",{className:"text-xs text-gray-400",children:"Search for users to start chatting"})]})]}),(0,a.jsx)("button",{onClick:s,className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",children:(0,a.jsx)(z.Z,{className:"w-5 h-5"})})]}),(0,a.jsxs)("div",{className:"p-5 space-y-4",children:[(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("div",{className:"flex-1 relative",children:[(0,a.jsx)(W.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 w-4 h-4"}),(0,a.jsx)("input",{ref:y,type:"text",placeholder:"Search by username...",value:n,onChange:e=>i(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),_())},className:"w-full pl-10 pr-4 py-3 bg-cipher-darker border border-gray-700 rounded-lg focus:ring-2 focus:ring-cipher-primary focus:border-transparent text-white placeholder-gray-500 transition-all",disabled:"searching"===d})]}),(0,a.jsx)("button",{onClick:_,disabled:"searching"===d||!n.trim(),className:"px-5 py-3 bg-gradient-to-r from-cipher-primary to-cipher-secondary text-white rounded-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2 font-medium",children:"searching"===d?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(J.Z,{className:"w-4 h-4 animate-spin"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"Searching..."})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(W.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"Search"})]})})]}),"error"===d&&m&&(0,a.jsxs)("div",{className:"flex items-center gap-2 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm",children:[(0,a.jsx)(ea.Z,{className:"w-4 h-4 flex-shrink-0"}),(0,a.jsx)("span",{children:m})]}),null===g&&m&&"error"!==d&&(0,a.jsxs)("div",{className:"flex items-center gap-2 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm",children:[(0,a.jsx)(ea.Z,{className:"w-4 h-4 flex-shrink-0"}),(0,a.jsx)("span",{children:m})]}),(0,a.jsxs)("div",{className:"min-h-[200px] max-h-[320px] overflow-y-auto",children:["idle"===d&&(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-[200px] text-gray-500",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4",children:(0,a.jsx)(G.Z,{className:"w-8 h-8 text-gray-600"})}),(0,a.jsxs)("p",{className:"text-center text-sm",children:["Search for a username to start a new",(0,a.jsx)("br",{}),"encrypted conversation"]})]}),"searching"===d&&(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-[200px] text-gray-400",children:[(0,a.jsx)(J.Z,{className:"w-10 h-10 animate-spin mb-4 text-cipher-primary"}),(0,a.jsx)("p",{className:"text-sm",children:"Searching for users..."})]}),"not_found"===d&&(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-[200px] text-gray-500",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4",children:(0,a.jsx)(ea.Z,{className:"w-8 h-8 text-amber-500/70"})}),(0,a.jsx)("p",{className:"text-center font-medium text-amber-400 mb-1",children:"No users found"}),(0,a.jsxs)("p",{className:"text-center text-sm text-gray-500",children:['No users match "',n,'".',(0,a.jsx)("br",{}),"Check the username and try again."]})]}),"success"===d&&l.length>0&&(0,a.jsx)("div",{className:"space-y-2",children:l.map(e=>{let t=j.some(t=>t.username===e.username),s=g===e.id;return(0,a.jsxs)("div",{className:"flex items-center justify-between p-3 border border-gray-700 rounded-lg hover:bg-cipher-darker/70 transition-colors group",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"w-11 h-11 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-full flex items-center justify-center text-white font-semibold shadow-lg",children:e.username[0].toUpperCase()}),e.is_online&&(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-cipher-dark"})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("p",{className:"font-medium text-white flex items-center gap-2",children:[e.username,t&&(0,a.jsx)("span",{className:"text-xs px-1.5 py-0.5 bg-cipher-primary/20 text-cipher-primary rounded",children:"Existing"})]}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:e.public_key?"Encryption ready":"User available"})]})]}),(0,a.jsx)("button",{onClick:()=>k(e),disabled:s,className:"px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2\n                          ".concat(t?"bg-cipher-primary/20 text-cipher-primary hover:bg-cipher-primary/30":"bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:opacity-90","\n                          disabled:opacity-50 disabled:cursor-not-allowed"),children:s?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(J.Z,{className:"w-4 h-4 animate-spin"}),(0,a.jsx)("span",{children:"Starting..."})]}):t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(F.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Open"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(G.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Chat"})]})})]},e.id)})})]})]}),(0,a.jsx)("div",{className:"px-5 py-3 border-t border-gray-700 bg-cipher-darker/50",children:(0,a.jsxs)("p",{className:"text-xs text-gray-500 text-center flex items-center justify-center gap-1",children:[(0,a.jsx)("span",{className:"inline-block w-2 h-2 bg-green-500 rounded-full"}),"All conversations are end-to-end encrypted"]})})]})}):null}var eE=s(3021),eK=s(597),eP=s(4135),eI=s(3088),eM=s(6369),eF=s(7346);function eZ(e){let{isOpen:t,onClose:s}=e,{user:n,logout:i}=E(),[l,c]=(0,r.useState)("profile"),{settings:d,updateSettings:u,getAccentGradient:m}=(0,N.MU)(),{theme:h,accent:g,fontSize:p,density:y,messagePreview:x,animationsEnabled:b}=d,[v,f]=(0,r.useState)("rounded"),[w,j]=(0,r.useState)("inter");(0,r.useEffect)(()=>{f(S()),j(D())},[]);let _=e=>{u(e),o.updateSettings(e).catch(e=>console.error("Failed to save settings to server:",e))},K=e=>{f(e),function(e){try{localStorage.setItem(k,e)}catch(e){console.error("Failed to save bubble style:",e)}}(e)},P=e=>{j(e),function(e){try{localStorage.setItem(C,e)}catch(e){console.error("Failed to save font style:",e)}}(e)},M=[{id:"profile",label:"Profile",icon:Z.Z},{id:"security",label:"Security",icon:I.Z},{id:"notifications",label:"Notifications",icon:eE.Z},{id:"appearance",label:"Appearance",icon:eK.Z}];return t?(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Settings"}),(0,a.jsx)("button",{onClick:s,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300",children:(0,a.jsx)(z.Z,{className:"w-6 h-6"})})]}),(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)("div",{className:"w-64 bg-gray-50 dark:bg-gray-900 p-4",children:(0,a.jsx)("nav",{className:"space-y-2",children:M.map(e=>{let t=e.icon;return(0,a.jsxs)("button",{onClick:()=>c(e.id),className:"w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-left transition-colors ".concat(l===e.id?"bg-blue-600 text-white":"text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700"),children:[(0,a.jsx)(t,{className:"w-5 h-5"}),(0,a.jsx)("span",{children:e.label})]},e.id)})})}),(0,a.jsxs)("div",{className:"flex-1 p-6 overflow-y-auto max-h-[calc(90vh-80px)]",children:["profile"===l&&(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Profile Information"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Username"}),(0,a.jsx)("input",{type:"text",value:(null==n?void 0:n.username)||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Email"}),(0,a.jsx)("input",{type:"email",value:(null==n?void 0:n.email)||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white"})]})]}),(0,a.jsx)("div",{className:"pt-4 border-t border-gray-200 dark:border-gray-700",children:(0,a.jsx)("button",{onClick:()=>{i(),s()},className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Sign Out"})})]}),"security"===l&&(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Security & Privacy"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"p-4 bg-green-50 dark:bg-green-900/20 rounded-lg",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 mb-2",children:[(0,a.jsx)(I.Z,{className:"w-5 h-5 text-green-600"}),(0,a.jsx)("span",{className:"font-medium text-green-800 dark:text-green-200",children:"End-to-End Encryption Active"})]}),(0,a.jsx)("p",{className:"text-sm text-green-700 dark:text-green-300",children:"Your messages are encrypted with X25519 + Ed25519 cryptography. Only you and your recipients can read them."})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("h4",{className:"font-medium text-gray-900 dark:text-white",children:"Cryptographic Keys"}),(0,a.jsxs)("button",{onClick:()=>{console.log("Exporting keys...")},className:"flex items-center space-x-2 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700",children:[(0,a.jsx)(ei.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Export Key Backup"})]}),(0,a.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Export your keys for backup or device migration. Keep this file secure."})]})]})]}),"notifications"===l&&(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Notification Preferences"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Message Notifications"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Get notified when you receive new messages"})]}),(0,a.jsx)("input",{type:"checkbox",defaultChecked:!0,className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Sound Notifications"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Play sound for new messages"})]}),(0,a.jsx)("input",{type:"checkbox",defaultChecked:!0,className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"})]})]})]}),"appearance"===l&&(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Appearance"}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Theme Mode"}),(0,a.jsx)("div",{className:"grid grid-cols-3 gap-3",children:[{value:"light",icon:eP.Z,label:"Light"},{value:"dark",icon:eI.Z,label:"Dark"},{value:"system",icon:eu.Z,label:"System"}].map(e=>{let t=e.icon,s=h===e.value;return(0,a.jsxs)("button",{onClick:()=>_({theme:e.value}),className:"flex flex-col items-center gap-2 p-4 rounded-lg border-2 transition-all ".concat(s?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:[(0,a.jsx)(t,{className:"w-6 h-6 ".concat(s?"text-blue-500":"text-gray-500")}),(0,a.jsx)("span",{className:"text-sm font-medium ".concat(s?"text-blue-600 dark:text-blue-400":"text-gray-700 dark:text-gray-300"),children:e.label}),s&&(0,a.jsx)(et.Z,{className:"w-4 h-4 text-blue-500 absolute top-2 right-2"})]},e.value)})})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Accent Color"}),(0,a.jsx)("div",{className:"flex flex-wrap gap-3",children:Object.keys(N.FN).map(e=>{let t=N.FN[e],s=g===e;return(0,a.jsx)("button",{onClick:()=>_({accent:e}),className:"relative w-12 h-12 rounded-full transition-transform hover:scale-110 ".concat(s?"ring-2 ring-offset-2 ring-offset-white dark:ring-offset-gray-800":""),style:{background:"linear-gradient(135deg, ".concat(t.primary,", ").concat(t.secondary,")"),boxShadow:s?"0 0 0 2px ".concat(t.primary):void 0},title:t.name,children:s&&(0,a.jsx)(et.Z,{className:"w-5 h-5 text-white absolute inset-0 m-auto"})},e)})}),(0,a.jsxs)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Selected: ",N.FN[g].name]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Font Size"}),(0,a.jsx)("div",{className:"flex items-center gap-4",children:[{value:"small",label:"Small",size:"text-sm"},{value:"medium",label:"Medium",size:"text-base"},{value:"large",label:"Large",size:"text-lg"}].map(e=>{let t=p===e.value;return(0,a.jsx)("button",{onClick:()=>_({fontSize:e.value}),className:"px-4 py-2 rounded-lg border-2 transition-all ".concat(e.size," ").concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400":"border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:border-gray-300"),children:e.label},e.value)})})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Chat Density"}),(0,a.jsx)("div",{className:"space-y-2",children:[{value:"compact",label:"Compact",desc:"More messages visible"},{value:"comfortable",label:"Comfortable",desc:"Balanced spacing"},{value:"spacious",label:"Spacious",desc:"More breathing room"}].map(e=>{let t=y===e.value;return(0,a.jsx)("label",{className:"flex items-center justify-between p-3 rounded-lg border-2 cursor-pointer transition-all ".concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300"),children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("input",{type:"radio",name:"density",checked:t,onChange:()=>_({density:e.value}),className:"w-4 h-4 text-blue-600"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium ".concat(t?"text-blue-600 dark:text-blue-400":"text-gray-900 dark:text-white"),children:e.label}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:e.desc})]})]})},e.value)})})]}),(0,a.jsxs)("div",{className:"space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Additional Options"}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Message Preview"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Show message preview in sidebar"})]}),(0,a.jsx)("button",{onClick:()=>_({messagePreview:!x}),className:"relative w-12 h-6 rounded-full transition-colors ".concat(x?"bg-blue-600":"bg-gray-300 dark:bg-gray-600"),children:(0,a.jsx)("div",{className:"absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ".concat(x?"translate-x-7":"translate-x-1")})})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Animations"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Enable UI animations and transitions"})]}),(0,a.jsx)("button",{onClick:()=>_({animationsEnabled:!b}),className:"relative w-12 h-6 rounded-full transition-colors ".concat(b?"bg-blue-600":"bg-gray-300 dark:bg-gray-600"),children:(0,a.jsx)("div",{className:"absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ".concat(b?"translate-x-7":"translate-x-1")})})]})]}),(0,a.jsxs)("div",{className:"space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Message Style"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:"Your message style will be visible to recipients"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Bubble Style"}),(0,a.jsx)("div",{className:"grid grid-cols-3 gap-3",children:[{value:"rounded",label:"Rounded",desc:"Classic"},{value:"glass",label:"Glass",desc:"Translucent"},{value:"neon",label:"Neon",desc:"Glow effect"}].map(e=>{let t=v===e.value;return(0,a.jsxs)("button",{onClick:()=>K(e.value),className:"flex flex-col items-center gap-1.5 p-3 rounded-lg border-2 transition-all ".concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:[(0,a.jsx)("div",{className:"w-12 h-8 rounded-lg flex items-center justify-center ".concat("glass"===e.value?"backdrop-blur-md border border-white/20":"neon"===e.value?"shadow-lg":""),style:{background:"linear-gradient(135deg, ".concat(N.FN[g].primary,", ").concat(N.FN[g].secondary,")"),boxShadow:"neon"===e.value?"0 0 10px ".concat(N.FN[g].primary,"50"):void 0},children:(0,a.jsx)(eM.Z,{className:"w-3 h-3 text-white"})}),(0,a.jsx)("span",{className:"text-xs font-medium ".concat(t?"text-blue-600 dark:text-blue-400":"text-gray-700 dark:text-gray-300"),children:e.label})]},e.value)})})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Message Font"}),(0,a.jsx)("div",{className:"grid grid-cols-2 gap-3",children:[{value:"inter",label:"Sans-serif",sample:"Hello!"},{value:"mono",label:"Monospace",sample:"Hello!"}].map(e=>{let t=w===e.value;return(0,a.jsxs)("button",{onClick:()=>P(e.value),className:"flex items-center gap-3 p-3 rounded-lg border-2 transition-all ".concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:[(0,a.jsx)(eF.Z,{className:"w-5 h-5 ".concat(t?"text-blue-500":"text-gray-500")}),(0,a.jsxs)("div",{className:"text-left",children:[(0,a.jsx)("p",{className:"text-sm font-medium ".concat(t?"text-blue-600 dark:text-blue-400":"text-gray-700 dark:text-gray-300"),children:e.label}),(0,a.jsx)("p",{className:"text-xs text-gray-500 ".concat("mono"===e.value?"font-mono":"font-sans"),children:e.sample})]})]},e.value)})})]})]}),(0,a.jsxs)("div",{className:"space-y-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,a.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Preview"}),(0,a.jsxs)("div",{className:"p-4 rounded-lg bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700",children:[(0,a.jsxs)("div",{className:"flex items-start gap-3",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center text-white font-medium",style:{background:"linear-gradient(135deg, ".concat(N.FN[g].primary,", ").concat(N.FN[g].secondary,")")},children:"J"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"font-medium text-gray-900 dark:text-white",children:"John Doe"}),(0,a.jsx)("span",{className:"text-xs text-gray-500",children:"12:34 PM"})]}),(0,a.jsx)("p",{className:"text-gray-700 dark:text-gray-300 mt-1",children:"This is how your messages will look with the current settings! \uD83C\uDFA8"})]})]}),(0,a.jsx)("div",{className:"flex justify-end mt-3",children:(0,a.jsxs)("div",{className:"px-4 py-2 rounded-2xl text-white max-w-xs",style:{background:"linear-gradient(135deg, ".concat(N.FN[g].primary,", ").concat(N.FN[g].secondary,")")},children:[(0,a.jsx)("p",{children:"Looking great! ✨"}),(0,a.jsx)("div",{className:"flex justify-end mt-1",children:(0,a.jsx)("span",{className:"text-xs opacity-70",children:"12:35 PM"})})]})})]})]})]})]})]})]})}):null}var eO=s(8004);function eA(){let{loadContacts:e,loadConversations:t,loadCallHistory:s,initializeWebSocket:n,currentConversation:i}=E(),[l,c]=(0,r.useState)(!0),[o,d]=(0,r.useState)(!1),[u,m]=(0,r.useState)(!1);return(0,r.useEffect)(()=>{e(),t(),s(),n()},[e,t,s,n]),(0,a.jsxs)("div",{className:"h-screen bg-cipher-darker flex overflow-hidden",children:[(0,a.jsx)("button",{onClick:()=>c(!l),className:"lg:hidden fixed top-4 left-4 z-50 p-2 bg-cipher-dark rounded-lg text-gray-400 hover:text-white",children:l?(0,a.jsx)(z.Z,{className:"w-5 h-5"}):(0,a.jsx)(eO.Z,{className:"w-5 h-5"})}),(0,a.jsx)("div",{className:"\n        fixed lg:relative inset-y-0 left-0 z-40\n        transform ".concat(l?"translate-x-0":"-translate-x-full","\n        lg:translate-x-0 transition-transform duration-200 ease-in-out\n        w-80 bg-cipher-dark border-r border-gray-800\n      "),children:(0,a.jsx)(Q,{onNewChat:()=>d(!0),onSettings:()=>m(!0)})}),(0,a.jsx)("div",{className:"flex-1 flex flex-col",children:i?(0,a.jsx)(eS,{}):(0,a.jsx)(eT,{})}),(0,a.jsx)(eD,{isOpen:o,onClose:()=>d(!1)}),(0,a.jsx)(eZ,{isOpen:u,onClose:()=>m(!1)}),l&&(0,a.jsx)("div",{className:"lg:hidden fixed inset-0 bg-black/50 z-30",onClick:()=>c(!1)})]})}function eT(){return(0,a.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-20 h-20 bg-gradient-to-br from-cipher-primary/20 to-cipher-secondary/20 rounded-full flex items-center justify-center mx-auto mb-6",children:(0,a.jsx)(P.Z,{className:"w-10 h-10 text-cipher-primary"})}),(0,a.jsx)("h2",{className:"text-2xl font-bold text-white mb-2",children:"Welcome to CipherLink"}),(0,a.jsx)("p",{className:"text-gray-400 max-w-md",children:"Select a conversation or start a new chat to begin sending end-to-end encrypted messages."}),(0,a.jsxs)("div",{className:"mt-6 flex items-center justify-center gap-2 text-sm text-gray-500",children:[(0,a.jsx)(P.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"All messages are encrypted on your device"})]})]})})}function eU(){let{isAuthenticated:e,isLoading:t,loadStoredAuth:s}=E();return((0,r.useEffect)(()=>{s()},[s]),t)?(0,a.jsx)("div",{className:"min-h-screen bg-cipher-darker flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 border-4 border-cipher-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-gray-400",children:"Loading CipherLink..."})]})}):e?(0,a.jsx)(eA,{}):(0,a.jsx)(U,{})}},804:function(e,t,s){"use strict";s.d(t,{E5:function(){return y},FN:function(){return r},MU:function(){return p}});var a=s(2265);let r={blue:{primary:"#3B82F6",secondary:"#1D4ED8",name:"Blue"},purple:{primary:"#8B5CF6",secondary:"#7C3AED",name:"Purple"},green:{primary:"#10B981",secondary:"#059669",name:"Green"},orange:{primary:"#F59E0B",secondary:"#D97706",name:"Orange"},pink:{primary:"#EC4899",secondary:"#DB2777",name:"Pink"},cyan:{primary:"#06B6D4",secondary:"#0891B2",name:"Cyan"}},n={compact:{messagePadding:"py-1",messageGap:"space-y-2",bubblePadding:"px-3 py-1.5"},comfortable:{messagePadding:"py-2",messageGap:"space-y-4",bubblePadding:"px-4 py-2"},spacious:{messagePadding:"py-3",messageGap:"space-y-6",bubblePadding:"px-5 py-3"}},i={small:{base:"text-sm",small:"text-xs",xs:"text-[10px]"},medium:{base:"text-base",small:"text-sm",xs:"text-xs"},large:{base:"text-lg",small:"text-base",xs:"text-sm"}},l="cipherlink_appearance",c={theme:"dark",accent:"blue",fontSize:"medium",density:"comfortable",messagePreview:!0,animationsEnabled:!0},o=e=>{let t=document.documentElement,s=window.matchMedia("(prefers-color-scheme: dark)").matches;"dark"===e||"system"===e&&s?(t.classList.add("dark"),t.style.colorScheme="dark"):(t.classList.remove("dark"),t.style.colorScheme="light")},d=e=>{let t=document.documentElement,s=r[e];t.style.setProperty("--color-cipher-primary",s.primary),t.style.setProperty("--color-cipher-secondary",s.secondary),t.style.setProperty("--cipher-primary",s.primary),t.style.setProperty("--cipher-secondary",s.secondary)},u=e=>{document.documentElement.style.setProperty("--base-font-size",{small:"14px",medium:"16px",large:"18px"}[e])},m=e=>{document.documentElement.classList.toggle("reduce-motion",!e)},h=()=>{try{let e=localStorage.getItem(l);if(e)return{...c,...JSON.parse(e)}}catch(e){console.error("Failed to load appearance settings:",e)}return c},g=e=>{try{localStorage.setItem(l,JSON.stringify(e))}catch(e){console.error("Failed to save appearance settings:",e)}};function p(){let[e,t]=(0,a.useState)(c),[s,p]=(0,a.useState)(!1);(0,a.useEffect)(()=>{let e=h();t(e),p(!0),o(e.theme),d(e.accent),u(e.fontSize),m(e.animationsEnabled)},[]),(0,a.useEffect)(()=>{if("system"!==e.theme)return;let t=window.matchMedia("(prefers-color-scheme: dark)"),s=()=>o("system");return t.addEventListener("change",s),()=>t.removeEventListener("change",s)},[e.theme]),(0,a.useEffect)(()=>{let e=e=>{if(e.key===l&&e.newValue){let s=JSON.parse(e.newValue);t(s),o(s.theme),d(s.accent),u(s.fontSize),m(s.animationsEnabled)}};return window.addEventListener("storage",e),()=>window.removeEventListener("storage",e)},[]);let y=(0,a.useCallback)(e=>{t(t=>{let s={...t,...e};return g(s),void 0!==e.theme&&o(e.theme),void 0!==e.accent&&d(e.accent),void 0!==e.fontSize&&u(e.fontSize),void 0!==e.animationsEnabled&&m(e.animationsEnabled),s})},[]),x=(0,a.useCallback)(()=>{let t=r[e.accent];return"linear-gradient(135deg, ".concat(t.primary,", ").concat(t.secondary,")")},[e.accent]),b=(0,a.useCallback)(()=>r[e.accent],[e.accent]),v=(0,a.useCallback)(()=>n[e.density],[e.density]),f=(0,a.useCallback)(()=>i[e.fontSize],[e.fontSize]);return{settings:e,isLoaded:s,updateSettings:y,getAccentGradient:x,getAccentColors:b,getDensityClasses:v,getFontClasses:f,accentColors:r,densityConfig:n,fontSizeConfig:i}}function y(){let e=h();o(e.theme),d(e.accent),u(e.fontSize),m(e.animationsEnabled)}}},function(e){e.O(0,[560,243,971,938,744],function(){return e(e.s=9325)}),_N_E=e.O()}]);