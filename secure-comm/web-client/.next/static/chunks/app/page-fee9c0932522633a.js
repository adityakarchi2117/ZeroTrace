(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{8924:function(){},5024:function(){},9325:function(e,t,a){Promise.resolve().then(a.bind(a,7047))},7047:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return eV}});var s=a(7437),r=a(2265),n=a(4660),i=a(4810),l=a(4829);class o{setToken(e){this.token=e}getToken(){return this.token}async register(e,t,a,s){return(await this.client.post("/api/auth/register",{username:e,email:t,password:a,device_id:s,device_type:"web"})).data}async login(e,t){let a=new URLSearchParams;a.append("username",e),a.append("password",t);let s=await this.client.post("/api/auth/login",a,{headers:{"Content-Type":"application/x-www-form-urlencoded"}});return this.token=s.data.access_token,s.data}async getCurrentUser(){return(await this.client.get("/api/auth/me")).data}async updateSettings(e){return(await this.client.patch("/api/auth/me/settings",{settings:e})).data}async uploadKeys(e){await this.client.post("/api/keys/upload",e)}async getPublicKey(e){return(await this.client.get("/api/keys/".concat(e))).data}async getKeyBundle(e){return(await this.client.get("/api/keys/bundle/".concat(e))).data}async sendMessage(e,t,a){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"none",r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"text",n=arguments.length>5?arguments[5]:void 0,i=arguments.length>6?arguments[6]:void 0;return(await this.client.post("/api/messages/send",{recipient_username:e,encrypted_content:t,encrypted_key:a,expiry_type:s,message_type:r,file_metadata:n,sender_theme:i})).data}async getConversation(e){return(await this.client.get("/api/messages/conversation/".concat(e))).data}async getUnreadMessages(){return(await this.client.get("/api/messages/unread")).data}async getCallHistory(){return(await this.client.get("/api/messages/calls/history")).data}async deleteMessage(e){await this.client.delete("/api/messages/".concat(e))}async deleteConversation(e){await this.client.delete("/api/messages/conversation/".concat(e))}async deleteCallHistory(e){await this.client.delete("/api/messages/calls/history/".concat(e))}async getContacts(){return(await this.client.get("/api/contacts/")).data}async addContact(e,t){return(await this.client.post("/api/contacts/",{username:e,nickname:t})).data}async removeContact(e){await this.client.delete("/api/contacts/".concat(e))}async blockContact(e){await this.client.post("/api/contacts/".concat(e,"/block"))}async searchUsers(e){return(await this.client.get("/api/contacts/search",{params:{q:e}})).data}async getConversations(){return(await this.client.get("/api/contacts/conversations")).data}async getAllConversationsWithMessages(){return(await this.client.get("/api/messages/all-conversations")).data}async getVaultItems(){return(await this.client.get("/api/vault/items")).data}async createVaultItem(e){await this.client.post("/api/vault/items",e)}constructor(){this.token=null,this.client=l.Z.create({baseURL:"http://10.100.42.35:8000",headers:{"Content-Type":"application/json"}}),this.client.interceptors.request.use(e=>(this.token&&(e.headers.Authorization="Bearer ".concat(this.token)),e))}}let c=new o;var d=a(7963),u=a.n(d),m=a(2092);function h(e,t,a){try{var s;let r=(0,m.decodeBase64)(e.ciphertext),n=(0,m.decodeBase64)(e.nonce),i=e.senderPublicKey||t;if(console.log("\uD83D\uDD13 Decryption attempt:",{version:e.version||"v1",hasEmbeddedKey:!!e.senderPublicKey,embeddedKeyPrefix:null===(s=e.senderPublicKey)||void 0===s?void 0:s.substring(0,20),fallbackKeyPrefix:null==t?void 0:t.substring(0,20),usingKeyPrefix:null==i?void 0:i.substring(0,20),recipientKeyPrefix:null==a?void 0:a.substring(0,20)}),!i)return console.error("❌ Decryption failed: No sender public key available"),null;let l=(0,m.decodeBase64)(i),o=(0,m.decodeBase64)(a),c=u().box.open(r,n,l,o);if(!c){if(console.warn("⚠️ Primary decryption failed with key:",null==i?void 0:i.substring(0,20)),e.senderPublicKey&&t&&e.senderPublicKey!==t){console.log("\uD83D\uDD04 Trying fallback sender key:",null==t?void 0:t.substring(0,20));try{let e=(0,m.decodeBase64)(t),a=u().box.open(r,n,e,o);if(a)return console.log("✅ Fallback decryption succeeded!"),(0,m.encodeUTF8)(a)}catch(e){console.warn("❌ Fallback decryption also failed:",e)}}return null}return console.log("✅ Decryption succeeded"),(0,m.encodeUTF8)(c)}catch(e){return console.error("❌ Decryption error:",e),null}}function g(e){var t;let a=(0,m.decodeBase64)(e),s=Array.from(u().hash(a).slice(0,16)).map(e=>e.toString(16).padStart(2,"0")).join("");return(null===(t=s.toUpperCase().match(/.{1,4}/g))||void 0===t?void 0:t.join(" "))||s.toUpperCase()}function p(e,t){try{let a=(0,m.decodeBase64)(e),s=(0,m.decodeBase64)(t),r=u().box.keyPair.fromSecretKey(a).publicKey;if(r.length!==s.length)return!1;for(let e=0;e<r.length;e++)if(r[e]!==s[e])return!1;return!0}catch(e){return console.error("Key pair verification failed:",e),!1}}function y(e){let t=(0,m.decodeBase64)(e),a=u().box.keyPair.fromSecretKey(t);return(0,m.encodeBase64)(a.publicKey)}function x(e,t){let a=(0,m.decodeBase64)(e),s=(0,m.decodeBase64)(t),r=u().box.before(s,a);return(0,m.encodeBase64)(r)}let v={STORAGE_KEY:"cipherlink_keys",SESSION_CACHE_KEY:"cipherlink_sessions",save(e,t){try{let a=localStorage.getItem(this.STORAGE_KEY),s=a?JSON.parse(a):{};t.fingerprint=g(t.publicKey),s[e]=t,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s))}catch(e){console.error("Failed to save keys:",e)}},load(e){try{let t=localStorage.getItem(this.STORAGE_KEY);if(!t)return null;return JSON.parse(t)[e]||null}catch(e){return null}},verifyKeyConsistency(e,t){let a=this.load(e);return!!a&&g(a.publicKey)===g(t)},remove(e){try{let t=localStorage.getItem(this.STORAGE_KEY);if(t){let a=JSON.parse(t);delete a[e],localStorage.setItem(this.STORAGE_KEY,JSON.stringify(a))}this.clearSessionCache(e)}catch(e){console.error("Failed to remove keys:",e)}},clear(){localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.SESSION_CACHE_KEY)},getOrDeriveSessionKey(e,t,a,s){let r="".concat(e,":").concat(t,":").concat(g(s).slice(0,16));try{let e=localStorage.getItem(this.SESSION_CACHE_KEY),t=e?JSON.parse(e):{};if(t[r])return t[r];let n=x(a,s);return t[r]=n,localStorage.setItem(this.SESSION_CACHE_KEY,JSON.stringify(t)),n}catch(e){return console.error("Session cache error:",e),x(a,s)}},clearSessionCache(e){if(!e){localStorage.removeItem(this.SESSION_CACHE_KEY);return}try{let t=localStorage.getItem(this.SESSION_CACHE_KEY);if(t){let a=JSON.parse(t),s={};for(let[t,r]of Object.entries(a))t.startsWith("".concat(e,":"))||(s[t]=r);localStorage.setItem(this.SESSION_CACHE_KEY,JSON.stringify(s))}}catch(e){console.error("Failed to clear session cache:",e)}}};class b{connect(e,t){this.userId=e,this.token=t,this.connectWebSocket()}connectWebSocket(){var e;if(!this.isConnecting&&(null===(e=this.ws)||void 0===e?void 0:e.readyState)!==WebSocket.OPEN){if(this.isConnecting=!0,!this.token){console.warn("No auth token available for WebSocket connection"),this.isConnecting=!1;return}try{this.ws=new WebSocket("".concat("ws://10.100.42.35:8000/ws","/chat?token=").concat(this.token)),this.ws.onopen=()=>{console.log("\uD83D\uDD17 WebSocket connected"),this.isConnecting=!1,this.reconnectAttempts=0,this.startHeartbeat(),this.flushMessageQueue()},this.ws.onmessage=e=>{try{let t=JSON.parse(e.data);this.handleMessage(t)}catch(e){console.error("Failed to parse WebSocket message:",e)}},this.ws.onclose=e=>{console.log("\uD83D\uDD0C WebSocket disconnected:",e.code,e.reason),this.isConnecting=!1,this.stopHeartbeat(),this.attemptReconnect()},this.ws.onerror=e=>{console.error("❌ WebSocket error:",e),this.isConnecting=!1}}catch(e){console.error("Failed to create WebSocket connection:",e),this.isConnecting=!1,this.attemptReconnect()}}}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnection attempts reached");return}this.reconnectAttempts++;let e=Math.min(this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),3e4);console.log("Attempting to reconnect in ".concat(e,"ms (attempt ").concat(this.reconnectAttempts,")")),setTimeout(()=>{this.connectWebSocket()},e)}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{var e;(null===(e=this.ws)||void 0===e?void 0:e.readyState)===WebSocket.OPEN&&this.send({type:"ping",data:{},timestamp:new Date().toISOString()})},3e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}handleMessage(e){let t=e.type,a=this.messageHandlers.get(t);a&&a.size>0?a.forEach(a=>{try{a(e)}catch(e){console.error("Error in handler for ".concat(t,":"),e)}}):"pong"!==t&&console.log("Unhandled WebSocket message type:",t,e)}flushMessageQueue(){for(;this.messageQueue.length>0;){let e=this.messageQueue.shift();e&&this.send(e)}}send(e){var t,a;(null===(t=this.ws)||void 0===t?void 0:t.readyState)===WebSocket.OPEN?(console.log("\uD83D\uDCE4 Sending ".concat(e.type," message:"),e),this.ws.send(JSON.stringify(e))):(this.messageQueue.push(e),console.warn("⏳ WebSocket not connected (state: ".concat(null===(a=this.ws)||void 0===a?void 0:a.readyState,"), queuing ").concat(e.type," message")),!this.isConnecting&&this.userId&&this.token&&(console.log("\uD83D\uDD04 Triggering reconnection from send failure"),this.connect(this.userId,this.token)))}on(e,t){this.messageHandlers.has(e)||this.messageHandlers.set(e,new Set),this.messageHandlers.get(e).add(t)}off(e,t){if(t){var a;null===(a=this.messageHandlers.get(e))||void 0===a||a.delete(t)}else this.messageHandlers.delete(e)}onMessage(e,t){this.on(e,t)}offMessage(e){this.messageHandlers.delete(e)}sendEncryptedMessage(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text",s=arguments.length>3?arguments[3]:void 0;this.send({type:"message",data:{recipient_username:e,encrypted_content:t,message_type:a,file_metadata:s},timestamp:new Date().toISOString()})}sendTypingIndicator(e,t){this.send({type:"typing",data:{recipient_username:e,is_typing:t},timestamp:new Date().toISOString()})}sendDeliveryReceipt(e,t){this.send({type:"delivery_receipt",data:{message_id:e,sender_id:t},timestamp:new Date().toISOString()})}sendReadReceipt(e,t){this.send({type:"read_receipt",data:{message_id:e,sender_id:t},timestamp:new Date().toISOString()})}updatePresence(e){this.send({type:"presence",data:{is_online:e},timestamp:new Date().toISOString()})}subscribeToPresence(e){this.send({type:"presence_subscribe",data:{user_ids:e},timestamp:new Date().toISOString()})}getOnlineStatus(e){this.send({type:"get_online_status",data:{user_ids:e},timestamp:new Date().toISOString()})}sendDeleteMessage(e,t){this.send({type:"delete_message",data:{message_id:e,recipient_username:t},timestamp:new Date().toISOString()})}sendDeleteConversation(e){this.send({type:"delete_conversation",data:{recipient_username:e},timestamp:new Date().toISOString()})}disconnect(){this.stopHeartbeat(),this.updatePresence(!1),this.ws&&(this.ws.close(),this.ws=null),this.messageQueue=[]}isConnected(){var e;return(null===(e=this.ws)||void 0===e?void 0:e.readyState)===WebSocket.OPEN}getConnectionState(){var e,t;return null!==(t=null===(e=this.ws)||void 0===e?void 0:e.readyState)&&void 0!==t?t:null}constructor(){this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=10,this.reconnectDelay=1e3,this.heartbeatInterval=null,this.messageHandlers=new Map,this.userId=null,this.token=null,this.isConnecting=!1,this.messageQueue=[]}}let f=new b;window.addEventListener("beforeunload",()=>{f.updatePresence(!1),f.disconnect()}),document.addEventListener("visibilitychange",()=>{document.hidden?f.updatePresence(!1):f.updatePresence(!0)});class w{async init(){return new Promise((e,t)=>{let a=indexedDB.open(this.dbName,this.version);a.onerror=()=>t(a.error),a.onsuccess=()=>{this.db=a.result,e()},a.onupgradeneeded=e=>{let t=e.target.result;if(!t.objectStoreNames.contains("messages")){let e=t.createObjectStore("messages",{keyPath:"id"});e.createIndex("conversation",["sender_username","recipient_username"],{unique:!1}),e.createIndex("recipient","recipient_username",{unique:!1}),e.createIndex("sender","sender_username",{unique:!1}),e.createIndex("created_at","created_at",{unique:!1})}t.objectStoreNames.contains("conversations")||t.createObjectStore("conversations",{keyPath:"username"}).createIndex("last_message_time","last_message_time",{unique:!1}),t.objectStoreNames.contains("contacts")||t.createObjectStore("contacts",{keyPath:"id"}).createIndex("contact_username","contact_username",{unique:!1}),t.objectStoreNames.contains("sync_metadata")||t.createObjectStore("sync_metadata",{keyPath:"key"})}})}async saveMessage(e){return this.db||await this.init(),new Promise((t,a)=>{let s=this.db.transaction(["messages"],"readwrite").objectStore("messages").put(e);s.onerror=()=>a(s.error),s.onsuccess=()=>t()})}async saveMessages(e){return this.db||await this.init(),new Promise((t,a)=>{let s=this.db.transaction(["messages"],"readwrite").objectStore("messages"),r=0,n=e.length;if(0===n){t();return}e.forEach(e=>{let i=s.put(e);i.onsuccess=()=>{++r===n&&t()},i.onerror=()=>a(i.error)})})}async getConversationMessages(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50;return this.db||await this.init(),new Promise((s,r)=>{let n=this.db.transaction(["messages"],"readonly").objectStore("messages"),i=[],l=n.openCursor();l.onsuccess=r=>{let n=r.target.result;if(n){let a=n.value;(a.sender_username===e&&a.recipient_username===t||a.sender_username===t&&a.recipient_username===e)&&i.push(a),n.continue()}else i.sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime()),s(i.slice(-a))},l.onerror=()=>r(l.error)})}async getAllMessages(){return this.db||await this.init(),new Promise((e,t)=>{let a=this.db.transaction(["messages"],"readonly").objectStore("messages").getAll();a.onerror=()=>t(a.error),a.onsuccess=()=>e(a.result)})}async saveConversation(e){return this.db||await this.init(),new Promise((t,a)=>{let s=this.db.transaction(["conversations"],"readwrite").objectStore("conversations").put(e);s.onerror=()=>a(s.error),s.onsuccess=()=>t()})}async saveConversations(e){return this.db||await this.init(),new Promise((t,a)=>{let s=this.db.transaction(["conversations"],"readwrite").objectStore("conversations"),r=0,n=e.length;if(0===n){t();return}e.forEach(e=>{let i=s.put(e);i.onsuccess=()=>{++r===n&&t()},i.onerror=()=>a(i.error)})})}async getAllConversations(){return this.db||await this.init(),new Promise((e,t)=>{let a=this.db.transaction(["conversations"],"readonly").objectStore("conversations").getAll();a.onerror=()=>t(a.error),a.onsuccess=()=>e(a.result)})}async saveContact(e){return this.db||await this.init(),new Promise((t,a)=>{let s=this.db.transaction(["contacts"],"readwrite").objectStore("contacts").put(e);s.onerror=()=>a(s.error),s.onsuccess=()=>t()})}async saveContacts(e){return this.db||await this.init(),new Promise((t,a)=>{let s=this.db.transaction(["contacts"],"readwrite").objectStore("contacts"),r=0,n=e.length;if(0===n){t();return}e.forEach(e=>{let i=s.put(e);i.onsuccess=()=>{++r===n&&t()},i.onerror=()=>a(i.error)})})}async getAllContacts(){return this.db||await this.init(),new Promise((e,t)=>{let a=this.db.transaction(["contacts"],"readonly").objectStore("contacts").getAll();a.onerror=()=>t(a.error),a.onsuccess=()=>e(a.result)})}async setSyncTimestamp(e,t){return this.db||await this.init(),new Promise((a,s)=>{let r=this.db.transaction(["sync_metadata"],"readwrite").objectStore("sync_metadata").put({key:e,timestamp:t});r.onerror=()=>s(r.error),r.onsuccess=()=>a()})}async getSyncTimestamp(e){return this.db||await this.init(),new Promise((t,a)=>{let s=this.db.transaction(["sync_metadata"],"readonly").objectStore("sync_metadata").get(e);s.onerror=()=>a(s.error),s.onsuccess=()=>{let e=s.result;t(e?e.timestamp:null)}})}async clearAllData(){this.db||await this.init();let e=["messages","conversations","contacts","sync_metadata"];return new Promise((t,a)=>{let s=this.db.transaction(e,"readwrite"),r=0;e.forEach(n=>{let i=s.objectStore(n).clear();i.onsuccess=()=>{++r===e.length&&t()},i.onerror=()=>a(i.error)})})}async deleteConversation(e){return this.db||await this.init(),new Promise((t,a)=>{let s=this.db.transaction(["conversations","messages"],"readwrite");s.objectStore("conversations").delete(e);let r=s.objectStore("messages").openCursor();r.onsuccess=a=>{let s=a.target.result;if(s){let t=s.value;(t.sender_username===e||t.recipient_username===e)&&s.delete(),s.continue()}else t()},r.onerror=()=>a(r.error)})}async deleteMessage(e){return this.db||await this.init(),new Promise((t,a)=>{let s=this.db.transaction(["messages"],"readwrite").objectStore("messages").delete(e);s.onerror=()=>a(s.error),s.onsuccess=()=>t()})}async markMessageAsDeleted(e){return this.db||await this.init(),new Promise((t,a)=>{let s=this.db.transaction(["messages"],"readwrite").objectStore("messages"),r=s.get(e);r.onsuccess=()=>{let e=r.result;if(e){e.encrypted_content=JSON.stringify({deleted:!0}),e.message_type="deleted",e.status="deleted";let r=s.put(e);r.onsuccess=()=>t(),r.onerror=()=>a(r.error)}else t()},r.onerror=()=>a(r.error)})}async clearConversationMessages(e,t){return this.db||await this.init(),new Promise((a,s)=>{let r=this.db.transaction(["messages"],"readwrite").objectStore("messages").openCursor();r.onsuccess=s=>{let r=s.target.result;if(r){let a=r.value;(a.sender_username===e&&a.recipient_username===t||a.sender_username===t&&a.recipient_username===e)&&r.delete(),r.continue()}else a()},r.onerror=()=>s(r.error)})}constructor(){this.db=null,this.dbName="CipherLinkDB",this.version=1}}let j=new w;j.init().catch(console.error);var N=a(804);let k={bubbleColor:"#3B82F6",textColor:"#ffffff",style:"rounded",font:"inter",accentGradient:"linear-gradient(135deg, #3B82F6, #1D4ED8)",accentPrimary:"#3B82F6",accentSecondary:"#1D4ED8"},_="cipherlink_bubble_style",C="cipherlink_font_style";function S(){try{let e=localStorage.getItem(_);if(e&&["rounded","glass","neon"].includes(e))return e}catch(e){console.error("Failed to load bubble style:",e)}return"rounded"}function D(){try{let e=localStorage.getItem(C);if(e&&["inter","mono"].includes(e))return e}catch(e){console.error("Failed to load font style:",e)}return"inter"}let E=(0,n.Ue)()((0,i.tJ)((e,t)=>({user:null,token:null,isAuthenticated:!1,isLoading:!1,error:null,privateKey:null,publicKey:null,identityKey:null,identityPrivateKey:null,contacts:[],conversations:[],currentConversation:null,messages:new Map,onlineUsers:new Set,typingUsers:new Map,callHistory:[],login:async(a,s)=>{var r,n,i,l,o,d,h,g,x,b;e({isLoading:!0,error:null});try{let x=await c.login(a,s),b=await c.getCurrentUser();if(b.settings)try{let e=localStorage.getItem("cipherlink_appearance"),t={...e?JSON.parse(e):{},...b.settings},a=JSON.stringify(t);localStorage.setItem("cipherlink_appearance",a),window.dispatchEvent(new StorageEvent("storage",{key:"cipherlink_appearance",newValue:a,storageArea:localStorage,url:window.location.href}))}catch(e){console.error("Failed to sync settings",e)}localStorage.setItem("cipherlink_token",x.access_token),localStorage.setItem("cipherlink_username",a);let w=v.load(a),j=!b.public_key;if(w&&b.public_key&&!v.verifyKeyConsistency(a,b.public_key)&&(console.warn("⚠️ Key mismatch detected! Local key differs from server key."),console.warn("This may happen if you logged in from a different device."),console.warn("Old messages encrypted with the server key may not decrypt correctly.")),!w){console.log("\uD83D\uDD10 Generating new key bundle...");let{bundle:e,privateKeys:t}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=u().sign.keyPair(),a=u().box.keyPair(),s=u().sign.detached(a.publicKey,t.secretKey),r=[],n=[];for(let t=0;t<e;t++){let e=u().box.keyPair();r.push((0,m.encodeBase64)(e.publicKey)),n.push((0,m.encodeBase64)(e.secretKey))}return{bundle:{publicKey:(0,m.encodeBase64)(a.publicKey),identityKey:(0,m.encodeBase64)(t.publicKey),signedPrekey:(0,m.encodeBase64)(a.publicKey),signedPrekeySignature:(0,m.encodeBase64)(s),oneTimePrekeys:r},privateKeys:{identityPrivate:(0,m.encodeBase64)(t.secretKey),signedPrekeyPrivate:(0,m.encodeBase64)(a.secretKey),oneTimePrekeyPrivates:n}}}(5);w={privateKey:t.signedPrekeyPrivate,publicKey:e.publicKey,identityKey:e.identityKey,signedPrekey:e.signedPrekey,signedPrekeySignature:e.signedPrekeySignature,identityPrivateKey:t.identityPrivate,oneTimePrekeys:e.oneTimePrekeys},v.save(a,w),j=!0,console.log("✅ Key bundle generated")}if(w.privateKey&&w.publicKey){let e=p(w.privateKey,w.publicKey);if(console.log("\uD83D\uDD11 Key pair verification:",e?"✅ VALID":"❌ INVALID"),!e){console.warn("⚠️ Key pair mismatch detected! Deriving correct public key...");let e=y(w.privateKey);console.log("\uD83D\uDD27 Original publicKey:",null===(l=w.publicKey)||void 0===l?void 0:l.substring(0,30)),console.log("\uD83D\uDD27 Derived publicKey:",null==e?void 0:e.substring(0,30)),w.publicKey=e,v.save(a,w),j=!0,console.log("✅ Key pair corrected and saved")}}if(j&&w){console.log("\uD83D\uDCE4 Uploading keys to server...",{publicKeyToUpload:null===(o=w.publicKey)||void 0===o?void 0:o.substring(0,30)});try{await c.uploadKeys({public_key:w.publicKey||"",identity_key:w.identityKey||"",signed_prekey:w.signedPrekey||w.publicKey||"",signed_prekey_signature:w.signedPrekeySignature||"",one_time_prekeys:w.oneTimePrekeys||[]}),b=await c.getCurrentUser(),console.log("✅ Keys uploaded successfully!",{serverNowHas:null===(d=b.public_key)||void 0===d?void 0:d.substring(0,30)})}catch(e){console.error("❌ Failed to upload keys:",(null==e?void 0:null===(h=e.response)||void 0===h?void 0:h.data)||e)}}let N=(null==w?void 0:w.publicKey)===b.public_key;if(console.log("\uD83D\uDD10 Final Key Status:",{username:a,localPubKey:null==w?void 0:null===(r=w.publicKey)||void 0===r?void 0:r.substring(0,30),serverPubKey:null===(n=b.public_key)||void 0===n?void 0:n.substring(0,30),localPrivKey:null==w?void 0:null===(i=w.privateKey)||void 0===i?void 0:i.substring(0,30),LOCAL_MATCHES_SERVER:N?"✅ YES":"❌ NO"}),!N&&(null==w?void 0:w.publicKey)&&b.public_key){console.error("\uD83D\uDEA8 CRITICAL: Local public key does not match server! This will cause decryption failures."),console.log("\uD83D\uDD27 Attempting to force upload correct key...");try{await c.uploadKeys({public_key:w.publicKey||"",identity_key:w.identityKey||"",signed_prekey:w.signedPrekey||w.publicKey||"",signed_prekey_signature:w.signedPrekeySignature||"",one_time_prekeys:w.oneTimePrekeys||[]}),b=await c.getCurrentUser(),console.log("✅ Force upload complete, server now has:",null===(g=b.public_key)||void 0===g?void 0:g.substring(0,30))}catch(e){console.error("❌ Force upload failed:",e)}}e({user:b,token:x.access_token,isAuthenticated:!0,isLoading:!1,privateKey:w.privateKey||null,publicKey:w.publicKey||null,identityKey:w.identityKey||null}),f.connect(b.id.toString(),x.access_token),window._wsHandlersRegistered||(I(t,e),window._wsHandlersRegistered=!0)}catch(t){throw e({isLoading:!1,error:(null===(b=t.response)||void 0===b?void 0:null===(x=b.data)||void 0===x?void 0:x.detail)||"Login failed"}),t}},register:async(a,s,r)=>{e({isLoading:!0,error:null});try{let e="web-".concat(Date.now(),"-").concat(Math.random().toString(36).slice(2));await c.register(a,s,r,e),await t().login(a,r)}catch(t){var n,i;throw e({isLoading:!1,error:(null===(i=t.response)||void 0===i?void 0:null===(n=i.data)||void 0===n?void 0:n.detail)||"Registration failed"}),t}},logout:()=>{f.disconnect(),window._wsHandlersRegistered=!1,localStorage.removeItem("cipherlink_token"),localStorage.removeItem("cipherlink_username"),c.setToken(null),e({user:null,token:null,isAuthenticated:!1,privateKey:null,publicKey:null,identityKey:null,identityPrivateKey:null,contacts:[],conversations:[],currentConversation:null,messages:new Map,onlineUsers:new Set,typingUsers:new Map,callHistory:[]})},initializeWebSocket:()=>{let{user:a,token:s}=t();if(a&&s){f.connect(a.id.toString(),s);let r=window;r._cipherlinkWsHandlersRegistered||(I(t,e),r._cipherlinkWsHandlersRegistered=!0,console.log("\uD83D\uDD0C WebSocket handlers registered"))}},loadStoredAuth:async()=>{let a=localStorage.getItem("cipherlink_token"),s=localStorage.getItem("cipherlink_username");if(a&&s){c.setToken(a);try{let r=await c.getCurrentUser();if(r.settings)try{let e=localStorage.getItem("cipherlink_appearance"),t={...e?JSON.parse(e):{},...r.settings},a=JSON.stringify(t);localStorage.setItem("cipherlink_appearance",a),window.dispatchEvent(new StorageEvent("storage",{key:"cipherlink_appearance",newValue:a,storageArea:localStorage,url:window.location.href}))}catch(e){console.error("Failed to sync settings",e)}let n=v.load(s);e({user:r,token:a,isAuthenticated:!0,privateKey:(null==n?void 0:n.privateKey)||null,publicKey:(null==n?void 0:n.publicKey)||null,identityKey:(null==n?void 0:n.identityKey)||null}),f.connect(r.id.toString(),a),window._wsHandlersRegistered||(I(t,e),window._wsHandlersRegistered=!0),await t().loadPersistedData(),t().syncWithServer().catch(console.error);return}catch(e){localStorage.removeItem("cipherlink_token"),localStorage.removeItem("cipherlink_username")}}},generateAndUploadKeys:async()=>{let{user:a}=t();if(!a)return;let s=function(){let e=u().box.keyPair();return{publicKey:(0,m.encodeBase64)(e.publicKey),privateKey:(0,m.encodeBase64)(e.secretKey)}}(),r=function(){let e=u().sign.keyPair();return{publicKey:(0,m.encodeBase64)(e.publicKey),privateKey:(0,m.encodeBase64)(e.secretKey)}}();v.save(a.username,{privateKey:s.privateKey,publicKey:s.publicKey,identityKey:r.publicKey}),await c.uploadKeys({public_key:s.publicKey,identity_key:r.publicKey,signed_prekey:s.publicKey,signed_prekey_signature:r.publicKey,one_time_prekeys:[]}),e({privateKey:s.privateKey,publicKey:s.publicKey,identityKey:r.publicKey})},loadStoredKeys:()=>{let{user:a}=t();if(!a)return;let s=v.load(a.username);s&&e({privateKey:s.privateKey,publicKey:s.publicKey,identityKey:s.identityKey})},loadContacts:async()=>{try{let t=await c.getContacts();e({contacts:t})}catch(e){console.error("Failed to load contacts:",e)}},loadConversations:async()=>{try{let t=await c.getConversations();e({conversations:t})}catch(e){console.error("Failed to load conversations:",e)}},loadMessages:async a=>{try{let r=await c.getConversation(a);console.log("\uD83D\uDCE5 Loaded ".concat(r.length," messages from server for ").concat(a));let n=t().messages.get(a)||[],i=new Set(n.map(e=>e.id)),l=[];for(let e of r)i.has(e.id)||l.push(e);if(l.length>0){let s=[...n,...l];s.sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime());let r=new Map(t().messages);r.set(a,s),e({messages:r})}let{privateKey:o,contacts:d,user:u}=t();if(o){for(let e of r)if(e.encrypted_content&&!e._decryptedContent)try{let t;let a=JSON.parse(e.encrypted_content);if(e.sender_username===(null==u?void 0:u.username)){var s;t=null===(s=d.find(t=>t.contact_username===e.recipient_username))||void 0===s?void 0:s.public_key}else{let a=d.find(t=>t.contact_username===e.sender_username);t=null==a?void 0:a.public_key}let r=h(a,t||"",o);e._decryptedContent=r}catch(t){console.warn("Failed to decrypt message:",e.id,t),e._decryptedContent="[Decryption Failed]"}}let m=[...n];for(let e of r){let t=m.findIndex(t=>t.id===e.id);t>=0?m[t]={...m[t],...e}:i.has(e.id)||m.push(e)}m.sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime());let g=new Map(t().messages);g.set(a,m),e({messages:g}),console.log("✅ Merged and decrypted messages for ".concat(a,": ").concat(m.length," total"))}catch(e){console.error("Failed to load messages:",e)}},sendMessage:async function(a,s){let r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text",i=arguments.length>3?arguments[3]:void 0;console.log("\uD83D\uDCE4 sendMessage called:",{recipientUsername:a,content:s.substring(0,50),messageType:n});let{privateKey:l,publicKey:o,user:d}=t();if(!l||!o||!d){console.error("Cannot send message: missing keys or user",{hasPrivateKey:!!l,hasPublicKey:!!o,hasUser:!!d});return}p(l,o)||(console.warn("⚠️ Invalid key pair detected in sendMessage! Deriving correct public key..."),console.log("\uD83D\uDD27 Using derived publicKey:",null==(o=y(l))?void 0:o.substring(0,30)),e({publicKey:o})),console.log("\uD83D\uDCE4 Fetching public key from server for:",a);try{r=(await c.getPublicKey(a)).public_key,console.log("\uD83D\uDCE4 Got recipient public key from server:",null==r?void 0:r.substring(0,30))}catch(e){throw console.error("Failed to get recipient public key:",e),Error("Could not get recipient encryption key")}if(!r)throw Error("Recipient has not set up encryption");console.log("\uD83D\uDCE4 Encrypting with:",{recipientPubKey:null==r?void 0:r.substring(0,30),senderPrivKey:null==l?void 0:l.substring(0,30),senderPubKey:null==o?void 0:o.substring(0,30)});let h=JSON.stringify(function(e,t,a,s){console.log("\uD83D\uDD10 Encrypting message:",{recipientKeyPrefix:null==t?void 0:t.substring(0,20),senderPrivKeyPrefix:null==a?void 0:a.substring(0,20),senderPubKeyPrefix:null==s?void 0:s.substring(0,20),hasSenderPubKey:!!s});let r=u().randomBytes(u().box.nonceLength),n=(0,m.decodeUTF8)(e),i=(0,m.decodeBase64)(t),l=(0,m.decodeBase64)(a),o=u().box(n,r,i,l),c={ciphertext:(0,m.encodeBase64)(o),nonce:(0,m.encodeBase64)(r),senderPublicKey:s,version:"v2"};return console.log("✅ Encrypted with v2 protocol, embedded senderPublicKey:",!!s),c}(s,r,l,o)),g=function(){try{let e=localStorage.getItem("cipherlink_appearance"),t="blue";e&&(t=JSON.parse(e).accent||"blue");let a=S(),s=D();return function(e,t,a){let s=N.FN[e];return{bubbleColor:s.primary,textColor:"#ffffff",style:t||"rounded",font:a||"inter",accentGradient:"linear-gradient(135deg, ".concat(s.primary,", ").concat(s.secondary,")"),accentPrimary:s.primary,accentSecondary:s.secondary}}(t,a,s)}catch(e){return console.error("Failed to build current message theme:",e),k}}(),x=t().messages.get(a)||[],v=-Date.now(),b={id:v,sender_id:d.id,sender_username:d.username,recipient_id:0,recipient_username:a,encrypted_content:h,message_type:n,status:"sending",expiry_type:"none",created_at:new Date().toISOString(),_decryptedContent:s,sender_theme:g},f=new Map(t().messages);f.set(a,[...x,b]),e({messages:f});try{console.log("\uD83D\uDCE4 Sending to API...");let r=await c.sendMessage(a,h,void 0,"none",n,i,g);console.log("✅ Message sent successfully",r),r._decryptedContent=s;let l=new Map(t().messages),o=l.get(a)||[],d=o.findIndex(e=>e.id===v);-1!==d?o[d]=r:o.push(r),l.set(a,o),e({messages:l});try{await t().persistMessage(r)}catch(e){console.error("❌ Failed to persist sent message:",e)}let u=t(),m=u.conversations.findIndex(e=>e.username===a);if(m>=0){let a=[...u.conversations],i={...a[m],last_message_time:r.created_at,last_message_preview:"image"===n?"\uD83D\uDCF7 Image":s};a[m]=i,e({conversations:a});try{await t().persistConversation(i)}catch(e){console.error("❌ Failed to persist conversation after send:",e)}}}catch(i){console.error("Failed to send message:",i);let s=new Map(t().messages),r=s.get(a)||[],n=r.findIndex(e=>e.id===v);throw -1!==n&&(r[n].status="failed",s.set(a,r),e({messages:s})),i}},setCurrentConversation:a=>{if(e({currentConversation:a}),a){t().loadMessages(a);let s=t(),r=new Map(s.typingUsers);r.delete(a),e({typingUsers:r})}},addContact:async a=>{try{let s=await c.addContact(a),r=t();if(e({contacts:[...r.contacts,s]}),!r.conversations.find(e=>e.username===a)){let t={user_id:s.contact_id,username:s.contact_username,public_key:s.public_key,identity_key:s.identity_key,last_message_time:void 0,last_message_preview:void 0,unread_count:0,is_online:!1};e({conversations:[t,...r.conversations]})}}catch(e){throw console.error("Failed to add contact:",e),e}},searchUsers:async e=>{try{return await c.searchUsers(e)}catch(e){return console.error("Failed to search users:",e),[]}},addIncomingMessage:a=>{let s=t(),r=a.sender_username,n=t().messages.get(r)||[];if(!n.some(e=>e.id===a.id)){let{privateKey:i,contacts:l}=t();if(i&&a.encrypted_content)try{let e=JSON.parse(a.encrypted_content),t=l.find(e=>e.contact_username===a.sender_username),s=(null==t?void 0:t.public_key)||"";a._decryptedContent=h(e,s,i),a._decryptedContent?console.log("✅ Successfully decrypted incoming message"):console.warn("⚠️ Decryption returned null for message:",a.id)}catch(e){console.error("❌ Decryption failed for incoming:",e)}let o=new Map(t().messages);o.set(r,[...n,a]),e({messages:o});let c=s.conversations.findIndex(e=>e.username===r);if(c>=0){let r=[...s.conversations],n={...r[c],last_message_time:a.created_at,last_message_preview:a._decryptedContent?"image"===a.message_type?"\uD83D\uDCF7 Image":a._decryptedContent:"[Encrypted Message]",unread_count:(r[c].unread_count||0)+1};r[c]=n,e({conversations:r}),t().persistMessage(a).catch(e=>console.error("❌ Failed to persist incoming message:",e)),t().persistConversation(n).catch(e=>console.error("❌ Failed to persist conversation for incoming message:",e))}else{let n={user_id:a.sender_id,username:r,public_key:void 0,identity_key:void 0,last_message_time:a.created_at,last_message_preview:a._decryptedContent?"image"===a.message_type?"\uD83D\uDCF7 Image":a._decryptedContent:"[Encrypted Message]",unread_count:1,is_online:!1};e({conversations:[n,...s.conversations]}),t().persistMessage(a).catch(e=>console.error("❌ Failed to persist incoming message:",e)),t().persistConversation(n).catch(e=>console.error("❌ Failed to persist new conversation for incoming message:",e))}}},loadCallHistory:async()=>{try{let t=await c.getCallHistory();e({callHistory:t})}catch(e){console.error("Failed to load call history:",e)}},setUserOnline:(a,s)=>{let r=t(),n=new Set(r.onlineUsers);s?n.add(a):n.delete(a),e({onlineUsers:n})},setUserTyping:(a,s)=>{let r=t(),n=new Map(r.typingUsers);s?n.set(a,!0):n.delete(a),e({typingUsers:n})},clearError:()=>e({error:null}),deleteMessageForMe:async(a,s)=>{try{let r=new Map(t().messages),n=(r.get(s)||[]).filter(e=>e.id!==a);r.set(s,n),e({messages:r}),await j.deleteMessage(a),console.log("\uD83D\uDDD1️ Message deleted locally:",a)}catch(e){console.error("Failed to delete message locally:",e)}},deleteMessageForEveryone:async(a,s)=>{try{let r=new Map(t().messages),n=(r.get(s)||[]).map(e=>e.id===a?{...e,_decryptedContent:null,encrypted_content:JSON.stringify({deleted:!0}),message_type:"deleted"}:e);r.set(s,n),e({messages:r}),await j.markMessageAsDeleted(a),f.sendDeleteMessage(a,s);try{await c.deleteMessage(a)}catch(e){console.warn("Could not delete message on server:",e)}console.log("\uD83D\uDDD1️ Message deleted for everyone:",a)}catch(e){console.error("Failed to delete message for everyone:",e)}},clearChat:async a=>{try{let{user:s}=t();if(!s)return;let r=new Map(t().messages);r.set(a,[]),e({messages:r}),await j.clearConversationMessages(a,s.username);let n=t().callHistory.filter(e=>e.caller_username!==a&&e.receiver_username!==a);e({callHistory:n});try{await c.deleteCallHistory(a)}catch(e){console.warn("Failed to delete call history on server:",e)}let i=[...t().conversations],l=i.findIndex(e=>e.username===a);l>=0&&(i[l]={...i[l],last_message_preview:void 0,last_message_time:void 0,unread_count:0},e({conversations:i})),console.log("\uD83E\uDDF9 Chat cleared locally:",a)}catch(e){console.error("Failed to clear chat:",e)}},deleteConversationForEveryone:async a=>{try{let{user:s}=t();if(!s)return;let r=new Map(t().messages);r.set(a,[]),e({messages:r});let n=[...t().conversations],i=n.findIndex(e=>e.username===a);i>=0&&(n[i]={...n[i],last_message_preview:"Chat cleared",last_message_time:new Date().toISOString(),unread_count:0},e({conversations:n})),await j.clearConversationMessages(a,s.username),f.sendDeleteConversation(a);try{await c.deleteConversation(a)}catch(e){console.warn("Could not delete conversation messages on server:",e)}console.log("\uD83D\uDDD1️ Conversation messages deleted for everyone:",a)}catch(e){console.error("Failed to delete conversation messages for everyone:",e)}},handleRemoteDeleteMessage:(a,s)=>{let r=new Map(t().messages),n=(r.get(s)||[]).map(e=>e.id===a?{...e,_decryptedContent:null,encrypted_content:JSON.stringify({deleted:!0}),message_type:"deleted"}:e);r.set(s,n),e({messages:r}),j.markMessageAsDeleted(a).catch(console.error),console.log("\uD83D\uDCE8 Remote message deletion received:",a)},handleRemoteDeleteConversation:a=>{let s=new Map(t().messages);s.set(a,[]),e({messages:s});let r=[...t().conversations],n=r.findIndex(e=>e.username===a);n>=0&&(r[n]={...r[n],last_message_preview:"Chat cleared",last_message_time:new Date().toISOString(),unread_count:0},e({conversations:r}));let i=t().user;i&&j.clearConversationMessages(a,i.username).catch(console.error),console.log("\uD83D\uDCE8 Remote conversation cleared:",a)},loadPersistedData:async()=>{try{console.log("\uD83D\uDCC2 Loading persisted data from IndexedDB...");let a=await j.getAllConversations();if(a.length>0){let t=a.map(e=>({user_id:e.user_id,username:e.username,public_key:e.public_key,identity_key:e.identity_key,last_message_time:e.last_message_time,last_message_preview:e.last_message_preview,unread_count:e.unread_count,is_online:e.is_online}));e({conversations:t}),console.log("\uD83D\uDCC2 Loaded ".concat(t.length," conversations from storage"))}let s=await j.getAllContacts();if(s.length>0){let t=s.map(e=>({id:e.id,user_id:e.user_id,contact_id:e.contact_id,contact_username:e.contact_username,contact_email:e.contact_email,public_key:e.public_key,identity_key:e.identity_key,nickname:e.nickname,is_blocked:e.is_blocked,is_verified:e.is_verified,added_at:e.added_at}));e({contacts:t}),console.log("\uD83D\uDCC2 Loaded ".concat(t.length," contacts from storage"))}let{user:r}=t();if(r){let t=new Map;for(let e of a){let a=await j.getConversationMessages(e.username,r.username,50);if(a.length>0){let s=a.map(e=>({id:e.id,sender_id:e.sender_id,sender_username:e.sender_username,recipient_id:e.recipient_id,recipient_username:e.recipient_username,encrypted_content:e.encrypted_content,encrypted_key:e.encrypted_key,message_type:e.message_type,status:e.status,created_at:e.created_at,delivered_at:e.delivered_at,read_at:e.read_at,expiry_type:e.expiry_type,expires_at:e.expires_at,file_metadata:e.file_metadata}));t.set(e.username,s)}}e({messages:t}),console.log("\uD83D\uDCC2 Loaded messages for ".concat(t.size," conversations"))}}catch(e){console.error("❌ Failed to load persisted data:",e)}},syncWithServer:async()=>{try{console.log("\uD83D\uDD04 Syncing with server..."),await t().loadContacts(),await t().loadConversations();let a=await c.getAllConversationsWithMessages(),{user:s,contacts:r,conversations:n}=t();if(s){let t=n.map(e=>({username:e.username,user_id:e.user_id,public_key:e.public_key,identity_key:e.identity_key,last_message_time:e.last_message_time,last_message_preview:e.last_message_preview,unread_count:e.unread_count,is_online:e.is_online}));await j.saveConversations(t);let s=r.map(e=>({id:e.id,user_id:e.user_id,contact_id:e.contact_id,contact_username:e.contact_username,contact_email:e.contact_email,public_key:e.public_key,identity_key:e.identity_key,nickname:e.nickname,is_blocked:e.is_blocked,is_verified:e.is_verified,added_at:e.added_at}));for(let[e,t]of(await j.saveContacts(s),Object.entries(a))){let e=t.map(e=>({id:e.id,sender_id:e.sender_id,sender_username:e.sender_username,recipient_id:e.recipient_id,recipient_username:e.recipient_username,encrypted_content:e.encrypted_content,encrypted_key:e.encrypted_key,message_type:e.message_type,status:e.status,created_at:e.created_at,delivered_at:e.delivered_at,read_at:e.read_at,expiry_type:e.expiry_type,expires_at:e.expires_at,file_metadata:e.file_metadata}));await j.saveMessages(e)}let i=new Map;for(let[e,t]of Object.entries(a))i.set(e,t);e({messages:i}),console.log("✅ Sync completed successfully")}}catch(e){console.error("❌ Sync failed:",e)}},persistMessage:async e=>{try{let t={id:e.id,sender_id:e.sender_id,sender_username:e.sender_username,recipient_id:e.recipient_id,recipient_username:e.recipient_username,encrypted_content:e.encrypted_content,encrypted_key:e.encrypted_key,message_type:e.message_type,status:e.status,created_at:e.created_at,delivered_at:e.delivered_at,read_at:e.read_at,expiry_type:e.expiry_type,expires_at:e.expires_at,file_metadata:e.file_metadata};await j.saveMessage(t)}catch(e){console.error("❌ Failed to persist message:",e)}},persistConversation:async e=>{try{let t={username:e.username,user_id:e.user_id,public_key:e.public_key,identity_key:e.identity_key,last_message_time:e.last_message_time,last_message_preview:e.last_message_preview,unread_count:e.unread_count,is_online:e.is_online};await j.saveConversation(t)}catch(e){console.error("❌ Failed to persist conversation:",e)}},loadAllConversationHistory:async()=>{try{let{conversations:e}=t();for(let a of(console.log("\uD83D\uDCDA Loading history for ".concat(e.length," conversations...")),e))await t().loadMessages(a.username),await new Promise(e=>setTimeout(e,100));console.log("✅ All conversation history loaded")}catch(e){console.error("❌ Failed to load conversation history:",e)}}}),{name:"cipherlink-store",partialize:e=>({currentConversation:e.currentConversation})}));function I(e,t){let a=new Set;f.on("message",t=>{var s,r;console.log("\uD83D\uDCE8 Received message via WebSocket:",t);let n=t.message_id;if(a.has(n)){console.log("⏩ Skipping duplicate message ".concat(n));return}if(a.add(n),a.size>1e3){let e=a.values().next().value;void 0!==e&&a.delete(e)}let i=e(),l=t.sender_username,o={id:n,sender_id:t.sender_id,sender_username:l,recipient_id:(null===(s=i.user)||void 0===s?void 0:s.id)||0,recipient_username:(null===(r=i.user)||void 0===r?void 0:r.username)||"",encrypted_content:t.content||t.encrypted_content,encrypted_key:t.encrypted_key,message_type:t.message_type||"text",status:"delivered",expiry_type:t.expiry_type||"none",sender_theme:t.sender_theme,created_at:t.timestamp||new Date().toISOString()};e().addIncomingMessage(o),f.sendDeliveryReceipt(n,t.sender_id)}),f.on("typing",t=>{e().setUserTyping(t.sender_username,t.is_typing),t.is_typing&&setTimeout(()=>{e().setUserTyping(t.sender_username,!1)},3e3)}),f.on("presence",t=>{e().setUserOnline(t.user_id,t.is_online)}),f.on("message_sent",e=>{console.log("✅ Message sent confirmation:",e)}),f.on("read_receipt",e=>{console.log("\uD83D\uDC41️ Read receipt:",e)}),f.on("delivery_receipt",e=>{console.log("\uD83D\uDCEC Delivery receipt:",e)}),f.on("connected",e=>{console.log("✅ WebSocket connected:",e)}),f.on("error",e=>{console.error("❌ WebSocket error:",e)}),f.on("delete_message_received",t=>{var a,s;console.log("\uD83D\uDDD1️ Remote delete message received:",t);let r=t.message_id||(null===(a=t.data)||void 0===a?void 0:a.message_id),n=t.sender_username||(null===(s=t.data)||void 0===s?void 0:s.sender_username);r&&n&&e().handleRemoteDeleteMessage(r,n)}),f.on("delete_conversation_received",t=>{var a;console.log("\uD83D\uDDD1️ Remote delete conversation received:",t);let s=t.sender_username||(null===(a=t.data)||void 0===a?void 0:a.sender_username);s&&e().handleRemoteDeleteConversation(s)})}var M=a(5589),K=a(9036),P=a(774),T=a(2882),F=a(7972),O=a(1295),Z=a(7216),A=a(9670);function H(){let[e,t]=(0,r.useState)(!0),[a,n]=(0,r.useState)(""),[i,l]=(0,r.useState)(""),[o,c]=(0,r.useState)(""),[d,u]=(0,r.useState)(!1),{login:m,register:h,isLoading:g,error:p,clearError:y}=E(),x=async t=>{t.preventDefault(),y();try{e?await m(a,o):await h(a,i,o)}catch(e){}};return(0,s.jsxs)("div",{className:"min-h-screen bg-cipher-darker flex",children:[(0,s.jsxs)("div",{className:"hidden lg:flex lg:w-1/2 bg-gradient-to-br from-cipher-dark to-cipher-darker p-12 flex-col justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center gap-3 mb-8",children:[(0,s.jsx)("div",{className:"w-12 h-12 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-xl flex items-center justify-center",children:(0,s.jsx)(M.Z,{className:"w-6 h-6 text-white"})}),(0,s.jsx)("span",{className:"text-2xl font-bold gradient-text",children:"CipherLink"})]}),(0,s.jsxs)("h1",{className:"text-4xl font-bold text-white mb-4",children:["Private by design.",(0,s.jsx)("br",{}),(0,s.jsx)("span",{className:"text-cipher-primary",children:"Secure by default."})]}),(0,s.jsx)("p",{className:"text-gray-400 text-lg mb-12",children:"End-to-end encrypted communication where only you and your recipient can read messages. The server never sees your data."}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsx)(U,{icon:(0,s.jsx)(K.Z,{className:"w-5 h-5"}),title:"Zero-Knowledge Server",description:"We can't read your messages. Ever."}),(0,s.jsx)(U,{icon:(0,s.jsx)(P.Z,{className:"w-5 h-5"}),title:"Cryptographic Identity",description:"Your identity is based on math, not trust."}),(0,s.jsx)(U,{icon:(0,s.jsx)(T.Z,{className:"w-5 h-5"}),title:"Ephemeral Messages",description:"Messages that disappear after being read."})]})]}),(0,s.jsxs)("div",{className:"text-gray-500 text-sm",children:[(0,s.jsx)("p",{children:"Encryption: X25519 + AES-256-GCM"}),(0,s.jsx)("p",{children:"Protocol: Signal-style X3DH"})]})]}),(0,s.jsx)("div",{className:"w-full lg:w-1/2 flex items-center justify-center p-8",children:(0,s.jsxs)("div",{className:"w-full max-w-md",children:[(0,s.jsxs)("div",{className:"lg:hidden flex items-center gap-3 mb-8 justify-center",children:[(0,s.jsx)("div",{className:"w-10 h-10 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-xl flex items-center justify-center",children:(0,s.jsx)(M.Z,{className:"w-5 h-5 text-white"})}),(0,s.jsx)("span",{className:"text-xl font-bold gradient-text",children:"CipherLink"})]}),(0,s.jsxs)("div",{className:"glass rounded-2xl p-8",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold text-white mb-2",children:e?"Welcome back":"Create account"}),(0,s.jsx)("p",{className:"text-gray-400 mb-6",children:e?"Enter your credentials to access your encrypted messages":"Generate your cryptographic identity"}),p&&(0,s.jsx)("div",{className:"bg-red-500/10 border border-red-500/20 rounded-lg p-3 mb-4",children:(0,s.jsx)("p",{className:"text-red-400 text-sm",children:p})}),(0,s.jsxs)("form",{onSubmit:x,className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Username"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(F.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"}),(0,s.jsx)("input",{type:"text",value:a,onChange:e=>n(e.target.value),className:"w-full bg-cipher-dark border border-gray-700 rounded-lg py-3 pl-10 pr-4 text-white placeholder-gray-500 focus:border-cipher-primary transition-colors",placeholder:"Enter username",required:!0,minLength:3})]})]}),!e&&(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Email"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(O.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"}),(0,s.jsx)("input",{type:"email",value:i,onChange:e=>l(e.target.value),className:"w-full bg-cipher-dark border border-gray-700 rounded-lg py-3 pl-10 pr-4 text-white placeholder-gray-500 focus:border-cipher-primary transition-colors",placeholder:"Enter email",required:!e})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm text-gray-400 mb-1",children:"Password"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(M.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"}),(0,s.jsx)("input",{type:d?"text":"password",value:o,onChange:e=>c(e.target.value),className:"w-full bg-cipher-dark border border-gray-700 rounded-lg py-3 pl-10 pr-12 text-white placeholder-gray-500 focus:border-cipher-primary transition-colors",placeholder:"Enter password",required:!0,minLength:8}),(0,s.jsx)("button",{type:"button",onClick:()=>u(!d),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-300",children:d?(0,s.jsx)(Z.Z,{className:"w-5 h-5"}):(0,s.jsx)(A.Z,{className:"w-5 h-5"})})]})]}),(0,s.jsx)("button",{type:"submit",disabled:g,className:"w-full bg-gradient-to-r from-cipher-primary to-cipher-secondary text-white py-3 rounded-lg font-medium btn-primary disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:g?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),e?"Authenticating...":"Creating keys..."]}):(0,s.jsxs)(s.Fragment,{children:[e?"Sign In":"Create Account",(0,s.jsx)(M.Z,{className:"w-4 h-4"})]})})]}),(0,s.jsx)("div",{className:"mt-6 text-center",children:(0,s.jsxs)("p",{className:"text-gray-400",children:[e?"Don't have an account?":"Already have an account?",(0,s.jsx)("button",{onClick:()=>{t(!e),y(),c("")},className:"text-cipher-primary hover:text-cipher-secondary ml-1 font-medium",children:e?"Sign up":"Sign in"})]})})]}),(0,s.jsxs)("div",{className:"mt-6 flex items-start gap-3 text-sm text-gray-500",children:[(0,s.jsx)(K.Z,{className:"w-5 h-5 flex-shrink-0 text-cipher-primary"}),(0,s.jsx)("p",{children:"Your private keys are generated locally and never leave your device. We use end-to-end encryption so only you can read your messages."})]})]})})]})}function U(e){let{icon:t,title:a,description:r}=e;return(0,s.jsxs)("div",{className:"flex items-start gap-4",children:[(0,s.jsx)("div",{className:"w-10 h-10 bg-cipher-primary/20 rounded-lg flex items-center justify-center text-cipher-primary flex-shrink-0",children:t}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-white font-medium",children:a}),(0,s.jsx)("p",{className:"text-gray-400 text-sm",children:r})]})]})}var R=a(7662),L=a(6307),W=a(6004),z=a(6397);let B={sm:"w-8 h-8 text-sm",md:"w-10 h-10 text-base",lg:"w-12 h-12 text-lg",xl:"w-24 h-24 text-4xl"};function G(e){let{name:t,isOnline:a=!1,size:r="md",className:n="",disableTilt:i=!1}=e,{getAccentGradient:l}=(0,N.MU)(),o=l(),c=(0,s.jsx)("div",{className:"\n        ".concat(B[r],"\n        rounded-full flex items-center justify-center font-medium text-white\n        ").concat(n,"\n      "),style:{background:o},children:t.charAt(0).toUpperCase()});return i?(0,s.jsxs)("div",{className:"relative",children:[c,a&&(0,s.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-cipher-dark"})]}):(0,s.jsxs)(W.TiltAvatar,{maxTilt:20,scale:1.05,glare:!0,shadow:!0,className:"relative",children:[c,a&&(0,s.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-cipher-dark"})]})}var V=a(9883),J=a(9409),Y=a(5883),q=a(1827),Q=a(2549),X=a(6264),$=a(4527),ee=a(6834),et=a(8175),ea=a(5626);function es(e){let{onNewChat:t,onSettings:a}=e,{user:n,conversations:i,currentConversation:l,setCurrentConversation:o,logout:c,onlineUsers:d,searchUsers:u,addContact:m,loadContacts:h,loadConversations:g,contacts:p}=E(),{getAccentGradient:y,settings:x}=(0,N.MU)(),v=y(),[b,f]=(0,r.useState)(""),[w,j]=(0,r.useState)(!1),[k,_]=(0,r.useState)([]),[C,S]=(0,r.useState)(!1),[D,I]=(0,r.useState)(null),P=(0,r.useMemo)(()=>{if(!b.trim())return i;let e=b.toLowerCase();return i.filter(t=>t.username.toLowerCase().includes(e))},[i,b]),F=async e=>{if(f(e),e.trim().length>=2){j(!0),S(!0);try{let t=(await u(e.trim())).filter(e=>e.username!==(null==n?void 0:n.username));_(t)}catch(e){console.error("Search failed:",e),_([])}finally{j(!1)}}else _([]),S(!1)},O=async e=>{I(e.id);try{i.find(t=>t.username===e.username)||(p.find(t=>t.contact_username===e.username)||(await m(e.username),await h()),await g()),o(e.username),f(""),_([]),S(!1)}catch(e){console.error("Failed to start chat:",e)}finally{I(null)}},Z=e=>{if(!e)return"";let t=new Date(e);return(0,ee.z)(t)?(0,et.WU)(t,"HH:mm"):(0,ea.g)(t)?"Yesterday":(0,et.WU)(t,"dd/MM")};return(0,s.jsxs)("div",{className:"h-full flex flex-col",children:[(0,s.jsxs)(R.E.div,{className:"p-4 border-b border-gray-800",initial:{y:-20,opacity:0},animate:{y:0,opacity:1},transition:{duration:.4},children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(R.E.div,{className:"w-8 h-8 rounded-lg flex items-center justify-center",style:{background:v},whileHover:{scale:1.1,rotate:5},whileTap:{scale:.95},children:(0,s.jsx)(M.Z,{className:"w-4 h-4 text-white"})}),(0,s.jsx)("span",{className:"font-bold text-white dark:text-white",children:"CipherLink"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(R.E.button,{onClick:t,className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"New Chat",whileHover:{scale:1.1},whileTap:{scale:.9},children:(0,s.jsx)(V.Z,{className:"w-5 h-5"})}),(0,s.jsx)(R.E.button,{onClick:a,className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Settings",whileHover:{scale:1.1,rotate:30},whileTap:{scale:.9},children:(0,s.jsx)(J.Z,{className:"w-5 h-5"})})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-3 p-2 bg-cipher-darker/50 dark:bg-gray-800/50 rounded-lg",children:[(0,s.jsx)(G,{name:(null==n?void 0:n.username)||"U",size:"md",disableTilt:!0}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"font-medium text-white truncate",children:null==n?void 0:n.username}),(0,s.jsx)("p",{className:"text-xs text-gray-500 truncate",children:null==n?void 0:n.email})]}),(0,s.jsx)(R.E.button,{onClick:c,className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-red-400 transition-colors",title:"Logout",whileHover:{scale:1.1,x:2},whileTap:{scale:.9},children:(0,s.jsx)(Y.Z,{className:"w-4 h-4"})})]})]}),(0,s.jsxs)(R.E.div,{className:"p-4",initial:{y:-10,opacity:0},animate:{y:0,opacity:1},transition:{delay:.1},children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(q.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"}),(0,s.jsx)("input",{type:"text",placeholder:"Search users or conversations...",value:b,onChange:e=>F(e.target.value),className:"w-full bg-cipher-darker border border-gray-700 rounded-lg py-2 pl-10 pr-10 text-sm text-white placeholder-gray-500 focus:border-cipher-primary transition-colors"}),b&&(0,s.jsx)(R.E.button,{onClick:()=>{f(""),_([]),S(!1)},className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white transition-colors",whileHover:{scale:1.2,rotate:90},whileTap:{scale:.9},children:(0,s.jsx)(Q.Z,{className:"w-4 h-4"})}),w&&(0,s.jsx)(X.Z,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-cipher-primary animate-spin"})]}),(0,s.jsx)(L.M,{children:C&&k.length>0&&(0,s.jsxs)(R.E.div,{className:"mt-2 bg-cipher-darker border border-gray-700 rounded-lg overflow-hidden",initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},children:[(0,s.jsx)("div",{className:"px-3 py-2 border-b border-gray-700 bg-gray-800/50",children:(0,s.jsx)("p",{className:"text-xs text-gray-400 font-medium",children:"Users Found"})}),(0,s.jsx)("div",{className:"max-h-48 overflow-y-auto",children:k.map((e,t)=>{let a=i.find(t=>t.username===e.username),r=D===e.id;return(0,s.jsxs)(R.E.button,{onClick:()=>O(e),disabled:r,className:"w-full p-3 flex items-center gap-3 hover:bg-gray-800 transition-colors border-b border-gray-700/50 last:border-0",initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.05*t},whileHover:{x:4,backgroundColor:"rgba(255,255,255,0.05)"},children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{background:v},children:(0,s.jsx)("span",{className:"text-white font-medium text-sm",children:e.username[0].toUpperCase()})}),e.is_online&&(0,s.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-cipher-darker"})]}),(0,s.jsxs)("div",{className:"flex-1 text-left min-w-0",children:[(0,s.jsx)("p",{className:"text-white font-medium truncate text-sm",children:e.username}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:a?"Open chat":"Start new chat"})]}),r?(0,s.jsx)(X.Z,{className:"w-5 h-5 text-cipher-primary animate-spin"}):a?(0,s.jsx)(T.Z,{className:"w-5 h-5 text-cipher-primary"}):(0,s.jsx)($.Z,{className:"w-5 h-5 text-green-500"})]},e.id)})})]})}),(0,s.jsx)(L.M,{children:C&&!w&&b.length>=2&&0===k.length&&(0,s.jsxs)(R.E.div,{className:"mt-2 p-4 bg-cipher-darker border border-gray-700 rounded-lg text-center",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:[(0,s.jsxs)("p",{className:"text-sm text-gray-400",children:['No users found for "',b,'"']}),(0,s.jsx)("button",{onClick:t,className:"mt-2 text-xs text-cipher-primary hover:underline",children:"Try advanced search"})]})})]}),(0,s.jsx)(R.E.div,{className:"flex-1 overflow-y-auto",variants:z.fb.stagger,initial:"hidden",animate:"visible",children:0===P.length&&0===i.length?(0,s.jsxs)(R.E.div,{className:"p-8 text-center",initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},children:[(0,s.jsx)("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,s.jsx)(T.Z,{className:"w-8 h-8 text-gray-600"})}),(0,s.jsx)("p",{className:"text-gray-400 text-sm",children:"No conversations yet"}),(0,s.jsx)(R.E.button,{onClick:t,className:"mt-3 text-cipher-primary hover:text-cipher-secondary text-sm font-medium",whileHover:{scale:1.05},whileTap:{scale:.95},children:"Start a new chat"})]}):0===P.length&&b?(0,s.jsx)("div",{className:"p-4 text-center",children:(0,s.jsxs)("p",{className:"text-gray-400 text-sm",children:['No conversations match "',b,'"']})}):(0,s.jsx)("div",{className:"space-y-1 p-2",children:P.map((e,t)=>{let a=l===e.username,r=d.has(e.user_id);return(0,s.jsxs)(R.E.button,{onClick:()=>o(e.username),variants:z.fb.listItem,whileHover:{x:4,backgroundColor:a?void 0:"rgba(255,255,255,0.05)"},whileTap:{scale:.98},className:"\n                    w-full p-3 rounded-lg flex items-center gap-3 transition-colors\n                    ".concat(a?"bg-cipher-primary/20 border border-cipher-primary/30":"hover:bg-gray-800","\n                  "),children:[(0,s.jsxs)("div",{className:"relative flex-shrink-0",children:[(0,s.jsx)("div",{className:"w-12 h-12 rounded-full flex items-center justify-center ".concat(a?"":"bg-gray-700"),style:a?{background:v}:void 0,children:(0,s.jsx)("span",{className:"text-white font-medium",children:e.username.charAt(0).toUpperCase()})}),r&&(0,s.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-cipher-dark online-indicator"})]}),(0,s.jsxs)("div",{className:"flex-1 min-w-0 text-left",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("span",{className:"font-medium truncate ".concat(a?"text-white":"text-gray-200"),children:e.username}),(0,s.jsx)("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:Z(e.last_message_time)})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between mt-1",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1 text-sm text-gray-400 truncate",children:[(0,s.jsx)(K.Z,{className:"w-3 h-3 text-cipher-primary flex-shrink-0"}),(0,s.jsx)("span",{className:"truncate",children:e.last_message_preview||"Start conversation"})]}),e.unread_count>0&&(0,s.jsx)(R.E.span,{className:"bg-cipher-primary text-white text-xs px-2 py-0.5 rounded-full flex-shrink-0 ml-2",initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:15},children:e.unread_count})]})]})]},e.user_id)})})}),(0,s.jsx)(R.E.div,{className:"p-4 border-t border-gray-800",initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},children:(0,s.jsxs)("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[(0,s.jsx)(M.Z,{className:"w-3 h-3 text-cipher-primary"}),(0,s.jsx)("span",{children:"End-to-end encrypted"})]})})]})}let er={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}]};class en{setupWebSocketHandlers(){f.on("call_offer",async e=>{console.log("\uD83D\uDCDE Incoming call offer received:",e);let t=e.call_id,a=e.call_type||"audio",s=e.caller_username,r=e.sdp;if(!t||!s){console.error("Invalid call_offer message:",e);return}this.pendingSdp=r,this.currentCall={callId:t,type:a,status:"ringing",remoteUsername:s,isIncoming:!0,isMuted:!1,isVideoOff:!1},console.log("\uD83D\uDCDE Call state set to RINGING:",this.currentCall),this.notifyStateChange()}),f.on("call_answer",async e=>{if(console.log("✅ Call answer received:",e),!this.currentCall||!this.peerConnection){console.error("No active call or peer connection");return}try{await this.peerConnection.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e.sdp})),console.log("✅ Remote description (answer) set"),await this.processPendingIceCandidates(),this.currentCall.status="connecting",this.notifyStateChange(),console.log("\uD83D\uDCDE State: CALLING → CONNECTING")}catch(e){console.error("❌ Error handling call answer:",e),this.handleError("Failed to establish connection")}}),f.on("call_rejected",e=>{console.log("❌ Call rejected:",e),this.handleError("Call was rejected")}),f.on("call_ended",e=>{console.log("\uD83D\uDCF4 Call ended by remote:",e),this.endCall(!1)}),f.on("ice_candidate",async e=>{console.log("\uD83E\uDDCA ICE candidate received");let t=e.candidate;if(!t){console.log("⚠️ Empty ICE candidate received (end of candidates)");return}if(this.peerConnection&&this.peerConnection.remoteDescription)try{await this.peerConnection.addIceCandidate(new RTCIceCandidate(t)),console.log("✅ ICE candidate added")}catch(e){console.error("❌ Error adding ICE candidate:",e)}else console.log("⏳ Queued ICE candidate"),this.pendingIceCandidates.push(t)}),f.on("call_failed",e=>{console.warn("\uD83D\uDCA5 Call failed:",e),this.handleError(e.reason||"Call failed")})}async processPendingIceCandidates(){if(this.peerConnection&&this.peerConnection.remoteDescription){for(let e of this.pendingIceCandidates)try{await this.peerConnection.addIceCandidate(new RTCIceCandidate(e))}catch(e){console.error("Error adding pending ICE candidate:",e)}this.pendingIceCandidates=[]}}notifyStateChange(){if(this.onCallStateChange&&this.currentCall){let e={...this.currentCall,localStream:this.currentCall.localStream,remoteStream:this.currentCall.remoteStream};this.onCallStateChange(e)}}setOnCallStateChange(e){this.onCallStateChange=e}setOnRemoteStream(e){this.onRemoteStream=e}setOnLocalStream(e){this.onLocalStream=e}async startCall(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"audio";try{var a;if(console.log("\uD83D\uDCDE START CALL: ".concat(t," to ").concat(e)),this.isInCall())return console.error("Already in a call"),!1;let s="".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9));console.log("\uD83D\uDCDE Step 1: Getting user media...");try{this.localStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:"video"===t&&{width:{ideal:1280},height:{ideal:720},facingMode:"user"}})}catch(e){throw this.handleMediaError(e)}console.log("✅ Got user media:",this.localStream.getTracks().map(e=>e.kind)),null===(a=this.onLocalStream)||void 0===a||a.call(this,this.localStream),this.currentCall={callId:s,type:t,status:"calling",remoteUsername:e,isIncoming:!1,localStream:this.localStream,isMuted:!1,isVideoOff:!1},this.notifyStateChange(),console.log("\uD83D\uDCDE State: IDLE → CALLING"),console.log("\uD83D\uDCDE Step 3: Creating peer connection..."),this.peerConnection=new RTCPeerConnection({iceServers:this.config.iceServers,iceCandidatePoolSize:10}),this.setupPeerConnectionHandlers(),console.log("\uD83D\uDCDE Step 4: Adding local tracks..."),this.localStream.getTracks().forEach(e=>{this.peerConnection&&this.localStream&&(this.peerConnection.addTrack(e,this.localStream),console.log("✅ Added ".concat(e.kind," track")))}),console.log("\uD83D\uDCDE Step 5: Creating offer...");let r=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:"video"===t});return await this.peerConnection.setLocalDescription(r),console.log("✅ Offer created and set as local description"),console.log("\uD83D\uDCDE Step 6: Sending offer..."),f.send({type:"call_offer",data:{call_id:s,recipient_username:e,call_type:t,sdp:r.sdp},timestamp:new Date().toISOString()}),console.log("✅ Call started successfully"),!0}catch(e){return console.error("❌ Error starting call:",e),this.handleError(e.message||"Failed to start call"),!1}}async answerCall(){if(console.log("\uD83D\uDCDE ANSWER CALL called"),!this.currentCall)return console.error("❌ No current call to answer"),!1;if("ringing"!==this.currentCall.status)return console.error("❌ Call is not in ringing state:",this.currentCall.status),!1;try{var e;let t=this.currentCall.type;console.log("\uD83D\uDCDE Step 1: Getting user media...");try{this.localStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:"video"===t&&{width:{ideal:1280},height:{ideal:720},facingMode:"user"}})}catch(e){throw this.handleMediaError(e)}console.log("✅ Got user media:",this.localStream.getTracks().map(e=>e.kind)),null===(e=this.onLocalStream)||void 0===e||e.call(this,this.localStream),console.log("\uD83D\uDCDE Step 2: Creating peer connection..."),this.peerConnection=new RTCPeerConnection({iceServers:this.config.iceServers,iceCandidatePoolSize:10}),this.setupPeerConnectionHandlers(),console.log("\uD83D\uDCDE Step 3: Adding local tracks..."),this.localStream.getTracks().forEach(e=>{this.peerConnection&&this.localStream&&(this.peerConnection.addTrack(e,this.localStream),console.log("✅ Added ".concat(e.kind," track")))});let a=this.pendingSdp;if(!a)throw Error("No SDP available to answer call");console.log("\uD83D\uDCDE Step 4: Setting remote description..."),await this.peerConnection.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:a})),console.log("✅ Remote description set"),await this.processPendingIceCandidates(),console.log("\uD83D\uDCDE Step 5: Creating answer...");let s=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(s),console.log("✅ Answer created and set as local description"),this.currentCall.status="connecting",this.currentCall.localStream=this.localStream,this.notifyStateChange(),console.log("\uD83D\uDCDE State: RINGING → CONNECTING"),console.log("\uD83D\uDCDE Step 6: Sending answer..."),f.send({type:"call_answer",data:{call_id:this.currentCall.callId,sdp:s.sdp},timestamp:new Date().toISOString()}),console.log("✅ Call answered successfully"),!0}catch(e){return console.error("❌ Error answering call:",e),this.handleError(e.message||"Failed to answer call"),!1}}rejectCall(){this.currentCall&&(console.log("❌ REJECTING CALL"),f.send({type:"call_reject",data:{call_id:this.currentCall.callId,reason:"rejected"},timestamp:new Date().toISOString()}),this.cleanup())}endCall(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];this.currentCall&&(console.log("\uD83D\uDCF4 ENDING CALL"),e&&f.send({type:"call_end",data:{call_id:this.currentCall.callId},timestamp:new Date().toISOString()}),this.cleanup())}setupPeerConnectionHandlers(){this.peerConnection&&(this.peerConnection.ontrack=e=>{console.log("\uD83C\uDFA5 Remote track received:",e.track.kind);let[t]=e.streams;if(t){var a;this.remoteStream=t,console.log("✅ Remote stream set"),null===(a=this.onRemoteStream)||void 0===a||a.call(this,this.remoteStream)}},this.peerConnection.onicecandidate=e=>{e.candidate&&this.currentCall&&(console.log("\uD83E\uDDCA Sending ICE candidate"),f.send({type:"ice_candidate",data:{call_id:this.currentCall.callId,candidate:e.candidate.toJSON()},timestamp:new Date().toISOString()}))},this.peerConnection.onconnectionstatechange=()=>{var e;let t=null===(e=this.peerConnection)||void 0===e?void 0:e.connectionState;if(console.log("\uD83D\uDD04 Connection state changed:",t),this.currentCall)switch(t){case"connected":"connecting"===this.currentCall.status&&(this.currentCall.status="connected",this.currentCall.startTime=new Date,this.notifyStateChange(),console.log("\uD83D\uDCDE State: CONNECTING → CONNECTED ✅"),this.startConnectionMonitor());break;case"failed":console.error("❌ Connection failed"),this.handleError("Connection failed");break;case"disconnected":console.warn("⚠️ Connection disconnected"),setTimeout(()=>{var e;(null===(e=this.peerConnection)||void 0===e?void 0:e.connectionState)==="disconnected"&&this.handleError("Connection lost")},5e3);break;case"closed":console.log("\uD83D\uDCF4 Connection closed")}},this.peerConnection.oniceconnectionstatechange=()=>{var e;console.log("\uD83E\uDDCA ICE connection state:",null===(e=this.peerConnection)||void 0===e?void 0:e.iceConnectionState)},this.peerConnection.onsignalingstatechange=()=>{var e;console.log("\uD83D\uDCF6 Signaling state:",null===(e=this.peerConnection)||void 0===e?void 0:e.signalingState)})}startConnectionMonitor(){this.connectionMonitorInterval&&clearInterval(this.connectionMonitorInterval),this.connectionMonitorInterval=setInterval(()=>{if(!this.peerConnection||!this.currentCall){this.stopConnectionMonitor();return}let e=this.peerConnection.connectionState;("failed"===e||"closed"===e)&&(console.error("Connection unhealthy, ending call"),this.handleError("Connection lost"),this.stopConnectionMonitor())},2e3)}stopConnectionMonitor(){this.connectionMonitorInterval&&(clearInterval(this.connectionMonitorInterval),this.connectionMonitorInterval=null)}handleMediaError(e){let t="Failed to access camera/microphone";switch(e.name){case"NotAllowedError":t="Camera/microphone permission denied. Please allow access in your browser settings.";break;case"NotFoundError":t="No camera or microphone found. Please connect a device.";break;case"NotReadableError":t="Camera/microphone is in use by another application. Please close other apps.";break;case"OverconstrainedError":t="Camera does not support the requested resolution.";break;case"SecurityError":t="Camera/microphone access is blocked. Please use HTTPS or localhost."}return Error(t)}handleError(e){console.error("Call error:",e),this.currentCall&&(this.currentCall.status="failed",this.currentCall.errorMessage=e,this.notifyStateChange()),this.cleanup()}cleanup(){console.log("\uD83E\uDDF9 Cleaning up..."),this.stopConnectionMonitor(),this.localStream&&(this.localStream.getTracks().forEach(e=>{e.stop(),console.log("Stopped ".concat(e.kind," track"))}),this.localStream=null),this.remoteStream&&(this.remoteStream.getTracks().forEach(e=>e.stop()),this.remoteStream=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.currentCall&&("failed"!==this.currentCall.status&&(this.currentCall.status="ended"),this.notifyStateChange()),this.currentCall=null,this.pendingIceCandidates=[],this.pendingSdp=null,console.log("\uD83E\uDDF9 Cleanup complete")}toggleMute(){if(!this.localStream)return!1;let e=this.localStream.getAudioTracks()[0];if(e){e.enabled=!e.enabled;let t=!e.enabled;return this.currentCall&&(this.currentCall.isMuted=t,this.notifyStateChange()),console.log("\uD83C\uDFA4 Audio ".concat(t?"muted":"unmuted")),t}return!1}toggleVideo(){if(!this.localStream)return!1;let e=this.localStream.getVideoTracks()[0];if(e){e.enabled=!e.enabled;let t=!e.enabled;return this.currentCall&&(this.currentCall.isVideoOff=t,this.notifyStateChange()),console.log("\uD83D\uDCF9 Video ".concat(t?"off":"on")),t}return!1}getCurrentCall(){return this.currentCall?{...this.currentCall}:null}isInCall(){return null!==this.currentCall&&["calling","ringing","connecting","connected"].includes(this.currentCall.status)}async replaceVideoTrack(e){if(!this.peerConnection)return!1;let t=this.peerConnection.getSenders().find(e=>{var t;return(null===(t=e.track)||void 0===t?void 0:t.kind)==="video"});if(t)try{if(await t.replaceTrack(e),this.localStream){var a;let t=this.localStream.getVideoTracks()[0];t&&(this.localStream.removeTrack(t),t.stop()),this.localStream.addTrack(e),this.currentCall&&(this.currentCall.localStream=this.localStream,this.notifyStateChange()),null===(a=this.onLocalStream)||void 0===a||a.call(this,this.localStream)}return!0}catch(e){console.error("Error replacing video track:",e)}return!1}async checkPermissions(e){let t={audio:!1,video:!1};try{let a=await navigator.permissions.query({name:"microphone"});if(t.audio="granted"===a.state,"video"===e){let e=await navigator.permissions.query({name:"camera"});t.video="granted"===e.state}}catch(e){console.log("Permissions API not supported")}return t}constructor(e=er){this.peerConnection=null,this.localStream=null,this.remoteStream=null,this.currentCall=null,this.onCallStateChange=null,this.onRemoteStream=null,this.onLocalStream=null,this.pendingIceCandidates=[],this.pendingSdp=null,this.connectionMonitorInterval=null,this.config=e,this.setupWebSocketHandlers()}}let ei=new en;var el=a(612),eo=a(1841),ec=a(5099),ed=a(7803),eu=a(5671),em=a(8339),eh=a(2741),eg=a(4043),ep=a(9292);function ey(e){let{callState:t,callDuration:a,isMuted:n,isVideoOff:i,isScreenSharing:l,isFullscreen:o,onToggleMute:c,onToggleVideo:d,onToggleScreenShare:u,onToggleFullscreen:m,onEndCall:h,onRejectCall:g,onAnswerCall:p}=e,{getAccentGradient:y}=(0,N.MU)(),x=y(),v=(0,r.useRef)(null),b=(0,r.useRef)(null),f=(0,r.useRef)(null),[w,j]=(0,r.useState)({width:0,height:0});(0,r.useEffect)(()=>{let e=()=>{j({width:window.innerWidth,height:window.innerHeight})};return e(),window.addEventListener("resize",e),window.addEventListener("orientationchange",e),()=>{window.removeEventListener("resize",e),window.removeEventListener("orientationchange",e)}},[]),(0,r.useEffect)(()=>{t.localStream&&v.current&&(v.current.srcObject=t.localStream),t.remoteStream&&(b.current&&(b.current.srcObject=t.remoteStream),f.current&&(f.current.srcObject=t.remoteStream))},[t.localStream,t.remoteStream]);let k=e=>"".concat(Math.floor(e/60),":").concat((e%60).toString().padStart(2,"0")),_="video"===t.type,C=t.remoteStream&&t.remoteStream.getVideoTracks().length>0,S=w.width<768,D=_&&C&&"connected"===t.status,E=_&&"ringing"!==t.status;return(0,s.jsxs)("div",{className:"fixed inset-0 w-screen h-screen bg-black z-[9999] overflow-hidden flex flex-col",style:{position:"fixed",top:0,left:0,right:0,bottom:0},children:[(0,s.jsx)("audio",{ref:f,autoPlay:!0,playsInline:!0}),(0,s.jsx)("video",{ref:b,autoPlay:!0,playsInline:!0,muted:!0,className:"absolute inset-0 w-full h-full object-cover ".concat(D?"opacity-100":"opacity-0 pointer-events-none")}),!D&&(0,s.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-gradient-to-b from-gray-900 to-black z-10",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)(R.E.div,{className:"w-32 h-32 md:w-48 md:h-48 rounded-full flex items-center justify-center mx-auto mb-6",style:{background:x},animate:"calling"===t.status||"ringing"===t.status?{scale:[1,1.05,1]}:{},transition:{duration:2,repeat:1/0},children:(0,s.jsx)("span",{className:"text-5xl md:text-7xl text-white font-bold",children:t.remoteUsername.charAt(0).toUpperCase()})}),(0,s.jsx)("h2",{className:"text-2xl md:text-3xl font-bold text-white mb-2",children:t.remoteUsername}),(0,s.jsxs)("p",{className:"text-gray-400 text-lg",children:["calling"===t.status&&"Calling...","ringing"===t.status&&(t.isIncoming?"Incoming call...":"Ringing..."),"connecting"===t.status&&"Connecting...","connected"===t.status&&(0,s.jsxs)("span",{className:"flex items-center justify-center gap-2",children:[(0,s.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),k(a)]})]})]})}),(0,s.jsxs)("div",{className:"absolute top-0 left-0 right-0 z-50 p-4 md:p-6 flex items-center justify-between bg-gradient-to-b from-black/80 to-transparent",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center",style:{background:x},children:(0,s.jsx)("span",{className:"text-white font-bold text-lg",children:t.remoteUsername.charAt(0).toUpperCase()})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-white font-medium text-lg",children:t.remoteUsername}),"connected"===t.status&&(0,s.jsx)("span",{className:"text-green-400 text-sm",children:k(a)}),l&&(0,s.jsxs)("span",{className:"text-blue-400 text-sm flex items-center gap-1 ml-2",children:[(0,s.jsx)(el.Z,{className:"w-3 h-3"})," Presenting"]})]})]}),"connected"===t.status&&(0,s.jsx)("button",{onClick:m,className:"p-2 md:p-3 bg-white/10 hover:bg-white/20 rounded-full text-white transition-colors",children:o?(0,s.jsx)(eo.Z,{className:"w-5 h-5"}):(0,s.jsx)(ec.Z,{className:"w-5 h-5"})})]}),E&&(0,s.jsxs)(R.E.div,{className:"\n            absolute z-40 rounded-xl overflow-hidden shadow-2xl border-2 border-white/20\n            ".concat(S?"bottom-28 right-4 w-28 h-36":"bottom-32 right-6 w-48 h-36 md:w-64 md:h-48","\n          "),initial:{x:100,opacity:0},animate:{x:0,opacity:1},transition:{delay:.3},children:[i?(0,s.jsx)("div",{className:"w-full h-full flex items-center justify-center bg-gray-800",children:(0,s.jsx)("div",{className:"w-16 h-16 rounded-full flex items-center justify-center",style:{background:x},children:(0,s.jsx)("span",{className:"text-2xl text-white font-bold",children:"You"})})}):(0,s.jsx)("video",{ref:v,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"}),n&&(0,s.jsx)("div",{className:"absolute bottom-2 right-2 p-1.5 bg-red-500 rounded-full",children:(0,s.jsx)(ed.Z,{className:"w-3 h-3 text-white"})})]}),(0,s.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 z-50 p-4 md:p-8 bg-gradient-to-t from-black/90 via-black/50 to-transparent",children:[(0,s.jsxs)("div",{className:"flex items-center justify-center gap-3 md:gap-4",children:["ringing"===t.status&&t.isIncoming&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(R.E.button,{onClick:g,className:"p-4 md:p-5 bg-red-500 rounded-full hover:bg-red-600 transition-all shadow-lg",whileHover:{scale:1.1},whileTap:{scale:.95},children:(0,s.jsx)(eu.Z,{className:"w-7 h-7 md:w-8 md:h-8 text-white"})}),(0,s.jsx)(R.E.button,{onClick:p,className:"p-4 md:p-5 bg-green-500 rounded-full hover:bg-green-600 transition-all shadow-lg",whileHover:{scale:1.1},whileTap:{scale:.95},animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0},children:_?(0,s.jsx)(em.Z,{className:"w-7 h-7 md:w-8 md:h-8 text-white"}):(0,s.jsx)(eh.Z,{className:"w-7 h-7 md:w-8 md:h-8 text-white"})})]}),("calling"===t.status||"connecting"===t.status||"connected"===t.status)&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(R.E.button,{onClick:c,className:"\n                  p-4 md:p-5 rounded-full transition-all shadow-lg\n                  ".concat(n?"bg-red-500 hover:bg-red-600":"bg-gray-700 hover:bg-gray-600","\n                "),whileHover:{scale:1.1},whileTap:{scale:.95},children:n?(0,s.jsx)(ed.Z,{className:"w-6 h-6 md:w-7 md:h-7 text-white"}):(0,s.jsx)(eg.Z,{className:"w-6 h-6 md:w-7 md:h-7 text-white"})}),_&&(0,s.jsx)(R.E.button,{onClick:d,className:"\n                    p-4 md:p-5 rounded-full transition-all shadow-lg\n                    ".concat(i?"bg-red-500 hover:bg-red-600":"bg-gray-700 hover:bg-gray-600","\n                  "),whileHover:{scale:1.1},whileTap:{scale:.95},children:i?(0,s.jsx)(ep.Z,{className:"w-6 h-6 md:w-7 md:h-7 text-white"}):(0,s.jsx)(em.Z,{className:"w-6 h-6 md:w-7 md:h-7 text-white"})}),_&&"connected"===t.status&&(0,s.jsx)(R.E.button,{onClick:u,className:"\n                    p-4 md:p-5 rounded-full transition-all shadow-lg\n                    ".concat(l?"bg-blue-500 hover:bg-blue-600":"bg-gray-700 hover:bg-gray-600","\n                  "),whileHover:{scale:1.1},whileTap:{scale:.95},children:(0,s.jsx)(el.Z,{className:"w-6 h-6 md:w-7 md:h-7 text-white"})}),(0,s.jsx)(R.E.button,{onClick:h,className:"p-4 md:p-5 bg-red-500 rounded-full hover:bg-red-600 transition-all shadow-lg px-6 md:px-8",whileHover:{scale:1.05},whileTap:{scale:.95},children:(0,s.jsx)(eu.Z,{className:"w-6 h-6 md:w-7 md:h-7 text-white"})})]})]}),(0,s.jsxs)("p",{className:"text-center text-gray-400 text-sm mt-4",children:["connecting"===t.status&&"Establishing secure connection...","calling"===t.status&&"Waiting for answer..."]})]})]})}var ex=a(2442),ev=a(690),eb=a(1981),ef=a(6141),ew=a(1138),ej=a(5817),eN=a(6637),ek=a(3067),e_=a(4056),eC=a(290),eS=a(3714),eD=a(8438),eE=a(8734),eI=a(6489),eM=a(6020),eK=a(7870);function eP(e){return e?new Date(e.endsWith("Z")||/[+-]\d{2}:\d{2}$/.test(e)||/[+-]\d{4}$/.test(e)?e:e+"Z"):new Date}function eT(e){let{children:t,isSent:a,isNew:r=!1,index:n=0}=e;return(0,s.jsxs)(R.E.div,{initial:a?{scale:.8,opacity:0,y:20,rotateY:5}:{scale:.9,opacity:0,y:20,z:-30},animate:{scale:1,opacity:1,y:0,rotateY:0,z:0},transition:{type:"spring",stiffness:400,damping:25,delay:.03*n},style:{transformStyle:"preserve-3d",perspective:1e3},children:[a&&r&&(0,s.jsx)(R.E.div,{className:"absolute inset-0 rounded-2xl pointer-events-none",initial:{boxShadow:"0 0 0 0 rgba(var(--accent-rgb), 0.4)"},animate:{boxShadow:["0 0 0 0 rgba(var(--accent-rgb), 0.4)","0 0 20px 5px rgba(var(--accent-rgb), 0.2)","0 0 0 0 rgba(var(--accent-rgb), 0)"]},transition:{duration:1.5}}),t]})}function eF(){let{user:e,currentConversation:t,messages:a,contacts:n,conversations:i,privateKey:l,sendMessage:o,onlineUsers:d,typingUsers:u,setCurrentConversation:m,loadCallHistory:p,callHistory:y,deleteMessageForMe:x,deleteMessageForEveryone:v,clearChat:b,deleteConversationForEveryone:w}=E(),{getAccentGradient:j,getAccentColors:k,getDensityClasses:_,getFontClasses:C,settings:S}=(0,N.MU)(),D=j(),I=k(),M=_(),P=C(),[T,F]=(0,r.useState)(""),[O,Z]=(0,r.useState)(!1),[A,H]=(0,r.useState)(!1),[U,z]=(0,r.useState)(null),[B,G]=(0,r.useState)(null),[V,J]=(0,r.useState)(!1),[Y,q]=(0,r.useState)(!1),[$,ee]=(0,r.useState)(!1),[ea,es]=(0,r.useState)(!1),[er,en]=(0,r.useState)(0),[el,eo]=(0,r.useState)(!1),[ec,ed]=(0,r.useState)(!1),[eg,ep]=(0,r.useState)(!1),[eF,eO]=(0,r.useState)(null),[eZ,eA]=(0,r.useState)(new Set),[eH,eU]=(0,r.useState)(null),[eR,eL]=(0,r.useState)(!1),[eW,ez]=(0,r.useState)(null),eB=(0,r.useRef)(null),eG=(0,r.useRef)(null),eV=(0,r.useRef)(null),eJ=n.find(e=>e.contact_username===t),eY=i.find(e=>e.username===t),eq=(null==eJ?void 0:eJ.contact_id)||(null==eY?void 0:eY.user_id),eQ=(null==eJ?void 0:eJ.public_key)||(null==eY?void 0:eY.public_key),eX=!!eq&&d.has(eq),e$=!!t&&u.get(t),e0=t&&a.get(t)||[],e1=(y||[]).filter(e=>e.caller_username===t||e.receiver_username===t),e2=[...e0.map(e=>({type:"message",data:e,date:eP(e.created_at)})),...e1.map(e=>({type:"call",data:e,date:eP(e.start_time)}))].sort((e,t)=>e.date.getTime()-t.date.getTime());(0,r.useEffect)(()=>{p()},[p]),(0,r.useEffect)(()=>{(async function(){if(t&&!eQ)try{let e=await c.getPublicKey(t);(null==e?void 0:e.public_key)&&eO(e.public_key)}catch(e){console.error("Failed to fetch public key:",e)}else eQ&&eO(eQ)})()},[t,eQ]),(0,r.useEffect)(()=>{var e;null===(e=eB.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[e0]),(0,r.useEffect)(()=>{if(t&&T){f.sendTypingIndicator(t,!0);let e=setTimeout(()=>{f.sendTypingIndicator(t,!1)},2e3);return()=>clearTimeout(e)}},[T,t]),(0,r.useEffect)(()=>(ei.setOnCallStateChange(e=>{G(e)}),()=>{ei.setOnCallStateChange(null)}),[]),(0,r.useEffect)(()=>{B&&(void 0!==B.isMuted&&J(B.isMuted),void 0!==B.isVideoOff&&q(B.isVideoOff))},[null==B?void 0:B.isMuted,null==B?void 0:B.isVideoOff]),(0,r.useEffect)(()=>{let e=null;return(null==B?void 0:B.status)==="connected"&&B.startTime?e=setInterval(()=>{let e=new Date,t=new Date(B.startTime);en(Math.floor((e.getTime()-t.getTime())/1e3))},1e3):en(0),()=>{e&&clearInterval(e)}},[null==B?void 0:B.status,null==B?void 0:B.startTime]),(0,r.useEffect)(()=>{B&&"ended"!==B.status&&"failed"!==B.status||(J(!1),q(!1),ee(!1))},[null==B?void 0:B.status]),(0,r.useEffect)(()=>{let e=()=>eL(!1);return eR&&document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[eR]);let e5=async()=>{if($)try{let e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});ei.replaceVideoTrack(e.getVideoTracks()[0]),ee(!1)}catch(e){console.error("Error stopping screen share:",e)}else try{let e=await navigator.mediaDevices.getDisplayMedia({video:!0});ei.replaceVideoTrack(e.getVideoTracks()[0]),ee(!0),e.getVideoTracks()[0].onended=()=>{ee(!1),navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{ei.replaceVideoTrack(e.getVideoTracks()[0])})}}catch(e){console.error("Error starting screen share:",e)}},e4=async()=>{if(T.trim()&&t&&!O){Z(!0);try{var e;let a=Date.now();eA(e=>new Set(e).add(a)),await o(t,T),F(""),null===(e=eG.current)||void 0===e||e.focus(),setTimeout(()=>{eA(e=>{let t=new Set(e);return t.delete(a),t})},1e3)}catch(e){console.error("Failed to send message:",e)}finally{Z(!1)}}},e3=async e=>{t&&(await ei.startCall(t,e)||console.error("Failed to start call"))},e6=async()=>{try{await ei.answerCall()}catch(e){console.error("Error answering call:",e)}},e8=()=>{ei.rejectCall(),G(null)},e9=async e=>{let a=e.target.files;if(!a||0===a.length||!t)return;let s=a[0];ed(!1),Z(!0);try{let e=new FileReader;e.onload=async()=>{let a=e.result,r={name:s.name,type:s.type,size:s.size};await o(t,a,s.type.startsWith("image/")?"image":"file",r)},e.readAsDataURL(s)}catch(e){console.error("Failed to send file:",e)}finally{Z(!1),eV.current&&(eV.current.value="")}},e7=(0,r.useCallback)(t=>{if(t._decryptedContent)return t._decryptedContent;if(!l)return"[Encrypted]";try{let a;let s=JSON.parse(t.encrypted_content);if(t.sender_username===(null==e?void 0:e.username)){if(a=(null==eJ?void 0:eJ.public_key)||(null==eY?void 0:eY.public_key)||eF||void 0,!s.senderPublicKey&&!a)return"[Sent message]"}else if(a=(null==eJ?void 0:eJ.public_key)||(null==eY?void 0:eY.public_key)||eF||void 0,!s.senderPublicKey&&!a)return"[Key not available]";let r=h(s,a||"",l);if(!r){if(t.sender_username===(null==e?void 0:e.username))return"[Sent message]";return"[Decryption failed]"}return r}catch(e){return console.error("Decryption error:",e),"[Encrypted message]"}},[l,e,eJ,eY,eF]),te=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"download";try{let a=document.createElement("a");a.href=e,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a)}catch(e){console.error("Download failed:",e)}},tt=e=>{switch(e.status){case"sent":return(0,s.jsx)(ex.Z,{className:"w-4 h-4 text-gray-400"});case"delivered":return(0,s.jsx)(ev.Z,{className:"w-4 h-4 text-gray-400"});case"read":return(0,s.jsx)(ev.Z,{className:"w-4 h-4",style:{color:I.primary}});case"sending":return(0,s.jsx)(X.Z,{className:"w-4 h-4 text-gray-500 animate-spin"});case"failed":return(0,s.jsx)(eb.Z,{className:"w-4 h-4 text-red-500"});default:return(0,s.jsx)(ef.Z,{className:"w-4 h-4 text-gray-500"})}},ta=e=>{if("deleted"===e.message_type)return(0,s.jsxs)("p",{className:"italic text-gray-400/70",children:[(0,s.jsx)(ew.Z,{className:"w-3 h-3 inline mr-1"}),"This message was deleted"]});let t=e7(e);if("image"===e.message_type&&t.startsWith("data:image"))return(0,s.jsxs)("div",{className:"relative group",children:[(0,s.jsx)("img",{src:t,alt:"Shared image",className:"max-w-full rounded-lg max-h-64 object-cover cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>z(t)}),(0,s.jsx)("button",{onClick:()=>te(t,"image_".concat(e.id,".png")),className:"absolute top-2 right-2 p-1.5 bg-black/50 hover:bg-black/70 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity",title:"Download Image",children:(0,s.jsx)(ej.Z,{className:"w-4 h-4"})})]});if("file"===e.message_type||"image"===e.message_type&&!t.startsWith("data:image")){var a,r,n;return(0,s.jsx)("div",{className:"flex flex-col gap-2 p-1",children:(0,s.jsxs)("div",{className:"flex items-center gap-3 bg-cipher-dark/40 p-3 rounded-xl border border-white/5",children:[(0,s.jsx)("div",{className:"w-10 h-10 bg-cipher-primary/20 rounded-lg flex items-center justify-center text-cipher-primary",children:(0,s.jsx)(eN.Z,{className:"w-6 h-6"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"text-sm font-medium truncate text-white",children:(null===(a=e.file_metadata)||void 0===a?void 0:a.name)||"document_".concat(e.id)}),(0,s.jsx)("p",{className:"text-xs text-gray-500 uppercase",children:(null===(n=e.file_metadata)||void 0===n?void 0:null===(r=n.type)||void 0===r?void 0:r.split("/")[1])||"FILE"})]}),(0,s.jsx)("button",{onClick:()=>{var a;return te(t,(null===(a=e.file_metadata)||void 0===a?void 0:a.name)||"document")},className:"p-2 hover:bg-white/10 rounded-full text-cipher-primary transition-colors",title:"Download File",children:(0,s.jsx)(ej.Z,{className:"w-5 h-5"})})]})})}return(0,s.jsx)("p",{className:"break-words",children:t})},ts=(e,t,a)=>{e.preventDefault(),eU({visible:!0,x:e.clientX,y:e.clientY,messageId:t,isMine:a})},tr=async e=>{eH&&t&&(e?ez({visible:!0,type:"message",messageId:eH.messageId,deleteForEveryone:!0}):await x(eH.messageId,t),eU(null))},tn=async()=>{if(eW&&t){try{"message"===eW.type&&eW.messageId?eW.deleteForEveryone?await v(eW.messageId,t):await x(eW.messageId,t):"chat"===eW.type?await b(t):"conversation"===eW.type&&await w(t)}catch(e){console.error("Deletion failed:",e)}ez(null)}};return t?B&&"failed"===B.status?(0,s.jsx)("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50",children:(0,s.jsxs)(R.E.div,{className:"text-center max-w-md p-6",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},children:[(0,s.jsx)("div",{className:"w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,s.jsx)(eb.Z,{className:"w-10 h-10 text-red-500"})}),(0,s.jsx)("h2",{className:"text-xl font-bold text-white mb-2",children:"Call Failed"}),(0,s.jsx)("p",{className:"text-gray-400 mb-6",children:B.errorMessage||"Unable to connect the call. Please try again."}),(0,s.jsx)("button",{onClick:()=>{ei.endCall(!1),G(null)},className:"px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors",children:"Dismiss"})]})}):B&&"rejected"===B.status?(0,s.jsx)("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50",children:(0,s.jsxs)(R.E.div,{className:"text-center max-w-md p-6",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},children:[(0,s.jsx)("div",{className:"w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,s.jsx)(eu.Z,{className:"w-10 h-10 text-red-500"})}),(0,s.jsx)("h2",{className:"text-xl font-bold text-white mb-2",children:"Call Declined"}),(0,s.jsxs)("p",{className:"text-gray-400 mb-6",children:[B.remoteUsername," declined your call."]}),(0,s.jsx)("button",{onClick:()=>{G(null)},className:"px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors",children:"Close"})]})}):B&&["calling","ringing","connecting","connected"].includes(B.status)?(0,s.jsx)(ey,{callState:B,callDuration:er,isMuted:V,isVideoOff:Y,isScreenSharing:$,isFullscreen:ea,onToggleMute:()=>{J(ei.toggleMute())},onToggleVideo:()=>{q(ei.toggleVideo())},onToggleScreenShare:e5,onToggleFullscreen:()=>{document.fullscreenElement?(document.exitFullscreen(),es(!1)):(document.documentElement.requestFullscreen(),es(!0))},onEndCall:()=>{ei.endCall(),G(null)},onRejectCall:e8,onAnswerCall:e6}):(0,s.jsxs)("div",{className:"flex-1 flex flex-col h-full",children:[(0,s.jsxs)(R.E.div,{className:"h-16 px-4 border-b border-gray-800 flex items-center justify-between bg-cipher-dark/50",initial:{y:-20,opacity:0},animate:{y:0,opacity:1},transition:{duration:.3},children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)(R.E.button,{onClick:()=>m(null),className:"lg:hidden p-2 -ml-2 hover:bg-gray-700 rounded-lg text-gray-400",whileHover:{x:-2},whileTap:{scale:.95},children:(0,s.jsx)(ek.Z,{className:"w-5 h-5"})}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(R.E.div,{className:"w-10 h-10 rounded-full flex items-center justify-center cursor-pointer",style:{background:D},whileHover:{scale:1.1,rotate:5},whileTap:{scale:.95},children:(0,s.jsx)("span",{className:"text-white font-medium",children:t.charAt(0).toUpperCase()})}),eX&&(0,s.jsx)(R.E.div,{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-cipher-dark",animate:{scale:[1,1.2,1]},transition:{duration:2,repeat:1/0}})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"font-medium text-white",children:t}),(0,s.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[e$?(0,s.jsx)("span",{className:"text-cipher-primary",children:"typing..."}):eX?(0,s.jsx)("span",{className:"text-green-500",children:"Online"}):(0,s.jsx)("span",{className:"text-gray-500",children:"Offline"}),(0,s.jsx)("span",{className:"text-gray-600",children:"•"}),(0,s.jsxs)("div",{className:"flex items-center gap-1 text-gray-500",children:[(0,s.jsx)(W.EncryptionLock,{size:"sm",isEncrypting:!1}),(0,s.jsx)("span",{children:"Encrypted"})]})]})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)(R.E.button,{onClick:()=>e3("audio"),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Voice Call",whileHover:{scale:1.1},whileTap:{scale:.9},children:(0,s.jsx)(eh.Z,{className:"w-5 h-5"})}),(0,s.jsx)(R.E.button,{onClick:()=>e3("video"),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Video Call",whileHover:{scale:1.1},whileTap:{scale:.9},children:(0,s.jsx)(em.Z,{className:"w-5 h-5"})}),(0,s.jsx)(R.E.button,{onClick:()=>H(!A),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",whileHover:{scale:1.1,rotate:15},whileTap:{scale:.9},children:(0,s.jsx)(e_.Z,{className:"w-5 h-5"})}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(R.E.button,{onClick:()=>eL(!eR),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",title:"Chat Options",whileHover:{scale:1.1},whileTap:{scale:.9},children:(0,s.jsx)(eC.Z,{className:"w-5 h-5"})}),eR&&(0,s.jsxs)(R.E.div,{className:"absolute right-0 top-full mt-1 bg-cipher-dark border border-gray-700 rounded-lg shadow-xl py-1 min-w-[180px] z-50",initial:{opacity:0,y:-10,scale:.95},animate:{opacity:1,y:0,scale:1},children:[(0,s.jsxs)("button",{onClick:()=>{ez({visible:!0,type:"chat"}),eL(!1)},className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-gray-700/50 transition-colors",children:[(0,s.jsx)(ew.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"Clear chat"})]}),(0,s.jsxs)("button",{onClick:()=>{ez({visible:!0,type:"conversation"}),eL(!1)},className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-400 hover:bg-red-500/10 transition-colors",children:[(0,s.jsx)(ew.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"Delete for everyone"})]})]})]})]})]}),(0,s.jsxs)(R.E.div,{className:"px-4 py-2 bg-cipher-primary/10 border-b border-cipher-primary/20 flex items-center justify-center gap-2 text-xs text-cipher-primary",initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},children:[(0,s.jsx)(W.EncryptionLock,{size:"sm",isEncrypting:!1}),(0,s.jsx)("span",{children:"Messages are end-to-end encrypted. No one outside this chat can read them."})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 ".concat(M.messageGap),children:[0===e2.length?(0,s.jsx)(R.E.div,{className:"h-full flex items-center justify-center",initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:.3},children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)(R.E.div,{className:"w-16 h-16 bg-cipher-primary/20 rounded-full flex items-center justify-center mx-auto mb-4",animate:{rotate:[0,10,-10,0]},transition:{duration:4,repeat:1/0},children:(0,s.jsx)(K.Z,{className:"w-8 h-8 text-cipher-primary"})}),(0,s.jsx)("p",{className:"text-gray-400 text-sm",children:"Send a message or start a call to begin"}),((null==eJ?void 0:eJ.public_key)||eF)&&(0,s.jsxs)("div",{className:"mt-4 p-3 bg-cipher-dark rounded-lg",children:[(0,s.jsx)("p",{className:"text-xs text-gray-500 mb-1",children:"Key fingerprint"}),(0,s.jsx)("p",{className:"text-xs font-mono text-gray-400",children:g((null==eJ?void 0:eJ.public_key)||eF||"")})]})]})}):(0,s.jsxs)(s.Fragment,{children:[e2.map((t,a)=>{var r,n,i;let l=0===a||(0,et.WU)(t.date,"yyyy-MM-dd")!==(0,et.WU)(e2[a-1].date,"yyyy-MM-dd");if("call"===t.type){let a=t.data,r=a.caller_username===(null==e?void 0:e.username),n="video"===a.call_type?em.Z:eh.Z;return(0,s.jsxs)("div",{children:[l&&(0,s.jsx)(R.E.div,{className:"flex justify-center my-4",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},children:(0,s.jsx)("span",{className:"bg-cipher-dark px-3 py-1 rounded-full text-xs text-gray-500",children:(0,et.WU)(t.date,"MMMM d, yyyy")})}),(0,s.jsx)(R.E.div,{className:"flex justify-center my-4",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},children:(0,s.jsxs)("div",{className:"bg-gray-800/40 backdrop-blur-sm border border-gray-700/50 px-4 py-2 rounded-2xl flex items-center gap-3",children:[(0,s.jsx)("div",{className:"p-2 rounded-full ".concat("missed"===a.status?"bg-red-500/20 text-red-500":"bg-cipher-primary/20 text-cipher-primary"),children:(0,s.jsx)(n,{className:"w-4 h-4"})}),(0,s.jsxs)("div",{className:"text-left",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-200",children:"completed"===a.status?r?"Outgoing call":"Incoming call":"missed"===a.status?r?"No answer":"Missed call":"rejected"===a.status?r?"Call declined":"Declined call":"Call failed"}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:"completed"===a.status&&a.duration_seconds>0?"".concat(Math.floor(a.duration_seconds/60),"m ").concat(a.duration_seconds%60,"s"):(0,et.WU)(t.date,"HH:mm")})]})]})})]},"call-".concat(a.id))}let o=t.data,c=o.sender_username===(null==e?void 0:e.username),d="deleted"===o.message_type,u=eZ.has(o.id),m=!c&&(null===(r=o.sender_theme)||void 0===r?void 0:r.accentGradient);return(0,s.jsxs)("div",{className:M.messagePadding,children:[l&&(0,s.jsx)(R.E.div,{className:"flex justify-center my-4",initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},children:(0,s.jsx)("span",{className:"bg-cipher-dark dark:bg-gray-800 px-3 py-1 rounded-full ".concat(P.xs," text-gray-500"),children:(0,et.WU)(t.date,"MMMM d, yyyy")})}),(0,s.jsx)("div",{className:"flex ".concat(c?"justify-end":"justify-start"," message-bubble group"),children:(0,s.jsx)(eT,{isSent:c,isNew:u,index:a,children:(0,s.jsxs)("div",{className:"\n                          relative max-w-[85%] ".concat(M.bubblePadding," rounded-2xl ").concat(P.base,"\n                          ").concat(c?"text-white rounded-br-md":m?"text-white rounded-bl-md":"bg-gray-800 dark:bg-gray-800 text-white dark:text-white rounded-bl-md","\n                          ").concat(d?"":"cursor-pointer","\n                          ").concat((null===(n=o.sender_theme)||void 0===n?void 0:n.style)==="glass"?"backdrop-blur-md border border-white/10":"","\n                          ").concat((null===(i=o.sender_theme)||void 0===i?void 0:i.style)==="neon"?"shadow-lg shadow-[var(--accent-color)]/30":"","\n                        "),style:(()=>{var e;if(!d){if(c)return{background:D};if(null===(e=o.sender_theme)||void 0===e?void 0:e.accentGradient)return{background:o.sender_theme.accentGradient}}})(),onContextMenu:e=>!d&&ts(e,o.id,c),children:[ta(o),(0,s.jsxs)("div",{className:"flex items-center gap-1 mt-1 ".concat(c?"justify-end":""),children:[(0,s.jsx)("span",{className:"".concat(P.xs," opacity-60"),children:(0,et.WU)(t.date,"HH:mm")}),!d&&(0,s.jsx)(R.E.button,{onClick:e=>{e.stopPropagation(),ts(e,o.id,c)},className:"opacity-0 group-hover:opacity-100 p-0.5 text-gray-400 hover:text-red-400 transition-opacity",title:"Delete",whileHover:{scale:1.2},whileTap:{scale:.9},children:(0,s.jsx)(ew.Z,{className:"w-3 h-3"})}),c&&tt(o)]})]})})})]},"msg-".concat(o.id))}),e$&&(0,s.jsx)(R.E.div,{className:"flex justify-start",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:(0,s.jsx)("div",{className:"bg-gray-800 px-4 py-3 rounded-2xl rounded-bl-md",children:(0,s.jsxs)("div",{className:"flex gap-1",children:[(0,s.jsx)(R.E.div,{className:"w-2 h-2 bg-gray-500 rounded-full",animate:{y:[0,-5,0]},transition:{duration:.5,repeat:1/0,delay:0}}),(0,s.jsx)(R.E.div,{className:"w-2 h-2 bg-gray-500 rounded-full",animate:{y:[0,-5,0]},transition:{duration:.5,repeat:1/0,delay:.15}}),(0,s.jsx)(R.E.div,{className:"w-2 h-2 bg-gray-500 rounded-full",animate:{y:[0,-5,0]},transition:{duration:.5,repeat:1/0,delay:.3}})]})})})]}),(0,s.jsx)("div",{ref:eB})]}),(0,s.jsx)(R.E.div,{className:"p-4 border-t border-gray-800 bg-cipher-dark/50",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},children:(0,s.jsxs)("div",{className:"flex items-end gap-3",children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(R.E.button,{onClick:()=>ed(!ec),className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white",whileHover:{scale:1.1,rotate:-10},whileTap:{scale:.9},children:(0,s.jsx)(eS.Z,{className:"w-5 h-5"})}),(0,s.jsx)(L.M,{children:ec&&(0,s.jsxs)(R.E.div,{className:"absolute bottom-12 left-0 bg-cipher-dark border border-gray-700 rounded-lg shadow-lg p-2 min-w-[150px]",initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},children:[(0,s.jsxs)("button",{onClick:()=>{var e;return null===(e=eV.current)||void 0===e?void 0:e.click()},className:"w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-700 rounded text-gray-300 text-sm",children:[(0,s.jsx)(eD.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"Photo"})]}),(0,s.jsxs)("button",{onClick:()=>{var e;return null===(e=eV.current)||void 0===e?void 0:e.click()},className:"w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-700 rounded text-gray-300 text-sm",children:[(0,s.jsx)(eE.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"Document"})]})]})}),(0,s.jsx)("input",{ref:eV,type:"file",className:"hidden",accept:"image/*,video/*,.pdf,.doc,.docx,.txt",onChange:e9})]}),(0,s.jsxs)("div",{className:"flex-1 relative",children:[(0,s.jsx)("textarea",{ref:eG,value:T,onChange:e=>F(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),e4())},placeholder:"Type a message...",rows:1,className:"w-full bg-cipher-darker border border-gray-700 rounded-2xl py-3 px-4 pr-12 text-white placeholder-gray-500 focus:border-cipher-primary resize-none transition-colors",style:{maxHeight:"120px"}}),(0,s.jsx)(R.E.button,{onClick:()=>ep(!eg),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-cipher-primary transition-colors",whileHover:{scale:1.2},whileTap:{scale:.9},children:(0,s.jsx)(eI.Z,{className:"w-5 h-5"})}),(0,s.jsx)(L.M,{children:eg&&(0,s.jsx)(R.E.div,{className:"absolute right-0 bottom-14 z-50",initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},children:(0,s.jsx)(eK.ZP,{onEmojiClick:e=>{var t;F(t=>t+e.emoji),ep(!1),null===(t=eG.current)||void 0===t||t.focus()},theme:eK.Q2.DARK,width:350,height:400,searchPlaceholder:"Search emoji...",previewConfig:{showPreview:!1}})})})]}),(0,s.jsx)(R.E.button,{onClick:e4,disabled:!T.trim()||O,className:"\n              p-3 rounded-full transition-all\n              ".concat(T.trim()?"text-white hover:opacity-90":"bg-gray-700 text-gray-500 cursor-not-allowed","\n            "),style:T.trim()?{background:D}:void 0,whileHover:T.trim()?{scale:1.1}:{},whileTap:T.trim()?{scale:.9}:{},children:O?(0,s.jsx)(X.Z,{className:"w-5 h-5 animate-spin"}):(0,s.jsx)(eM.Z,{className:"w-5 h-5"})})]})}),(0,s.jsx)(L.M,{children:A&&(0,s.jsxs)(R.E.div,{className:"absolute right-0 top-0 h-full w-80 bg-cipher-dark/95 backdrop-blur-xl border-l border-gray-800 p-4 overflow-y-auto z-20",initial:{x:"100%",opacity:0},animate:{x:0,opacity:1},exit:{x:"100%",opacity:0},transition:{type:"spring",stiffness:300,damping:30},children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,s.jsx)("h3",{className:"font-medium text-white",children:"Contact Info"}),(0,s.jsx)(R.E.button,{onClick:()=>H(!1),className:"p-1 hover:bg-gray-700 rounded",whileHover:{scale:1.1,rotate:90},whileTap:{scale:.9},children:(0,s.jsx)(Q.Z,{className:"w-5 h-5 text-gray-400"})})]}),(0,s.jsxs)(R.E.div,{className:"text-center mb-6",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1},children:[(0,s.jsx)(R.E.div,{className:"w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-3",style:{background:D},whileHover:{scale:1.05,rotate:5},children:(0,s.jsx)("span",{className:"text-2xl text-white font-medium",children:t.charAt(0).toUpperCase()})}),(0,s.jsx)("h4",{className:"text-lg font-medium text-white",children:t}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:(null==eJ?void 0:eJ.contact_email)||"Secured Peer"})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)(R.E.div,{className:"p-3 bg-cipher-darker rounded-lg",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},children:[(0,s.jsx)("p",{className:"text-xs text-gray-500 mb-1",children:"Public Key Fingerprint"}),(0,s.jsx)("p",{className:"text-xs font-mono text-gray-400 break-all",children:(null==eJ?void 0:eJ.public_key)||eF?g((null==eJ?void 0:eJ.public_key)||eF||""):"Not available - user has not set up encryption"})]}),(0,s.jsxs)(R.E.div,{className:"p-3 bg-cipher-darker rounded-lg",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.3},children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 text-cipher-primary",children:[(0,s.jsx)(K.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{className:"text-sm font-medium",children:"Encryption Active"})]}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"All messages are encrypted with X25519 + AES-256-GCM"})]})]})]})}),(0,s.jsx)(L.M,{children:B&&"ringing"===B.status&&B.isIncoming&&(0,s.jsx)(R.E.div,{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsxs)(R.E.div,{className:"relative mx-auto mb-6",initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",stiffness:200,damping:15},children:[(0,s.jsx)(R.E.div,{className:"absolute inset-0 rounded-full border-2 border-cipher-primary/30",animate:{scale:[1,1.5],opacity:[.5,0]},transition:{duration:2,repeat:1/0}}),(0,s.jsx)(R.E.div,{className:"absolute inset-0 rounded-full border-2 border-cipher-primary/20",animate:{scale:[1,1.8],opacity:[.3,0]},transition:{duration:2,repeat:1/0,delay:.3}}),(0,s.jsx)(R.E.div,{className:"relative w-24 h-24 rounded-full flex items-center justify-center",style:{background:D},children:(0,s.jsx)("span",{className:"text-3xl text-white font-bold",children:B.remoteUsername.charAt(0).toUpperCase()})})]}),(0,s.jsx)(R.E.h2,{className:"text-xl font-bold text-white mb-2",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},children:B.remoteUsername}),(0,s.jsxs)(R.E.p,{className:"text-gray-400 mb-6",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.3},children:["Incoming ",B.type," call..."]}),(0,s.jsxs)(R.E.div,{className:"flex items-center justify-center gap-4",initial:{y:30,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4},children:[(0,s.jsx)(R.E.button,{onClick:e8,className:"p-4 bg-red-500 rounded-full hover:bg-red-600 transition-colors",whileHover:{scale:1.1},whileTap:{scale:.9},children:(0,s.jsx)(eu.Z,{className:"w-6 h-6 text-white"})}),(0,s.jsx)(R.E.button,{onClick:e6,className:"p-4 bg-green-500 rounded-full hover:bg-green-600 transition-colors",whileHover:{scale:1.1},whileTap:{scale:.9},animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0},children:"video"===B.type?(0,s.jsx)(em.Z,{className:"w-6 h-6 text-white"}):(0,s.jsx)(eh.Z,{className:"w-6 h-6 text-white"})})]})]})})}),(0,s.jsx)(L.M,{children:U&&(0,s.jsxs)(R.E.div,{className:"fixed inset-0 bg-black/95 z-[100] flex flex-col",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>z(null),children:[(0,s.jsx)("div",{className:"h-16 px-4 flex items-center justify-end",children:(0,s.jsx)(R.E.button,{onClick:()=>z(null),className:"p-2 text-white/70 hover:text-white transition-colors",whileHover:{scale:1.1,rotate:90},whileTap:{scale:.9},children:(0,s.jsx)(Q.Z,{className:"w-8 h-8"})})}),(0,s.jsx)(R.E.div,{className:"flex-1 flex items-center justify-center p-4",initial:{scale:.9},animate:{scale:1},exit:{scale:.9},children:(0,s.jsx)("img",{src:U,alt:"Full screen preview",className:"max-w-full max-h-full object-contain shadow-2xl rounded-lg",onClick:e=>e.stopPropagation()})}),(0,s.jsx)("div",{className:"h-20 flex items-center justify-center pb-4",children:(0,s.jsxs)(R.E.button,{onClick:()=>te(U,"cipherlink_image.png"),className:"flex items-center gap-2 px-6 py-2 text-white rounded-full hover:opacity-90 transition-colors",style:{background:D},whileHover:{scale:1.05},whileTap:{scale:.95},children:[(0,s.jsx)(ej.Z,{className:"w-5 h-5"}),(0,s.jsx)("span",{children:"Download Full Image"})]})})]})}),(0,s.jsx)(L.M,{children:eH&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(R.E.div,{className:"fixed inset-0 z-[90]",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>{eU(null)}}),(0,s.jsxs)(R.E.div,{className:"fixed bg-cipher-dark/95 backdrop-blur-md border border-gray-700 rounded-xl shadow-2xl py-2 min-w-[160px] z-[100]",style:{left:Math.min(eH.x,window.innerWidth-180),top:Math.min(eH.y,window.innerHeight-120)},initial:{opacity:0,scale:.9,y:-10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:-10},children:[(0,s.jsxs)("button",{onClick:()=>tr(!1),className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-300 hover:bg-gray-700/50 transition-colors",children:[(0,s.jsx)(ew.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"Delete for me"})]}),eH.isMine&&(0,s.jsxs)("button",{onClick:()=>tr(!0),className:"w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-400 hover:bg-red-500/10 transition-colors",children:[(0,s.jsx)(ew.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"Delete for everyone"})]})]})]})}),(0,s.jsx)(L.M,{children:eW&&(0,s.jsx)(R.E.div,{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[110]",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:(0,s.jsxs)(R.E.div,{className:"bg-cipher-dark border border-gray-700 rounded-2xl p-6 max-w-sm mx-4 shadow-2xl",initial:{scale:.9,opacity:0,y:20},animate:{scale:1,opacity:1,y:0},exit:{scale:.9,opacity:0,y:20},children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-white mb-2",children:"message"===eW.type?"Delete message?":"chat"===eW.type?"Clear chat?":"Delete conversation?"}),(0,s.jsx)("p",{className:"text-gray-400 text-sm mb-6",children:"message"===eW.type?"This message will be deleted for everyone. This action cannot be undone.":"chat"===eW.type?"This will clear all messages from your device. The other person will still have their copy.":"This will delete the entire conversation for both you and the other person. This cannot be undone."}),(0,s.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,s.jsx)(R.E.button,{onClick:()=>ez(null),className:"px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition-colors",whileHover:{scale:1.05},whileTap:{scale:.95},children:"Cancel"}),(0,s.jsx)(R.E.button,{onClick:tn,className:"px-4 py-2 text-sm font-medium rounded-lg transition-colors ".concat("conversation"===eW.type?"bg-red-500 hover:bg-red-600 text-white":"text-white hover:opacity-90"),style:"conversation"!==eW.type?{background:D}:void 0,whileHover:{scale:1.05},whileTap:{scale:.95},children:"message"===eW.type?"Delete":"chat"===eW.type?"Clear":"Delete for everyone"})]})]})})})]}):null}function eO(e){let{isOpen:t,onClose:a}=e,[n,i]=(0,r.useState)(""),[l,o]=(0,r.useState)([]),[d,u]=(0,r.useState)("idle"),[m,h]=(0,r.useState)(""),[g,p]=(0,r.useState)(null),y=(0,r.useRef)(null),{addContact:x,setCurrentConversation:v,searchUsers:b,loadContacts:f,loadConversations:w,conversations:j,contacts:N}=E();(0,r.useEffect)(()=>{t&&y.current&&setTimeout(()=>{var e;return null===(e=y.current)||void 0===e?void 0:e.focus()},100),t||(i(""),o([]),u("idle"),h(""),p(null))},[t]);let k=async()=>{let e=n.trim();if(e){if(e.length<2){h("Please enter at least 2 characters"),u("error");return}u("searching"),h(""),o([]);try{let t=await b(e);0===t.length?u("not_found"):(o(t),u("success"))}catch(e){var t,a;console.error("Search failed:",e),h((null==e?void 0:null===(a=e.response)||void 0===a?void 0:null===(t=a.data)||void 0===t?void 0:t.detail)||"Search failed. Please try again."),u("error")}}},_=async e=>{p(e.id),h("");try{if(j.find(t=>t.username===e.username)){v(e.username),a();return}try{if(!(await c.getPublicKey(e.username)).public_key){h("".concat(e.username," hasn't set up their encryption keys yet.")),p(null);return}}catch(e){console.log("Key fetch failed, proceeding with contact addition:",e)}N.find(t=>t.contact_username===e.username)||(await x(e.username),await f()),await w(),v(e.username),a()}catch(e){var t,s;console.error("Failed to start chat:",e),h((null==e?void 0:null===(s=e.response)||void 0===s?void 0:null===(t=s.data)||void 0===t?void 0:t.detail)||"Failed to start chat. Please try again."),p(null)}};return t?(0,s.jsx)("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",onClick:e=>e.target===e.currentTarget&&a(),children:(0,s.jsxs)("div",{className:"bg-cipher-dark border border-gray-700 rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-in fade-in zoom-in duration-200",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-5 border-b border-gray-700 bg-gradient-to-r from-cipher-primary/10 to-cipher-secondary/10",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"w-10 h-10 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-full flex items-center justify-center",children:(0,s.jsx)(T.Z,{className:"w-5 h-5 text-white"})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-white",children:"New Conversation"}),(0,s.jsx)("p",{className:"text-xs text-gray-400",children:"Search for users to start chatting"})]})]}),(0,s.jsx)("button",{onClick:a,className:"p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white transition-colors",children:(0,s.jsx)(Q.Z,{className:"w-5 h-5"})})]}),(0,s.jsxs)("div",{className:"p-5 space-y-4",children:[(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)("div",{className:"flex-1 relative",children:[(0,s.jsx)(q.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 w-4 h-4"}),(0,s.jsx)("input",{ref:y,type:"text",placeholder:"Search by username...",value:n,onChange:e=>i(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),k())},className:"w-full pl-10 pr-4 py-3 bg-cipher-darker border border-gray-700 rounded-lg focus:ring-2 focus:ring-cipher-primary focus:border-transparent text-white placeholder-gray-500 transition-all",disabled:"searching"===d})]}),(0,s.jsx)("button",{onClick:k,disabled:"searching"===d||!n.trim(),className:"px-5 py-3 bg-gradient-to-r from-cipher-primary to-cipher-secondary text-white rounded-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2 font-medium",children:"searching"===d?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(X.Z,{className:"w-4 h-4 animate-spin"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Searching..."})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(q.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Search"})]})})]}),"error"===d&&m&&(0,s.jsxs)("div",{className:"flex items-center gap-2 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm",children:[(0,s.jsx)(eb.Z,{className:"w-4 h-4 flex-shrink-0"}),(0,s.jsx)("span",{children:m})]}),null===g&&m&&"error"!==d&&(0,s.jsxs)("div",{className:"flex items-center gap-2 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm",children:[(0,s.jsx)(eb.Z,{className:"w-4 h-4 flex-shrink-0"}),(0,s.jsx)("span",{children:m})]}),(0,s.jsxs)("div",{className:"min-h-[200px] max-h-[320px] overflow-y-auto",children:["idle"===d&&(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-[200px] text-gray-500",children:[(0,s.jsx)("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4",children:(0,s.jsx)($.Z,{className:"w-8 h-8 text-gray-600"})}),(0,s.jsxs)("p",{className:"text-center text-sm",children:["Search for a username to start a new",(0,s.jsx)("br",{}),"encrypted conversation"]})]}),"searching"===d&&(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-[200px] text-gray-400",children:[(0,s.jsx)(X.Z,{className:"w-10 h-10 animate-spin mb-4 text-cipher-primary"}),(0,s.jsx)("p",{className:"text-sm",children:"Searching for users..."})]}),"not_found"===d&&(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-[200px] text-gray-500",children:[(0,s.jsx)("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4",children:(0,s.jsx)(eb.Z,{className:"w-8 h-8 text-amber-500/70"})}),(0,s.jsx)("p",{className:"text-center font-medium text-amber-400 mb-1",children:"No users found"}),(0,s.jsxs)("p",{className:"text-center text-sm text-gray-500",children:['No users match "',n,'".',(0,s.jsx)("br",{}),"Check the username and try again."]})]}),"success"===d&&l.length>0&&(0,s.jsx)("div",{className:"space-y-2",children:l.map(e=>{let t=j.some(t=>t.username===e.username),a=g===e.id;return(0,s.jsxs)("div",{className:"flex items-center justify-between p-3 border border-gray-700 rounded-lg hover:bg-cipher-darker/70 transition-colors group",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("div",{className:"w-11 h-11 bg-gradient-to-br from-cipher-primary to-cipher-secondary rounded-full flex items-center justify-center text-white font-semibold shadow-lg",children:e.username[0].toUpperCase()}),e.is_online&&(0,s.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-cipher-dark"})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("p",{className:"font-medium text-white flex items-center gap-2",children:[e.username,t&&(0,s.jsx)("span",{className:"text-xs px-1.5 py-0.5 bg-cipher-primary/20 text-cipher-primary rounded",children:"Existing"})]}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:e.public_key?"Encryption ready":"User available"})]})]}),(0,s.jsx)("button",{onClick:()=>_(e),disabled:a,className:"px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2\n                          ".concat(t?"bg-cipher-primary/20 text-cipher-primary hover:bg-cipher-primary/30":"bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:opacity-90","\n                          disabled:opacity-50 disabled:cursor-not-allowed"),children:a?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(X.Z,{className:"w-4 h-4 animate-spin"}),(0,s.jsx)("span",{children:"Starting..."})]}):t?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(T.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"Open"})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)($.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"Chat"})]})})]},e.id)})})]})]}),(0,s.jsx)("div",{className:"px-5 py-3 border-t border-gray-700 bg-cipher-darker/50",children:(0,s.jsxs)("p",{className:"text-xs text-gray-500 text-center flex items-center justify-center gap-1",children:[(0,s.jsx)("span",{className:"inline-block w-2 h-2 bg-green-500 rounded-full"}),"All conversations are end-to-end encrypted"]})})]})}):null}var eZ=a(3021),eA=a(597),eH=a(4135),eU=a(3088),eR=a(6369),eL=a(7346);function eW(e){let{isOpen:t,onClose:a}=e,{user:n,logout:i}=E(),[l,o]=(0,r.useState)("profile"),{settings:d,updateSettings:u,getAccentGradient:m}=(0,N.MU)(),{theme:h,accent:g,fontSize:p,density:y,messagePreview:x,animationsEnabled:v}=d,[b,f]=(0,r.useState)("rounded"),[w,j]=(0,r.useState)("inter");(0,r.useEffect)(()=>{f(S()),j(D())},[]);let k=e=>{u(e),c.updateSettings(e).catch(e=>console.error("Failed to save settings to server:",e))},I=e=>{f(e),function(e){try{localStorage.setItem(_,e)}catch(e){console.error("Failed to save bubble style:",e)}}(e)},M=e=>{j(e),function(e){try{localStorage.setItem(C,e)}catch(e){console.error("Failed to save font style:",e)}}(e)},P=[{id:"profile",label:"Profile",icon:F.Z},{id:"security",label:"Security",icon:K.Z},{id:"notifications",label:"Notifications",icon:eZ.Z},{id:"appearance",label:"Appearance",icon:eA.Z}];return t?(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Settings"}),(0,s.jsx)("button",{onClick:a,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300",children:(0,s.jsx)(Q.Z,{className:"w-6 h-6"})})]}),(0,s.jsxs)("div",{className:"flex",children:[(0,s.jsx)("div",{className:"w-64 bg-gray-50 dark:bg-gray-900 p-4",children:(0,s.jsx)("nav",{className:"space-y-2",children:P.map(e=>{let t=e.icon;return(0,s.jsxs)("button",{onClick:()=>o(e.id),className:"w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-left transition-colors ".concat(l===e.id?"bg-blue-600 text-white":"text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700"),children:[(0,s.jsx)(t,{className:"w-5 h-5"}),(0,s.jsx)("span",{children:e.label})]},e.id)})})}),(0,s.jsxs)("div",{className:"flex-1 p-6 overflow-y-auto max-h-[calc(90vh-80px)]",children:["profile"===l&&(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Profile Information"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Username"}),(0,s.jsx)("input",{type:"text",value:(null==n?void 0:n.username)||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Email"}),(0,s.jsx)("input",{type:"email",value:(null==n?void 0:n.email)||"",disabled:!0,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white"})]})]}),(0,s.jsx)("div",{className:"pt-4 border-t border-gray-200 dark:border-gray-700",children:(0,s.jsx)("button",{onClick:()=>{i(),a()},className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Sign Out"})})]}),"security"===l&&(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Security & Privacy"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"p-4 bg-green-50 dark:bg-green-900/20 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-2 mb-2",children:[(0,s.jsx)(K.Z,{className:"w-5 h-5 text-green-600"}),(0,s.jsx)("span",{className:"font-medium text-green-800 dark:text-green-200",children:"End-to-End Encryption Active"})]}),(0,s.jsx)("p",{className:"text-sm text-green-700 dark:text-green-300",children:"Your messages are encrypted with X25519 + Ed25519 cryptography. Only you and your recipients can read them."})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("h4",{className:"font-medium text-gray-900 dark:text-white",children:"Cryptographic Keys"}),(0,s.jsxs)("button",{onClick:()=>{console.log("Exporting keys...")},className:"flex items-center space-x-2 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700",children:[(0,s.jsx)(ej.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"Export Key Backup"})]}),(0,s.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Export your keys for backup or device migration. Keep this file secure."})]})]})]}),"notifications"===l&&(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Notification Preferences"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Message Notifications"}),(0,s.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Get notified when you receive new messages"})]}),(0,s.jsx)("input",{type:"checkbox",defaultChecked:!0,className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Sound Notifications"}),(0,s.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Play sound for new messages"})]}),(0,s.jsx)("input",{type:"checkbox",defaultChecked:!0,className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"})]})]})]}),"appearance"===l&&(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Appearance"}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Theme Mode"}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-3",children:[{value:"light",icon:eH.Z,label:"Light"},{value:"dark",icon:eU.Z,label:"Dark"},{value:"system",icon:el.Z,label:"System"}].map(e=>{let t=e.icon,a=h===e.value;return(0,s.jsxs)("button",{onClick:()=>k({theme:e.value}),className:"flex flex-col items-center gap-2 p-4 rounded-lg border-2 transition-all ".concat(a?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:[(0,s.jsx)(t,{className:"w-6 h-6 ".concat(a?"text-blue-500":"text-gray-500")}),(0,s.jsx)("span",{className:"text-sm font-medium ".concat(a?"text-blue-600 dark:text-blue-400":"text-gray-700 dark:text-gray-300"),children:e.label}),a&&(0,s.jsx)(ex.Z,{className:"w-4 h-4 text-blue-500 absolute top-2 right-2"})]},e.value)})})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Accent Color"}),(0,s.jsx)("div",{className:"flex flex-wrap gap-3",children:Object.keys(N.FN).map(e=>{let t=N.FN[e],a=g===e;return(0,s.jsx)("button",{onClick:()=>k({accent:e}),className:"relative w-12 h-12 rounded-full transition-transform hover:scale-110 ".concat(a?"ring-2 ring-offset-2 ring-offset-white dark:ring-offset-gray-800":""),style:{background:"linear-gradient(135deg, ".concat(t.primary,", ").concat(t.secondary,")"),boxShadow:a?"0 0 0 2px ".concat(t.primary):void 0},title:t.name,children:a&&(0,s.jsx)(ex.Z,{className:"w-5 h-5 text-white absolute inset-0 m-auto"})},e)})}),(0,s.jsxs)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Selected: ",N.FN[g].name]})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Font Size"}),(0,s.jsx)("div",{className:"flex items-center gap-4",children:[{value:"small",label:"Small",size:"text-sm"},{value:"medium",label:"Medium",size:"text-base"},{value:"large",label:"Large",size:"text-lg"}].map(e=>{let t=p===e.value;return(0,s.jsx)("button",{onClick:()=>k({fontSize:e.value}),className:"px-4 py-2 rounded-lg border-2 transition-all ".concat(e.size," ").concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400":"border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:border-gray-300"),children:e.label},e.value)})})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Chat Density"}),(0,s.jsx)("div",{className:"space-y-2",children:[{value:"compact",label:"Compact",desc:"More messages visible"},{value:"comfortable",label:"Comfortable",desc:"Balanced spacing"},{value:"spacious",label:"Spacious",desc:"More breathing room"}].map(e=>{let t=y===e.value;return(0,s.jsx)("label",{className:"flex items-center justify-between p-3 rounded-lg border-2 cursor-pointer transition-all ".concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300"),children:(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("input",{type:"radio",name:"density",checked:t,onChange:()=>k({density:e.value}),className:"w-4 h-4 text-blue-600"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium ".concat(t?"text-blue-600 dark:text-blue-400":"text-gray-900 dark:text-white"),children:e.label}),(0,s.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:e.desc})]})]})},e.value)})})]}),(0,s.jsxs)("div",{className:"space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Additional Options"}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Message Preview"}),(0,s.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Show message preview in sidebar"})]}),(0,s.jsx)("button",{onClick:()=>k({messagePreview:!x}),className:"relative w-12 h-6 rounded-full transition-colors ".concat(x?"bg-blue-600":"bg-gray-300 dark:bg-gray-600"),children:(0,s.jsx)("div",{className:"absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ".concat(x?"translate-x-7":"translate-x-1")})})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Animations"}),(0,s.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Enable UI animations and transitions"})]}),(0,s.jsx)("button",{onClick:()=>k({animationsEnabled:!v}),className:"relative w-12 h-6 rounded-full transition-colors ".concat(v?"bg-blue-600":"bg-gray-300 dark:bg-gray-600"),children:(0,s.jsx)("div",{className:"absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ".concat(v?"translate-x-7":"translate-x-1")})})]})]}),(0,s.jsxs)("div",{className:"space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Message Style"}),(0,s.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:"Your message style will be visible to recipients"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Bubble Style"}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-3",children:[{value:"rounded",label:"Rounded",desc:"Classic"},{value:"glass",label:"Glass",desc:"Translucent"},{value:"neon",label:"Neon",desc:"Glow effect"}].map(e=>{let t=b===e.value;return(0,s.jsxs)("button",{onClick:()=>I(e.value),className:"flex flex-col items-center gap-1.5 p-3 rounded-lg border-2 transition-all ".concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:[(0,s.jsx)("div",{className:"w-12 h-8 rounded-lg flex items-center justify-center ".concat("glass"===e.value?"backdrop-blur-md border border-white/20":"neon"===e.value?"shadow-lg":""),style:{background:"linear-gradient(135deg, ".concat(N.FN[g].primary,", ").concat(N.FN[g].secondary,")"),boxShadow:"neon"===e.value?"0 0 10px ".concat(N.FN[g].primary,"50"):void 0},children:(0,s.jsx)(eR.Z,{className:"w-3 h-3 text-white"})}),(0,s.jsx)("span",{className:"text-xs font-medium ".concat(t?"text-blue-600 dark:text-blue-400":"text-gray-700 dark:text-gray-300"),children:e.label})]},e.value)})})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Message Font"}),(0,s.jsx)("div",{className:"grid grid-cols-2 gap-3",children:[{value:"inter",label:"Sans-serif",sample:"Hello!"},{value:"mono",label:"Monospace",sample:"Hello!"}].map(e=>{let t=w===e.value;return(0,s.jsxs)("button",{onClick:()=>M(e.value),className:"flex items-center gap-3 p-3 rounded-lg border-2 transition-all ".concat(t?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"),children:[(0,s.jsx)(eL.Z,{className:"w-5 h-5 ".concat(t?"text-blue-500":"text-gray-500")}),(0,s.jsxs)("div",{className:"text-left",children:[(0,s.jsx)("p",{className:"text-sm font-medium ".concat(t?"text-blue-600 dark:text-blue-400":"text-gray-700 dark:text-gray-300"),children:e.label}),(0,s.jsx)("p",{className:"text-xs text-gray-500 ".concat("mono"===e.value?"font-mono":"font-sans"),children:e.sample})]})]},e.value)})})]})]}),(0,s.jsxs)("div",{className:"space-y-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900 dark:text-white",children:"Preview"}),(0,s.jsxs)("div",{className:"p-4 rounded-lg bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700",children:[(0,s.jsxs)("div",{className:"flex items-start gap-3",children:[(0,s.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center text-white font-medium",style:{background:"linear-gradient(135deg, ".concat(N.FN[g].primary,", ").concat(N.FN[g].secondary,")")},children:"J"}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"font-medium text-gray-900 dark:text-white",children:"John Doe"}),(0,s.jsx)("span",{className:"text-xs text-gray-500",children:"12:34 PM"})]}),(0,s.jsx)("p",{className:"text-gray-700 dark:text-gray-300 mt-1",children:"This is how your messages will look with the current settings! \uD83C\uDFA8"})]})]}),(0,s.jsx)("div",{className:"flex justify-end mt-3",children:(0,s.jsxs)("div",{className:"px-4 py-2 rounded-2xl text-white max-w-xs",style:{background:"linear-gradient(135deg, ".concat(N.FN[g].primary,", ").concat(N.FN[g].secondary,")")},children:[(0,s.jsx)("p",{children:"Looking great! ✨"}),(0,s.jsx)("div",{className:"flex justify-end mt-1",children:(0,s.jsx)("span",{className:"text-xs opacity-70",children:"12:35 PM"})})]})})]})]})]})]})]})]})}):null}var ez=a(8004);function eB(){let{loadContacts:e,loadConversations:t,loadCallHistory:a,initializeWebSocket:n,currentConversation:i}=E(),[l,o]=(0,r.useState)(!0),[c,d]=(0,r.useState)(!1),[u,m]=(0,r.useState)(!1),[h,g]=(0,r.useState)(!1);return(0,r.useEffect)(()=>{e(),t(),a(),n();let s=()=>g(window.innerWidth<1024);return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[e,t,a,n]),(0,s.jsxs)("div",{className:"h-screen bg-cipher-darker flex overflow-hidden relative",children:[(0,s.jsx)(W.ParticleField,{density:"low",className:"opacity-30"}),(0,s.jsx)(R.E.button,{onClick:()=>o(!l),className:"lg:hidden fixed top-4 left-4 z-50 p-2 bg-cipher-dark rounded-lg text-gray-400 hover:text-white",whileHover:{scale:1.05},whileTap:{scale:.95},initial:{opacity:0,x:-20},animate:{opacity:1,x:0},children:l?(0,s.jsx)(Q.Z,{className:"w-5 h-5"}):(0,s.jsx)(ez.Z,{className:"w-5 h-5"})}),(0,s.jsx)(R.E.div,{className:"\n          fixed lg:relative inset-y-0 left-0 z-40\n          w-80 bg-cipher-dark border-r border-gray-800\n          transform ".concat(l?"translate-x-0":"-translate-x-full","\n          lg:translate-x-0\n        "),initial:!1,animate:{x:l?0:-320,rotateY:l&&!h?0:5,scale:l?1:.95},transition:{type:"spring",stiffness:300,damping:30},style:{transformStyle:"preserve-3d",perspective:1200,transformOrigin:"left center"},children:(0,s.jsx)(es,{onNewChat:()=>d(!0),onSettings:()=>m(!0)})}),(0,s.jsx)("div",{className:"flex-1 flex flex-col relative",children:(0,s.jsx)(L.M,{mode:"wait",children:i?(0,s.jsx)(R.E.div,{className:"flex-1 flex flex-col h-full",initial:{x:50,opacity:0,rotateY:-10},animate:{x:0,opacity:1,rotateY:0},exit:{x:-30,opacity:0,rotateY:10},transition:{type:"spring",stiffness:300,damping:30},style:{transformStyle:"preserve-3d",perspective:1200},children:(0,s.jsx)(eF,{})},"chat"):(0,s.jsx)(R.E.div,{className:"flex-1 flex items-center justify-center",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.3},children:(0,s.jsx)(eG,{})},"empty")})}),(0,s.jsx)(eO,{isOpen:c,onClose:()=>d(!1)}),(0,s.jsx)(eW,{isOpen:u,onClose:()=>m(!1)}),(0,s.jsx)(L.M,{children:l&&h&&(0,s.jsx)(R.E.div,{className:"lg:hidden fixed inset-0 bg-black/50 z-30 backdrop-blur-sm",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>o(!1)})})]})}function eG(){return(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)(R.E.div,{className:"w-20 h-20 bg-gradient-to-br from-cipher-primary/20 to-cipher-secondary/20 rounded-full flex items-center justify-center mx-auto mb-6",initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.2},children:(0,s.jsx)(M.Z,{className:"w-10 h-10 text-cipher-primary"})}),(0,s.jsx)(R.E.h2,{className:"text-2xl font-bold text-white mb-2",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.3},children:"Welcome to CipherLink"}),(0,s.jsx)(R.E.p,{className:"text-gray-400 max-w-md",initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4},children:"Select a conversation or start a new chat to begin sending end-to-end encrypted messages."}),(0,s.jsxs)(R.E.div,{className:"mt-6 flex items-center justify-center gap-2 text-sm text-gray-500",initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},children:[(0,s.jsx)(M.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"All messages are encrypted on your device"})]})]})}function eV(){let{isAuthenticated:e,isLoading:t,loadStoredAuth:a}=E();return((0,r.useEffect)(()=>{a()},[a]),t)?(0,s.jsx)("div",{className:"min-h-screen bg-cipher-darker flex items-center justify-center",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"w-16 h-16 border-4 border-cipher-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"}),(0,s.jsx)("p",{className:"text-gray-400",children:"Loading CipherLink..."})]})}):e?(0,s.jsx)(eB,{}):(0,s.jsx)(H,{})}}},function(e){e.O(0,[560,89,706,336,971,938,744],function(){return e(e.s=9325)}),_N_E=e.O()}]);